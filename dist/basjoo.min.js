!function(){"use strict";var e=function(e){console.log(e)},t=function(e){console.debug(e)},i=function(e){console.info(e)},n=function(e){console.warn(e)},r=function(e){console.error(e)},a=function(){},s=function(){function s(){this.mode={log:!0,debug:!0,info:!0,warn:!0,error:!0},this.log=e,this.debug=t,this.info=i,this.warn=n,this.error=r,this.nullfunc=a}return s.prototype.setMode=function(s){for(var o in s)"log"==o?(s[o]?this.log=e:this.log=a,this.mode[o]=s[o]):"debug"==o?(s[o]?this.debug=t:this.debug=a,this.mode[o]=s[o]):"info"==o?(s[o]?this.info=i:this.info=a,this.mode[o]=s[o]):"warn"==o?(s[o]?this.warn=n:this.warn=a,this.mode[o]=s[o]):"error"==o&&(s[o]?this.error=r:this.error=a,this.mode[o]=s[o])},s.prototype.getMode=function(){return this.mode},s}(),o=function(e,t){return e instanceof Object&&Object.prototype.hasOwnProperty.call(e,t)},l=new s,u=function(e,t){return o(e,t)||(e[t]=0),e[t]},d=function(){function e(){this.autoSwitchBitrate=!0,this.qualityDict={},this.defaultQualityDict={video:0,audio:0},this.averageDownloadRatio={},this.averageDownloadRate={},this.confidenceDict={},this.maxQualityIndexDict={},this.minBufferTime=4,this.lastCheckedRequest={video:null,audio:null},this.downloadRateList={video:[],audio:[]},this.downloadDiffList={video:[],audio:[]},this.NXDebug=new s}return e.prototype.getAutoSwitchBitrate=function(){return this.autoSwitchBitrate},e.prototype.setAutoSwitchBitrate=function(e){this.autoSwitchBitrate=e},e.prototype.getPlaybackQuality=function(e,t,i,n,r,a){var s,d,f;return d=u(this.qualityDict,e),f=function(e,t){return o(e,t)||(e[t]=0),e[t]}(this.confidenceDict,e),this.autoSwitchBitrate&&null!=(s=function(e,t,i,n,r,a,s,u,d,f,c,m,g){var p,h,y,v,S=!1;if(!t)return{idx:e,switchTo:0};if(null===r)return l.log("No requests made for this stream yet, bailing."),{idx:e,switchTo:0};if(r===a[i.type])return{idx:e,switchTo:0};if(a[i.type]=r,(p=(r.tfinish-r.trequest)/1e3)<=0)return{idx:e,switchTo:0};var T=8*r.size/p*.9;if(function(e,t,i){o(e,t)?e[t]=.75*e[t]+.25*i:e[t]=i,e[t]}(f,i.type,T),s[i.type].length>2&&s[i.type].shift(),s[i.type].push(T),u[i.type].length>2&&u[i.type].shift(),408==r.code?u[i.type].push(-p):u[i.type].push(r.mediaduration-p),void 0===n)return{idx:e,switchTo:0};if(null===r.mediaduration||void 0===r.mediaduration||r.mediaduration<=0||isNaN(r.mediaduration))return{idx:e,switchTo:0};if(h=.9*(y=408!=r.code?r.mediaduration/p:.1),isNaN(h)||isNaN(y))return l.log("The ratios are NaN, bailing."),{idx:e,switchTo:0};var E=n<1.5*r.mediaduration||h<1?1.5:1;if(isNaN(h))return{idx:e,switchTo:0};if(h<1){if(n<r.mediaduration)return{idx:0,switchTo:1};if(!(T<i.representations[e].bandwidth*E)){for(var b=0,D=0;D<u[i.type].length;D++)b+=u[i.type][D];return m?{idx:Math.max(e-2,0),switchTo:1}:b<0&&n<2*r.mediaduration?{idx:Math.max(e-1,0),switchTo:1}:{idx:e,switchTo:0}}if(!(e>0))return{idx:0,switchTo:0};for(S=!1,v=e-1;v>=0;v--)if(T>=i.representations[v].bandwidth*E)return S=!0,{idx:v,switchTo:1};if(!S)return{idx:0,switchTo:1}}else{var R=!1;if(n<c){var M=i.representations[e].bandwidth*E;for(D=0;D<s[i.type].length;D++)if(s[i.type][D]<M){R=!0;break}}var I=i.representations.length;if(R)return{idx:e,switchTo:0};if(!(e<I))return{idx:e,switchTo:0};for(S=!1,v=e;v<I;v++)if(T<i.representations[v].bandwidth*E)return S=!0,v==e+1?{idx:v-1,switchTo:0}:{idx:v-1,switchTo:2};if(!S)return{idx:I-1,switchTo:2}}return null}(d,i,t,n,i.getCurrentRevisedHttpRequest(),this.lastCheckedRequest,this.downloadRateList,this.downloadDiffList,this.averageDownloadRatio,this.averageDownloadRate,this.minBufferTime,r))?(s.idx<0&&(s.idx=0),this.qualityDict[e]=s.idx,this.confidenceDict[e]=s.switchTo,{quality:s.idx,confidence:s.switchTo}):{quality:d,confidence:f}},e.prototype.setPlaybackQuality=function(e,t){t!==u(this.qualityDict,e)&&(this.qualityDict[e]=t)},e.prototype.getQualityFor=function(e){return u(this.qualityDict,e)},e.prototype.setDefaultPlaybackQuality=function(e,t){this.defaultQualityDict[e]=t},e.prototype.getDefaultQualityFor=function(e){return this.defaultQualityDict[e]},e.prototype.setMaxQualityIndex=function(e,t){this.maxQualityIndexDict[e]=t-1,o(this.qualityDict,e)&&this.qualityDict[e]>t-1&&(this.qualityDict[e]=t-1)},e.prototype.getMaxQualityIndexFor=function(e){return o(this.maxQualityIndexDict,e)?this.maxQualityIndexDict[e]:0},e.prototype.setMinBufferTime=function(e){this.minBufferTime=e},e.prototype.getAverageDownloadRate=function(e){return o(this.averageDownloadRate,e)?this.averageDownloadRate[e]:0},e.prototype.matchingQualityBetweenDifferentAdaptation=function(e,t){if(e!==t){l.debug("********* matchingQualityBetweenDifferentAdaptation *********");var i=u(this.qualityDict,e.type),n=0,r=e.representations[i].bandwidth,a=this.getAverageDownloadRate(e.type),s=Math.max(a,1.1*r);this.setMaxQualityIndex(t.type,t.representations.length);for(var o=t.representations.length-1;o>=0;o--)if(t.representations[o].bandwidth<=s){n=o;break}l.debug("["+e.type+"] from:["+i+"]:"+r+",to:["+n+"]:"+t.representations[n].bandwidth+", averageDownloadRate:"+a),this.setPlaybackQuality(e.type,n)}},e}(),f={capabilityError:function(e,t){e.dispatchEvent({type:"error",error:"capability",event:t})},downloadError:function(e,t,i,n,r){e.dispatchEvent({type:"error",error:"download",event:{id:t,url:i,request:n,_request:r}})},manifestError:function(e,t,i,n){e.dispatchEvent({type:"error",error:"manifestError",event:{message:t,id:i,manifest:n}})},mediaSourceError:function(e,t){e.dispatchEvent({type:"error",error:"mediasource",event:t})},mediaKeySessionError:function(e,t){e.dispatchEvent({type:"error",error:"key_session",event:t})},mediaKeyMessageError:function(e,t){e.dispatchEvent({type:"error",error:"key_message",event:t})},mediaKeySystemSelectionError:function(e,t){e.dispatchEvent({type:"error",error:"key_system_selection",event:t})}},c=function(){var e=this;this.getListeners=function(t,i){var n="".concat(i?"1":"0").concat(t);return n in e.registrations||(e.registrations[n]=[]),e.registrations[n]},this.addEventListener=function(t,i,n){void 0===n&&(n=!1);var r=e.getListeners(t,n);-1===r.indexOf(i)&&r.push(i)},this.removeEventListener=function(t,i,n){void 0===n&&(n=!1);var r=e.getListeners(t,n),a=r.indexOf(i);-1!==a&&r.splice(a,1)},this.dispatchEvent=function(t){for(var i=e.getListeners(t.type,!1).slice(),n=0;n<i.length;n++)i[n].call(e,t);return!t.defaultPrevented},this.clearAllEventListener=function(){e.registrations={}},this.registrations={}},m={log:function(e,t){},log_A:function(){},log_V:function(){},log_V2:function(e){},log_A2:function(e){},log_d:function(e){},log_V2Q:function(e){},log_A2Q:function(e){},log_item:function(e,t){},log_slider:function(e,t){},log_DRM:function(e,t){},clearLogs:function(){}},g=function(){var e=this;this.TcpList=[],this.HttpList=[],this.revHttpList=[],this.RepSwitchList=[],this.BufferLevel=[],this.PlayList=[],this.DroppedFrames=[],this.ReportHttpList=[],this.ReportBufferLevel=[],this.ReportBufferingEvent=[],this.storeMeasuredData=!1,this.setStoreMeasuredData=function(t){e.storeMeasuredData=t},this.getCurrentBufferLevel=function(){var t=e.BufferLevel.length;return t<=0?null:e.BufferLevel[t-1]},this.getCurrentHttpRequest=function(){var t,i=e.HttpList.length;if(i<=0)return null;for(t=i-1;t>=0;){if(e.HttpList[t].responsecode)return e.HttpList[t];t-=1}return null},this.getCurrentRevisedHttpRequest=function(){var t=e.revHttpList.length;return t<=0?null:e.revHttpList[t-1]},this.shiftMetrics=function(e){return e&&e.length>9&&e.shift()||{}},this.addHttpRequest=function(t,i,n,r,a,s,o,l,u,d,f,c,m){var g=e.shiftMetrics(e.HttpList);return g.stream=t,g.tcpid=i,g.type=n,g.url=r,g.baseURL=a,g.range=s,g.trequest=o,g.tresponse=l,g.tfinish=u,g.responsecode=d,g.interval=f,g.mediaduration=c,g.bandwidth=m,g.trace=[],g.size=0,e.HttpList.push(g),g},this.addReportHttpRequest=function(t,i){var n={};return n.type=t.stream,n.url=t.url,n.baseURL=t.baseURL,n.treq=t.trequest,n.tres=t.tresponse,n.tfin=t.tfinish,n.code=t.responsecode,n.dur=t.mediaduration,n.bw=t.bandwidth,n.size=t.size,n.index=t.index,n.c=i.toFixed(3),e.ReportHttpList.push(n),n},this.addRevisedHttpRequest=function(t){var i=e.shiftMetrics(e.revHttpList);return i.stream=t.stream,i.trequest=t.trequest,i.tresponse=t.tresponse,i.tfinish=t.tfinish,i.mediaduration=t.mediaduration,i.bandwidth=t.bandwidth,i.size=t.size,i.code=t.responsecode,i.index=t.index,e.revHttpList.push(i),i},this.appendHttpTrace=function(t,i,n,r){var a=e.shiftMetrics(t.trace);return a.s=i,a.d=n,a.b=r,t.trace.push(a),a},this.addRepresentationSwitch=function(t,i,n,r,a){var s=e.shiftMetrics(e.RepSwitchList);return s.t=i,s.mt=n,s.to=r,s.lto=a,e.RepSwitchList.push(s),s},this.addBufferLevel=function(t,i,n,r,a){var s=e.shiftMetrics(e.BufferLevel);if(s.t=i,s.level=n,s.totalLevel=n+r,e.BufferLevel.push(s),e.storeMeasuredData){var o={};o.t=i,o.l=new Number(n).toFixed(3),o.ql=new Number(r).toFixed(3),o.c=a.toFixed(3),e.ReportBufferLevel.push(o)}return s},this.addBufferingEvent=function(t,i,n){var r={};return r.t=t,r.e=i,r.c=n.toFixed(3),e.ReportBufferingEvent.push(r),r},this.addPlayList=function(t,i,n,r){var a=e.shiftMetrics(e.PlayList);return a.stream=t,a.start=i,a.mstart=n,a.starttype=r,a.trace=[],e.PlayList.push(a),a},this.appendPlayListTrace=function(t,i,n,r,a,s,o,l){var u=e.shiftMetrics(t.trace);return u.representationid=i,u.subreplevel=n,u.start=r,u.mstart=a,u.duration=s,u.playbackspeed=o,u.stopreason=l,t.trace.push(u),u}},p=function(){var e=this;this.streamMetrics={},this.getReadOnlyMetricsFor=function(t){return o(e.streamMetrics,t)?e.streamMetrics[t]:null},this.getMetricsFor=function(t){var i;return o(e.streamMetrics,t)?i=e.streamMetrics[t]:(i=new g,e.streamMetrics[t]=i),i}},h=function(e,t){var i=this;this.autoPlay=!0,this.selfPaused=!1,this.manualPause=!0,this.startTime=NaN,this.startOffset=0,this.stalledStreams=[],this.sourceBuffers={video:void 0,audio:void 0},this.epsilonVal={video:0,audio:0},this.canplaythroughListener=function(){},this.adjusting=!1,this.playbackStarted=!1,this.addStalledStream=function(e){null!==e&&(m.log("*** addStalledStream trigger: "+e+", paused: true"),-1===i.stalledStreams.indexOf(e)&&i.stalledStreams.push(e))},this.removeStalledStream=function(){},this.play=function(e){e&&(i.manualPause=!1)},this.pause=function(e){e&&(i.manualPause=!0)},this.stallStream=function(e,t){t?i.addStalledStream(e):i.removeStalledStream.call(i)},this.adjustCurrentTime=function(e){},this.silentSeek=function(e,t){},this.checkCanplaythrough=function(){},this.isPaused=function(){return!0},this.getPlaybackRate=function(){return 1},this.getCurrentTime=function(){return 0},this.setCurrentTime=function(){},this.getDuration=function(){return 1/0},this.getCanPlayType=function(){return"probably"},this.getReadyState=function(){return 1},this.getBuffered=function(){return{length:0,start:function(e){return 0},end:function(e){return 0}}},this.listen=function(){},this.unlisten=function(){},this.getElement=function(){return null},this.setSource=function(){},this.setAutoPlay=function(e){i.autoPlay=e,i.autoPlay&&(i.manualPause=!1,i.selfPaused=!0)},this.setStartTime=function(e){i.startTime=e},this.getStartTime=function(){return i.startTime},this.setStartOffset=function(e){i.startOffset=e},this.getPlaybackState=function(){return i.playbackStarted},this.reset=function(){i.startTime=NaN,i.startOffset=0,i.manualPause=!0,i.selfPaused=!1,i.stalledStreams=[],i.playbackStarted=!1,i.sourceBuffers={video:void 0,audio:void 0},i.unlisten(),i.canplaythroughListener=function(){}},this.setSelfPaused=function(e){i.selfPaused=e},this.getSelfPaused=function(){return i.selfPaused},this.getNeedsMoreData=function(){return!0},this.setSourceBuffer=function(e,t){i.sourceBuffers[e]=t},this.setEpsilonFor=function(e,t){i.epsilonVal[e]=t},this.setSkipGapAtHOB=function(){},this.onAdjusting=function(){return i.adjusting},this.getCurrentStatus=function(){return{autoPlay:i.autoPlay,selfPaused:i.selfPaused,manualPause:i.manualPause,startTime:i.startTime,startOffset:i.startOffset,stalledStreams:i.stalledStreams,epsilonVal:i.epsilonVal,adjusting:i.adjusting,playbackStarted:i.playbackStarted}},this.isDummy=function(){return!0},this.value=e,this.eventBus=t},y=function(n,r){var a=this;this.autoPlay=!0,this.selfPaused=!1,this.startTime=NaN,this.startOffset=0,this.stalledStreams=[],this.sourceBuffers={video:void 0,audio:void 0},this.epsilonVal={video:0,audio:0},this.canplaythroughListener=function(){},this.adjusting=!1,this.needsMoreData=!0,this.skipGapAtHOB=!1,this.playbackStarted=!1,this.playCheckTimerId=null,this.isStalled=function(){return a.stalledStreams.length>0},this.playCheck=function(e){var t,i=a,n=!1,r=function(s){if(a.playCheckTimerId=null,!a.element.paused||n)if(e==a.element.currentTime)if(a.element.readyState<3)for(var o=a.element.buffered,l=0;l<o.length;l++)o.start(l)<=e&&e<o.end(l)&&(o.end(l)-e>10?(a.element.removeEventListener("timeupdate",t),i.silentSeek(e+.01)):a.playCheckTimerId=setTimeout(r.bind(i,a.element.readyState),2e3));else s>2?(a.element.removeEventListener("timeupdate",t),a.element.paused?(a.playCheckTimerId=setTimeout(r.bind(i,a.element.readyState),2e3),a.play.call(i)):i.silentSeek(e+.1)):(a.playCheckTimerId=setTimeout(r.bind(i,a.element.readyState),1e3),a.element.pause(),n=!0);else a.element.removeEventListener("timeupdate",t)};null!=a.playCheckTimerId&&clearTimeout(a.playCheckTimerId),t=function(e){e!=a.element.currentTime&&(a.element.removeEventListener("timeupdate",t),null!=a.playCheckTimerId&&clearTimeout(a.playCheckTimerId))}.bind(i,e),a.element.addEventListener("timeupdate",t),a.playCheckTimerId=setTimeout(r.bind(i),2e3)},this.addStalledStream=function(e){if(null!==e){var t=document.createEvent("HTMLEvents");t.initEvent("buffering",!0,!1),t.visibility=!0,m.log("*** addStalledStream trigger: "+e+", paused: "+a.element.paused),a.element.dispatchEvent(t),a.element.paused||(a.selfPaused=!0,a.element.pause()),-1===a.stalledStreams.indexOf(e)&&a.stalledStreams.push(e)}},this.play=function(t){var i;a.element.paused&&void 0!==(i=a.element.play())&&i.then((function(){a.eventBus.dispatchEvent({type:"PLAY_PROMISE",data:{element:a.element}})})).catch((function(){a.eventBus.dispatchEvent({type:"PLAY_PROMISE_ERROR",data:{element:a.element}})})),m.log("*** PLAY"),e("*** PLAY")},this.removeStalledStream=function(e){var t=a;if(null!==e){var i=document.createEvent("HTMLEvents");i.initEvent("buffering",!0,!1),i.visibility=!1;var n=a.stalledStreams.indexOf(e);-1!==n&&a.stalledStreams.splice(n,1),a.isStalled()||(m.log("*** removeStalledStream paused: "+a.element.paused+", selfPaused: "+a.selfPaused+",readyState:"+a.element.readyState),a.element.dispatchEvent(i),a.adjustCurrentTime.call(a,(function(){a.playCheck.call(t,a.element.currentTime),a.element.paused&&a.selfPaused&&(a.selfPaused=!1,a.play.call(t),a.playbackStarted||(a.playbackStarted=!0,a.eventBus.dispatchEvent({type:"playbackStarted",data:{}})))})))}},this.pause=function(t){a.element.pause(),m.log("*** PAUSE"),e("*** PAUSE")},this.stallStream=function(e,t){t?a.addStalledStream(e):a.removeStalledStream.call(a,e)},this.adjustCurrentTime=function(e){var i,n,r,s=a,o=e||function(){},l=a.element.currentTime,u=l,d=l,f=a.skipGapAtHOB||a.playbackStarted?0:.5;if(i=a.sourceBuffers.video?a.sourceBuffers.video.buffered:null,n=a.sourceBuffers.audio?a.sourceBuffers.audio.buffered:null,null===i||0==a.element.readyState)o(l);else{for(r=0;r<i.length;r++){if(i.start(r)-1<l&&l<i.start(r)){u=i.start(r);break}if(i.start(r)<=l&&l<i.end(r))break}if(n)for(r=0;r<n.length;r++){if(n.start(r)-1<u&&u<n.start(r)){d=n.start(r);break}if(n.start(r)<=u&&u<n.end(r)){d=u;break}}else d=u;0==l&&l+f<d||0!=l&&l<d?(t("adjusted start time !!! "+l+"=>"+d),m.log("adjusted start time !!! "+l+"=>"+d),s.silentSeek(d,(function(e){e<d?s.silentSeek(d+.1,(function(e){o(e)})):o(e)}))):o(l)}},this.silentSeek=function(e,t){var i=a,n=t||function(){},r=function(e){a.eventBus.removeEventListener("ADJUST_CURRENTTIME_END",r,!1),a.adjusting=!1,n(e.data.ctime)},s=function(){a.eventBus.removeEventListener("ADJUST_CURRENTTIME_END",s,!1),a.adjusting=!0,a.eventBus.addEventListener("ADJUST_CURRENTTIME_END",r,!1),i.setCurrentTime(e)};a.adjusting?a.eventBus.addEventListener("ADJUST_CURRENTTIME_END",s,!1):s()},this.onCanplaythrough=function(){a.unlisten("canplaythrough",a.canplaythroughListener),m.log("CanplayThrough!!!!!!!!!"),a.needsMoreData=!1,i("CanplayThrough!!!!!!!!!")},this.checkCanplaythrough=function(){a.canplaythroughListener=a.onCanplaythrough.bind(a),a.listen("canplaythrough",a.canplaythroughListener)},this.isPaused=function(){return a.element.paused},this.getPlaybackRate=function(){return a.element.playbackRate},this.getCurrentTime=function(){return a.element.currentTime},this.setCurrentTime=function(e){a.element.currentTime=e},this.getDuration=function(){return a.element.duration},this.getCanPlayType=function(e){return a.element.canPlayType(e)},this.getReadyState=function(){return a.element.readyState},this.getBuffered=function(){return a.element.buffered},this.listen=function(e,t){a.element.addEventListener(e,t,!1)},this.unlisten=function(e,t){a.element.removeEventListener(e,t,!1)},this.getElement=function(){return a.element},this.setSource=function(e){a.element.src=e},this.setAutoPlay=function(e){if(a.autoPlay=e,a.autoPlay&&(a.selfPaused=!0),!a.autoPlay&&!a.playbackStarted){var t=function(){};t=function(){a.element.removeEventListener("play",t),a.playbackStarted||(a.playbackStarted=!0,a.eventBus.dispatchEvent({type:"playbackStarted",data:{}}))}.bind(a),a.element.addEventListener("play",t)}},this.setStartTime=function(e){a.startTime=e},this.getStartTime=function(){return a.startTime},this.setStartOffset=function(e){a.startOffset=e},this.getPlaybackState=function(){return a.playbackStarted},this.reset=function(){a.startTime=NaN,a.startOffset=0,a.selfPaused=!1,a.stalledStreams=[],a.playbackStarted=!1,a.sourceBuffers={video:void 0,audio:void 0},a.unlisten("canplaythrough",a.canplaythroughListener),a.canplaythroughListener=function(){},a.needsMoreData=!0},this.setSelfPaused=function(e){a.selfPaused=e},this.getSelfPaused=function(){return a.selfPaused},this.getNeedsMoreData=function(){return a.needsMoreData||a.element.readyState<4},this.setSourceBuffer=function(e,t){a.sourceBuffers[e]=t},this.setEpsilonFor=function(e,t){a.epsilonVal[e]=t},this.setSkipGapAtHOB=function(e){a.skipGapAtHOB=e},this.onAdjusting=function(){return a.adjusting},this.isDummy=function(){return!1},this.setCurrentStatus=function(e){a.autoPlay=e.autoPlay,a.selfPaused=e.selfPaused,a.startTime=e.startTime,a.startOffset=e.startOffset,a.stalledStreams=e.stalledStreams,a.epsilonVal=e.epsilonVal,a.adjusting=e.adjusting,a.playbackStarted=e.playbackStarted},this.element=n,this.eventBus=r},v=function(e){for(var t,i,n,r,a,s,o,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u=[],d=0;d<e.length;)t=l.indexOf(e.charAt(d++)),i=l.indexOf(e.charAt(d++)),n=l.indexOf(e.charAt(d++)),64!=(r=l.indexOf(e.charAt(d++)))?(a=t<<2|i>>4,s=(15&i)<<4|n>>2,o=(3&n)<<6|r,u.push(255&a),u.push(255&s),u.push(255&o)):64!=n?(a=t<<2|i>>4,s=(15&i)<<4|n>>2,u.push(255&a),u.push(255&s)):(a=t<<2|i>>4,u.push(255&a));return u},S=function(e){return new Uint8Array(v(e))},T=function(e){return function(e){for(var t="",i=null,n=0;n<e.length;)(i=e[n++])<128||(i=i<224?(31&i)<<6|63&e[n++]:i<240?(15&i)<<12|(63&e[n++])<<6|63&e[n++]:i<248?(7&i)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++]:i<252?(3&i)<<24|(63&e[n++])<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++]:(1&i)<<30|(63&e[n++])<<24|(63&e[n++])<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++]),t+=String.fromCharCode(i);return t}(v(e))},E=function(){this.manifest=null,this.BaseURL=[],this.targetLatency=NaN,this.targetLatencyMin=NaN,this.targetLatencyMax=NaN,this.referenceIdPRT=NaN,this.playbackRateMin=1,this.playbackRateMax=1,this.suggestedPresentationDelay=20,this.availabilityStartTime=new Date(0),this.publishTime=NaN,this.availabilityEndTime=new Date(0),this.timeShiftBufferDepth=Number.POSITIVE_INFINITY,this.maxSegmentDuration=Number.POSITIVE_INFINITY,this.checkTime=NaN,this.timestampOffsetFor32bitVE=0,this.liveEdge=NaN,this.liveEdgeS=NaN,this.liveEdgeE=NaN,this.liveEdgeC=NaN,this.periods=[]},b=function(){function e(){var e=this;this.getDataForIndex=function(t){return e.adaptationSets[t]},this.getDataForRole=function(t,i){for(var n=e.adaptationSets,r=0;r<n.length;r++)if(n[r].type==t&&n[r].getRole()==i)return n[r];return e.getPrimaryMediaData(t)},this.id=null,this.index=-1,this.duration=NaN,this.start=NaN,this.end=1/0,this.mpd=null,this.type=null,this.BaseURL=[],this.selectedBaseURLIdx=NaN,this.liveEdge=NaN,this.liveEdgeS=NaN,this.liveEdgeE=NaN,this.liveEdgeC=NaN,this.temporalLiveEdgeDecided={video:!1,audio:!1},this.isClientServerTimeSyncCompleted=!1,this.isClientServerTimeSyncCompletedForTC=!1,this.clientServerTimeShift=0,this.timestampOffsetFor32bitVE=0,this.assetId=null,this.offset=NaN,this.liveEdgeFromRequest=0,this.outEventList=[],this.inEventList=[],this.adaptationSets=[]}return e.prototype.getPrimaryMediaData=function(e){for(var t=this.adaptationSets,i=[],n=0;n<t.length;n++)if(t[n].type===e){if(t[n].getIsMain())return t[n];i.push(t[n])}return 0==i.length?null:i[0]},e.prototype.getRolesFor=function(e){for(var t=[],i=this.adaptationSets,n=0;n<i.length;n++)if(i[n].type===e){var r={index:n,id:i[n].id,role:i[n].getRole()};t.push(r)}return t},e.prototype.getDataForId=function(e){for(var t=this.adaptationSets,i=t.length,n=0;n<i;n++)if(o(t[n],"id")&&t[n].id===e)return t[n];return null},e}(),D=function(){this.id=null,this.index=-1,this.BaseURL=[],this.adaptation=null,this.segmentInfoType=null,this.initialization=null,this.segmentDuration=NaN,this.timescale=1,this.startNumber=1,this.indexRange=null,this.range=null,this.presentationTimeOffset=0,this.MSETimeOffset=NaN,this.segmentAvailabilityRange=null,this.availableSegmentsNumber=0,this.codecs=null,this.mimeType=null,this.segments=null,this.indexOffset=0,this.availabilityTimeOffset=0,this.lastRequestIndex=-1,this.transferCharacteristics=1,this.colourPrimaries=1,this.producerReferenceTime={id:null,inband:!1,type:null,wallClockTime:null,presentationTime:NaN}};function R(e,t,i,n){return n?i&&t.timeShiftBufferDepth!=Number.POSITIVE_INFINITY?new Date(t.availabilityStartTime.getTime()+1e3*(e+t.timeShiftBufferDepth)):t.availabilityEndTime:i?new Date(t.availabilityStartTime.getTime()+1e3*e):t.availabilityStartTime}var M={calcAvailabilityStartTimeFromPresentationTime:function(e,t,i){return R.call(this,e,t,i)},calcAvailabilityEndTimeFromPresentationTime:function(e,t,i){return R.call(this,e,t,i,!0)},calcPresentationTimeFromWallTime:function(e,t){return(e.getTime()-t.mpd.availabilityStartTime.getTime())/1e3},calcPresentationTimeFromMediaTime:function(e,t){return t.adaptation.period.offset-t.presentationTimeOffset+e},calcMediaTimeFromPresentationTime:function(e,t){return e-t.adaptation.period.offset},calcWallTimeForSegment:function(e,t){if(!t)return NaN;var i=e.representation.adaptation.period.mpd.suggestedPresentationDelay,n=e.presentationStartTime+i;return"number"==typeof e.availabilityStartTime?new Date(e.availabilityStartTime+1e3*n):new Date(e.availabilityStartTime.getTime()+1e3*n)},calcSegmentAvailabilityRange:function(e,t){var i=e.segmentDuration,n=e.adaptation.period,r=n.start,a=r+n.duration;if(!t)return{start:r,end:a};var s=n.mpd.periods,o=n.isClientServerTimeSyncCompletedForTC,l=n.clientServerTimeShift;if((!o||isNaN(i))&&e.segmentAvailabilityRange)return e.segmentAvailabilityRange;var u=this.calcPresentationTimeFromWallTime(new Date((new Date).getTime()+l),n),d=n.liveEdgeFromRequest>0?Math.max(u,n.liveEdgeFromRequest):u;return n.start===s[0].start&&(r=Math.max(d-n.mpd.timeShiftBufferDepth-i-n.mpd.timestampOffsetFor32bitVE,0)),n.start===s[s.length-1].start&&(a=Math.max(d-i+e.availabilityTimeOffset-n.mpd.timestampOffsetFor32bitVE,0)),{start:r,end:a,now:a}}},I=/^P(([\d.]*)Y)?(([\d.]*)M)?(([\d.]*)D)?T?(([\d.]*)H)?(([\d.]*)M)?(([\d.]*)S)?/,k=/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2})(?::([0-9]*)(\.[0-9]*)?)?(?:([+-])([0-9]{2})([0-9]{2}))?/,x=/^([0-9]+[.]?[0-9]*)\/?([0-9]*)/,L=function(){function e(){this.url=null,this.availabilityTimeOffset=null}return e.prototype.copy=function(){var t=new e;return t.url=this.url,t.availabilityTimeOffset=this.availabilityTimeOffset,t},e}(),_=function(){function e(){this.period=null,this.id=null,this.index=-1,this.representations=null,this.contentProtections=null,this.hasMpdPssh=!1,this.BaseURL=[],this.Role=null,this.lang=null,this.transferCharacteristics=1,this.colourPrimaries=1,this.availabilityTimeOffset=0,this.hasMpdData=!1}return e.prototype.getCodec=function(){var e=this.representations[this.representations.length-1];return e.mimeType+';codecs="'+e.codecs+'"'},e.prototype.getFrameRate=function(){return this.representations[0].frameRate},e.prototype.getAudioSamplingRate=function(){return this.representations[0].audioSamplingRate},e.prototype.getMimeType=function(){return this.representations[0].mimeType},e.prototype.getIsMain=function(){return"main"===this.Role},e.prototype.getRole=function(){return this.Role?this.Role:"none"},e.prototype.getContentProtectionData=function(){return null!=this.contentProtections&&0!==this.contentProtections.length?this.contentProtections:null},e.prototype.getRepresentations=function(){return this.representations},e}(),A=function(){function e(e,t,i){var n=this;this.errHandler=f,this.logHandler=m,this.timelineConverter=M,this.parseBaseUrl=function(e){var t=null;return null!=e&&-1!==e.indexOf("/")&&(-1!==e.indexOf("?")&&(e=e.substring(0,e.indexOf("?"))),t=e.substring(0,e.lastIndexOf("/")+1)),t},this.parseDuration=function(e){var t=I.exec(e);return t?31536e3*parseFloat(t[2]||"0")+2592e3*parseFloat(t[4]||"0")+86400*parseFloat(t[6]||"0")+3600*parseFloat(t[8]||"0")+60*parseFloat(t[10]||"0")+parseFloat(t[12]||"0"):null},this.parseDateTime=function(e){var t=k.exec(e);if(!t)return null;var i=Date.UTC(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10),parseInt(t[4],10),parseInt(t[5],10),t[6]&&parseInt(t[6],10)||0,t[7]&&1e3*parseFloat(t[7])||0);if(t[9]&&t[10]){var n=60*parseInt(t[9],10)+parseInt(t[10],10);i+=("+"===t[8]?-1:1)*n*60*1e3}return new Date(i)},this.parseFrameRate=function(e){var t=x.exec(e);return t?parseFloat(t[1])/(parseFloat(t[2])||1):null},this.parseString=function(e){return e},this.float3=function(e){return Math.round(1e3*e)/1e3},this.abortWrapper=function(e,t){return new Promise((function(i,n){setTimeout((function(){t.aborted=!0,n(new Error("abort"))}),3e3),e.then(i,n)}))},this.parseSegmentTimeline=function(e){for(var t={},i=[],n=0;n<e.length;n++){var r=e[n].getAttribute("t")?parseInt(e[n].getAttribute("t")):null,a=e[n].getAttribute("d")?parseInt(e[n].getAttribute("d")):null,s=e[n].getAttribute("r")?parseInt(e[n].getAttribute("r")):null;i.push({t:r,d:a,r:s})}return t.S=i,t},this.parseSegmentTemplate=function(e,t,i){var r={timescale:parseFloat,duration:parseFloat,startNumber:parseInt,media:n.parseString,initialization:n.parseString,presentationTimeOffset:parseInt,availabilityTimeOffset:parseFloat},a={};for(var s in r)t.getAttribute(s)?a[s]=r[s](t.getAttribute(s)):i&&o(e,"SegmentTemplate")&&o(e.SegmentTemplate,s)&&(a[s]=e.SegmentTemplate[s]);var l=t.getElementsByTagName("SegmentTimeline")[0];return l&&(a.SegmentTimeline=n.parseSegmentTimeline(l.getElementsByTagName("S"))),i&&o(e,"SegmentTemplate")&&o(e.SegmentTemplate,"SegmentTimeline")&&(a.SegmentTimeline=e.SegmentTemplate.SegmentTimeline),a},this.parseSegmentList=function(e,t){var i={timescale:parseFloat,duration:parseFloat,startNumber:parseInt,presentationTimeOffset:parseInt},r={};for(var a in i)t.getAttribute(a)?r[a]=i[a](t.getAttribute(a)):o(e,a)&&(r[a]=e[a]);var s=t.getElementsByTagName("Initialization")[0];s&&s.getAttribute("sourceURL")&&(r.Initialization={},r.Initialization.sourceURL=s.getAttribute("sourceURL"),n.NXDebug.info(r.Initialization.sourceURL));for(var l=t.getElementsByTagName("SegmentURL"),u=[],d=0;d<l.length;d++){var f=l[d].getAttribute("media")?l[d].getAttribute("media"):null,c=l[d].getAttribute("mediaRange")?l[d].getAttribute("mediaRange"):null,m=l[d].getAttribute("index")?parseInt(l[d].getAttribute("index")):null,g=l[d].getAttribute("indexRange")?parseInt(l[d].getAttribute("indexRange")):null;u.push({media:f,mediaRange:c,index:m,indexRange:g})}r.SegmentURLs=u;var p=t.getElementsByTagName("SegmentTimeline")[0];return p&&(r.SegmentTimeline=n.parseSegmentTimeline(p.getElementsByTagName("S"))),r},this.parseContentProtection=function(e){var t,i,r,a={schemeIdUri:n.parseString,value:n.parseString,"cenc:default_KID":n.parseString},s={};for(var o in a)e.getAttribute(o)&&(s[o]=a[o](e.getAttribute(o)));i=e.childNodes;for(var l=0;l<i.length;l++)"cenc:pssh"==i[l].nodeName||"CENC:PSSH"==i[l].nodeName?(r=i[l].textContent.replace(/\s+/g,""),s.pssh=S(r)):"mspr:pro"==i[l].nodeName||"MSPR:PRO"==i[l].nodeName?(t=i[l].textContent.replace(/\s+/g,""),s.pro=t):"pro"!=i[l].nodeName&&"PRO"!=i[l].nodeName||(t=i[l].textContent.replace(/\s+/g,""),s.pro=t);return s},this.parseRepresentation=function(e,t,i,r){var a,s={id:n.parseString,bandwidth:parseFloat,height:parseInt,width:parseInt,availabilityTimeOffset:parseFloat},l=new D;for(a in l.adaptation=t,i)e.hasAttribute(a)&&e.getAttribute(a)?l[a]=i[a](e.getAttribute(a)):o(t.attrs,a)&&(l[a]=t.attrs[a]);for(a in s)e.hasAttribute(a)&&e.getAttribute(a)&&(l[a]=s[a](e.getAttribute(a)));o(t,"type")||(t.mimeType=l.mimeType,-1!==t.mimeType.indexOf("video")?t.type="video":-1!==t.mimeType.indexOf("audio")||-1!==t.mimeType.indexOf("text")?t.type="audio":-1!==t.mimeType.indexOf("vtt")||-1!==t.mimeType.indexOf("ttml")?t.type="text":t.type="???");for(var u,d=e.childNodes,f=!0,c=0;c<d.length;c++)if("BaseURL"==d[c].nodeName){var m=d[c].textContent,g=new L;if(0===m.indexOf("http://")||0===m.indexOf("https://"))g.url=m,(a=d[c].getAttribute("availabilityTimeOffset"))&&(g.availabilityTimeOffset=parseFloat(a)),l.BaseURL.push(g);else for(var p=0;p<t.BaseURL.length;p++)(g=t.BaseURL[p].copy()).url=g.url+m,(a=d[c].getAttribute("availabilityTimeOffset"))&&(g.availabilityTimeOffset=parseFloat(a)),l.BaseURL.push(g)}else if("SegmentBase"==d[c].nodeName)l.segmentInfoType="SegmentBase",(u={}).indexRange=d[c].getAttribute("indexRange"),d[c].getAttribute("presentationTimeOffset")&&(u.presentationTimeOffset=parseInt(d[c].getAttribute("presentationTimeOffset"))),d[c].getElementsByTagName("Initialization").length>0&&((y={}).range=d[c].getElementsByTagName("Initialization")[0].getAttribute("range"),u.Initialization=y),f=!1;else if("SegmentTemplate"==d[c].nodeName)u=n.parseSegmentTemplate(t,d[c],!0),l.SegmentTemplate=u,o(u,"SegmentTimeline")?l.segmentInfoType="SegmentTimeline":l.segmentInfoType="SegmentTemplate",o(u,"initialization")&&(l.initialization=u.initialization.split("$Bandwidth$").join(String(l.bandwidth)).split("$RepresentationID$").join(l.id)),f=!1;else if("SegmentList"==d[c].nodeName)l.segmentInfoType="SegmentList",u=n.parseSegmentList(t,d[c]),l.SegmentList=u,o(u,"startNumber")&&(l.startNumber=u.startNumber),f=!1,o(u,"SegmentTimeline")?l.segmentInfoType="SegmentTimeline":l.segmentInfoType="SegmentList";else if("ContentProtection"==d[c].nodeName){var h=n.parseContentProtection(d[c]);t.contentProtections.push(h),h.pssh&&(t.hasMpdData=!0)}else"EssentialProperty"==d[c].nodeName?("urn:mpeg:mpegB:cicp:ColourPrimaries"==d[c].getAttribute("schemeIdUri")&&(l.colourPrimaries=parseInt(d[c].getAttribute("value"))),"urn:mpeg:mpegB:cicp:TransferCharacteristics"==d[c].getAttribute("schemeIdUri")&&(l.transferCharacteristics=parseInt(d[c].getAttribute("value")))):"ProducerReferenceTime"==d[c].nodeName&&(d[c].getAttribute("id")&&(l.producerReferenceTime.id=d[c].getAttribute("id")),d[c].getAttribute("inband")&&(l.producerReferenceTime.inband=Boolean(d[c].getAttribute("inband"))),d[c].getAttribute("type")&&(l.producerReferenceTime.type=d[c].getAttribute("type")),d[c].getAttribute("wallClockTime")&&(l.producerReferenceTime.wallClockTime=new Date(n.parseDateTime(d[c].getAttribute("wallClockTime")).getTime())),d[c].getAttribute("presentationTime")&&(l.producerReferenceTime.presentationTime=parseFloat(d[c].getAttribute("presentationTime"))));if(n.supported_colour_primaries.indexOf(l.colourPrimaries)<0||n.supported_transfer_characteristics.indexOf(l.transferCharacteristics)<0)return null;for(0===l.BaseURL.length&&t.BaseURL.forEach((function(e){l.BaseURL.push(e.copy())})),c=0;c<l.BaseURL.length;c++)l.BaseURL[c].url=l.BaseURL[c].url.split("$Bandwidth$").join(String(l.bandwidth)).split("$RepresentationID$").join(l.id);if(f&&(o(t,"SegmentTemplate")?(u=t.SegmentTemplate,l.SegmentTemplate=u,o(u,"SegmentTimeline")?l.segmentInfoType="SegmentTimeline":l.segmentInfoType="SegmentTemplate",o(u,"initialization")&&(l.initialization=u.initialization.split("$Bandwidth$").join(String(l.bandwidth)).split("$RepresentationID$").join(l.id))):(n.NXDebug.debug("can not decide Segment Type"),u=isNaN(t.period.selectedBaseURLIdx)?l.BaseURL[0]:l.BaseURL[t.period.selectedBaseURLIdx],l.segmentInfoType="BaseURL")),o(u,"Initialization")){var y=u.Initialization;o(y,"sourceURL")?l.initialization=y.sourceURL:o(y,"range")&&(isNaN(t.period.selectedBaseURLIdx)?l.initialization=l.BaseURL[0].url:l.initialization=l.BaseURL[t.period.selectedBaseURLIdx].url,l.range=y.range)}else!o(l,"mimeType")||"text/vtt"!==l.mimeType&&"application/ttml+xml"!==l.mimeType||(isNaN(t.period.selectedBaseURLIdx)?l.initialization=l.BaseURL[0].url:l.initialization=l.BaseURL[t.period.selectedBaseURLIdx].url,l.range="0");if(o(u,"timescale")&&(l.timescale=u.timescale),o(u,"duration")&&(l.segmentDuration=u.duration/l.timescale),o(u,"startNumber")&&(l.startNumber=u.startNumber),o(u,"indexRange")&&(l.indexRange=u.indexRange),o(u,"presentationTimeOffset")?l.presentationTimeOffset=u.presentationTimeOffset/l.timescale:l.presentationTimeOffset=r,o(u,"availabilityTimeOffset")?l.availabilityTimeOffset=u.availabilityTimeOffset:l.BaseURL[t.period.selectedBaseURLIdx].availabilityTimeOffset?l.availabilityTimeOffset=l.BaseURL[t.period.selectedBaseURLIdx].availabilityTimeOffset:l.adaptation.availabilityTimeOffset&&(l.availabilityTimeOffset=l.adaptation.availabilityTimeOffset),"dynamic"===l.adaptation.period.mpd.type&&0!=l.presentationTimeOffset)l.timestampOffsetFor32bitVE=r;else if("SegmentTemplate"===l.segmentInfoType)l.timestampOffsetFor32bitVE=r;else if("SegmentTimeline"===l.segmentInfoType){var v=null!=l.SegmentTemplate?l.SegmentTemplate.SegmentTimeline.S:l.SegmentList.SegmentTimeline.S;"dynamic"===l.adaptation.period.mpd.type&&n.SET_1STSEG_TIME_ZERO||"static"===l.adaptation.period.mpd.type?l.timestampOffsetFor32bitVE=v[0].t/l.timescale:l.timestampOffsetFor32bitVE=0,0!=l.presentationTimeOffset&&(l.timestampOffsetFor32bitVE=r)}else l.timestampOffsetFor32bitVE=r;return l},this.parseEventStream=function(e,t){var i,n,r=1,a=function(e,t){for(var i=0;i<e.length;i++)if(null!=e[i].id&&e[i].id==t)return!0;return!1};if(!e.getAttribute("schemeIdUri"))throw"Invalid EventStream. SchemeIdUri has to be set";i=e.getAttribute("schemeIdUri"),e.getAttribute("timescale")&&(r=parseInt(e.getAttribute("timescale"))),e.getAttribute("value")&&(n=e.getAttribute("value"));for(var s=e.childNodes,l=0;l<s.length;l++)if("Event"==s[l].nodeName){var u={};u.schemeIdUri=i,u.timescale=r,u.value=n,u.presentationTime=0,u.duration=NaN,u.messageData=null,s[l].getAttribute("presentationTime")&&(u.presentationTime=parseFloat(s[l].getAttribute("presentationTime"))/r),s[l].getAttribute("duration")&&(u.duration=parseFloat(s[l].getAttribute("duration"))/r),s[l].getAttribute("id")&&(u.id=s[l].getAttribute("id")),u.messageData=s[l].childNodes,o(t,i)?0==a(t[i],u.id)&&t[i].push(u):(t[i]=[],t[i].push(u))}},this.MpdParser=function(e,t,i,r,a){var s,o,l=new DOMParser,u=a||function(){},d=l.parseFromString(e,"text/xml"),f=new E,c=d.getElementsByTagName("MPD")[0],m={"xmlns:xsi":n.parseString,xmlns:n.parseString,"xsi:schemaLocation":n.parseString,type:n.parseString,minBufferTime:n.parseDuration,profiles:n.parseString,minimumUpdatePeriod:n.parseDuration};for(s in m)c.getAttribute(s)&&(f[s]=m[s](c.getAttribute(s)),n.NXDebug.log("mpd: "+s+":"+f[s]));if(s=c.getAttribute("availabilityStartTime"),f.availabilityStartTime=s?new Date(n.parseDateTime(s).getTime()):new Date(t.mpdLoadedTime.getTime()),(s=c.getAttribute("publishTime"))&&(f.publishTime=new Date(n.parseDateTime(s).getTime()),n.NXDebug.info("publishTime:::"+f.publishTime)),(s=c.getAttribute("availabilityEndTime"))&&(f.availabilityEndTime=new Date(n.parseDateTime(s).getTime())),(s=c.getAttribute("suggestedPresentationDelay"))&&(f.suggestedPresentationDelay=n.parseDuration(s)),(s=c.getAttribute("timeShiftBufferDepth"))&&(f.timeShiftBufferDepth=n.parseDuration(s)),(s=c.getAttribute("maxSegmentDuration"))&&(f.maxSegmentDuration=n.parseDuration(s)),(s=c.getAttribute("mediaPresentationDuration"))&&(f.mediaPresentationDuration=n.parseDuration(s)),f.checkTime=NaN,f.BaseURL=[],c.getElementsByTagName("Location").length>0){var g=c.getElementsByTagName("Location")[0];t.Location=g.textContent}for(var p=c.childNodes,h=0;h<p.length;h++)if("BaseURL"===p[h].nodeName){var y=p[h].textContent,v=0===y.indexOf("http://")||0===y.indexOf("https://")?y:i+y;(o=new L).url=v,(s=p[h].getAttribute("availabilityTimeOffset"))&&(o.availabilityTimeOffset=parseFloat(s)),f.BaseURL.push(o)}0===f.BaseURL.length&&((o=new L).url=i,o.availabilityTimeOffset=0,f.BaseURL.push(o));var S,T,b=c.getElementsByTagName("ServiceDescription");if(b)for(h=0;h<b.length;h++)b[h].getElementsByTagName("Latency").length>0&&(S=b[h].getElementsByTagName("Latency")[0],f.targetLatency=S.getAttribute("target")||NaN,f.targetLatencyMin=S.getAttribute("min")||NaN,f.targetLatencyMax=S.getAttribute("max")||NaN,f.referenceIdPRT=S.getAttribute("referenceId")||NaN),b[h].getElementsByTagName("PlaybackRate").length>0&&(T=b[h].getElementsByTagName("PlaybackRate")[0],f.playbackRateMin=T.getAttribute("min")||NaN,f.playbackRateMax=T.getAttribute("max")||NaN);isNaN(n.DEFAULT_PRESENTATION_DELAY)?isNaN(f.targetLatency)||(f.suggestedPresentationDelay=f.targetLatency/1e3):f.suggestedPresentationDelay=n.DEFAULT_PRESENTATION_DELAY,"dynamic"==f.type&&f.suggestedPresentationDelay<f.minBufferTime&&(f.minBufferTime=f.suggestedPresentationDelay),f.manifest=t,n.parsePeriod(f,c.getElementsByTagName("Period"),(function(e){f.periods=e.data;for(var t={profiles:n.parseString,width:parseInt,height:parseInt,sar:n.parseString,frameRate:n.parseFrameRate,audioSamplingRate:parseFloat,mimeType:n.parseString,lang:n.parseString,segmentProfiles:n.parseString,codecs:n.parseString,maximumSAPPeriod:parseFloat,startsWithSap:parseInt,maxPlayoutRate:parseFloat,codingDependency:n.parseString,scanType:n.parseString,FramePacking:n.parseString,AudioChannelConfiguration:n.parseString,availabilityTimeOffset:parseFloat},i=0;i<f.periods.length;i++){f.periods[i].adaptationSets=[];for(var a=f.periods[i].childNodes,o=!1,l=!1,d=function(e){var u=a[e],d=new _;for(var c in d.period=f.periods[i],d.index=e,d.attrs={},d.id=u.getAttribute("id")?u.getAttribute("id"):d.index,d.lang=u.getAttribute("lang")?u.getAttribute("lang"):null,d.childNodes=u.childNodes,t)u.getAttribute(c)&&(d.attrs[c]=t[c](u.getAttribute(c)));d.representations=[],d.contentProtections=[];for(var m=0;m<d.childNodes.length;m++)if("BaseURL"==d.childNodes[m].nodeName){var g=d.childNodes[m].textContent,p={};if(0===g.indexOf("http://")||0===g.indexOf("https://"))p.url=g,(s=d.childNodes[m].getAttribute("availabilityTimeOffset"))==typeof String&&(p.availabilityTimeOffset=parseFloat(s)),d.BaseURL.push(p);else for(var h=0;h<f.periods[i].BaseURL.length;h++)(p=f.periods[i].BaseURL[h].copy()).url=p.url+g,(s=d.childNodes[m].getAttribute("availabilityTimeOffset"))==typeof String&&(p.availabilityTimeOffset=parseFloat(s)),d.BaseURL.push(p)}for(0===d.BaseURL.length&&f.periods[i].BaseURL.forEach((function(e){d.BaseURL.push(e.copy())})),m=0;m<d.childNodes.length;m++)if("Representation"==d.childNodes[m].nodeName){var y=n.parseRepresentation(d.childNodes[m],d,t,r);null!=y&&d.representations.push(y)}else if("ContentProtection"==d.childNodes[m].nodeName){var v=d.childNodes[m];v=n.parseContentProtection(v),d.contentProtections.push(v),v.pssh&&(d.hasMpdPssh=!0)}else"SegmentTemplate"==d.childNodes[m].nodeName?d.SegmentTemplate=n.parseSegmentTemplate(d,d.childNodes[m],!1):"Role"==d.childNodes[m].nodeName?d.Role=d.childNodes[m].getAttribute("value"):"EssentialProperty"==d.childNodes[m].nodeName&&("urn:mpeg:mpegB:cicp:ColourPrimaries"==d.childNodes[m].getAttribute("schemeIdUri")&&(d.colourPrimaries=parseInt(d.childNodes[m].getAttribute("value"))),"urn:mpeg:mpegB:cicp:TransferCharacteristics"==d.childNodes[m].getAttribute("schemeIdUri")&&(d.transferCharacteristics=parseInt(d.childNodes[m].getAttribute("value"))));return"video"==d.type&&(n.supported_colour_primaries.indexOf(d.colourPrimaries)<0||n.supported_transfer_characteristics.indexOf(d.transferCharacteristics)<0)?(n.logHandler.log("ColourPrimaries="+d.colourPrimaries+" and/or TransferCharacteristics="+d.transferCharacteristics+"are not supported"),"continue"):"audio"==d.type&&1==n.unuseAudio?"continue":0===d.representations.length?(n.logHandler.log("!!!!!!!!!!no representations found!!!!!"),n.NXDebug.log("no representations found!!!"),"continue"):(n.setIndexForRepresentation.call(n,d),f.periods[i].adaptationSets.push(d),"video"===d.type&&(l=!0),"audio"===d.type&&(o=!0),void(d=null))},c=0;c<a.length;c++)d(c);l&&o?f.periods[i].type="video/audio":l?f.periods[i].type="video":o&&(f.periods[i].type="audio")}f.timestampOffsetFor32bitVE=n.setTimestampOffsetFor32bitVE(f.periods),n.NXDebug.log(String(f.timestampOffsetFor32bitVE)),u({data:f})}))},this.setTimestampOffsetFor32bitVE=function(e){var t,i,r,a=e[0];if(-1==n.timestampOffsetFor32bitVE){for(var s=a.adaptationSets,o=0x10000000000000000,l=0;l<s.length;l++){var u=s[l].representations;for(t=0;t<u.length;t++)o>u[t].timestampOffsetFor32bitVE&&(o=u[t].timestampOffsetFor32bitVE)}n.timestampOffsetFor32bitVE=o+a.start}if(0!=n.timestampOffsetFor32bitVE)for(l=0;l<e.length;l++)for(i in e[l].start=n.float3(e[l].start-n.timestampOffsetFor32bitVE),e[l].offset=n.float3(e[l].offset-n.timestampOffsetFor32bitVE),e[l].end=n.float3(e[l].end-n.timestampOffsetFor32bitVE),e[l].outEventList)for(t=0;t<e[l].outEventList[i].length;t++)(r=e[l].outEventList[i][t]).presentationTime+=e[l].start;for(l=0;l<e.length;l++)for(i in e[l].outEventList){var d=e[l].outEventList[i],f=d.length;for(t=0;t<f;)r=d[t],n.eventBus.dispatchEvent({type:"DASHEVENT_RECEIVED",data:{type:"outband",event:r,eventList:d,index:l}}),d.length<f?f=d.length:t++}return n.timestampOffsetFor32bitVE},this.processAdaptation=function(e){return void 0!==e.representations&&null!==e.representations&&e.representations.sort((function(e,t){return e.bandwidth-t.bandwidth})),e},this.setIndexForRepresentation=function(e){var t=n.processAdaptation(e),i=n.minBandwidth[t.type],r=n.maxBandwidth[t.type],a=-1,s=-1;if(!isNaN(i)){for(var o=0;o<t.representations.length;o++)if(i<=t.representations[o].bandwidth){a=o;break}-1==a&&(a=t.representations.length-1),a>0&&t.representations.splice(0,a)}if(!isNaN(r)){for(o=t.representations.length-1;o>=0;o--)if(t.representations[o].bandwidth<r){s=o;break}-1==s&&(s=0),s<t.representations.length-1&&t.representations.splice(s+1)}for(o=0;o<t.representations.length;o++)t.representations[o].index=o},this.getRefreshDelay=function(e){var t=2;return o(e.mpd,"minimumUpdatePeriod")&&(t=e.mpd.minimumUpdatePeriod||2),t},this.internalParse=function(e,t,i){var r=null,a=i||function(){};try{(r={}).mpdLoadedTime=new Date,n.getServerTime.call(n,(function(i){n.MpdParser.call(n,e,r,t,0,(function(e){r.mpd=e.data,n.NXDebug.log("MPD"),n.NXDebug.log("Parsing complete: "),a(r)}))}))}catch(t){n.errHandler.manifestError(n.eventBus,"parsing the manifest failed","parse",e),r=null,a(null)}},this.setManifestData=function(e,t){var i=n.parseBaseUrl(e),r=n,a=null;n.manifestText=t,n.internalParse.call(r,t,i,(function(t){null!=t?((a=t).mpdUrl=e,r.setValue(a)):r.setValue(null)}))},this.getRemotePeriodsX=function(e,t,i){var r=new XMLHttpRequest,a=!0,s=n,o=!1,l=n.xlinkCommonQrys.concat(),u=n.xlinkCommonHdrs.concat(),d=null,f=setTimeout((function(){n.logHandler.log("RemotePeriod request aborted!!!"),n.NXDebug.debug("RemotePeriod request aborted!!!"),o=!0,r.abort()}),1e3),c=function(){o&&n.logHandler.log("remoteperiods request is aborted."+a),null!=f&&clearTimeout(f),a&&(n.xlinkOnError({status:r.status,req:r,xhr:r}),a=!1,i>0?(n.NXDebug.log("Failed loading remoteperiods: "+e+", retry in "+n.RETRY_INTERVAL+"ms attempts: "+i),i--,setTimeout((function(){n.getRemotePeriods.call(s,e,t,i)}),n.RETRY_INTERVAL)):(n.NXDebug.log("Failed loading remoteperiods: "+e+" no retry attempts left"),n.errHandler.downloadError(n.eventBus,"manifest",e,r),n.eventBus.dispatchEvent({type:"LOAD_RPERIODS_END",data:{success:!1,pid:t,result:null}})))};r.url=e,n.xlinkOnPrepare({req:r,qrys:l,hdrs:u,xhr:r}),l.length>0&&l.forEach((function(e){r.url+=r.url.indexOf("?")>0?"&":"?",r.url+=e.name+"="+e.value}));try{r.onload=function(){if(!(r.status<200||r.status>299))if(0!==r.responseText.length){n.xlinkOnSuccess({status:r.status,req:r,xhr:r}),a=!1,d="<root>"+(d=r.responseText)+"</root>";try{var e=(new DOMParser).parseFromString(d,"text/xml").getElementsByTagName("Period");return n.NXDebug.info(String(e)),void n.eventBus.dispatchEvent({type:"LOAD_RPERIODS_END",data:{success:!0,pid:t,result:e}})}catch(e){return void n.eventBus.dispatchEvent({type:"LOAD_RPERIODS_END",data:{success:!1,pid:t,result:null}})}}else n.logHandler.log("!!! Load mpd size : "+r.responseText.length+" !!!! remainingAttempts:"+i)},r.onloadend=c,r.onerror=c,r.open("GET",r.url,!0),u.length>0&&u.forEach((function(e){r.setRequestHeader(e.name,e.value)})),r.send()}catch(e){r.onerror(e)}},this.getRemotePeriodsF=function(e,t,i){var r={},a={method:"GET",headers:{},credentials:"same-origin"},s=n,o={aborted:!1},l=n.xlinkCommonQrys.concat(),u=n.xlinkCommonHdrs.concat(),d=null;r.url=e,n.xlinkOnPrepare({req:r,qrys:l,hdrs:u,xhr:r}),l.length>0&&l.forEach((function(e){r.url+=r.url.indexOf("?")>0?"&":"?",r.url+=e.name+"="+e.value})),u.length>0&&u.forEach((function(e){a.headers[e.name]=e.value})),n.abortWrapper(fetch(r.url,a),o).then((function(e){return r.status=e.status,1==e.ok?e.text():Promise.reject(new Error("res.false"))})).then((function(e){if(0==e.length)return n.logHandler.log("!!! Load mpd size : "+e.length+" !!!! remainingAttempts:"+i),Promise.reject(new Error("size0"));n.xlinkOnSuccess({status:r.status,req:r,xhr:r}),d="<root>"+(d=e)+"</root>";try{var a=(new DOMParser).parseFromString(d,"text/xml").getElementsByTagName("Period");return n.NXDebug.info(String(a)),void n.eventBus.dispatchEvent({type:"LOAD_RPERIODS_END",data:{success:!0,pid:t,result:a}})}catch(e){return void n.eventBus.dispatchEvent({type:"LOAD_RPERIODS_END",data:{success:!1,pid:t,result:null}})}})).catch((function(a){o.aborted&&(n.logHandler.log("remoteperiods request is aborted."),r.status=-1),n.xlinkOnError({status:r.status,req:r,xhr:r}),i>0?(n.NXDebug.log("Failed loading remoteperiods: "+e+", retry in "+n.RETRY_INTERVAL+"ms attempts: "+i),i--,setTimeout((function(){n.getRemotePeriods.call(s,e,t,i)}),n.RETRY_INTERVAL)):(n.NXDebug.log("Failed loading remoteperiods: "+e+" no retry attempts left"),n.errHandler.downloadError(n.eventBus,"manifest",e,r),n.eventBus.dispatchEvent({type:"LOAD_RPERIODS_END",data:{success:!1,pid:t,result:null}}))}))},this.getRemotePeriods=function(e,t,i){return n.useFetch?n.getRemotePeriodsF(e,t,i):n.getRemotePeriodsX(e,t,i)},this.getServerTimeX=function(e){var t=e||function(){};if(isNaN(n.clientServerTimeShift)){var i=new XMLHttpRequest,r=!1,a=(new Date).getTime(),s=window.location.href;s=s.indexOf("?")>-1?s+"&_t="+a:s+"?_t="+a,i.open("HEAD",s,!0),i.onload=function(){r=!0;var e=i.getResponseHeader("Date"),s=(new Date).getTime()-a,o=0;null!=e&&(o=1e3*Math.ceil((new Date(e).getTime()+s/2-(new Date).getTime())/1e3))>Math.abs(2)?n.clientServerTimeShift=o:n.clientServerTimeShift=0,t(!0)},i.onloadend=i.onerror=function(){r||(n.clientServerTimeShift=0,t(!0))},i.send()}else t(!0)},this.getServerTimeF=function(e){var t=e||function(){};if(isNaN(n.clientServerTimeShift)){var i=(new Date).getTime(),r=window.location.href;r=r.indexOf("?")>-1?r+"&_t="+i:r+"?_t="+i,fetch(r,{method:"HEAD",credentials:"same-origin"}).then((function(e){var r=e.headers.get("Date"),a=(new Date).getTime()-i,s=0;null!=r&&(s=1e3*Math.ceil((new Date(r).getTime()+a/2-(new Date).getTime())/1e3))>Math.abs(2)?n.clientServerTimeShift=s:n.clientServerTimeShift=0,t(!0)})).catch((function(e){n.clientServerTimeShift=0,t(!0)}))}else t(!0)},this.getServerTime=function(e){return n.useFetch?n.getServerTimeF(e):n.getServerTimeX(e)},this.doLoadX=function(e,t){var i=n.parseBaseUrl(e),r=new XMLHttpRequest,a=!0,s=n,o=null,l=!1,u=!1,d=n.mpdCommonQrys.concat(),f=n.mpdCommonHdrs.concat(),c=setTimeout((function(){n.logHandler.log("MPD request aborted!!!"),n.NXDebug.debug("MPD request aborted!!!"),l=!0,r.abort()}),1e3),m=function(){l&&n.logHandler.log("manifest request is aborted."+a),null!=c&&clearTimeout(c),a&&(n.mpdOnError({status:r.status,req:r,xhr:r}),a=!1,t>0?(n.NXDebug.log("Failed loading manifest: "+e+", retry in "+n.RETRY_INTERVAL+"ms attempts: "+t),t--,setTimeout((function(){n.doLoad.call(s,e,t)}),n.RETRY_INTERVAL)):(n.NXDebug.log("Failed loading manifest: "+e+" no retry attempts left"),n.errHandler.downloadError(n.eventBus,"manifest",e,r),n.eventBus.dispatchEvent({type:"LOAD_MANIFEST_END",data:{success:!1,result:null}})))};r.url=e,n.mpdOnPrepare({req:r,qrys:d,hdrs:f,xhr:r}),d.length>0&&d.forEach((function(e){r.url+=r.url.indexOf("?")>0?"&":"?",r.url+=e.name+"="+e.value}));try{r.onload=function(){n.lastMpdLoadedTime=(new Date).getTime(),r.status<200||r.status>299||(0!==r.responseText.length?n.manifestText!=r.responseText&&(n.mpdOnSuccess({status:r.status,req:r,xhr:r}),a=!1,n.manifestText=r.responseText,n.internalParse.call(s,r.responseText,i,(function(t){if(null!=t)return(o=t).mpdUrl=e,u=!0,void n.eventBus.dispatchEvent({type:"LOAD_MANIFEST_END",data:{success:u,result:o}});u=!1}))):n.logHandler.log("!!! Load mpd size : "+r.responseText.length+" !!!! remainingAttempts:"+t))},r.onloadend=m,r.onerror=m,r.open("GET",r.url,!0),f.length>0&&f.forEach((function(e){r.setRequestHeader(e.name,e.value)})),r.send()}catch(e){r.onerror(e)}},this.doLoadF=function(e,t){var i=n.parseBaseUrl(e),r={},a={aborted:!1},s={method:"GET",headers:{},credentials:"same-origin"},o=n,l=null,u=!1,d=n.mpdCommonQrys.concat(),f=n.mpdCommonHdrs.concat();r.url=e,n.mpdOnPrepare({req:r,qrys:d,hdrs:f,xhr:r}),d.length>0&&d.forEach((function(e){r.url+=r.url.indexOf("?")>0?"&":"?",r.url+=e.name+"="+e.value})),f.length>0&&f.forEach((function(e){s.headers[e.name]=e.value})),n.abortWrapper(fetch(r.url,s),a).then((function(e){return n.lastMpdLoadedTime=(new Date).getTime(),r.status=e.status,1==e.ok?e.text():Promise.reject(new Error("res.false"))})).then((function(a){if(0==a.length)return n.logHandler.log("!!! Load mpd size : "+a.length+" !!!! remainingAttempts:"+t),Promise.reject(new Error("size0"));if(n.manifestText==a)return Promise.reject(new Error("same"));n.mpdOnSuccess({status:r.status,req:r,xhr:r});var s=a.charCodeAt(0),d=a.charCodeAt(1),f=a.charCodeAt(2);n.manifestText=239==s&&187==d&&191==f?a.substring(3):a,n.internalParse.call(o,n.manifestText,i,(function(t){null!=t?((l=t).mpdUrl=e,u=!0,n.eventBus.dispatchEvent({type:"LOAD_MANIFEST_END",data:{success:u,result:l}})):u=!1}))})).catch((function(i){a.aborted&&(n.logHandler.log("manifest request is aborted."),r.status=-1),n.mpdOnError({status:r.status,req:r,xhr:r}),t>0?(n.NXDebug.log("Failed loading manifest: "+e+", retry in "+n.RETRY_INTERVAL+"ms attempts: "+t),t--,setTimeout((function(){n.doLoad.call(o,e,t)}),n.RETRY_INTERVAL)):(n.NXDebug.log("Failed loading manifest: "+e+" no retry attempts left"),n.errHandler.downloadError(n.eventBus,"manifest",e,r),n.eventBus.dispatchEvent({type:"LOAD_MANIFEST_END",data:{success:!1,result:null}}))}))},this.doLoad=function(e,t){return n.useFetch?n.doLoadF(e,t):n.doLoadX(e,t)},this.manifestUpdateClear=function(){null!==n.manifestRefreshTimer&&(n.NXDebug.log("Refresh manifest in ... clearTimeout id : "+n.manifestRefreshTimer),n.manifestUpdating=!1,clearTimeout(n.manifestRefreshTimer),n.manifestRefreshTimer=null)},this.setManifestUpdateStart=function(){n.manifestUpdateClear.call(n),isNaN(n.manifestRefreshDelay)||(n.NXDebug.log("Refresh manifest in "+n.manifestRefreshDelay+" seconds."),n.manifestRefreshTimer=setTimeout(n.onManifestRefreshTimer.bind(n),Math.min(1e3*n.manifestRefreshDelay,Math.pow(2,31)-1),n))},this.manifestUpdateRun=function(){var e,t=n;if(void 0!==n.manifest&&null!==n.manifest){if(!t.getIsDynamic.call(t,n.manifest))return;e=((new Date).getTime()-n.lastMpdLoadedTime)/1e3,n.manifestRefreshDelay=Math.max(n.DEFAULT_MANIFEST_REFRESH_DELAY-e,0),n.NXDebug.debug("Refresh manifest in timeSince:"+e+", delay:"+n.manifestRefreshDelay)}else n.manifestRefreshDelay=0;n.setManifestUpdateStart.call(t)},this.manifest=null,this.DEFAULT_MANIFEST_REFRESH_DELAY=e.DEFAULT_MANIFEST_REFRESH_DELAY||10,this.DEFAULT_PRESENTATION_DELAY=e.DEFAULT_PRESENTATION_DELAY||NaN,this.DEFAULT_BASEURL_IDX=e.DEFAULT_BASEURL_IDX||0,this.SET_1STSEG_TIME_ZERO=void 0===e.SET_1STSEG_TIME_ZERO||e.SET_1STSEG_TIME_ZERO,this.supported_colour_primaries=e.SUPPORTED_COLOUR_PRIMARIES||[1,9],this.supported_transfer_characteristics=e.SUPPORTED_TRANSFER_CHARACTERISTICS||[1,16,18],this.unuseAudio=e.UNUSE_AUDIO||!1,this.useFetch=!(!e.USE_FETCH||!("fetch"in window)),this.manifestRefreshDelay=NaN,this.manifestRefreshTimer=null,this.manifestUpdateIsStopped=!1,this.manifestUpdating=!1,this.lastMpdLoadedTime=0,this.manifestText=null,this.clientServerTimeShift=NaN,this.timestampOffsetFor32bitVE=-1,this.minBandwidth={video:NaN,audio:NaN},this.mpdCommonQrys=o(i,"mpd")&&o(i.mpd,"query")?i.mpd.query:[],this.mpdCommonHdrs=o(i,"mpd")&&o(i.mpd,"header")?i.mpd.header:[],this.mpdOnPrepare=o(i,"mpd")&&o(i.mpd,"onPrepare")?i.mpd.onPrepare:function(){},this.mpdOnSuccess=o(i,"mpd")&&o(i.mpd,"onSuccess")?i.mpd.onSuccess:function(){},this.mpdOnError=o(i,"mpd")&&o(i.mpd,"onError")?i.mpd.onError:function(){},this.xlinkCommonQrys=o(i,"xlink")&&o(i.xlink,"query")?i.xlink.query:[],this.xlinkCommonHdrs=o(i,"xlink")&&o(i.xlink,"header")?i.xlink.header:[],this.xlinkOnPrepare=o(i,"xlink")&&o(i.xlink,"onPrepare")?i.xlink.onPrepare:function(){},this.xlinkOnSuccess=o(i,"xlink")&&o(i.xlink,"onSuccess")?i.xlink.onSuccess:function(){},this.xlinkOnError=o(i,"xlink")&&o(i.xlink,"onError")?i.xlink.onError:function(){},this.maxBandwidth={video:NaN,audio:NaN},this.xlinks={},this.xPeriods={},this.RETRY_ATTEMPTS=3,this.RETRY_INTERVAL=500,this.NXDebug=new s,this.eventBus=t}return e.prototype.parsePeriod=function(e,t,i){var n=this,r=[],a=i||function(){},s=function(t){for(var i,r=[],a=null,s=null,l=null,u=null,d=0;d<t.length;d++){if((a=t[d]).getAttribute("start")?(s=new b).start=n.parseDuration(a.getAttribute("start")):null!==l&&a.getAttribute("duration")?((s=new b).start=n.float3(u.start+u.duration),s.duration=n.parseDuration(a.getAttribute("duration")),s.end=n.float3(s.start+s.duration)):0===d&&((s=new b).start=0),null!==u&&isNaN(u.duration)&&(u.duration=n.float3(s.start-u.start),u.end=n.float3(u.start+u.duration)),null!==s&&(a.getAttribute("id")?s.id=a.getAttribute("id"):s.id="pid:"+d),null!==s&&a.getAttribute("duration")&&(s.duration=n.parseDuration(a.getAttribute("duration")),s.end=n.float3(s.start+s.duration)),null!==s&&a.getAttribute("xlink:href")&&(o(n.xlinks,s.id)||o(n.xPeriods,s.id)||(n.xlinks[s.id]=a.getAttribute("xlink:href"))),null!==s){s.index=d,s.mpd=e,s.childNodes=[];for(var f=t[d].childNodes,c=0;c<f.length;c++)if("AdaptationSet"===f[c].nodeName)s.childNodes.push(f[c]);else if("BaseURL"===f[c].nodeName){var m=f[c].textContent,g=new L;if(0===m.indexOf("http://")||0===m.indexOf("https://"))g.url=m,(i=f[c].getAttribute("availabilityTimeOffset"))&&(g.availabilityTimeOffset=parseFloat(i)),s.BaseURL.push(g);else for(var p=0;p<e.BaseURL.length;p++)(g=e.BaseURL[p].copy()).url=g.url+m,(i=f[c].getAttribute("availabilityTimeOffset"))&&(g.availabilityTimeOffset=parseFloat(i)),s.BaseURL.push(g)}else"AssetIdentifier"===f[c].nodeName?s.assetId=f[c].getAttribute("value"):"EventStream"===f[c].nodeName&&n.parseEventStream(f[c],s.outEventList);0===s.BaseURL.length&&e.BaseURL.forEach((function(e){s.BaseURL.push(e.copy())})),r.push(s)}l=a,a=null,u=s,s=null}l=null,u=null;var h=NaN;if(o(e,"minimumUpdatePeriod")&&(h=n.timelineConverter.calcPresentationTimeFromWallTime(new Date(e.manifest.mpdLoadedTime.getTime()+n.clientServerTimeShift),r[0])),e.checkTime=h,r[r.length-1].end==1/0){var y=0;e.mediaPresentationDuration?y=e.mediaPresentationDuration:isNaN(e.checkTime)?n.NXDebug.log("Must have @mediaPresentationDuration or @minimumUpdatePeriod on MPD or an explicit @duration on the last period."):y=e.checkTime,r[r.length-1].start<y?(r[r.length-1].end=n.float3(y),r[r.length-1].duration=n.float3(r[r.length-1].end-r[r.length-1].start)):r.pop()}return r};r=s(t);for(var l=0;l<r.length;l++)if(r[l].assetId){for(var u=0,d=0;d<l;d++)r[l].assetId!==r[d].assetId&&(u=this.float3(u+r[d].duration));r[l].offset=u}else r[l].offset=r[l].start;(function(e){var t=e;if(Object.keys(n.xlinks).length>0){var i=0,r=function(e){i--,e.data.success&&(n.xPeriods[e.data.pid]=s(e.data.result),n.NXDebug.info(String(n.xPeriods[e.data.pid]))),delete n.xlinks[e.data.pid],0==i&&(n.eventBus.removeEventListener("LOAD_RPERIODS_END",r),t())};for(var a in n.eventBus.addEventListener("LOAD_RPERIODS_END",r),n.xlinks)n.getRemotePeriods(n.xlinks[a],a,1),i++}else t()}).call(this,(function(){r=function(t){var i=[],r=t.length,a=0;for(a=0;a<r;a++)i.push(t[a].id);a=0;for(var s=function(){if(o(n.xPeriods,t[a].id)){for(var i,s,l=n.xPeriods[t[a].id],u=t[a].start,d=t[a].duration,f=t[a].end,c=n.float3(u-l[0].start),m=l.length,g=[],p=0,h=function(r){i=new b,Object.keys(l[r]).forEach((function(e){i[e]=l[r][e]})),i.id=t[a].id+" #"+r,i.start=n.float3(l[r].start+c),i.offset=i.start,i.duration=l[r].duration,i.end=n.float3(i.start+l[r].duration),i.mpd=e,p+=i.duration,(r==m-1||p>=d)&&(i.end=f,i.duration=n.float3(i.end-i.start),r=m-1),g.push(i),s=r},y=0;y<m;y++)h(y),y=s;if(1==g.length)t[a]=g[0],a++;else for(t.splice(a,1),r-=1,y=0;y<g.length;y++)n.NXDebug.log("i="+a),t.splice(a,0,g[y]),r++,a++}else a++};a<r;)s();for(a=0;a<t.length;a++)t[a].index=a;for(var l in n.xPeriods)i.indexOf(l)<0&&delete n.xPeriods[l];return t}(r);for(var t=0;t<r.length;t++)r[t].BaseURL.length>0&&(r[t].selectedBaseURLIdx=n.DEFAULT_BASEURL_IDX<r[t].BaseURL.length?n.DEFAULT_BASEURL_IDX:0),r[t].clientServerTimeShift=n.clientServerTimeShift,r[t].isClientServerTimeSyncCompleted=!0,r[t].isClientServerTimeSyncCompletedForTC=!0;a({data:r})}))},e.prototype.manifestUpdateStartPoll=function(){var e,t=this;if(void 0!==this.manifest&&null!==this.manifest){if(!t.getIsDynamic.call(t,this.manifest))return;e=((new Date).getTime()-this.lastMpdLoadedTime)/1e3,this.manifestRefreshDelay=Math.max(this.getRefreshDelay.call(t,this.manifest)-e,0),0==this.manifestRefreshDelay&&(this.manifestUpdateIsStopped=!1,this.onManifestRefreshTimer.call(t))}},e.prototype.onManifestRefreshTimer=function(){var e,t=this,i=this,n=function(){if(t.eventBus.removeEventListener("REFRESH_MANIFEST_END",n),!1===t.manifestUpdating){t.manifestUpdating=!0,t.NXDebug.debug("######################## Refresh Start ######################### Refresh manifest in "),t.manifestUpdateClear.call(i),e=t.manifest.mpdUrl,o(t.manifest,"Location")&&(e=t.manifest.Location);var r=function(e){if(e.data.success){if(t.NXDebug.log("Manifest has been refreshed. Refresh manifest in"),t.manifestUpdateIsStopped)return}else t.NXDebug.log("Failed to refresh Manifest. Refresh manifest in");i.setValue(e.data.result),t.manifestUpdateRun.call(i),t.eventBus.removeEventListener("LOAD_MANIFEST_END",r)};t.eventBus.addEventListener("LOAD_MANIFEST_END",r),i.loadManifest.call(i,e)}else t.NXDebug.log("### MPD Refresh Skip ###")};this.manifestUpdating?this.NXDebug.debug("refresh updating..."):n()},e.prototype.loadManifest=function(e){this.doLoad.call(this,e,this.RETRY_ATTEMPTS)},e.prototype.setManifestFromExt=function(e,t){this.setManifestData.call(this,e,t)},e.prototype.getIsDynamic=function(e){var t=!1;return o(e.mpd,"type")&&(t="dynamic"===e.mpd.type),t},e.prototype.getValue=function(){return this.manifest},e.prototype.setValue=function(e){null!=e?(this.manifest=e,this.eventBus.dispatchEvent({type:"manifestUpdated",data:{}})):(this.NXDebug.debug("manifest load failed ..."),this.onManifestRefreshEnd())},e.prototype.setBandwidthLimit=function(e,t){this.minBandwidth=e,this.maxBandwidth=t},e.prototype.manifestUpdateStart=function(){this.manifestUpdateIsStopped=!1,this.manifestUpdateRun.call(this)},e.prototype.manifestUpdateStop=function(){this.manifestUpdateIsStopped=!0,this.manifestUpdateClear.call(this)},e.prototype.onManifestRefreshEnd=function(){this.manifestUpdating&&(this.manifestUpdating=!1,this.eventBus.dispatchEvent({type:"REFRESH_MANIFEST_END",data:{}}))},e}(),C=function(){function e(){var e=this;this.logHandler=m,this.setState=function(t){e.state=t,null!==e.fragmentModel&&e.state===e.READY&&("video"==e.type?0==e.fragmentModel.getLoadingRequests().length&&e.fragmentModel.executeCurrentRequest():e.fragmentModel.executeCurrentRequest())},this.clearPlayListTraceMetrics=function(t,i){var n=0,r=null;!1===e.playListTraceMetricsClosed&&e.playListTraceMetrics&&(r=e.playListTraceMetrics.start,n=t.getTime()-r.getTime(),e.playListTraceMetrics.duration=n,e.playListTraceMetrics.stopreason=i,e.playListTraceMetricsClosed=!0)},this.setBufferState=function(t,i){var n=0;e.minBufferTime&&(t<e.minBufferTime?n=1:t>=e.minBufferTime&&t<i?n=2:t>=i&&(n=3)),e.bufferState!=n&&e.eventBus&&(e.bufferState=n,e.eventBus.dispatchEvent({type:"bufferStateChangeInt",data:{type:e.type,state:e.bufferState}}))},this.startScheduling=function(t){var i=e;e.requestScheduler&&clearInterval(e.requestScheduler),e.requestScheduler=setInterval(t.bind(i),e.SCHEDULE_EXECUTE_INTERVAL),e.isScheduled=!0,t.call(i)},this.stopScheduling=function(){e.requestScheduler&&(clearInterval(e.requestScheduler),e.requestScheduler=null),e.isScheduled=!1},this.startPlayback=function(){e.ready&&e.started&&(e.setState.call(e,e.READY),e.startScheduling.call(e,e.validate))},this.start=function(t){var i;e.isStreamCompleted=!1,e.isScheduled&&e.stopScheduling.call(e),!1===e.seeking&&e.metrics&&e.type&&(i=new Date,e.clearPlayListTraceMetrics(i,e.USER_REQUEST_STOP_REASON),e.playListMetrics=e.metrics.addPlayList(e.type,i,0,e.INITIAL_PLAY_START_REASON)),e.NXDebug.debug("["+e.type+"] BufferController start."+t),e.started=!0,e.updateBufferLevel.call(e),!e.waitingForBuffer&&e.bufferLevel<=e.STALL_THRESHOLD&&(e.waitingForBuffer=!0,e.bufferStartThreshold=Math.min(e.minBufferTime||e.DEFAULT_MIN_BUFFER_TIME,e.getTimeToEnd.call(self))),e.startPlayback.call(e)},this.checkQ=function(t){var i,n,r,a=e;if(e.buffer){if(!e.playbackStarted){if(!e.videoModel.isDummy())return;for(i=e.videoModel.getCurrentTime(),r=0;r<e.buffer.queue.length&&!(i>=(n=e.buffer.queue[r]).time&&i<n.time+n.dur);r++);for(;r>1;)e.buffer.queue.shift(),r--}for(var s=e.fragmentModel.getLoadingRequests(),o=s.length-1;o>=0;o--)if(!s[o].keep){var l=s[o].startTime;s.splice(o,1),e.fragmentModel.abortRequestForTime(l)}e.cancelPendingRequests.call(a,e.type,e.NOCHANGE,1),e.fragmentModel.removeAllExecutedRequests();var u=!0;if(e.videoModel&&(i=e.videoModel.getCurrentTime()),e.buffer.queue.length>0){var d=e.sourceBufferExt.getBufferRange(e.buffer,i,e.tolerance),f=null!=d?d.end:i,c=e.buffer.queue[0].time-.1,m=e.buffer.queue[e.buffer.queue.length-1].time+e.buffer.queue[e.buffer.queue.length-1].dur+.1;if(!e.playbackStarted&&e.BUFFER_PREFETCH_THRESHOLD&&f<c&&c-f<e.BUFFER_PREFETCH_THRESHOLD||c<=f&&f<m){for(var g=e.buffer.queue.length-1;g>=0;g--)if(e.buffer.queue[g].time-f>e.BUFFER_PREFETCH_THRESHOLD){var p=void 0;for(p=(n=e.buffer.queue.pop()).divNum,n=void 0;p>0;){var h=e.buffer.queue.pop();p=h.divNum,h=void 0,g--}}u=!1}}u&&(e.buffer.queue=[],e.buffer.lastAppendtime=-1,e.preAppendTime=-1),e.buffer.laData=null}},this.seek=function(t,i){var n,r,a,s,o=e;if(e.isStreamCompleted=!1,e.seeking=!0,e.seekTarget="audio"==e.type&&1==e.isSegmentTemplate&&e.periodInfo?Math.max(t-1,e.periodInfo.start):t,e.setIncrementalMode.call(o,!1,1),n=new Date,e.clearPlayListTraceMetrics(n,e.USER_REQUEST_STOP_REASON),e.metrics&&e.type&&(e.playListMetrics=e.metrics.addPlayList(e.type,n,e.seekTarget,e.SEEK_START_REASON)),e.NXDebug.debug("["+e.type+"] BufferController seek: "+t+", bufferLevel: "+e.bufferLevel+","+i),e.updateBufferLevel.call(o),r=e.videoModel.getCurrentTime(),e.buffer)if(e.stalled||(e.bufferStartThreshold=Math.min(e.minBufferTime||e.DEFAULT_MIN_BUFFER_TIME,e.getTimeToEnd.call(o)),e.videoModel&&e.videoModel.isPaused()?(e.stalled=!0,e.waitingForBuffer=!0,e.stallStream.call(o,e.stalled,0),e.bufferLevel<e.bufferStartThreshold&&e.abrController&&e.abrController.getAutoSwitchBitrate()&&e.type&&e.abrController.setPlaybackQuality(e.type,e.abrController.getDefaultQualityFor(e.type))):e.seekTarget<r&&e.sourceBufferExt.getBufferLength(e.buffer,r,e.tolerance)>0&&(e.seeking=!1)),e.seeking&&e.loadFirstSegmentRequestAfterSeek(e.seekTarget),e.bDatInsertMode&&void 0===e.buffer.updating){for(var l=e.buffer.buffered.length-1;l>=0;l--)if(e.buffer.buffered.start(l)>r+.5&&!(e.buffer.buffered.end(l)-e.buffer.buffered.start(l)<1.5)){var u=e.buffer.buffered.start(l)-.3;if(e.getMSEDuration.call(o)-u<20)continue;u<0&&(u=0),a=new DataView(e.dmyData),"video"===e.type?e.isProtection?(a.setUint32(1644,3e4*u),a.setUint32(1728,3e4*u),a.setUint32(42829,3e4*u),a.setUint32(42913,3e4*u)):(a.setUint32(866,3e4*u),a.setUint32(950,3e4*u),a.setUint32(25326,3e4*u),a.setUint32(25410,3e4*u)):e.isProtection,e.buffer.timestampOffset=0,void 0===e.buffer.updating?(s=new Uint8Array(e.dmyData),e.buffer.append(s)):e.buffer.appendBuffer(e.dmyData),e.buffer.quality=-1;break}e.NXDebug.debug("["+e.type+"] BufferController  seek: "+t+", bufferLevel: "+e.bufferLevel+", qlen:"+e.buffer.queue.length),e.start.call(o,"11111")}else if("remove"in e.buffer&&void 0!==e.buffer.updating)if(e.periodInfo&&e.buffer.buffered.length>0&&(r+30<e.buffer.buffered.end(e.buffer.buffered.length-1)||e.periodInfo.end<e.buffer.buffered.end(e.buffer.buffered.length-1))){var d=e.buffer.buffered.end(e.buffer.buffered.length-1);e.sourceBufferExt.waitForUpdateEnd(e.buffer,(function(){var i=e.sourceBufferExt.getBufferLength(e.buffer,r,e.tolerance)+.5;e.sourceBufferExt.remove(e.buffer,Math.min(r+Math.max(i,30),e.periodInfo.end),d,e.periodInfo.duration,e.mediaSource,(function(){e.NXDebug.debug("["+e.type+"] BufferController  seek: "+t+", bufferLevel: "+e.bufferLevel+", qlen:"+e.buffer.queue.length),e.start.call(o,"11111-")}))}))}else e.NXDebug.debug("["+e.type+"] BufferController  seek: "+t+", bufferLevel: "+e.bufferLevel+", qlen:"+e.buffer.queue.length),e.start.call(o,"11111+");else e.NXDebug.debug("["+e.type+"] BufferController  seek: "+t+", bufferLevel: "+e.bufferLevel),e.start.call(o,"11111")},this.stop=function(){e.state!==e.WAITING&&(e.NXDebug.debug("["+e.type+"] BufferController stop."),e.setState.call(e,e.isBufferingCompleted?e.READY:e.WAITING),e.stopScheduling.call(e),e.started=!1,e.clearPlayListTraceMetrics(new Date,e.USER_REQUEST_STOP_REASON))},this.setIncrementalMode=function(t,i){e.incrementalMode=t},this.stallStream=function(t,i){e.STORE_MEASURED_DATA&&(t?e.metrics.addBufferingEvent((new Date).getTime(),0,e.videoModel.getCurrentTime()):e.metrics.addBufferingEvent((new Date).getTime(),1,e.videoModel.getCurrentTime())),e.videoModel.stallStream(e.type,t)},this.getRepresentationForQuality=function(t){return e.availableRepresentations[t]},this.cancelPendingRequests=function(t,i,n){var r=i||e.RESET,a=-1;if(r==e.UPDATE){var s=e.fragmentModel.getPendingRequests();a=-1,r=e.NOCHANGE;for(var o=0;o<s.length;o++)if(!s[o].keep&&s[o].periodIdx==e.periodInfo.index&&s[o].adaptationIdx==e.currentAdaptation.index){(a=s[o].index)>0&&(a-=1),r=e.UPDATE;break}}e.fragmentModel.cancelPendingRequests(),r!=e.NOCHANGE&&e.indexHandler.setupRequestStatus(t,a,n)},this.clearAllSegments=function(){for(var t=e.currentAdaptation.representations,i=0;i<t.length;i++)t[i].segments=null},this.abortOnGoingRequests=function(){e.fragmentModel.abortRequests(!0)},this.checkLoadingRequests=function(t,i){var n=e,r=!1;if(null!=e.fragmentModel){var a=e.fragmentModel.getLoadingRequests();if(a.length>0){for(var s=0;s<a.length;s++){var o=a[s],l=(new Date).getTime(),u=(l-o.requestStartTime)/1e3;if(u>(i>3*o.duration?2*o.duration:1.2*o.duration)*(1+(0==o.quality?1:0))){if(0!==o.quality||!o.aborted){e.NXDebug.info("["+t+"]============= This request should be aborted. ================"+a.length),e.logHandler.log("["+s+"/"+a.length+"]["+e.buffer.type+"]abort time:"+o.startTime+",q: "+o.quality+", diff:"+(l-o.requestStartTime)/1e3+",request.aborted:"+o.aborted),r=!0;break}}else u>o.duration&&0!==o.quality&&e.fragmentModel.setRestrictMultiLoad(!0)}if(r){var d=[];for(s=0;s<a.length;s++)d.push({startTime:a[s].startTime,representation:a[s].representation}),e.useFetch&&e.checkRemoveQForTime.call(n,a[s].startTime);for(e.fragmentModel.abortRequests(!1),e.cancelPendingRequests.call(e,t,e.RESET,2),s=0;s<d.length;s++){var f=e.abrController.getPlaybackQuality(t,d[s].representation.adaptation,e.metrics,i,r,e.stalled);e.indexHandler.getSegmentRequestForTime(d[s].representation.adaptation.representations[f.quality],d[s].startTime,t,5,(function(t){var i;"ok"===t.status?t.data&&null!=(i=t.data)&&(i.keep=!0,i.aborted=!0,e.fragmentController.isFragmentLoadingOrPending(n,i)||e.fragmentModel.addRequest(i)):i=null}))}}}}return r},this.finishValidation=function(){var t=e;e.state===e.LOADING&&e.setState.call(t,e.READY)},this.onBytesLoadingStart=function(t){if(e.fragmentController.isInitializationRequest(t))e.setState.call(e,e.READY);else{e.setState.call(e,e.LOADING);var i=e;if(!e.hasData())return;e.setState.call(i,e.READY),e.fragmentController.needToPrepareNewRequest(i)&&(e.getPlaybackQuality.call(i),e.requestNewFragment.call(i))}},this.onBytesLoaded=function(t,i){if("video"===e.type){var n=e.bufferLevel+e.sourceBufferExt.dataQduration(e.buffer,e.isSegmentTemplate);(t.requestEndTime-t.requestStartTime)/1e3>t.duration&&n<10&&e.cancelPendingRequests.call(e,e.type,e.UPDATE,3)}t.canceled?e.fragmentModel.removeExecutedRequest(t):e.fragmentController.isInitializationRequest(t)?e.onInitializationLoaded.call(e,t,i):e.onMediaLoaded.call(e,t,i)},this.onFirstChunkLoaded=function(t){var i=t.quality,n=t.index,r=t.startTime,a=t.duration,s=t.MSETimeOffset,o=t.representation.adaptation,l=t.adaptationIdx,u=o.period.start,d=e.initializationData[u][o.index][i];return e.sourceBufferExt.append(e.buffer,null,d,r,r,a,u,s,e.minBufferTime,i,l,0,n)},this.onChunkLoaded=function(t,i,n){var r=e,a={};if(t)i.done=!0,i.chunks.length>0&&(i.dur=i.chunks[i.chunks.length-1].dur+(i.chunks[i.chunks.length-1].start-i.time));else{var s,o=void 0,l=0,u=0,d=0;if(i.progress.push(n),i.progress.forEach((function(e){d+=e.length})),i.chunkEnd>d)return;if(0==(s=e.indexHandler.extractChunk(i,d,e.periodInfo.inEventList,e.type)).curChunkEnd)return i.chunkEnd=s.nextChunkEnd,i.chunkStartTime=s.nextChunkStartTime,void(i.chunkDur=s.nextChunkDur);o=new Uint8Array(s.curChunkEnd);for(var f=0;f<i.progress.length;f++){var c=i.progress[f].length;if(!((u+=c)<=s.curChunkEnd)){var m=i.progress[f].subarray(0,c-(u-s.curChunkEnd)),g=i.progress[f].subarray(c-(u-s.curChunkEnd),c);o.set(m,l),i.progress=[g],i.chunkEnd=s.nextChunkEnd>0?s.nextChunkEnd-s.curChunkEnd:0,i.chunkStartTime=s.nextChunkStartTime,i.chunkDur=s.nextChunkDur;break}if(o.set(i.progress[f],l),l+=c,u==s.curChunkEnd){i.progress=[],i.chunkEnd=s.nextChunkEnd,i.chunkStartTime=s.nextChunkStartTime,i.chunkDur=s.nextChunkDur;break}}a.data=o,a.start=s.curChunkStartTime,a.dur=s.curChunkDur,i.appending||0!=i.chunks.length||(i.time=a.start),i.chunks.push(a)}e.appendFromBufferQ.call(r)},this.onChunkLoadedError=function(t){var i=e.buffer.queue.indexOf(t);i>-1&&e.buffer.queue.splice(i,1),t=null},this.onMediaLoaded=function(t,i){var n=e,r=t.representation,a=t.url.split("/");e.NXDebug.info("str: ["+t.streamType+"] loaded, "+a[a.length-1]+", i="+t.index+" ,t="+Math.floor(t.startTime)+" total="+(t.requestEndTime-t.requestStartTime)+"ms, "+(null!=i?i.length:"NULL")+"bytes rst:"+(new Date).getTime()),e.isDynamic&&(r.adaptation.period.liveEdgeFromRequest=Math.max(r.adaptation.period.liveEdgeFromRequest,t.startTime+t.duration)),e.fragmentDuration||isNaN(t.duration)||(e.fragmentDuration=t.duration),null!==i?e.appendToBuffer.call(n,i,t,(function(i){i?(r.lastRequestIndex!==t.index||e.isBufferingCompleted?e.fragmentController.needToPrepareNewRequest(n)&&(e.getPlaybackQuality.call(n),e.requestNewFragment.call(n)):(e.isBufferingCompleted=!0,e.stalled&&(e.stalled=!1,e.stallStream.call(n,e.stalled,1)),e.setState.call(n,e.READY),e.eventBus.dispatchEvent({type:"bufferingCompleted",data:e.type})),e.useFetch||e.appendFromBufferQ.call(n)):e.NXDebug.debug("ERROR: appentToBuffer")})):e.NXDebug.log("No "+e.type+" bytes to push.")},this.appendToBuffer=function(t,i,n){var r,a,s=e,o=e.videoModel.getCurrentTime(),l=new Date,u=i.quality,d=i.startTime,f=i.duration,c=i.MSETimeOffset,m=i.representation,g=m.adaptation,p=i.adaptationIdx,h=g.period.start,y=0;if(!0===e.playListTraceMetricsClosed&&e.state!==e.WAITING&&-1!==e.requiredQuality&&(e.playListTraceMetricsClosed=!1,e.playListTraceMetrics=e.metrics.appendPlayListTrace(e.playListMetrics,m.id,null,l,o,null,1,null)),e.hasData())if(e.preAppendTime!==d?(y=Math.floor(d)-Math.floor(e.preAppendTime),-1===e.preAppendTime&&(y="-"),e.preAppendTime=d):"video"===e.type?e.logHandler.log_V2(e.type[0]+"["+u+"] t="+parseInt(String(100*d))/100+" dup"):e.logHandler.log_A2(e.type[0]+"["+u+"] t="+parseInt(String(100*d))/100+" dup"),e.currentQuality!==u?(e.currentQuality=u,"video"===e.type?(e.logHandler.log_V2(e.type[0]+"["+e.currentQuality+"] init"),e.logHandler.log_V2(e.type[0]+"["+u+"] t="+parseInt(String(100*d))/100+" : "+y),e.logHandler.log_item("bw_video","Video: "+m.bandwidth/1e3+" Kbps ("+m.width+"x"+m.height+")")):(e.logHandler.log_A2(e.type[0]+"["+e.currentQuality+"] init"),e.logHandler.log_A2(e.type[0]+"["+u+"] t="+parseInt(String(100*d))/100+" : "+y),e.logHandler.log_item("bw_audio","Audio: "+m.bandwidth/1e3+" Kbps"))):"video"===e.type?e.logHandler.log_V2(e.type[0]+"["+u+"] t="+parseInt(String(100*d))/100+" : "+y):e.logHandler.log_A2(e.type[0]+"["+u+"] t="+parseInt(String(100*d))/100+" : "+y),e.useFetch)n(!0);else{try{a=e.initializationData[h][g.index][u]}catch(e){a=void 0}if(a){"video"==e.type&&e.EXTRACT_ALL_IDR_IN_MOOF&&(t=e.indexHandler.extractIDRinMOOF(t,a.params.timescale,m.codecs));var v=e.indexHandler.parseFragment(t,a.params.timescale,a.params.dsd,c,e.type,e.periodInfo.inEventList);if(r=v[0].time,(f=v[v.length-1].time+v[v.length-1].dur-r)<e.MSE_APPEND_ENABLE_THRESHOLD+1||v.length<2)null!=t&&e.sourceBufferExt.append(e.buffer,t,a,d,r,f,h,c,e.minBufferTime,u,p,0,i.index);else for(var S=void 0,T=void 0,E=0,b=0,D=0;D<v.length;D++){var R=v[D].offset,M=v[D].size,I=v[D].time,k=void 0;0===E&&(T=I,S=R),((E+=v[D].dur)>e.MSE_APPEND_ENABLE_THRESHOLD||D==v.length-1)&&(k=t.subarray(S,R+M),e.sourceBufferExt.append(e.buffer,k,a,d,T,E,h,c,e.minBufferTime,u,p,b,i.index),E=0,b++)}t=void 0,e.updateBufferLevel.call(s);var x=e.sourceBufferExt.getAllRanges(e.buffer);if(x&&x.length>0){var L=x.length;for(D=0;D<L;D+=1)e.NXDebug.debug("["+e.type+"] Buffered Range["+D+"]: "+x.start(D)+" - "+x.end(D))}n(!0)}else e.fragmentModel.removeExecutedRequest(i)}else n(!1)},this.firstSegmentInCurrentPeriod=function(){if(0==e.buffer.queue.length)return!1;var t=e.buffer.queue[0];if(t.pStart==e.periodInfo.start){if(t.time-e.periodInfo.start<=e.tolerance){var i=e.videoModel.getCurrentTime();return e.periodInfo.start-i<e.MSE_APPEND_ENABLE_THRESHOLD}return!1}return!1},this.appendFromBufferQv01=function(){(e.bufferLevel<e.MSE_APPEND_ENABLE_THRESHOLD||e.waitingForBuffer||e.firstSegmentInCurrentPeriod())&&e.sourceBufferExt.appendFromQ(e.buffer,e.waitingForBuffer,e.bufferStartThreshold)},this.appendFromBufferQForAB=function(){e.appendFromBufferQisProcessing||(e.bufferLevel<e.MSE_APPEND_ENABLE_THRESHOLD||e.waitingForBuffer||e.firstSegmentInCurrentPeriod()||e.videoModel.getNeedsMoreData())&&(e.appendFromBufferQisProcessing=!0,e.sourceBufferExt.waitForUpdateEnd(e.buffer,(function(){if("remove"in e.buffer&&e.buffer.buffered.length>0){var t=e.videoModel.getCurrentTime(),i=e.buffer.buffered.start(0);i+35<t?e.sourceBufferExt.remove(e.buffer,i,t-30,e.periodInfo.duration,e.mediaSource,(function(){e.sourceBufferExt.appendFromQ(e.buffer,e.waitingForBuffer,e.bufferStartThreshold),e.appendFromBufferQisProcessing=!1})):(e.sourceBufferExt.appendFromQ(e.buffer,e.waitingForBuffer,e.bufferStartThreshold),e.appendFromBufferQisProcessing=!1)}else e.sourceBufferExt.appendFromQ(e.buffer,e.waitingForBuffer,e.bufferStartThreshold),e.appendFromBufferQisProcessing=!1})))},this.updateBufferLevel=function(){if(!e.hasData())return!1;var t=e,i=e.getWorkingTime.call(t),n=e.sourceBufferExt.getBufferLength(e.buffer,i,e.tolerance);return e.tlen=e.sourceBufferExt.getBufferLength(e.buffer,i+1,e.tolerance),!!e.hasData()&&(e.bufferLevel=n,e.buffer.level=e.bufferLevel,e.metrics.addBufferLevel(e.type,(new Date).getTime(),e.bufferLevel,e.sourceBufferExt.dataQduration(e.buffer,e.isSegmentTemplate),i),e.checkIfSufficientBuffer.call(t),e.started||("video"===e.type?(e.logHandler.log_item("ctime","time: "+new Number(e.videoModel.getCurrentTime()).toFixed(2)+", dur: "+(isFinite(e.videoModel.getDuration())?new Number(e.videoModel.getDuration()).toFixed(2):e.videoModel.getDuration())),e.logHandler.log_item("vlog",e.type+" len: "+e.buffer.buffered.length+", buffer: "+parseInt(String(100*e.bufferLevel))/100)):e.logHandler.log_item("alog",e.type+" len: "+e.buffer.buffered.length+", buffer: "+parseInt(String(100*e.bufferLevel))/100),e.logHandler.log_slider(e.videoModel.getCurrentTime(),e.videoModel.getDuration())),!0)},this.onInitializationLoaded=function(t,i){var n=t.quality;e.NXDebug.log("Initialization finished loading: "+t.streamType),null!==i?e.initializationData[e.periodInfo.start][e.currentAdaptation.index][n].data=i:e.NXDebug.log("No "+e.type+" bytes to push.")},this.onBytesError=function(t,i){var n=e;if(e.state===e.LOADING&&e.setState.call(e,e.READY),e.isScheduled){if("onloadend"==t){var r,a=i.quality;if(i.failedList)(r=i.failedList)[i.baseURLIdx].indexOf(a)<0&&r[i.baseURLIdx].push(a);else{r=new Array(i.baseURL.length);for(var s=0;s<r.length;s++)r[s]=[];r[i.baseURLIdx].push(i.quality)}var o=i.baseURL.length;for(s=0;s<o;s++)if(r[s].indexOf(a)<0)return i.baseURLIdx=s,i.failedList=r,e.useFetch&&e.checkRemoveQForTime.call(n,i.startTime),void(e.fragmentController.isFragmentLoadingOrPending(n,i)||e.fragmentModel.addRequest(i));var l=i.representation.adaptation.representations.length,u=0,d=i.representation.adaptation.period.selectedBaseURLIdx,f=d,c=!1;for(s=0;s<l;s++)if(r[d].indexOf(s)<0){u=s,c=!0;break}if(0==c)for(var m=0;m<o;m++)if(m!=d){for(s=0;s<l;s++)if(r[m].indexOf(s)<0){u=s,f=m,c=!0;break}if(1==c)break}e.indexHandler.getSegmentRequestForTime(i.representation.adaptation.representations[u],i.startTime,e.type,6,(function(t){var i;"ok"===t.status?t.data&&null!=(i=t.data)&&(i.baseURLIdx=f,i.failedList=r,e.useFetch&&e.checkRemoveQForTime.call(n,i.startTime),e.fragmentController.isFragmentLoadingOrPending(n,i)||e.fragmentModel.addRequest(i)):i=null}))}}else e.cancelPendingRequests.call(n,e.type,e.UPDATE,4)},this.checkRemoveQForTime=function(t){for(var i=0;i<e.buffer.queue.length;i++)if(e.buffer.queue[i].rstime==t){e.buffer.queue[i].done||e.buffer.queue.splice(i,1);break}},this.findLiveEdge=function(t,i,n,r,a){var s,o=e,l=r;null===(s="ok"===a.status?a.data:null)?(e.currentRepresentation.segments=null,e.currentRepresentation.segmentAvailabilityRange={start:t-e.liveEdgeSearchStep,end:t+e.liveEdgeSearchStep},e.indexHandler.getSegmentRequestForTime(e.currentRepresentation,t,e.type,0,e.findLiveEdge.bind(o,t,i,n,l))):e.fragmentController.isFragmentExists(o,s,(function(e){e?i.call(o,s,t,l):n.call(o,s,t,l)}))},this.onSearchForSegmentFailed=function(t,i,n){var r=i-5;r<e.currentRepresentation.segmentAvailabilityRange.start?e.eventBus.dispatchEvent({type:"segmentLoadingFailed",data:{}}):(e.setState.call(e,e.READY),e.indexHandler.getSegmentRequestForTime(e.currentRepresentation,r,e.type,0,e.findLiveEdge.bind(e,r,e.onSearchForSegmentSucceeded,e.onSearchForSegmentFailed,n)))},this.onSearchForSegmentSucceeded=function(t,i,n){var r,a=t.startTime,s=e,o=n||function(){};if(!e.useBinarySearch){if(0===e.fragmentDuration)return void o(a);if(e.useBinarySearch=!0,e.liveEdgeSearchRange.end=a+2*e.liveEdgeSearchStep,i===e.liveEdgeInitialSearchPosition)return r=i+e.fragmentDuration,void e.indexHandler.getSegmentRequestForTime(e.currentRepresentation,r,e.type,0,e.findLiveEdge.bind(s,r,(function(){e.binarySearch.call(s,!0,r,o)}),(function(){o(r)}),o))}e.binarySearch.call(e,!0,i,o)},this.binarySearch=function(t,i,n){var r,a=n||function(){};t?e.liveEdgeSearchRange.start=i:e.liveEdgeSearchRange.end=i,Math.floor(e.liveEdgeSearchRange.end-e.liveEdgeSearchRange.start)<=e.fragmentDuration?a(t?i:i-e.fragmentDuration):(r=(e.liveEdgeSearchRange.start+e.liveEdgeSearchRange.end)/2,e.indexHandler.getSegmentRequestForTime(e.currentRepresentation,r,e.type,0,e.findLiveEdge.bind(e,r,e.onSearchForSegmentSucceeded,e.onSearchForSegmentFailed,a)))},this.signalStreamComplete=function(t){t.periodIdx==e.periodInfo.index&&(e.stop.call(e),e.keepCurrentRequests.call(e),e.isStreamCompleted=!0,e.eventBus.dispatchEvent({type:"streamIsCompleted",data:{type:e.type,periodIdx:t.periodIdx,pStart:t.representation.adaptation.period.start,pEnd:t.representation.adaptation.period.end}}))},this.loadFirstSegmentRequestAfterSeek=function(t){var i,n,r=e,a=t,s=e.videoModel.getCurrentTime(),o=e.sourceBufferExt.getBufferRange(e.buffer,a,e.tolerance);e.isDynamic&&e.seeking&&("SegmentTimeline"===e.currentRepresentation.segmentInfoType||"SegmentTemplate"===e.currentRepresentation.segmentInfoType||"SegmentList"===e.currentRepresentation.segmentInfoType)&&(e.currentRepresentation.segments=null),(i=o?o.end:a)<e.periodInfo.start||(o?e.NXDebug.debug("["+e.type+"] Loading the fragment for seek time: "+i+", "+a+" ["+o.start+"-"+o.end+"]"):e.NXDebug.debug("["+e.type+"] Loading the fragment for seek time: "+i+", "+a),0===s||i<s+1.5*e.BUFFER_PREFETCH_THRESHOLD?(e.setIncrementalMode.call(r,!1,3),e.seeking=!1,e.indexHandler.getSegmentRequestForTime(e.currentRepresentation,i,e.type,1,(function(i){"ok"==i.status&&(null!=(n=i.data)?(e.buffer.startTimeAfterSeek=n.startTime,e.NXDebug.info("["+e.type+"] startTimeAfterSeek:"+e.buffer.startTimeAfterSeek),n.keep=!0,n.las=!0):e.buffer.startTimeAfterSeek=Number.MAX_VALUE,[e.fragmentModel.getLoadingRequests(),e.fragmentModel.getPendingRequests()].forEach((function(e){for(var t=0;t<e.length;t++)e[t].las&&(e[t].keep=!1)})),e.checkQ.call(r,t),e.useFetch&&e.checkRemoveQForTime.call(r,n.startTime),null==n||e.fragmentController.isFragmentLoadingOrPending(r,n)||e.fragmentModel.addRequest(n)),e.setIncrementalMode.call(r,!0,33),e.seeking=!1,e.setState.call(r,e.READY)}))):(e.NXDebug.debug("["+e.type+"] Loading the fragment for time: skip "+s+" : "+i),e.seeking=!1))},this.loadNextFragment=function(t){var i=t,n=e,r=e.videoModel.getCurrentTime();if(e.incrementalMode&&!e.indexHandler.isInitialIndex(e.type))e.indexHandler.getNextSegmentRequest(e.currentRepresentation,e.type,(function(t){"ok"===t.status&&null!=t.data&&r+1.5*e.BUFFER_PREFETCH_THRESHOLD<t.data.startTime&&e.setIncrementalMode.call(n,!0,4),i(t)}));else{var a,s;s=e.seeking?e.seekTarget:r>0?r:e.videoModel.getStartTime();var o=e.sourceBufferExt.getBufferRange(e.buffer,s,e.tolerance);if(e.isDynamic&&e.seeking&&("SegmentTimeline"===e.currentRepresentation.segmentInfoType||"SegmentTemplate"===e.currentRepresentation.segmentInfoType||"SegmentList"===e.currentRepresentation.segmentInfoType)&&(e.currentRepresentation.segments=null),(a=o?o.end:s)<e.periodInfo.start)return;o?e.NXDebug.debug("["+e.type+"] Loading the fragment for time: "+a+", "+s+" ["+o.start+"-"+o.end+"]"):e.NXDebug.debug("["+e.type+"] Loading the fragment for time: "+a+", "+s),0===r||a<r+1.5*e.BUFFER_PREFETCH_THRESHOLD?(e.setIncrementalMode.call(n,!0,5),e.indexHandler.getSegmentRequestForTime(e.currentRepresentation,a,e.type,1,i)):(e.NXDebug.debug("["+e.type+"] Loading the fragment for time: skip "+r+" : "+a),e.seeking=!1,i({status:"ok",data:null}))}},this.onFragmentRequest=function(t){var i,n=e;if(null!==(i="ok"===t.status?t.data:null)){var r=e.sourceBufferExt.getBufferLength(e.buffer,i.startTime,e.tolerance);r>i.duration?(e.setIncrementalMode.call(n,!1,6),e.setState.call(n,e.READY)):e.fragmentController.isFragmentLoadedOrPending(n,i)?"complete"!==i.action?(e.NXDebug.debug("["+e.type+"] Index for time Next!!! cur idx: "+i.index+", t="+i.startTime),e.indexHandler.getNextSegmentRequest(e.currentRepresentation,e.type,e.onFragmentRequest.bind(n))):(e.stop.call(n),e.setState.call(n,e.READY)):(e.NXDebug.debug("["+e.type+"] startTime:"+i.startTime+", length:"+r),e.seeking&&(e.buffer.startTimeAfterSeek=i.startTime,e.NXDebug.info("["+e.type+"] startTimeAfterSeek:"+e.buffer.startTimeAfterSeek+", length:"+r),i.keep=!0,e.seeking=!1),e.fragmentModel.addRequest(i),e.setState.call(n,e.READY))}else e.isDynamic&&e.isTargetType.call(n,e.type)&&!e.isSegmentTemplate&&e.manifestModel.manifestUpdateStartPoll(),null!=t.time&&t.time<e.periodInfo.start&&(e.keepCurrentRequests.call(n),e.seek.call(n,e.periodInfo.start,"no data")),e.setState.call(n,e.READY)},this.keepCurrentRequests=function(){var t=e.fragmentModel.getLoadingRequests(),i=e.fragmentModel.getPendingRequests();if(t.length>0)for(var n=0;n<t.length;n++)t[n].keep=!0;if(i.length>0)for(n=0;n<i.length;n++)i[n].keep=!0},this.checkIfSufficientBuffer=function(){if(e.waitingForBuffer){var t=e.getWorkingTime(),i=isNaN(e.getMSEDuration())?1/0:e.getMSEDuration()-t;e.bufferLevel<e.tlen&&e.logHandler.log("bufferLevel:"+e.bufferLevel+", tlen:"+e.tlen),e.NXDebug.debug("["+e.type+"] currentTime:"+t+", bufferLevel:"+e.tlen+", minBufferTime:"+e.minBufferTime+", timeToEnd:"+i+", isBufferingCompleted:"+e.isBufferingCompleted+",qlen:"+e.buffer.queue.length+",stalled:"+e.stalled),e.tlen<e.minBufferTime&&(e.minBufferTime<i||e.minBufferTime>=i&&!e.isBufferingCompleted)?e.stalled||(e.NXDebug.debug("["+e.type+"] Waiting for more buffer before starting playback."),e.logHandler.log("["+e.type+"] Waiting for more buffer before starting playback."),e.stalled=!0,e.stallStream.call(e,e.stalled,3),e.abrController.getAutoSwitchBitrate()&&e.abrController.setPlaybackQuality(e.type,e.videoModel.getPlaybackState()?0:e.abrController.getDefaultQualityFor(e.type))):(e.NXDebug.debug("["+e.type+"] Got enough buffer to start."+e.tlen+", stalled:"+e.stalled),e.waitingForBuffer=!1,e.seeking=!1,e.buffer.startTimeAfterSeek=Number.MAX_VALUE,e.stalled&&(e.stalled=!1,e.stallStream.call(e,e.stalled,4)))}},this.onNeedToModifyOffset=function(t){if(t.data.type==e.type){for(var i=e.currentAdaptation.representations,n=0;n<i.length;n++)i[n].segments=null,i[n].presentationTimeOffset+=t.data.minDiff;if(e.cancelPendingRequests.call(self,e.type,e.RESET,5),e.useFetch){var r=e.fragmentModel.getLoadingRequests();for(n=0;n<r.length;n++){for(var a=!1,s=0;s<e.buffer.queue.length;s++)if(r[n].startTime==e.buffer.queue[s].rstime){a=!0;break}a||e.fragmentModel.abortRequestForTime(r[n].startTime)}}else e.fragmentModel.abortRequests();e.setIncrementalMode.call(e,!1,7)}},this.onAppendedEnoughDataToStart=function(t){var i=e,n=!1,r=null,a=e.videoModel.getElement(),s=function(){var t,o,l=e.sourceBufferExt.getAllRanges(e.buffer);for(t=0,o=l.length;t<o;t+=1)e.logHandler.log("["+e.type+"] Buffered Range["+t+"]: "+l.start(t)+" - "+l.end(t)+", state:"+e.videoModel.getReadyState()+", c:"+e.videoModel.getCurrentTime()+", paused:"+e.videoModel.isPaused());e.NXDebug.debug("["+e.type+"] Appended enough data to start."+a.readyState),e.logHandler.log("["+e.type+"] Appended enough data to start."+a.readyState),n=!0,null!=e.buffer.updating&&(a.removeEventListener("canplay",s),e.buffer.removeEventListener("updateend",s),clearTimeout(r)),e.buffer.startTimeAfterSeek=Number.MAX_VALUE,e.stalled&&(e.stalled=!1,e.stallStream.call(i,e.stalled,5)),e.playbackStarted=!0},o=function(){if(!n)if(a.readyState>2)s();else{var t=e.getWorkingTime.call(i);e.sourceBufferExt.getBufferLength(e.buffer,t+.5,e.tolerance)>10&&a.readyState<3?s():r=setTimeout(o,1e3)}};if(e.type===t.data.type){if(e.waitingForBuffer=!1,!e.playbackStarted&&t.data.modOffset){for(var l=e.currentAdaptation.representations,u=0;u<l.length;u++)l[u].segments=null,l[u].presentationTimeOffset+=t.data.minDiff;for(u=0;u<e.buffer.queue.length;u++)e.buffer.queue[u].offset-=t.data.minDiff;if(e.cancelPendingRequests.call(i,e.type,e.UPDATE,6),e.useFetch){var d=e.fragmentModel.getLoadingRequests();for(u=0;u<d.length;u++){for(var f=!1,c=0;c<e.buffer.queue.length;c++)if(d[u].startTime==e.buffer.queue[c].rstime){f=!0;break}f||e.fragmentModel.abortRequestForTime(d[u].startTime)}}else e.fragmentModel.abortRequests();e.setIncrementalMode.call(i,!1,8)}null!=e.buffer.updating?e.listenToCanplay&&a.readyState<3?(a.addEventListener("canplay",s),r=setTimeout(o,1e3)):e.buffer.updating?e.buffer.addEventListener("updateend",s):s():setTimeout(s,50)}},this.onCheckBufferGap=function(t){var i=e;t.data.type==e.type&&e.indexHandler.getSegmentRequestForTime(e.currentRepresentation,t.data.time,e.type,2,(function(t){if("ok"===t.status){var n=t.data;null!=n&&(e.useFetch&&e.checkRemoveQForTime.call(i,n.startTime),e.fragmentController.isFragmentLoadingOrPending(i,n)||(e.fragmentModel.addRequest(n),e.setIncrementalMode.call(i,!1,9)))}else e.logHandler.log("ERROR: getSegmentsStartTime "+t.msg)}))},this.isSchedulingRequired=function(){var t=e.videoModel.isPaused();return!t||t&&e.scheduleWhilePaused},this.hasData=function(){return null!=e.currentAdaptation&&null!=e.buffer},this.getTimeToEnd=function(){var t=e.videoModel.getCurrentTime();return e.getMSEDuration.call(e)-t},this.getMSEDuration=function(){return null!=e.mediaSource?e.mediaSource.duration:1/0},this.setMSEDuration=function(t,i){if(null!=e.mediaSource)try{e.isTargetType(e.type)&&(isNaN(e.getMSEDuration())||e.getMSEDuration()==1/0||t>e.getMSEDuration())&&(e.mediaSource.duration=t)}catch(t){e.NXDebug.debug("duration set failed!"+i)}},this.getWorkingTime=function(){return e.videoModel.getPlaybackState()?e.videoModel.getCurrentTime():e.videoModel.getStartTime()},this.getRequiredFragmentCount=function(t,i){var n=e.videoModel.getPlaybackRate(),r=(e.bufferLevel+e.sourceBufferExt.dataQduration(e.buffer,e.isSegmentTemplate))/Math.max(n,1),a=i,s=e.getRequiredBufferLength.call(e,e.waitingForBuffer,e.SCHEDULE_EXECUTE_INTERVAL/1e3,e.isDynamic,e.periodInfo.duration);e.indexHandler.getSegmentCountForDuration(e.currentRepresentation,s,r,(function(e){"ok"===e.status&&e.data>0?a(e.data):a(0)})),e.setBufferState.call(e,r,s)},this.requestNewFragment=function(){var t=e,i=e.fragmentController.getPendingRequests(t),n=e.fragmentController.getLoadingRequests(t),r=(i?i.length:0)+(n?n.length:0);e.fragmentsToLoad-r>0?(e.fragmentsToLoad--,e.loadNextFragment.call(t,e.onFragmentRequest.bind(t))):(e.state===e.VALIDATING&&e.setState.call(t,e.READY),e.finishValidation.call(e))},this.getCurrentHttpRequestLatency=function(e){var t=e.getCurrentHttpRequest();return null!==t?(t.tresponse-t.trequest)/1e3:0},this.decideBufferLength=function(t,i){var n=0==e.forceDefaultMBT?t:e.DEFAULT_MIN_BUFFER_TIME;return isNaN(i)||i<0||e.DEFAULT_MIN_BUFFER_TIME<i&&n<i?1==e.ullMode?n:Math.max(e.DEFAULT_MIN_BUFFER_TIME,n):n>=i?Math.min(i,e.DEFAULT_MIN_BUFFER_TIME):Math.min(i,n)},this.getRequiredBufferLength=function(t,i,n,r){var a=e.metricsModel.getMetricsFor("video"),s=e.metricsModel.getMetricsFor("audio");return e.BUFFER_PREFETCH_THRESHOLD+i+Math.max(e.getCurrentHttpRequestLatency.call(e,a),e.getCurrentHttpRequestLatency.call(e,s))},this.initializationDataLoads=function(t,i){for(var n=0,r=t.period.mpd.periods,a=t.getCodec(),s=void 0,o=0;o<r.length;o++)(o<e.periodInfo.index-2||e.periodInfo.index+2<o)&&(r[o].start in e.initializationData&&delete e.initializationData[r[o].start],r[o].start in e.buffer.initQ&&delete e.buffer.initQ[r[o].start]);if(e.periodInfo.start in e.initializationData||(e.initializationData[e.periodInfo.start]={}),t.index in e.initializationData[e.periodInfo.start]||(e.initializationData[e.periodInfo.start][t.index]=[]),0===e.initializationData[e.periodInfo.start][t.index].length)for(a.indexOf("hev1")>-1&&"probably"!==e.videoModel.getCanPlayType(a)&&(s=!0),e.initializationData[e.periodInfo.start][t.index]=[],n=e.availableRepresentations.length,o=0;o<e.availableRepresentations.length;o++)e.indexHandler.getInitializationData(e.availableRepresentations[o],s,e.initializationData[e.periodInfo.start][t.index],(function(r){if("ok"===r.status||e.logHandler.log(r.msg),0==--n){var a=function(){e.eventBus.dispatchEvent({type:"initDataReceived",data:{type:e.type,initData:e.initializationData[e.periodInfo.start][t.index]}}),i(!0)};!e.isDynamic&&e.silaInsertMode&&null===e.dmyData?e.indexHandler.getFillerData(e.isProtection,e.type,e.availableRepresentations[0].adaptation.getCodec(),"SILA_INSERT_MODE",(function(t){"ok"===t.status?(e.dmyData=t.data,e.logHandler.log("["+e.type+"] dmyData len: "+e.dmyData.byteLength)):e.logHandler.log("["+e.type+"]"+t.msg),a()})):"video"===e.type&&e.bDatInsertMode&&void 0===e.buffer.updating&&null===e.dmyData?e.indexHandler.getDummyData(e.isProtection,e.type,(function(t){"ok"===t.status?e.dmyData=t.data:e.logHandler.log(t.msg),a()})):a()}}));else i(!0)},this.setDummy=function(){e.silaInsertMode&&null!==e.dmyData&&(e.buffer.appendBuffer?e.buffer.appendBuffer(e.dmyData):e.buffer.append(e.dmyData))},this.clearTimer=function(){e.buffer.timerId&&clearInterval(e.buffer.timerId),e.appendFromBufferQisProcessing=!1},this.isTargetType=function(t){if("video/audio"===e.periodInfo.type)return"video"===t;if("video"===e.periodInfo.type){if("video"===t)return!0}else if("audio"===e.periodInfo.type&&"audio"===t)return!0;return!1},this.convertInitData=function(){var t,i,n;for(t in e.initializationData)for(i in e.initializationData[t])for(n in e.initializationData[t][i])e.initializationData[t][i][n].data=e.indexHandler.checkAndConvertCodecType(e.initializationData[t][i][n].data);for(t in e.buffer.initQ)for(i in e.buffer.initQ[t])for(n in e.buffer.initQ[t][i])e.buffer.initQ[t][i][n].data=e.indexHandler.checkAndConvertCodecType(e.buffer.initQ[t][i][n].data)},this.updateForLiveEdgeMPD=function(){e.NXDebug.debug("================= updateForLiveEdge ====================================");var t=e.periodInfo.mpd.liveEdgeE;return e.indexHandler.updateForLiveEdgeMPD(e.type,e.periodInfo),e.setMSEDuration.call(e,e.periodInfo.mpd.liveEdge,"updateForLiveEdgeMPD"),e.NXDebug.debug("liveEdge:"+e.periodInfo.mpd.liveEdge+", minBufferTime:"+e.minBufferTime+", startTime:"+t+", dur:"+e.mediaSource.duration),t},this.getPlaybackQuality=function(){var t,i=e.bufferLevel+e.sourceBufferExt.dataQduration(e.buffer,e.isSegmentTemplate),n=e.checkLoadingRequests.call(e,e.type,i),r=e.abrController.getPlaybackQuality(e.type,e.currentAdaptation,e.metrics,i,n,e.stalled).quality,a=new Date;if(void 0!==r&&(t=r),!0==(r!==e.requiredQuality)){if(e.requiredQuality=t,"video"===e.type&&e.cancelPendingRequests.call(e,e.type,e.UPDATE,7),e.currentRepresentation=e.getRepresentationForQuality.call(self,t),null===e.currentRepresentation||void 0===e.currentRepresentation)throw"Unexpected error!";e.isSegmentTemplate="SegmentTemplate"===e.currentRepresentation.segmentInfoType,e.clearPlayListTraceMetrics(a,e.REPRESENTATION_SWITCH_STOP_REASON),e.metrics.addRepresentationSwitch(e.type,a,e.videoModel.getCurrentTime(),e.currentRepresentation.id,void 0)}return r},this.validate=function(){var t=e,i=e.videoModel.getCurrentTime();if(e.updateBufferLevel.call(t),"video"===e.type?(e.logHandler.log_item("ctime","time: "+new Number(i).toFixed(2)+", dur: "+(isFinite(e.videoModel.getDuration())?new Number(e.videoModel.getDuration()).toFixed(2):e.videoModel.getDuration())),e.logHandler.log_item("vlog",e.type+" len: "+e.buffer.buffered.length+", buffer: "+parseInt(String(100*e.bufferLevel))/100)):e.logHandler.log_item("alog",e.type+" len: "+e.buffer.buffered.length+", buffer: "+parseInt(String(100*e.bufferLevel))/100),e.logHandler.log_slider(i,e.videoModel.getDuration()),e.checkIfSufficientBuffer.call(t),e.isSchedulingRequired.call(t)||e.initialPlayback||e.waitingForBuffer)if(e.bufferLevel<=e.STALL_THRESHOLD&&!e.stalled&&!e.videoModel.onAdjusting()&&(e.tlen>e.STALL_THRESHOLD?e.videoModel.adjustCurrentTime((function(t){e.logHandler.log("skip small buffer gap."+t)})):(e.NXDebug.log("Stalling "+e.type+" Buffer: "+e.bufferLevel),e.clearPlayListTraceMetrics(new Date,e.REBUFFERING_REASON),e.stalled=!0,e.waitingForBuffer=!0,e.bufferStartThreshold=Math.min(e.minBufferTime||e.DEFAULT_MIN_BUFFER_TIME,e.getTimeToEnd()),e.cancelPendingRequests.call(e,e.type,e.RESET,8),e.stallStream.call(t,e.stalled,6),e.abrController.getAutoSwitchBitrate()&&e.abrController.setPlaybackQuality(e.type,0))),e.state===e.READY){e.setState.call(t,e.VALIDATING);var n=e.manifestModel.getValue().mpd.minBufferTime,r=e.decideBufferLength.call(t,n,e.periodInfo.duration);e.setMinBufferTime(r),e.abrController.setMinBufferTime(r);var a=e.getPlaybackQuality.call(t);e.getRequiredFragmentCount.call(t,a,(function(i){-1===i?(e.fragmentsToLoad=0,e.setIncrementalMode.call(t,!1,10)):e.fragmentsToLoad=i>0||0==e.buffer.underThreshold?i:1,e.requestNewFragment.call(t)})),e.isDynamic&&e.setMSEDuration.call(t,e.periodInfo.mpd.liveEdge,"validate")}else e.state===e.VALIDATING&&e.setState.call(t,e.READY);else e.stop.call(t)},this.getVideoModel=function(){return e.videoModel},this.STALL_THRESHOLD=.1,this.INITIAL_PLAY_START_REASON="initial_start",this.SEEK_START_REASON="seek",this.USER_REQUEST_STOP_REASON="user_request",this.REPRESENTATION_SWITCH_STOP_REASON="representation_switch",this.REBUFFERING_REASON="rebuffering",this.WAITING="WAITING",this.READY="READY",this.VALIDATING="VALIDATING",this.LOADING="LOADING",this.RESET=1,this.UPDATE=2,this.NOCHANGE=3,this.updateDataReason=ne,this.state=this.WAITING,this.ready=!1,this.started=!1,this.waitingForBuffer=!1,this.initialPlayback=!0,this.playbackStarted=!1,this.initializationData=[],this.seeking=!1,this.seekTarget=-1,this.isSegmentTemplate=!1,this.requiredQuality=-1,this.currentQuality=-1,this.stalled=!1,this.isDynamic=!1,this.isBufferingCompleted=!1,this.isStreamCompleted=!1,this.preAppendTime=-1,this.periodInfo=null,this.fragmentsToLoad=0,this.fragmentModel=null,this.bufferLevel=0,this.tlen=0,this.fragmentDuration=0,this.appendFromBufferQisProcessing=!1,this.liveEdgeSearchRange={start:null,end:null},this.liveEdgeInitialSearchPosition=null,this.liveEdgeSearchStep=null,this.useBinarySearch=!1,this.setLiveStartTime=!1,this.currentAdaptation=null,this.buffer=null,this.forceDefaultMBT=!1,this.useFetch=!1,this.listenToCanplay=!1,this.bDatInsertMode=!1,this.silaInsertMode=!1,this.ullMode=!1,this.dmyData=null,this.isProtection=!1,this.tolerance=.15,this.incrementalMode=!1,this.playListMetrics=null,this.playListTraceMetrics=null,this.playListTraceMetricsClosed=!0,this.scheduleWhilePaused=!1,this.SCHEDULE_EXECUTE_INTERVAL=500,this.isScheduled=!1,this.bufferState=0,this.NXDebug=new s}return e.prototype.initialize=function(e,t,i,n,r,a,s,o,l,u,d,f,c,g,p,h){var y,v=this,S=this;S.setMediaSource(o),S.setVideoModel(a),S.setType(t),S.setBuffer(r),S.setFragmentController(s),this.eventBus=l,this.manifestModel=u,this.metricsModel=d,this.abrController=f,this.sourceBufferExt=c,this.indexHandler=g,this.fragmentModel=s.attachBufferController(S),s.prepareFragmentForLoading(S,this.onBytesLoadingStart,this.onBytesLoaded,this.onBytesError,this.signalStreamComplete,this.onFirstChunkLoaded,this.onChunkLoaded,this.onChunkLoadedError),this.sourceBufferExt.attachBuffer(this.buffer),this.metrics=this.metricsModel.getMetricsFor(this.type),this.listenToCanplay=void 0!==e.LISTEN_TO_CANPLAY_AFTER_SEEK&&e.LISTEN_TO_CANPLAY_AFTER_SEEK,this.bDatInsertMode=void 0!==e.BDAT_INSERT_MODE&&"video"===t&&e.BDAT_INSERT_MODE,this.silaInsertMode=void 0!==e.SILA_INSERT_MODE&&e.SILA_INSERT_MODE,this.MSE_APPEND_ENABLE_THRESHOLD="video"==t?"MSE_APPEND_ENABLE_THRESHOLD_V"in e?e.MSE_APPEND_ENABLE_THRESHOLD_V:e.MSE_APPEND_ENABLE_THRESHOLD||5:"MSE_APPEND_ENABLE_THRESHOLD_A"in e?e.MSE_APPEND_ENABLE_THRESHOLD_A:e.MSE_APPEND_ENABLE_THRESHOLD||5,this.DEFAULT_MIN_BUFFER_TIME=void 0!==e.DEFAULT_MIN_BUFFER_TIME?e.DEFAULT_MIN_BUFFER_TIME:.6,this.forceDefaultMBT=e.FORCE_DEFAULT_MBT||!1,this.useFetch=!(!e.USE_FETCH||!("fetch"in window)),this.BUFFER_PREFETCH_THRESHOLD="video"==t?"BUFFER_PREFETCH_THRESHOLD_V"in e?e.BUFFER_PREFETCH_THRESHOLD_V:e.BUFFER_PREFETCH_THRESHOLD||15:"BUFFER_PREFETCH_THRESHOLD_A"in e?e.BUFFER_PREFETCH_THRESHOLD_A:e.BUFFER_PREFETCH_THRESHOLD||15,this.EXTRACT_ALL_IDR_IN_MOOF=e.EXTRACT_ALL_IDR_IN_MOOF||!1,this.DEV_TYPE=e.DEV_TYPE||"NORMAL",this.STORE_MEASURED_DATA=e.STORE_MEASURED_DATA||!1,this.START_FROM_MPDTOP_FORLIVE=e.START_FROM_MPDTOP_FORLIVE||!1,this.ullMode="ULL_MODE"in e&&e.ULL_MODE,this.STORE_MEASURED_DATA&&this.metrics.setStoreMeasuredData(this.STORE_MEASURED_DATA),"video"===this.type?this.tolerance=Math.ceil(1e3/n.getFrameRate())/1e3:this.tolerance=Math.ceil(1024e3/n.getAudioSamplingRate())/1e3,this.videoModel.setEpsilonFor(this.type,this.tolerance),this.indexHandler.setEpsilonFor(this.type,this.tolerance),this.eventBus.addEventListener("appendedEnoughDataToStart",this.onAppendedEnoughDataToStart.bind(this)),this.eventBus.addEventListener("needToModifyOffset",this.onNeedToModifyOffset.bind(this)),this.eventBus.addEventListener("checkBufferGap",this.onCheckBufferGap.bind(this)),y=this.manifestModel.getValue(),this.isDynamic=this.manifestModel.getIsDynamic(y),this.isStreamCompleted=!1,this.abrController.setMaxQualityIndex(this.type,n.representations.length),this.indexHandler.setupRequestStatus(this.type),function(e){var t="";try{t=(t+="append"in e?'<span style="color:#e7527d">append</span>':'<span style="color:#808080">append</span>')+" "+("appendBuffer"in e?'<span style="color:#e7527d">appendBuffer</span>':'<span style="color:#808080">appendBuffer</span>')}catch(e){t="err"}m.log_item("MSE_ver","MSE: "+t)}(r),this.videoModel.setSourceBuffer(this.type,r),this.isProtection=null!==n.getContentProtectionData(),r.queue=[],r.updatingRange={start:0,end:0},r.laData=null,r.initQ={},r.quality=-1,r.asetIdx=-1,r.appendStart=!1,r.type=this.type,r.timerId=null,this.appendFromBufferQisProcessing=!1,r.lastAppendtime=-1,r.preDur=0,r.pStart=-1,r.underThreshold=!1,r.startTimeAfterSeek=Number.MAX_VALUE,r.offset=i.start,r.level=0,this.videoModel.isDummy()?this.appendFromBufferQ=function(){}:void 0!==r.updating?(this.appendFromBufferQ=this.appendFromBufferQForAB,r.timerId=setInterval(this.appendFromBufferQ.bind(S),500),r.addEventListener("updateend",(function(e){v.isDynamic&&v.setMSEDuration.call(S,i.mpd.liveEdge,"updateend");var t=v.sourceBufferExt.getAllRanges(r);if(t&&t.length>0)for(var n=0,a=t.length;n<a;n+=1)v.NXDebug.log("["+v.type+"] Buffered Range["+n+"]: "+t.start(n)+" - "+t.end(n)+", state:"+v.videoModel.getReadyState()+", c:"+v.videoModel.getCurrentTime()+", paused:"+v.videoModel.isPaused());v.updateBufferLevel.call(S)}))):(this.appendFromBufferQ=this.appendFromBufferQv01,r.timerId=setInterval(this.appendFromBufferQ.bind(S),500)),S.updateData(this.updateDataReason.INITIAL_UPDATE,n,i,p,(function(e){if("ok"==e.status){if(!v.isDynamic)return v.ready=!0,v.startPlayback.call(S),void h({status:"ok",data:e.data});var t,n;v.NXDebug.debug("================= searchForLiveEdge ===================================="),0==v.setLiveStartTime&&1==v.START_FROM_MPDTOP_FORLIVE?t=i.mpd.liveEdgeS:isNaN(p)?t=Math.max(i.mpd.liveEdgeE,i.mpd.liveEdgeS):((t=p)<i.mpd.liveEdgeS&&(t=i.mpd.liveEdgeS),t>i.mpd.liveEdgeE&&(t=i.mpd.liveEdgeE)),v.indexHandler.getSegmentRequestForTime(v.currentRepresentation,t,v.type,3,(function(e){if("ok"===e.status){var a=e.data;n=a.startTime;var s=1==v.ullMode?t:n;if((isNaN(i.mpd.liveEdgeC)||s>i.mpd.liveEdgeC)&&(i.liveEdgeC=s,i.mpd.liveEdgeC=s),!v.setLiveStartTime){var o=1==v.START_FROM_MPDTOP_FORLIVE?i.mpd.liveEdgeS:i.mpd.liveEdgeC;(isNaN(v.videoModel.getStartTime())||o>v.videoModel.getStartTime())&&v.videoModel.setStartTime(o),v.setLiveStartTime=!0}v.ready=!0,"xxxxxx"===v.DEV_TYPE?v.indexHandler.getFillerData(v.isProtection,v.type,v.currentRepresentation.adaptation.getCodec(),"FILL_UP_THE_HEAD",(function(e){"ok"===e.status?(v.dmyData=e.data,v.logHandler.log("dmyData len: "+v.dmyData.byteLength),r.appendBuffer(v.dmyData)):v.logHandler.log(e.msg),h({status:"ok",data:n})})):h({status:"ok",data:n})}else h({status:"fail",msg:e.msg})}))}else h({status:"fail",msg:e.msg})})),this.indexHandler.setIsDynamic(this.isDynamic),S.setMinBufferTime(this.decideBufferLength.call(S,y.mpd.minBufferTime,i.duration))},e.prototype.update=function(e,t,i,n){var r=this;void 0===n&&(n=!1),e.queue=this.buffer.queue,e.updatingRange=this.buffer.updatingRange,e.laData=this.buffer.laData,e.initQ=this.buffer.initQ,e.quality=this.buffer.quality,e.asetIdx=this.buffer.asetIdx,e.appendStart=this.buffer.appendStart,e.type=this.buffer.type,e.timerId=this.buffer.timerId,e.lastAppendtime=this.buffer.lastAppendtime,e.preDur=this.buffer.preDur,e.pStart=this.buffer.pStart,e.startTimeAfterSeek=this.buffer.startTimeAfterSeek,e.offset=this.buffer.offset,e.level=this.buffer.level,e.underThreshold=this.buffer.underThreshold,this.sourceBufferExt.detachBuffer(this.buffer),this.setBuffer(e),this.sourceBufferExt.attachBuffer(e),this.setMediaSource(i),this.setVideoModel(t),n&&this.convertInitData.call(this),void 0!==this.buffer.updating?(null!=this.buffer.timerId&&clearInterval(this.buffer.timerId),this.appendFromBufferQ=this.appendFromBufferQForAB,this.buffer.timerId=setInterval(this.appendFromBufferQ.bind(self),500),this.buffer.addEventListener("updateend",(function(e){var t=r.sourceBufferExt.getAllRanges(r.buffer);if(t&&t.length>0)for(var i=t.length,n=0;n<i;n+=1)r.NXDebug.log("["+r.type+"] Buffered Range["+n+"]: "+t.start(n)+" - "+t.end(n)+", state:"+r.videoModel.getReadyState()+", c:"+r.videoModel.getCurrentTime()+", paused:"+r.videoModel.isPaused());r.updateBufferLevel.call(self)}))):(null!=this.buffer.timerId&&clearInterval(this.buffer.timerId),this.appendFromBufferQ=this.appendFromBufferQv01,this.buffer.timerId=setInterval(this.appendFromBufferQ.bind(self),500))},e.prototype.getType=function(){return this.type},e.prototype.setType=function(e){this.type=e},e.prototype.getPeriodInfo=function(){return this.periodInfo},e.prototype.setVideoModel=function(e){this.videoModel=e},e.prototype.setFragmentController=function(e){this.fragmentController=e},e.prototype.getAutoSwitchBitrate=function(){return this.abrController.getAutoSwitchBitrate()},e.prototype.getData=function(){return this.currentAdaptation},e.prototype.updateData=function(e,t,i,n,r){var a=this,s=this,o=r||function(){},l=this.currentAdaptation,u=null,d=!1,f=!1;l||(l=t),this.currentAdaptation=t,this.stop.call(s),this.NXDebug.info(e),this.availableRepresentations=t.getRepresentations(),this.isDynamic=this.manifestModel.getIsDynamic(this.manifestModel.getValue()),this.indexHandler.setIsDynamic(this.isDynamic),this.isDynamic?(null!=this.currentRepresentation&&this.currentRepresentation.adaptation.period.id==i.id?u=this.currentRepresentation?this.currentRepresentation.segments:null:this.currentRepresentation=null,e===this.updateDataReason.PERIOD_CHANGE?(this.indexHandler.setupRequestStatus(t.type),this.requiredQuality=-1,this.currentQuality=-1,d=!0):e===this.updateDataReason.MPD_UPDATE&&null!=this.periodInfo&&this.periodInfo.start!=i.start&&(this.indexHandler.setupRequestStatus(t.type),this.requiredQuality=-1,this.currentQuality=-1,this.setIncrementalMode.call(s,!1,11),d=!0)):(e===this.updateDataReason.MPD_UPDATE&&(this.initializationData=[],this.buffer.initQ={},this.buffer.queue=[],this.buffer.quality=-1,this.buffer.laData=null),this.currentRepresentation=null,this.indexHandler.setupRequestStatus(t.type),this.requiredQuality=-1,this.currentQuality=-1),this.periodInfo=i,this.abrController.matchingQualityBetweenDifferentAdaptation(l,t);var c=this.abrController.getPlaybackQuality(this.type,t,this.metrics);this.currentRepresentation||(this.currentRepresentation=this.getRepresentationForQuality.call(s,c.quality),this.isSegmentTemplate="SegmentTemplate"===this.currentRepresentation.segmentInfoType),this.initializationDataLoads.call(s,t,(function(){f=!0})),this.indexHandler.getCurrentTime(this.currentRepresentation,n,(function(i){var n=function(){if(a.eventBus.removeEventListener("initDataReceived",n),"ok"===i.status){var r=i.data;a.requiredQuality=c.quality,a.currentRepresentation=a.getRepresentationForQuality.call(s,c.quality),a.isSegmentTemplate="SegmentTemplate"===a.currentRepresentation.segmentInfoType,a.isDynamic&&(a.currentRepresentation.segments=u),a.isDynamic?0==d?a.indexHandler.updateSegmentList(a.currentRepresentation,(function(e){if("ok"===e.status){var i,n=e.data;i=a.updateForLiveEdgeMPD.call(s),-1===n?(a.indexHandler.setupRequestStatus(t.type),a.setIncrementalMode.call(s,!1,12),a.start.call(s,4444),o({status:"ok",data:i})):(a.start.call(s,4444),o({status:"ok",data:i}))}else a.NXDebug.debug("ERROR:"+e.msg),o({status:"fail",msg:e.msg})})):(a.setIncrementalMode.call(s,!1,13),o({status:"ok",data:r})):e===a.updateDataReason.MPD_UPDATE?(a.fragmentController.clearAllRequestsForModel(a.fragmentModel),a.fragmentModel.abortRequests(!0),a.setIncrementalMode.call(s,!1,14),a.start.call(s,4444),o({status:"ok",data:r})):e===a.updateDataReason.INITIAL_UPDATE?"video"==a.type?s.getSegmentStartTime(r,(function(e){o({status:"ok",data:e})})):o({status:"ok",data:r}):e==a.updateDataReason.ADAPTATION_CHANGE?(a.fragmentController.clearAllRequestsForModel(a.fragmentModel),a.fragmentModel.abortRequests(!0),a.setIncrementalMode.call(s,!1,15),a.buffer.queue=[],a.buffer.quality=-1,a.start.call(s,4444),o({status:"ok",data:r})):e==a.updateDataReason.PERIOD_CHANGE?(a.setIncrementalMode.call(s,!1,16),o({status:"ok",data:r})):(a.seek.call(s,r,"["+a.type+"] end of initialize"),o({status:"ok",data:r}))}else a.logHandler.log("ERROR:::"+i.msg),o({status:"fail",msg:"updateData ERROR"})};f?n():a.eventBus.addEventListener("initDataReceived",n)}))},e.prototype.getBuffer=function(){return this.buffer},e.prototype.setBuffer=function(e){this.buffer=e},e.prototype.setMinBufferTime=function(e){this.minBufferTime=e},e.prototype.setMediaSource=function(e){this.mediaSource=e},e.prototype.isReady=function(){return this.state===this.READY},e.prototype.clearMetrics=function(){null!==this.type&&""!==this.type&&(this.metrics=null)},e.prototype.updateBufferState=function(){this.updateBufferLevel.call(this)},e.prototype.updateStalledState=function(){this.stalled=this.videoModel.isStalled(),this.checkIfSufficientBuffer.call(this)},e.prototype.setStalledState=function(e){this.stalled=e,this.waitingForBuffer=e,this.bufferStartThreshold=Math.min(this.minBufferTime||this.DEFAULT_MIN_BUFFER_TIME,this.getTimeToEnd()),this.stallStream.call(this,this.stalled,7),this.stalled&&this.abrController.getAutoSwitchBitrate()&&this.abrController.setPlaybackQuality(this.type,0)},e.prototype.appendFromQ=function(){this.appendFromBufferQ.call(this)},e.prototype.reset=function(e){this.stop.call(this),this.isStreamCompleted=!1,this.clearMetrics(),this.fragmentController.abortRequestsForModel(this.fragmentModel),this.fragmentController.detachBufferController(this.fragmentModel),this.fragmentModel=null,this.initializationData=[],this.initialPlayback=!0,this.playbackStarted=!1,this.liveEdgeSearchRange={start:null,end:null},this.liveEdgeInitialSearchPosition=null,this.useBinarySearch=!1,this.liveEdgeSearchStep=null,this.setLiveStartTime=!1,this.currentRepresentation=null,this.isSegmentTemplate=!1,this.requiredQuality=-1,this.currentQuality=-1,this.stalled=!1,this.isDynamic=!1,this.isBufferingCompleted=!1,this.preAppendTime=-1,e||(this.sourceBufferExt.abort(this.mediaSource,this.buffer),this.sourceBufferExt.removeSourceBuffer(this.mediaSource,this.buffer)),this.buffer.queue=[],this.buffer.updatingRange={start:0,end:0},this.buffer.initQ={},this.buffer.timerId&&clearInterval(this.buffer.timerId),this.buffer.timerId=null,this.appendFromBufferQisProcessing=!1,this.buffer.quality=-1,this.buffer.underThreshold=!1,this.buffer.appendStart=!1,this.currentAdaptation=null,this.buffer=null,this.requestScheduler&&(clearInterval(this.requestScheduler),this.requestScheduler=null),this.isScheduled=!1},e.prototype.getBufferState=function(){return this.bufferState},e.prototype.getSegmentStartTime=function(e,t){var i=this,n=t;this.indexHandler.getSegmentRequestForTime(this.currentRepresentation,e,this.type,9,(function(t){if("ok"===t.status){var r=t.data;n(null===r?e:r.startTime)}else i.logHandler.log("ERROR: getSegmentsStartTime "+t.msg),n(e)}))},e.prototype.getTolerance=function(){return this.tolerance},e.prototype.getIsStreamCompleted=function(){return this.isStreamCompleted},e}(),N=function(){this.indexRange=null,this.index=null,this.mediaRange=null,this.media=null,this.duration=NaN,this.replacementTime=null,this.replacementNumber=NaN,this.mediaStartTime=NaN,this.presentationStartTime=NaN,this.availabilityStartTime=NaN,this.availabilityEndTime=NaN,this.availabilityIdx=NaN,this.wallStartTime=NaN,this.representation=null},P=function(){this.ACTION_DOWNLOAD="download",this.ACTION_COMPLETE="complete",this.action="download",this.startTime=NaN,this.streamType=null,this.type=null,this.duration=NaN,this.timescale=NaN,this.range=null,this.url=null,this.baseURL=[],this.baseURLIdx=NaN,this.relativeURL=null,this.requestStartTime=NaN,this.firstByteTime=NaN,this.requestEndTime=NaN,this.total=NaN,this.loaded=NaN,this.loading=!1,this.keep=!1,this.quality=NaN,this.index=NaN,this.size=0,this.code=null,this.bufferLevelAtStartDate=NaN,this.availabilityStartTime=null,this.availabilityEndTime=null,this.wallStartTime=null,this.bandwidth=null,this.MSETimeOffset=NaN,this.periodIdx=NaN,this.pStart=NaN,this.adaptationIdx=NaN},B=function(e,t){for(;e.length<t;)e="0"+e;return e},q=function(e,t){return 4294967296*e+t},F=function(e,t){return new Promise((function(i,n){setTimeout((function(){t.aborted=!0,n(new Error("abort"))}),3e3),e.then(i,n)}))},w=function(e,t){return e.representation.startNumber+t},O=function(e){var t=e.adaptation.period.selectedBaseURLIdx;return isNaN(t)?0:t},U=function(e,t,i){var n=this;this.errHandler=f,this.timelineConverter=M,this.logHandler=m,this.replaceTokenForTemplate=function(e,t,i){for(var r,a,s,o,l=0,u=0,d=t.length,f="%0".length;;){if((l=e.indexOf("$"+t))<0)return e;if((u=e.indexOf("$",l+d))<0)return e;if((r=e.indexOf("%0",l+d))>l&&r<u)switch(a=e.charAt(u-1),s=parseInt(e.substring(r+f,u-1),10),a){case"d":case"i":case"u":o=B(i.toString(),s);break;case"x":o=B(i.toString(16),s);break;case"X":o=B(i.toString(16),s).toUpperCase();break;case"o":o=B(i.toString(8),s);break;default:return n.NXDebug.log("Unsupported/invalid IEEE 1003.1 format identifier string in URL"),e}else o=i;e=e.substring(0,l)+o+e.substring(u+1)}},this.getInitRequestUrl=function(e,t,i){var r,a=i||function(){},s=t.BaseURL[O.call(n,t)].url;null!==e?(r=e===s||-1!==e.indexOf("http://")||-1!==e.indexOf("https://")?e:s+e,a({status:"ok",data:r})):n.loadInitialization.call(self,s,(function(e){"ok"===e.status?(t.range=e.data,t.initialization=s,a({status:"ok",data:s})):a({status:"error",msg:"loadInitialization error"})}))},this.generateInitRequest=function(e,t){var i,r,a=new P;return i=e.adaptation.period,a.streamType=t,a.type="Initialization Segment",a.baseURLIdx=O.call(n,e),a.baseURL=e.BaseURL,a.relativeURL=e.initialization,a.range=e.range,a.MSETimeOffset=i.offset-e.presentationTimeOffset,r=i.start,a.availabilityStartTime=n.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(r,e.adaptation.period.mpd,n.isDynamic),a.availabilityEndTime=n.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(r+i.duration,i.mpd,n.isDynamic),a.quality=e.index,a.periodIdx=i.index,a.pStart=i.start,a.adaptationIdx=e.adaptation.index,a.representation=e,a},this.getInit=function(e,t,i){var r=i||function(){},a=null,s=null,o=n;e||r({status:"error",msg:" no representation"}),e.initialization?(a=n.generateInitRequest.call(o,e,t),r({status:"ok",data:a})):(s=e.BaseURL[O.call(n,e)].url,n.loadInitialization.call(o,s,(function(i){"ok"===i.status?(e.range=i.data,e.initialization=s,a=n.generateInitRequest.call(o,e,t),r({status:"ok",data:a})):r({status:"error",msg:i.msg})})))},this.isMediaFinished=function(e,t){var i,r,a,s=e.adaptation.period,o=e.adaptation.period.mpd.periods.length,l=!1;return n.isDynamic&&s.index==o-1||t<0?l=!1:t<e.availableSegmentsNumber?(r=n.getSegmentByIndex(t,e))&&(a=r.presentationStartTime-(s.start+s.mpd.timestampOffsetFor32bitVE),i=e.adaptation.period.duration,n.NXDebug.debug("["+e.adaptation.type+"] "+e.segmentInfoType+": "+a+" / "+i),l=a>=i):l=!0,l},this.getIndexBasedSegment=function(e,t){var i=new N,r=e.segmentDuration,a=e.adaptation.period.start+t*r,s=a+r;return i.representation=e,i.duration=r,i.presentationStartTime=a>0?a:0,i.mediaStartTime=n.timelineConverter.calcMediaTimeFromPresentationTime(i.presentationStartTime,e),i.availabilityStartTime=n.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(i.presentationStartTime,e.adaptation.period.mpd,n.isDynamic),i.availabilityEndTime=n.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(s,e.adaptation.period.mpd,n.isDynamic),i.wallStartTime=n.timelineConverter.calcWallTimeForSegment(i,n.isDynamic),i.replacementNumber=w(i,t),i.availabilityIdx=t,i},this.getSegmentsFromTimeline=function(e,t){var i,r,a,s,o,l,u,d,f,c,m,g,p,h,y=n,v=t||function(){},S=null!=e.SegmentTemplate,T=e.availableSegmentsNumber>0,E=[],b=0,D=-1,R=function(t){var i=S?r:a[D].media;return n.getTimeBasedSegment.call(y,e,b,t.d,h,i,t.mediaRange,D)};S?(i=e.SegmentTemplate.SegmentTimeline,r=e.SegmentTemplate.media):(i=e.SegmentList.SegmentTimeline,a=e.SegmentList.SegmentURLs),h=e.timescale,s=i.S,(c=n.decideSegmentListRangeForTimeline.call(y,e))&&(g=c.start,p=c.end);for(var M=0,I=s.length;M<I;M+=1)if(0!==(o=s[M]).d)if(u=0,null!=o.r&&(u=o.r),null!=o.t&&(b=o.t),u<0&&(d=(f=s[M+1])&&null!=f.t?f.t/h:e.adaptation.period.duration,u=Math.ceil((d-b/h)/(o.d/h))-1),m){if(T)break;D+=u+1}else for(l=0;l<=u;l+=1){if(D+=1,c){if(D>p){if(m=!0,T)break;continue}D>=g&&E.push(R.call(y,o))}else E.push(R.call(y,o));b+=o.d}if(!T){var k=s[0],x=n.timelineConverter.calcPresentationTimeFromMediaTime(k.t/h,e),L=n.timelineConverter.calcPresentationTimeFromMediaTime((b-o.d)/h,e);e.segmentAvailabilityRange={start:x,end:L},e.availableSegmentsNumber=D+1}v({status:"ok",data:E})},this.getSegmentsFromTemplate=function(e,t){var i,r,a,s=[],o=n,l=t||function(){},u=e.SegmentTemplate,d=null,f=e.segments,c=null,m=null;a=e.startNumber,n.waitForAvailabilityWindow.call(o,e,(function(t){if(e.segmentAvailabilityRange=t,d=n.decideSegmentListRangeForTemplate.call(o,e),i=d.start,r=d.end,null!=f){for(var g=0,p=0;p<f.length;p++)if(i<=f[p].availabilityIdx){g=p;break}if(g>0)for(p=0;p<g;p++)f.splice(0,g-1);(s=f).length>0&&(i=s[s.length-1].availabilityIdx+1)}for(p=i;p<r;p+=1)(c=n.getIndexBasedSegment.call(o,e,p)).replacementTime=(a+p-1)*e.segmentDuration,m=u.media,c.media=m,s.push(c),c=null;e.availableSegmentsNumber=r,l({status:"ok",data:s})}))},this.decideSegmentListRangeForTemplate=function(e){var t=e.segmentDuration,i=e.segmentAvailabilityRange,r=(e.segments,e.adaptation.period);return n.isDynamic,{start:Math.floor((i.start-r.start)/t),end:Math.ceil((i.end-r.start)/t)}},this.decideSegmentListRangeForTimeline=function(e){var t,i,r=NaN,a=e.segments,s=Number.POSITIVE_INFINITY,o=n.requestStatus[e.adaptation.type].index;if(n.isDynamic)return{start:0,end:s};if(!n.isDynamic&&n.requestStatus[e.adaptation.type].requestedTime)return null;if(a){if(o<0)return null;r=o}else r=o>=0?o:n.isDynamic?s:0;return n.isDynamic?(t=Math.max(r-10,0),i=Math.min(r+10,s)):(t=0,i=s),{start:t,end:i}},this.waitForAvailabilityWindow=function(e,t){var i,r,a=t||function(){},s=function(){(i=n.timelineConverter.calcSegmentAvailabilityRange(e,n.isDynamic)).end>0?a(i):(r=1e3*Math.abs(i.end),setTimeout(s,r))};s()},this.getTimeBasedSegment=function(e,t,i,r,a,s,o){var l=t/r,u=i/r,d=n.timelineConverter.calcPresentationTimeFromMediaTime(l,e),f=d+u,c=new N;return c.representation=e,c.duration=u,c.mediaStartTime=l,c.presentationStartTime=d,c.availabilityStartTime=e.adaptation.period.mpd.manifest.mpdLoadedTime,c.availabilityEndTime=n.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(f,e.adaptation.period.mpd,n.isDynamic),c.wallStartTime=n.timelineConverter.calcWallTimeForSegment(c,n.isDynamic),c.replacementTime=t,c.replacementNumber=w(c,o),c.timescale=r,c.media=a,c.mediaRange=s,c.availabilityIdx=o,c},this.getSegmentsFromList=function(e,t){var i,r,a,s,o,l=n,u=[],d=t||function(){},f=e.SegmentList,c=f.SegmentURLs.length;o=e.startNumber,n.waitForAvailabilityWindow.call(l,e,(function(t){e.segmentAvailabilityRange=t,a=n.decideSegmentListRangeForTemplate.call(l,e),s=a.start;for(var m=0;m<c;m+=1)r=f.SegmentURLs[m],(i=n.getIndexBasedSegment.call(l,e,o+m-1)).replacementTime=(o+m-1)*e.segmentDuration,i.media=r.media,i.mediaRange=r.mediaRange,i.index=r.index,i.indexRange=r.indexRange,u.push(i),i=null;e.availableSegmentsNumber=c-s,d({status:"ok",data:u})}))},this.getSegmentsFromSource=function(e,t){var i,r,a,s=n,o=e.BaseURL[O.call(n,e)].url,l=t||function(){},u=[],d=0,f=null;e.indexRange&&(f=e.indexRange),n.loadSegments.call(s,o,f,(function(t){if("ok"===t.status){for(var o=t.data,f=0,c=o.length;f<c;f+=1)i=o[f],(a=n.getTimeBasedSegment.call(s,e,i.startTime,i.duration,i.timescale,i.media,i.mediaRange,d)).presentationStartTime>=0&&u.push(a),a=null,d+=1;r=u.length,e.segmentAvailabilityRange={start:u[0].presentationStartTime,end:u[r-1].presentationStartTime},e.availableSegmentsNumber=r,l({status:"ok",data:u})}else l({status:"error",msg:t.msg})}))},this.getSegments=function(e,t){var i=t||function(){},r=n;if(n.isSegmentListUpdateRequired.call(r,e)){var a=function(t){if("ok"===t.status){var a=t.data;if(e.segments=a,a.length>0&&(e.indexOffset=a[0].availabilityIdx),n.isDynamic){var s=e.adaptation.period,o=s.mpd.periods,l=NaN,u=NaN,d=!1;if(s.start==o[0].start&&(a.length>0?(isNaN(s.mpd.liveEdgeS)||s.mpd.liveEdgeS<a[0].presentationStartTime)&&(l=a[0].presentationStartTime,d=!0):d=!1),s.start==o[o.length-1].start){var f=void 0;f=a.length>0?a[a.length-1].presentationStartTime+a[a.length-1].duration:s.start,"SegmentTemplate"==e.segmentInfoType&&(f=e.segmentAvailabilityRange.now),(isNaN(s.mpd.liveEdge)||s.mpd.liveEdge<f)&&(u=f,d=!0)}d&&n.updateLiveEdge.call(r,s,l,u)}else e.lastRequestIndex=a.length-1;i({status:"ok",data:a})}else i({status:"error",msg:"getSegments null"})};"SegmentTimeline"===e.segmentInfoType?n.getSegmentsFromTimeline.call(r,e,a):"SegmentTemplate"===e.segmentInfoType?n.getSegmentsFromTemplate.call(r,e,a):"SegmentList"===e.segmentInfoType?n.getSegmentsFromList.call(r,e,a):n.getSegmentsFromSource.call(r,e,a)}else i({status:"ok",data:e.segments})},this.updateLiveEdge=function(e,t,i){var r=!1,a=!1;isNaN(t)||(e.mpd.liveEdgeS=t,r=!0),isNaN(i)||(e.mpd.liveEdge=i,a=!0,e.mpd.liveEdgeE=Math.max(e.mpd.liveEdge-e.mpd.suggestedPresentationDelay,isNaN(e.mpd.liveEdgeS)?0:e.mpd.liveEdgeS)),n.eventBus.dispatchEvent({type:"liveEdgeUpdated",data:{liveEdgeS:e.mpd.liveEdgeS,liveEdgeE:e.mpd.liveEdgeE,liveEdge:e.mpd.liveEdge,liveEdgeSUpdated:r,liveEdgeEUpdated:a,targetLatency:e.mpd.suggestedPresentationDelay}})},this.updateForLiveEdgeMPD=function(e,t){var i=n,r=t.mpd.periods,a=r[0],s=r[r.length-1],o=a.getPrimaryMediaData(e).getRepresentations()[0],l=s.getPrimaryMediaData(e).getRepresentations()[0];n.getSegments.call(i,o,(function(e){a.start!=s.start&&n.getSegments.call(i,l,(function(e){}))}))},this.updateSegmentList=function(e,t){var i,r=n,a=-1,s=n.requestStatus[e.adaptation.type].index,o=e.adaptation.period.mpd.periods,l=e.adaptation.period.index,u=t||function(){};if(n.isDynamic&&l==o.length-1)if(null!=e.segments&&e.segments.length>0&&s>=0)for(e.indexOffset=e.segments[0].availabilityIdx;s>0;){if(null!=(i=n.getSegmentByIndex(s,e))){a=i.presentationStartTime;break}s--}else a=-1;e.segments=null,n.isDynamic&&a>=0?n.getSegments.call(r,e,(function(t){"ok"===t.status?(e.segments=t.data,n.requestStatus[e.adaptation.type].index=n.getIndexForSegments.call(r,a,e),n.requestStatus[e.adaptation.type].requestedTime=a,n.NXDebug.debug("["+e.adaptation.type+"] index:"+n.requestStatus[e.adaptation.type].index+", "+n.requestStatus[e.adaptation.type].requestedTime+"  ***** update index *****"),u({status:"ok",data:a})):(n.NXDebug.debug("ERROR:"+t.msg),a=-1,n.requestStatus[e.adaptation.type]={index:-1,requestedTime:null},u({status:"error",msg:t.msg}))})):n.getSegments.call(r,e,(function(t){"ok"===t.status?(e.segments=t.data,n.requestStatus[e.adaptation.type]={index:-1,requestedTime:null},u({status:"ok",data:a})):(n.NXDebug.debug("ERROR:"+t.msg),a=-1,u({status:"error",msg:t.msg}))}))},this.getIndexForSegments=function(e,t){var i,r,a,s=t.segments,o=s.length-1,l=-1,u=n.epsilonVal[t.adaptation.type];if(s&&s.length>0){for(var d=o;d>=0;d--)if(r=(i=s[d]).presentationStartTime,a=i.duration,e+u>=r&&e-u<=r+a){l=i.availabilityIdx;break}if(-1===l)for(d=o;d>=0;d--){if(r=(i=s[d]).presentationStartTime,a=i.duration,e+n.EPSILON>=r&&e-n.EPSILON<=r+a){l=i.availabilityIdx;break}d==o&&e-n.EPSILON>r+a&&(l=o)}}return-1===l&&(isNaN(t.segmentDuration)?(n.NXDebug.debug("Couldn't figure out a time! "+t.adaptation.type),n.NXDebug.debug("Time: "+e)):(l=Math.floor(e/t.segmentDuration),n.NXDebug.debug("#?#?#? idx: "+l+" : "+e+"/"+t.segmentDuration))),l},this.getSegmentByIndex=function(e,t){if(!t||!t.segments)return null;var i,n=t.segments.length,r=e-t.segments[0].availabilityIdx;if(!(r>-1&&r<n))return null;if(t.segments[r].availabilityIdx===e)return t.segments[r];for(var a=0;a<n;a+=1)if((i=t.segments[a]).availabilityIdx===e)return i;return null},this.isSegmentListUpdateRequired=function(e){var t=e.segments;return n.requestStatus[e.adaptation.type].index,!t||!(!n.isDynamic||"SegmentTemplate"!==e.segmentInfoType)},this.getRequestForSegment=function(e,t){if(null==e)return null;var i=new P,r=e.representation,a=r.bandwidth,s=O.call(n,r),o=e.media;return[{name:"Number",value:e.replacementNumber},{name:"Time",value:e.replacementTime},{name:"Bandwidth",value:a},{name:"RepresentationID",value:r.id}].forEach((function(e){o=n.replaceTokenForTemplate(o,e.name,e.value)})),i.streamType=t,i.type="Media Segment",i.relativeURL=o,i.baseURL=r.BaseURL,i.baseURLIdx=s,i.range=e.mediaRange,i.startTime=e.presentationStartTime,i.duration=e.duration,i.timescale=e.timescale||r.timescale,i.availabilityStartTime=e.availabilityStartTime,i.availabilityEndTime=e.availabilityEndTime,i.wallStartTime=e.wallStartTime,i.quality=r.index,i.index=e.availabilityIdx,i.bandwidth=r.bandwidth,i.periodIdx=r.adaptation.period.index,i.pStart=r.adaptation.period.start,i.adaptationIdx=r.adaptation.index,i.representation=r,i.MSETimeOffset=r.adaptation.period.offset-r.presentationTimeOffset,i},this.getForTime=function(e,t,i,r,a){var s,o,l=a||function(){},u={},d=n;e?(n.requestStatus[i].requestedTime=t,n.NXDebug.debug("["+i+"] Getting the request for time: "+t),n.getSegments.call(d,e,(function(r){"ok"===r.status?(n.requestStatus[i].index=n.getIndexForSegments.call(d,t,e),u[i]=n.requestStatus[i].index,n.isMediaFinished.call(d,e,u[i])?((s=new P).action=s.ACTION_COMPLETE,s.index=u[i],s.MSETimeOffset=e.adaptation.period.offset-e.presentationTimeOffset,s.periodIdx=e.adaptation.period.index,s.pStart=e.adaptation.period.start,s.adaptationIdx=e.adaptation.index,s.representation=e,n.NXDebug.log("["+i+"] Signal complete. period:"+s.periodIdx),l({status:"ok",data:s})):(o=n.getSegmentByIndex(u[i],e),s=n.getRequestForSegment.call(d,o,i),l({status:"ok",data:s,time:t}))):(n.NXDebug.debug("ERROR:"+r.msg),l({status:"error",msg:r.msg}))}))):l({status:"error",msg:"no representation"})},this.isInitialIndex=function(e){return-1===n.requestStatus[e].index},this.getNext=function(e,t,i){var r,a=i||function(){},s=null,o={},l=n;if(e||a({status:"error",msg:"no representation"}),-1===n.requestStatus[t].index)throw"You must call getSegmentRequestForTime first.";n.requestStatus[t].requestedTime=null,n.requestStatus[t].index+=1,o[t]=n.requestStatus[t].index,n.getSegments.call(l,e,(function(i){"ok"===i.status?(n.isMediaFinished.call(l,e,o[t])?((r=new P).action=r.ACTION_COMPLETE,r.index=o[t],r.MSETimeOffset=e.adaptation.period.offset-e.presentationTimeOffset,r.periodIdx=e.adaptation.period.index,r.pStart=e.adaptation.period.start,r.adaptationIdx=e.adaptation.index,r.representation=e,n.NXDebug.log("["+t+"] Signal complete. period:"+r.periodIdx)):(s=n.getSegmentByIndex(o[t],e),n.requestStatus[t].requestedTime=null!=s?s.presentationStartTime:null,r=n.getRequestForSegment.call(l,s,t),s||(n.requestStatus[t].index-=1)),a({status:"ok",data:r,time:n.requestStatus[t].requestedTime})):(n.NXDebug.debug("ERROR:"+i.msg),a({status:"error",msg:i.msg}))}))},this.getSegmentCountForDuration=function(e,t,i,r){var a,s,o=n,l=r||function(){},u=0;e||l({status:"error",msg:"no representation"}),n.getSegments.call(o,e,(function(e){if("ok"===e.status){var r=e.data;s=r[0].duration,i>t+1.5*s?l({status:"ok",data:-1}):(a=Math.max(t-i,0),u=Math.ceil(a/s),l({status:"ok",data:u}))}else n.NXDebug.debug("ERROR:"+e.msg),l({status:"error",msg:e.msg})}))},this.getCurrentTime=function(e,t,i){var r,a,s=n,o=i||function(){};e||o({status:"error",msg:"no representation"}),a=n.requestStatus[e.adaptation.type].index,n.getSegments.call(s,e,(function(i){if("ok"===i.status){var s=i.data;a<0?(n.isDynamic,r=t):(a=a<s[0].availabilityIdx?s[0].availabilityIdx:Math.min(s[s.length-1].availabilityIdx,a),r=n.getSegmentByIndex(a,e).presentationStartTime),o({status:"ok",data:r})}else n.NXDebug.debug("ERROR:"+i.msg),o({status:"error",msg:i.msg})}))},this.parseSIDX=function(e,t){for(var i,n,r,a,s,o,l,u,d,f=new DataView(e),c={},m=0,g=-1,p=-1;(p<0||g<0)&&m<f.byteLength;){u=f.getUint32(m),m+=4,l="";for(var h=0;h<4;h+=1)d=f.getInt8(m),l+=String.fromCharCode(d),m+=1;"moof"!==l&&"traf"!==l&&"sidx"!==l||("sidx"===l?p=m-8:"moof"===l&&(g=m-8)),m+=u-8}if(p<0)return c.reference_count=0,c;if(m=p,(r=f.getUint32(m,!1)+m)>e.byteLength)throw"sidx terminates after array buffer";for(c.version=f.getUint8(m+8),m+=12,c.timescale=f.getUint32(m+4,!1),m+=8,0===c.version?(c.earliest_presentation_time=f.getUint32(m,!1),c.first_offset=f.getUint32(m+4,!1),m+=8):(c.earliest_presentation_time=q(f.getUint32(m,!1),f.getUint32(m+4,!1)),c.first_offset=q(f.getUint32(m+8,!1),f.getUint32(m+12,!1)),m+=16),c.first_offset+=(g>=0?g:r)+(t||0),c.reference_count=f.getUint16(m+2,!1),m+=4,c.references=[],i=c.first_offset,n=c.earliest_presentation_time,h=0;h<c.reference_count;h+=1)a=(s=f.getUint32(m,!1))>>>31,s&=2147483647,o=f.getUint32(m+4,!1),m+=12,c.references.push({size:s,type:a,offset:i,duration:o,time:n,timescale:c.timescale}),i+=s,n+=o;if(m!==r)throw"Error: final pos "+m+" differs from SIDX end "+r;return c},this.parseSegments=function(e,t,i){var r,a,s,o,l;r=n.parseSIDX.call(n,e,i).references,a=[];var u=0,d=0,f=0,c=0,m=0;if(isNaN(n.MIN_SEGSIZE_FORBASE))for(var g=0,p=r.length;g<p;g+=1)(s=new N).duration=r[g].duration,s.media=t,s.startTime=r[g].time,s.timescale=r[g].timescale,o=r[g].offset,l=r[g].offset+r[g].size-1,s.mediaRange=o+"-"+l,a.push(s);else for(g=0,p=r.length;g<p;g+=1)0==d?(u=r[g].time,d=r[g].duration,f=r[g].size,c=r[g].offset,m=r[g].timescale):(d+=r[g].duration,f+=r[g].size),(d/r[g].timescale>=n.MIN_SEGSIZE_FORBASE||g==r.length-1)&&((s=new N).duration=d,s.media=t,s.startTime=u,s.timescale=m,o=c,l=c+f-1,s.mediaRange=o+"-"+l,a.push(s),d=0);return n.NXDebug.debug("Parsed SIDX box: "+a.length+" segments."),a},this.requestWithRange=function(e,t,i,r){var a=n.commonQrys.concat(),s=n.commonHdrs.concat();null!=i&&(a.push({name:"range",value:i}),s.push({name:"Range",value:"bytes="+i})),e.url=t,n.onPrepare({req:e,qrys:a,hdrs:s,xhr:e}),a.length>0&&a.forEach((function(t){e.url+=e.url.indexOf("?")>0?"&":"?",e.url+=t.name+"="+t.value})),n.useFetch?s.length>0&&s.forEach((function(e){r.headers[e.name]=e.value})):(e.open("GET",e.url,!0),e.responseType="arraybuffer",s.length>0&&s.forEach((function(t){e.setRequestHeader(t.name,t.value)})),e.send(null))},this.findInit=function(e,t,i){var r,a,s,o,l=i||function(){},u=new DataView(e),d=0,f="",c=0,m=!1,g=n;for(n.NXDebug.log("Searching for initialization.");"moov"!==f&&d<u.byteLength;){c=u.getUint32(d),d+=4,f="";for(var p=0;p<4;p+=1)a=u.getInt8(d),f+=String.fromCharCode(a),d+=1;"moov"!==f&&(d+=c-8)}if("moov"!==f)if(n.NXDebug.log("Loading more bytes to find initialization."),t.range.start=0,t.range.end=t.bytesLoaded+t.bytesToLoad,n.useFetch){var h={method:"GET",headers:{},credentials:"same-origin"};s={},n.requestWithRange(s,t.url,t.range.start+"-"+t.range.end,h),F(fetch(s.url,h),{aborted:!1}).then((function(e){return t.bytesLoaded=t.range.end,1==e.ok?e.arrayBuffer():Promise.reject(new Error("res.false"))})).then((function(e){t.bytesLoaded=t.range.end,n.onSuccess({status:s.status,req:s,xhr:s}),n.findInit.call(g,e,t,(function(e){"ok"===e.status?l({status:"ok",data:e.data}):l({status:"error",msg:"Error loading initialization"})}))})).catch((function(e){n.onError({status:s.status,req:s,xhr:s}),l({status:"error",msg:"Error loading initialization"})}))}else(s=new XMLHttpRequest).onloadend=function(){m||l({status:"error",msg:"Error loading initialization"})},s.onload=function(){m=!0,t.bytesLoaded=t.range.end,n.onSuccess({status:s.status,req:s,xhr:s}),n.findInit.call(g,s.response,t,(function(e){"ok"===e.status?l({status:"ok",data:e.data}):l({status:"error",msg:"Error loading initialization"})}))},s.onerror=function(){n.onError({status:s.status,req:s,xhr:s}),l({status:"error",msg:"Error loading initialization"})},n.requestWithRange(s,t.url,t.range.start+"-"+t.range.end,null);else o=(r=d-8)+"-"+(r+c-1),n.NXDebug.log("Found the initialization.  Range: "+o),l({status:"ok",data:o})},this.loadInitializationX=function(e,t){var i=t||function(){},r=new XMLHttpRequest,a=!0,s=n,o={url:e,range:{},searching:!1,bytesLoaded:0,bytesToLoad:1500,request:r};n.NXDebug.log("Start searching for initialization."),o.range.start=0,o.range.end=o.bytesToLoad,r.onload=function(){r.status<200||r.status>299||(a=!1,o.bytesLoaded=o.range.end,n.onSuccess({status:r.status,req:r,xhr:r}),n.findInit.call(s,r.response,o,(function(e){"ok"===e.status?i({status:"ok",data:e.data}):i({status:"error",msg:"findInit error"})})))},r.onloadend=r.onerror=function(){a&&(a=!1,n.onError({status:r.status,req:r,xhr:r}),n.errHandler.downloadError(n.eventBus,"initialization",o.url,r),i({status:"error",msg:"initialization load error"}))},n.requestWithRange(r,o.url,o.range.start+"-"+o.range.end,null),n.NXDebug.log("Perform init search: "+o.url)},this.loadInitializationF=function(e,t){var i=t||function(){},r={},a={method:"GET",headers:{},credentials:"same-origin"},s=n,o={url:e,range:{},searching:!1,bytesLoaded:0,bytesToLoad:1500,request:r};n.NXDebug.log("Start searching for initialization."),o.range.start=0,o.range.end=o.bytesToLoad,n.requestWithRange(r,o.url,o.range.start+"-"+o.range.end,a),n.NXDebug.log("Perform init search: "+o.url),F(fetch(r.url,a),{aborted:!1}).then((function(e){return 1==e.ok?e.arrayBuffer():Promise.reject(new Error("res.false"))})).then((function(e){o.bytesLoaded=o.range.end,n.onSuccess({status:r.status,req:r,xhr:r}),n.findInit.call(s,e,o,(function(e){"ok"===e.status?i({status:"ok",data:e.data}):i({status:"error",msg:"findInit error"})}))})).catch((function(e){n.onError({status:r.status,req:r,xhr:r}),n.errHandler.downloadError(n.eventBus,"initialization",o.url,r),i({status:"error",msg:"initialization load error"})}))},this.loadInitialization=function(e,t){return n.useFetch?n.loadInitializationF(e,t):n.loadInitializationX(e,t)},this.extractChunk=function(e,t,i,r){for(var a,s,o,l,u,d=[],f=e.progress,c=e.chunkEnd,m=c,g=[],p=c,h=0,y=e.chunkDur,v=0,S=0,T=0,E=e.chunkStartTime,b=-1,D=0,R=function(e){for(var t=0,i=0;i<f.length;i++)if(e<(t+=f[i].length))return f[i][f[i].length-(t-e)];return null},M=function(e,t){for(var i=0,n=0,r=0;r<f.length;r++){if(t<i+(n=f[r].length))return void(f[r][t-i]=e);i+=n}},I=function(e,t){return(255&e(t))*Math.pow(2,24)+((255&e(t+1))<<16|(255&e(t+2))<<8|255&e(t+3))},k=function(e,t){var i=new DataView(new ArrayBuffer(4));return i.setUint8(0,e(t)),i.setUint8(1,e(t+1)),i.setUint8(2,e(t+2)),i.setUint8(3,e(t+3)),i.getInt32(0)},x=function(){s=I(R,m),m+=4,a="";for(var c=0;c<4;c+=1)o=R(m),a+=String.fromCharCode(o),m+=1;if("emsg"!==a&&"moof"!==a&&"traf"!==a&&"tfdt"!==a&&"tfhd"!==a&&"trun"!==a&&"mdat"!==a&&"sidx"!==a)m+=s-8;else if("emsg"===a){var x={};l=R(m),x.typePos=m-4,x.data=function(e,i,n){var r,a=0,s=i,o=0,l=0;if(t-i<n)return null;r=new Uint8Array(n);for(var u=0;u<e.length;u++){for(o=e[u].length;s<a+o;){if(r[l]=e[u][s-a],++l==n)return r;s++}a+=o}return null}(f,m-8,s),1==l?(n.parseEmsg(x.data,0,x.data.length,NaN,i),M(102,x.typePos),M(114,x.typePos+1),M(101,x.typePos+2),M(101,x.typePos+3)):g.push(x),m+=s-8}else if("sidx"===a){if(1==n.deleteUnnecessaryBox){var L={};L.typePos=m-4,d.push(L)}m+=s-8}else if("moof"===a);else if("traf"===a);else if("tfdt"==a){u=m+s-8,l=R(m),m+=1,m+=3;var _=(0==l?I(R,m):q(I(R,m),I(R,m+4)))/e.params.timescale+e.offset;T+=_,g.forEach((function(e){e.startTime=_,n.parseEmsg(e.data,0,e.data.length,e.startTime,i),M(102,e.typePos),M(114,e.typePos+1),M(101,e.typePos+2),M(101,e.typePos+3)})),g=[],m=u}else if("tfhd"===a){var A=void 0;u=m+s-8,m+=1,A=R(m+=2),m++,m+=4,1&A&&(m+=8),2&A&&(m+=4),8&A?(D=I(R,m),m+=4):D=e.params.dsd,16&A&&(m+=4),32&A&&("audio"==r&&(1==(1&R(m))&&M(R(m)+1,m),1==(1&R(m+1))&&M(R(m+1)-1,m+1)),m+=4),m=u}else if("trun"===a){var C,N,P,B,F;u=m+s-8,l=R(m);var w=function(e,t){return(255&e(t))<<8|255&e(t+1)}(R,m+=1);if(A=R(m+=2),N=1&w,P=2&w,B=4&w,F=8&w,C=I(R,m+=1),m+=4,1&A&&(m+=4),4&A&&(m+=4),N){var O=0;for(c=0;c<C;c++)O+=I(R,m),m+=4,P&&(m+=4),B&&(m+=4),F&&(0==c&&(T+=(l?k(R,m)/e.params.timescale:I(R,m))/e.params.timescale),m+=4);S=O/e.params.timescale}else S=D*C/e.params.timescale,F&&(P&&(m+=4),B&&(m+=4),T+=(l?k(R,m)/e.params.timescale:I(R,m))/e.params.timescale);m=u}else"mdat"===a&&((u=m+s-8)<=t?(p=u,y+=S,E<0&&(E=T)):(h=u,v=S,b=T),m=u,1==n.deleteUnnecessaryBox&&(d.forEach((function(e){M(102,e.typePos),M(114,e.typePos+1),M(101,e.typePos+2),M(101,e.typePos+3)})),d=[]))};m+8<t;)x();return{curChunkEnd:p,nextChunkEnd:h,curChunkDur:y,nextChunkDur:v,curChunkStartTime:E,nextChunkStartTime:b}},this.parseEmsg=function(e,t,i,r,a){var s,l,u=t,d=Math.pow(256,2),f=Math.pow(256,3),c=Math.max(isNaN(r)?0:r,0),m=void 0,g=void 0,p=1,h=0,y=0,v=0,S=void 0,T=0,E={},b=!1,D=[],R=0;if(0==e[u+8]){for(D=["","",0,0,0,0],R=0,l=u+12;l<i+u;)0===R||1==R?(0!==e[l]?D[R]+=String.fromCharCode(e[l]):R+=1,l+=1):6==R?(D[R]=e.subarray(l,i),l=i+u):(D[R]=e[l]*f+e[l+1]*d+256*e[l+2]+1*e[l+3],l+=4,R+=1);m=D[0],g=D[1],p=D[2],h=D[3],y=D[4],v=D[5],S=D[6],T=(c*p+h)/p}else{for(D=[0,0,0,0,"",""],R=0,l=u+12;l<i+u;)if(4===R||5==R)0!==e[l]?D[R]+=String.fromCharCode(e[l]):R+=1,l+=1;else if(6==R)D[R]=e.subarray(l,i),l=i+u;else if(1==R){var M=e[l]*f+e[l+1]*d+256*e[l+2]+1*e[l+3],I=e[l+4]*f+e[l+5]*d+256*e[l+6]+1*e[l+7];D[R]=q(M,I),l+=8,R+=1}else D[R]=e[l]*f+e[l+1]*d+256*e[l+2]+1*e[l+3],l+=4,R+=1;m=D[4],g=D[5],p=D[0],T=D[1]/p,y=D[2],v=D[3],S=D[6],h=0}E.schemeIdUri=m,E.value=g,E.timescale=p,E.duration=y,E.id=v,E.presentationTime=T,E.messageData=S,E.presentationTimeDelta=h,o(a,m)?0==function(e,t){for(var i=0;i<e.length;i++)if(null!=e[i].id&&e[i].id==t)return!0;return!1}(a[m],E.id)&&(a[m].push(E),s=a[m],b=!0):(a[m]=[],a[m].push(E),s=a[m],b=!0),b&&n.eventBus.dispatchEvent({type:"DASHEVENT_RECEIVED",data:{type:"inband",event:E,eventList:s,index:s.length-1}}),e[u+4]=102,e[u+5]=114,e[u+6]=101,e[u+7]=101},this.extractIDRinMOOF=function(e,t,i){for(var n,r,a,s,o,l,u,d,f=e,c=0,m=t||1,g=[],p=0,h=function(e,t){return(255&f[t])*Math.pow(2,24)+((255&f[t+1])<<16|(255&f[t+2])<<8|255&f[t+3])},y=function(e,t){return(255&e[t])<<8|255&e[t+1]},v=function(e,t,i){e[t]=i/Math.pow(2,24)&255,e[t+1]=i>>16&255,e[t+2]=i>>8&255,e[t+3]=255&i},S=function(e,t,i){e[t]=i>>8&255,e[t+1]=255&i};c<f.length;){r=h(0,c),c+=4,n="";for(var T=0;T<4;T+=1)a=f[c],n+=String.fromCharCode(a),c+=1;if("moof"!==n&&"traf"!==n&&"tfhd"!==n&&"tfdt"!==n&&"trun"!==n&&"mdat"!==n&&"senc"!=n&&"saio"!=n)c+=r-8;else if("moof"===n){var E=c-8;g.push({offset:E}),g[p].moofPos=E,g[p].moofSize=r,p++}else if("traf"===n)g[p-1].trafPos=c-8,g[p-1].trafSize=r;else if("tfhd"===n)s=c+r-8,l=y(f,c+=1),u=f[c+=2],c++,c+=4,1&u&&(c+=8),2&u&&(c+=4),8&u&&(g[p-1].defaultSampleDuration=h(0,c),c+=4),16&u&&(g[p-1].defaultSampleSize=h(0,c),c+=4),32&u&&(g[p-1].defaultSampleFlags=h(0,c),c+=4),c=s;else if("tfdt"===n){s=c+r-8,o=f[c],c+=1,c+=3;var b=(0==o?h(0,c):q(h(0,c),h(0,c+4)))/m;g[p-1].time=b,c=s}else if("trun"===n){g[p-1].trunPos=c-8,g[p-1].trunSize=r,s=c+r-8,o=f[c],l=y(f,c+=1),u=f[c+2];var D=h(0,c+=3),R=0,M=0,I=1&l,k=2&l,x=4&l,L=8&l,_=void 0;if(x)return e;var A=new ArrayBuffer(r+4*D),C=new Uint8Array(A),N=0;for(v(C,d=0,r+4*D),v(C,d+=4,1953658222),C[d+=4]=o,S(C,d+=1,l+4),C[d+=2]=u-4,v(C,++d,D),d+=4,c+=4,1&u&&(R=h(0,c),c+=4,v(C,d,R+4*D),d+=4),4&u&&(M=h(0,c),c+=4),_=R+g[p-1].moofPos,T=0;T<D;T++){var P=0;I&&(v(C,d,h(0,c)),c+=4,d+=4),k&&(P=h(0,c),c+=4,v(C,d,P),d+=4);for(var B=_,F=void 0,w=void 0;B<_+P;){if(F=h(0,B),B+=4,i.indexOf("avc")>-1){if(5==(w=31&f[B])){v(C,d,M),d+=4,N++;break}if(1==w){0==T?(v(C,d,M),N++):g[p-1].defaultSampleFlags?v(C,d,g[p-1].defaultSampleFlags):v(C,d,65536),d+=4;break}}else{if(19==(w=f[B]>>1&63)||20==w){v(C,d,M),d+=4,N++;break}if(w<19){0==T?(v(C,d,M),N++):g[p-1].defaultSampleFlags?v(C,d,g[p-1].defaultSampleFlags):v(C,d,65536),d+=4;break}}B+=F}_+=P,L&&(v(C,d,h(0,c)),c+=4,d+=4)}if(N<2)return e;v(C,d,0),c+=4,g[p-1].trunExp=x?0:4*D,g[p-1].modTrun=C,c=s,g[p-1].trunEnd=c}else if("senc"===n)g[p-1].sencPos=c-8,g[p-1].sencSize=r,c=c-8+r;else if("saio"===n){var O;if(s=c-8+r,g[p-1].checkSaio=!0,g[p-1].saioPos=c-8,g[p-1].saioSize=r,o=f[c],c++,l=y(f,c),u=f[c+=2],c++,1&u&&(c+=8),O=h(0,c),c+=4,O>1)return e;g[p-1].saioOffsetPos=c,g[p-1].saioVersion=o,c=s}else"mdat"===n&&(g[p-1].mdatPos=c-8,g[p-1].mdatSize=r,c=c-8+r)}var U=0;for(T=0;T<g.length;T++)U+=g[T].moofSize+g[T].mdatSize+g[T].trunExp;var H=new ArrayBuffer(U),K=new Uint8Array(H);for(d=0,T=0;T<g.length;T++){var X=g[T],V=void 0,Q=d;if(V=e.subarray(X.moofPos,X.trunPos),K.set(V,d),v(K,Q,X.moofSize+X.trunExp),v(K,Q+X.trafPos-X.moofPos,X.trafSize+X.trunExp),d+=V.length,K.set(X.modTrun,d),d+=X.modTrun.length,X.trunEnd!=X.mdatPos){if(V=e.subarray(X.trunEnd,X.mdatPos),K.set(V,d),X.checkSaio)if(X.sencPos<X.trunPos);else{var z;z=X.trunPos<X.saioPos?X.saioOffsetPos-X.trunEnd+d:X.saioOffsetPos-X.moofPos+Q,0==X.saioVersion?v(K,z,h(0,z)+X.trunExp):v(K,z+4,h(0,z+4)+X.trunExp)}d+=X.mdatPos-X.trunEnd}V=e.subarray(X.mdatPos,X.mdatPos+X.mdatSize),K.set(V,d),d+=X.mdatSize}return e=void 0,K},this.parseFragment=function(e,t,i,r,a,s){for(var o,l,u,d,f,c,m=0,g=t||1,p=[],h=[],y=0,v=0,S=0,T=function(e,t){return(255&e[t])*Math.pow(2,24)+((255&e[t+1])<<16|(255&e[t+2])<<8|255&e[t+3])},E=function(e,t){return(255&e[t])<<8|255&e[t+1]},b=function(e,t){var i=new DataView(new ArrayBuffer(4));return i.setUint8(0,e[t]),i.setUint8(1,e[t+1]),i.setUint8(2,e[t+2]),i.setUint8(3,e[t+3]),i.getInt32(0)};m<e.length;){u=T(e,m),m+=4,l="";for(var D=0;D<4;D+=1)d=e[m],l+=String.fromCharCode(d),m+=1;if("emsg"!==l&&"moof"!==l&&"traf"!==l&&"tfdt"!==l&&"tfhd"!==l&&"trun"!==l&&"sidx"!==l)m+=u-8;else if("emsg"===l){var R={};R.sizePos=m-8,R.size=u,h.push(R),m+=u-8}else if("sidx"===l)1==n.deleteUnnecessaryBox&&(e[m-4]=102,e[m-3]=114,e[m-2]=101,e[m-1]=101),m+=u-8;else if("moof"===l)o=m-8,0==y?p.push({time:0,offset:0}):p.push({time:0,offset:o}),y++;else if("tfdt"===l){var M,I=e[m];c=m+u-8,m+=1,m+=3,M=0==I?T(e,m):q(T(e,m),T(e,m+4)),v+=M/g+r,p[y-1].time+=v,y>1&&(p[y-2].size=p[y-1].offset-p[y-2].offset),h.length>0&&(h.forEach((function(t){n.parseEmsg(e,t.sizePos,t.size,v,s)})),h=[]),m=c}else if("tfhd"===l){var k=void 0;c=m+u-8,m+=1,k=e[m+=2],m++,m+=4,1&k&&(m+=8),2&k&&(m+=4),8&k?(S=T(e,m),m+=4):S=i,16&k&&(m+=4),32&k&&("audio"==a&&(1==(1&e[m])&&(e[m]+=1),1==(1&e[m+1])&&(e[m+1]-=1)),m+=4),p[y-1].defaultSampleDuration=S,m=c}else if("trun"===l){var x,L,_,A,C,N=0,P=0;c=m+u-8,f=e[m];var B=E(e,m+=1);if(k=e[m+=2],L=1&B,_=2&B,A=4&B,C=8&B,x=T(e,m+=1),m+=4,1&k&&(m+=4),4&k&&(m+=4),L){var F=0;for(D=0;D<x;D++)F+=T(e,m),m+=4,_&&(m+=4),A&&(m+=4),C&&(0==D&&(P=(f?b(e,m)/g:T(e,m))/g,v+=P,p[y-1].time+=P),m+=4);N=F/g}else N=p[y-1].defaultSampleDuration*x/g,C&&(_&&(m+=4),A&&(m+=4),P=(f?b(e,m)/g:T(e,m))/g,v+=P,p[y-1].time+=P);p[y-1].dur=N,m=c}}return 1==y?p[0].size=e.length:y>1&&(p[y-1].size=e.length-p[y-1].offset),p},this.checkAndConvertCodecType=function(e){for(var t,i=0;i<e.length-4;i++)if(1751479857==((255&e[t=i])<<24|(255&e[t+1])<<16|(255&e[t+2])<<8|255&e[t+3])){e[i]=104,e[i+1]=118,e[i+2]=99,e[i+3]=49,n.logHandler.log("#### convert HEV1 to  HVC1 #####");break}return e},this.getMoovParams=function(e,t){for(var i,r,a,s,o,l=0,u=0,d=0,f=function(t){return(255&e[t])*Math.pow(2,24)+((255&e[t+1])<<16|(255&e[t+2])<<8|255&e[t+3])};l<e.length;){r=f(l),l+=4,i="";for(var c=0;c<4;c+=1)a=e[l],i+=String.fromCharCode(a),l+=1;if("moov"!==i&&"trak"!==i&&"mdia"!==i&&"mdhd"!==i&&"mvex"!==i&&"trex"!==i&&"edts"!==i)l+=r-8;else if("edts"==i)1==n.deleteUnnecessaryBox&&(e[l-4]=102,e[l-3]=114,e[l-2]=101,e[l-1]=101),l+=r-8;else if("mdhd"==i){if(s=l+r-8,o=e[l],l++,l+=3,1==o?(l+=8,l+=8):(l+=4,l+=4),u=f(l),0!=d)break;l=s}else if("trex"==i){if(s=l+r-8,o=e[l],l++,d=f(l+=11),l+=4,"audio"==t&&(1==(1&e[l])&&(e[l]+=1),l++,1==(1&e[l])&&(e[l]-=1)),0!=u)break;l=s}}return{timescale:u,dsd:d}},this.getInitializationDataX=function(e,t,i,r){var a,s=r||function(){},o=n,l=new XMLHttpRequest,u=!0;n.getInitRequestUrl(e.initialization,e,(function(r){"ok"===r.status?(a=r.data,l.onload=function(){l.status<200||l.status>299||(u=!1,i[e.index]={},i[e.index].data=void 0===t?new Uint8Array(l.response):n.checkAndConvertCodecType.call(o,new Uint8Array(l.response)),i[e.index].params=n.getMoovParams.call(o,i[e.index].data,e.adaptation.type),s({status:"ok",data:i[e.index]}))},l.onloadend=l.onerror=function(){u&&(n.onError({status:l.status,req:l,xhr:l}),u=!1,s({status:"error",msg:"getInitializationData failed"}))},n.requestWithRange(l,a,null!=e.range?e.range:null,null)):s({status:"error",msg:r.msg})}))},this.getInitializationDataF=function(e,t,i,r){var a,s=r||function(){},o=n,l={},u={method:"GET",headers:{},credentials:"same-origin"};n.getInitRequestUrl(e.initialization,e,(function(r){"ok"===r.status?(a=r.data,n.requestWithRange(l,a,null!=e.range?e.range:null,u),fetch(l.url,u).then((function(e){return 1==e.ok?e.arrayBuffer():Promise.reject(new Error("res.false"))})).then((function(r){n.onSuccess({status:l.status,req:l,xhr:l}),i[e.index]={},i[e.index].data=void 0===t?new Uint8Array(r):n.checkAndConvertCodecType.call(o,new Uint8Array(r)),i[e.index].params=n.getMoovParams.call(o,i[e.index].data,e.adaptation.type),s({status:"ok",data:i[e.index]})})).catch((function(e){n.onError({status:l.status,req:l,xhr:l}),s({status:"error",msg:"getInitializationData failed"})}))):s({status:"error",msg:r.msg})}))},this.getInitializationData=function(e,t,i,r){n.useFetch?n.getInitializationDataF(e,t,i,r):n.getInitializationDataX(e,t,i,r)},this.getFillerData=function(e,t,i,r,a){var s,o=a||function(){},l=!0,u="";if("SILA_INSERT_MODE"==r?"video"===t?i.indexOf("avc")>0?u=e?"asset/b2k_ff_i05.dat":"asset/b2k_no_i05.dat":i.indexOf("hvc")>0?u=e?"asset/b4k_ff_v_vc_i05.dat":"asset/b4k_no_v_vc_i05.dat":i.indexOf("hev")>0&&(u=e?"asset/b4k_ff_v_ev_i05.dat":"asset/b4k_no_v_ev_i05.dat"):u=e?"asset/si_ff_a.dat":"asset/si_no_a.dat":"FILL_UP_THE_HEAD"==r&&("video"===t?i.indexOf("avc")>0?u=e?"asset/b2k_ff_v_i10.dat":"asset/b2k_no_v_i10.dat":i.indexOf("hvc")>0?u=e?"asset/b4k_ff_v_vc_i10.dat":"asset/b4k_no_v_vc_i10.dat":i.indexOf("hev")>0&&(u=e?"asset/b4k_ff_v_ev_i10.dat":"asset/b4k_no_v_ev_i10.dat"):u=e?"asset/b4k_ff_a_i10.dat":"asset/b4k_no_a_i10.dat"),n.useFetch){var d={method:"GET",headers:{},credentials:"same-origin"};s={},n.requestWithRange(s,u,null,d),fetch(s.url,d).then((function(e){return 1==e.ok?e.arrayBuffer():Promise.reject(new Error("res.false"))})).then((function(e){n.onSuccess({status:s.status,req:s,xhr:s}),o({status:"ok",data:e})})).catch((function(e){n.onError({status:s.status,req:s,xhr:s}),o({status:"error",msg:"getFillerData failed"})}))}else(s=new XMLHttpRequest).onload=function(){s.status<200||s.status>299||(n.onSuccess({status:s.status,req:s,xhr:s}),l=!1,o({status:"ok",data:s.response}))},s.onloadend=s.onerror=function(){l&&(l=!1,n.onError({status:s.status,req:s,xhr:s}),o({status:"error",msg:"getFillerData failed"}))},n.requestWithRange(s,u,null,null)},this.getDummyData=function(e,t,i){var r,a=i||function(){},s=!0,o="";if("video"===t&&(o=e?"asset/b20_ff_v_i20_05.dat":"asset/b20_no_v_i20_i05.dat"),n.useFetch){var l={method:"GET",headers:{},credentials:"same-origin"};r={},n.requestWithRange(r,o,null,l),fetch(r.url,l).then((function(e){return 1==e.ok?e.arrayBuffer():Promise.reject(new Error("res.false"))})).then((function(e){n.onSuccess({status:r.status,req:r,xhr:r}),a({status:"ok",data:e})})).catch((function(e){n.onError({status:r.status,req:r,xhr:r}),a({status:"error",msg:"getDummyData failed"})}))}else(r=new XMLHttpRequest).onload=function(){r.status<200||r.status>299||(n.onSuccess({status:r.status,req:r,xhr:r}),s=!1,a({status:"ok",data:r.response}))},r.onloadend=r.onerror=function(){s&&(n.onError({status:r.status,req:r,xhr:r}),s=!1,a({status:"error",msg:"getDummyData failed"}))},n.requestWithRange(r,o,null,null)},this.findSIDX=function(e,t,i){var r,a,s,o,l,u,d,f,c=i||function(){},m=new DataView(e),g=0,p="",h=0,y=!0,v=!1,S=n;for(n.NXDebug.log("Searching for SIDX box."),n.NXDebug.log(t.bytesLoaded+" bytes loaded.");"sidx"!==p&&g<m.byteLength;){h=m.getUint32(g),g+=4,p="";for(var T=0;T<4;T+=1)u=m.getInt8(g),p+=String.fromCharCode(u),g+=1;"sidx"!==p&&(g+=h-8)}if(a=m.byteLength-g,"sidx"!==p)c({status:"error",msg:"We didn't download enough bytes to find the sidx."});else if(a<h-8)if(n.NXDebug.log("Found SIDX but we don't have all of it."),t.range.start=0,t.range.end=t.bytesLoaded+(h-a),n.useFetch){var E={method:"GET",headers:{},credentials:"same-origin"};r={},n.requestWithRange(r,t.url,t.range.start+"-"+t.range.end,E),fetch(r.url,E).then((function(e){return 1==e.ok?e.arrayBuffer():Promise.reject(new Error("res.false"))})).then((function(e){t.bytesLoaded=t.range.end,n.onSuccess({status:r.status,req:r,xhr:r}),n.findSIDX.call(S,e,t,(function(e){"ok"===e.status?c({status:"ok",data:e.data}):c({status:"error",msg:"find SIDX error"})}))})).catch((function(e){n.onError({status:r.status,req:r,xhr:r}),n.errHandler.downloadError(n.eventBus,"SIDX",t.url,r),c({status:"error",msg:"findSIDX request error"})}))}else(r=new XMLHttpRequest).onload=function(){r.status<200||r.status>299||(y=!1,t.bytesLoaded=t.range.end,n.onSuccess({status:r.status,req:r,xhr:r}),n.findSIDX.call(S,r.response,t,(function(e){"ok"===e.status?c({status:"ok",data:e.data}):c({status:"error",msg:"find SIDX error"})})))},r.onloadend=r.onerror=function(){y&&(y=!1,n.onError({status:r.status,req:r,xhr:r}),n.errHandler.downloadError(n.eventBus,"SIDX",t.url,r),c({status:"error",msg:"findSIDX request error"}))},n.requestWithRange(r,t.url,t.range.start+"-"+t.range.end,null);else if(t.range.start=g-8,t.range.end=t.range.start+h,n.NXDebug.log("Found the SIDX box.  Start: "+t.range.start+" | End: "+t.range.end),s=new ArrayBuffer(t.range.end-t.range.start),l=new Uint8Array(s),o=new Uint8Array(e,t.range.start,t.range.end-t.range.start),l.set(o),d=n.parseSIDX.call(n,s,t.range.start),null!=(f=d.references)&&f.length>0&&(v=1===f[0].type),v){n.NXDebug.log("Initiate multiple SIDX load.");for(var b,D=void 0,R=void 0,M=void 0,I=new Array(f.length),k=f.length,x=function(e,i){D=f[e].offset,R=f[e].offset+f[e].size-1,M=D+"-"+R,n.loadSegments.call(S,t.url,M,(function(t){if("ok"===t.status?(k--,I[e]=t.data):k--,0===k){b=[];for(var i=0;i<I.length;i++)b=b.concat(I[i]);c({status:"ok",data:b})}}))},L=0,_=f.length;L<_;L+=1)x(L)}else n.NXDebug.log("Parsing segments from SIDX."),c({status:"ok",data:n.parseSegments.call(S,s,t.url,t.range.start)})},this.loadSegments=function(e,t,i){var r,a,s=i||function(){},o=!0,l=n,u={url:e,range:{},searching:!1,bytesLoaded:0,bytesToLoad:1500,request:r};if(null===t?(n.NXDebug.log("No known range for SIDX request."),u.searching=!0,u.range.start=0,u.range.end=u.bytesToLoad):(a=t.split("-"),u.range.start=parseFloat(a[0]),u.range.end=parseFloat(a[1])),n.useFetch){var d={method:"GET",headers:{},credentials:"same-origin"};r={},n.requestWithRange(r,u.url,u.range.start+"-"+u.range.end,d),n.NXDebug.debug("Perform SIDX load: "+u.url),fetch(r.url,d).then((function(e){return 1==e.ok?e.arrayBuffer():Promise.reject(new Error("res.false"))})).then((function(e){u.searching?(u.bytesLoaded=u.range.end,n.onSuccess({status:r.status,req:r,xhr:r}),n.findSIDX.call(l,e,u,(function(e){s(e)}))):s({status:"ok",data:n.parseSegments.call(l,e,u.url,u.range.start)})})).catch((function(e){n.onError({status:r.status,req:r,xhr:r}),n.errHandler.downloadError(n.eventBus,"SIDX",u.url,r),s({status:"error",msg:"loadSegments error"})}))}else(r=new XMLHttpRequest).onload=function(){var e=u.url.split("/");n.logHandler.log_d(r.status+": "+e[e.length-1]+" , "+u.range.start+"-"+u.range.end+" sidx"),r.status<200||r.status>299||(o=!1,n.onSuccess({status:r.status,req:r,xhr:r}),u.searching?(u.bytesLoaded=u.range.end,n.findSIDX.call(l,r.response,u,(function(e){s(e)}))):s({status:"ok",data:n.parseSegments.call(l,r.response,u.url,u.range.start)}))},r.onloadend=r.onerror=function(){o&&(o=!1,n.onError({status:r.status,req:r,xhr:r}),n.errHandler.downloadError(n.eventBus,"SIDX",u.url,r),s({status:"error",msg:"loadSegments error"}))},n.requestWithRange(r,u.url,u.range.start+"-"+u.range.end,null),n.NXDebug.debug("Perform SIDX load: "+u.url)},this.setupRequestStatus=function(e,t,i){var r=t||-1;n.requestStatus[e]={index:r,requestedTime:null}},this.setIsDynamic=function(e){n.isDynamic=e},this.setEpsilonFor=function(e,t){n.epsilonVal[e]=t},this.getInitRequest=this.getInit,this.getSegmentRequestForTime=this.getForTime,this.getNextSegmentRequest=this.getNext,this.EPSILON=.2,this.MIN_SEGSIZE_FORBASE=e.MIN_SEGSIZE_FORBASE||NaN,this.deleteUnnecessaryBox=e.DELETE_UNNECESSARY_BOX||!1,this.epsilonVal={},this.requestStatus={},this.useFetch=!(!e.USE_FETCH||!("fetch"in window)),this.commonQrys=o(i,"query")?i.query:[],this.commonHdrs=o(i,"header")?i.header:[],this.onPrepare=o(i,"onPrepare")?i.onPrepare:function(){},this.onSuccess=o(i,"onSuccess")?i.onSuccess:function(){},this.onError=o(i,"onError")?i.onError:function(){},this.NXDebug=new s,this.eventBus=t},H=function(e,t){return new Promise((function(i,n){t.listener=function(e){e.data.lid==t.lid&&(t.unlisten(),n(new Error("abort")))},t.listen(),e.then(i,n)}))},K=function(e,t){return e===t||-1!==e.indexOf("http://")||-1!==e.indexOf("https://")?e:t+e},X=function(){function e(e,t,i,n){var r=this;this.doLoadX=function(e,t,i){var n=i,a=new XMLHttpRequest,s=null,o=!0,l=!0,u=!0,d=null,c=r.commonQrys.concat(),g=r.commonHdrs.concat(),p=r;r.xhrs.push(a),e.requestStartTime=(new Date).getTime(),a.startTime=e.requestStartTime,e.range&&(e.url+="?range="+e.range,c.push({name:"range",value:e.range})),e.url=K.call(p,e.relativeURL,e.baseURL[e.baseURLIdx].url),r.onPrepare({req:e,qrys:c,hdrs:g,xhr:a}),c.length>0&&c.forEach((function(t){e.url+=e.url.indexOf("?")>0?"&":"?",e.url+=t.name+"="+t.value})),s=r.metrics.addHttpRequest(e.streamType,null,e.type,e.url,e.baseURL[e.baseURLIdx].url,e.range,e.requestStartTime,null,null,null,null,e.duration,e.bandwidth),r.metrics.appendHttpTrace(s,e.requestStartTime,e.requestStartTime-e.requestStartTime,[0]),d=e.requestStartTime,a.open&&a.open("GET",e.url,!0),a.responseType="arraybuffer";var h=e.url.split("/");e.range&&a.setRequestHeader&&a.setRequestHeader("Range","bytes="+e.range),g.length>0&&g.forEach((function(e){a.setRequestHeader&&a.setRequestHeader(e.name,e.value)})),a.onprogress=function(t){var i=(new Date).getTime();if(o)if(o=!1,(!t.lengthComputable||t.lengthComputable&&t.total!=t.loaded)&&(e.firstByteTime=i),t.lengthComputable)e.total=t.total;else if(e.range){var n=e.range.split("-");n.length>1&&(e.total=parseInt(n[1])-parseInt(n[0])+1)}else e.total=0;e.loaded=t.loaded,l&&r.pendingRequests.length>0&&e.loaded>0&&e.total>0&&(i-e.requestStartTime)/e.loaded*(e.total-e.loaded)<e.firstByteTime-e.requestStartTime&&(l=!1,p.executeCurrentRequest())},a.onload=function(){if(e.timeouttimerId&&(clearTimeout(e.timeouttimerId),e.timeouttimerId=null),l&&r.pendingRequests.length>0&&(l=!1,p.executeCurrentRequest()),a.status<200||a.status>299)m.log_d(a.status+": "+h[h.length-1]+" , "+e.range);else{u=!1;var t,i,o,f=(new Date).getTime();e.firstByteTime||(e.firstByteTime=e.requestStartTime),e.requestEndTime=f,i=e.firstByteTime-e.requestStartTime,o=e.requestEndTime-e.firstByteTime,m.log_d("X"+a.status+": "+h[h.length-1]+", i="+e.index+" ,t="+Math.floor(e.startTime)+", "+i+"ms, "+o+"ms, "),r.NXDebug.debug("["+e.streamType+"] loaded : "+e.type+":"+e.startTime+" ("+a.status+", "+i+"ms, "+o+"ms)"),r.NXDebug.info("["+e.streamType+"] loaded : "+e.type+":"+e.startTime+" ("+a.status+", "+i+"ms, "+o+"ms)"),e.size=a.response.byteLength,s.tresponse=e.firstByteTime,s.tfinish=e.requestEndTime,s.responsecode=a.status,e.code=200,s.size=a.response.byteLength,r.onSuccess({status:a.status,req:e,xhr:a}),t=a.response,r.metrics.appendHttpTrace(s,f,f-d,[t?t.byteLength:0]),d=f,n({status:"ok",data:new Uint8Array(t)})}},a.onabort=function(t){e.requestEndTime=(new Date).getTime(),isNaN(e.firstByteTime)||(e.firstByteTime=e.requestEndTime),e.canceled||isNaN(e.loaded)?e.code=400:(e.size=e.loaded,e.code=408),n({status:"error",type:"onabort",msg:"aborted: "+e.streamType+":"+e.type+":"+e.startTime,data:a})},a.onloadend=a.onerror=function(){if(e.timeouttimerId&&(clearTimeout(e.timeouttimerId),e.timeouttimerId=null),-1!==r.xhrs.indexOf(a)&&(r.xhrs.splice(r.xhrs.indexOf(a),1),u)){r.onError({status:a.status,req:e,xhr:a}),u=!1;var i,o,l=(new Date).getTime(),c=a.response;e.firstByteTime||(e.firstByteTime=e.requestStartTime),e.requestEndTime=l,i=e.firstByteTime-e.requestStartTime,o=e.requestEndTime-e.firstByteTime,r.NXDebug.log("failed "+e.streamType+":"+e.type+":"+e.startTime+" ("+a.status+", "+i+"ms, "+o+"ms)"),s.tresponse=e.firstByteTime,s.tfinish=e.requestEndTime,s.responsecode=a.status,r.metrics.appendHttpTrace(s,l,l-d,[c?c.byteLength:0]),r.STORE_MEASURED_DATA&&(r.metrics.addReportHttpRequest(s,r.context.getVideoModel().getCurrentTime()),r.eventBus.dispatchEvent({type:"httpRequestReceived",data:s})),d=l,t>0&&a.status<399?(r.NXDebug.log("Failed loading segment: "+e.streamType+":"+e.type+":"+e.startTime+", retry in "+r.RETRY_INTERVAL+"ms attempts: "+t),t--,f.downloadError(r.eventBus,"content",e.url,a,e),setTimeout((function(){r.doLoadX.call(p,e,t,n)}),r.RETRY_INTERVAL)):(r.NXDebug.log("Failed loading segment: "+e.streamType+":"+e.type+":"+e.startTime+" no retry attempts left"),e.code=400,n({status:"error",type:"onloadend",msg:"Failed loading segment: "+e.streamType+":"+e.type+":"+e.startTime+" no retry attempts left",data:a}))}},r.NXDebug.info("str: ["+e.streamType+"] "+h[h.length-1]+", i="+e.index+" ,t="+Math.floor(e.startTime)),a.send&&a.send(),r.startLoadingCallback.call(r.context,e)},this.doLoadF=function(e,t,i){var n,a=i||function(){},s=r.eventBus,o={aborted:!1,listener:null,lid:null,startTime:null,listen:function(){s.addEventListener("abortFetch",this.listener)},unlisten:function(){s.removeEventListener("abortFetch",this.listener)},abort:function(){this.aborted=!0,s.dispatchEvent({type:"abortFetch",data:{lid:this.lid}})}},l={},u={method:"GET",headers:{},credentials:"same-origin"},d=null,c=!0,g=!0,p=null,h=r.commonQrys.concat(),y=r.commonHdrs.concat(),v=r,S=function(i){if(r.xhrs.indexOf(o)>-1&&r.xhrs.splice(r.xhrs.indexOf(o),1),n&&(r.errorChunkLoadingCallback(n),n=null),o.aborted||1==l.ok)e.requestEndTime=(new Date).getTime(),isNaN(e.firstByteTime)||(e.firstByteTime=e.requestEndTime),e.canceled||isNaN(e.loaded)?(e.code=400,l.status=400):(e.size=e.loaded,e.code=408,l.status=408),a({status:"error",type:"onabort",msg:"aborted: "+e.streamType+":"+e.type+":"+e.startTime,data:l});else{l.status||(l.status=-1),r.onError({status:l.status,req:e,xhr:l});var u,c,m=(new Date).getTime();e.firstByteTime||(e.firstByteTime=e.requestStartTime),e.requestEndTime=m,u=e.firstByteTime-e.requestStartTime,c=e.requestEndTime-e.firstByteTime,r.NXDebug.log("failed "+e.streamType+":"+e.type+":"+e.startTime+" ("+l.status+", "+u+"ms, "+c+"ms)"),d&&(d.tresponse=e.firstByteTime,d.tfinish=e.requestEndTime,d.responsecode=l.status),r.metrics.appendHttpTrace(d,m,m-p,[0]),r.STORE_MEASURED_DATA&&(r.metrics.addReportHttpRequest(d,r.context.getVideoModel().getCurrentTime()),s.dispatchEvent({type:"httpRequestReceived",data:d})),p=m,t>0&&l.status<399?(r.NXDebug.log("Failed loading segment: "+e.streamType+":"+e.type+":"+e.startTime+", retry in "+r.RETRY_INTERVAL+"ms attempts: "+t),t--,f.downloadError(s,"content",e.url,l,e),setTimeout((function(){r.doLoadF.call(v,e,t,a)}),r.RETRY_INTERVAL)):(r.NXDebug.log("Failed loading segment: "+e.streamType+":"+e.type+":"+e.startTime+" no retry attempts left"),e.code=400,a({status:"error",type:"onloadend",msg:"Failed loading segment: "+e.streamType+":"+e.type+":"+e.startTime+" no retry attempts left",data:l}))}o=null};e.requestStartTime=(new Date).getTime(),l.startTime=e.requestStartTime,o.startTime=e.startTime,o.lid=e.startTime+","+e.requestStartTime,r.xhrs.push(o),e.range&&(e.url+="?range="+e.range,h.push({name:"range",value:e.range})),e.url=K.call(v,e.relativeURL,e.baseURL[e.baseURLIdx].url),r.onPrepare({req:e,qrys:h,hdrs:y,xhr:l}),h.length>0&&h.forEach((function(t){e.url+=e.url.indexOf("?")>0?"&":"?",e.url+=t.name+"="+t.value})),d=r.metrics.addHttpRequest(e.streamType,null,e.type,e.url,e.baseURL[e.baseURLIdx].url,e.range,e.requestStartTime,null,null,null,null,e.duration,e.bandwidth),r.metrics.appendHttpTrace(d,e.requestStartTime,e.requestStartTime-e.requestStartTime,[0]),p=e.requestStartTime;var T=e.url.split("/");e.range&&(u.headers.Range="bytes="+e.range),y.length>0&&y.forEach((function(e){u.headers[e.name]=e.value}));var E=function(t,i,s){var u;if(o.unlisten(),!o.aborted){var f,h;if(t.done)return u=(new Date).getTime(),r.xhrs.indexOf(o)>-1&&r.xhrs.splice(r.xhrs.indexOf(o),1),r.chunkLoadingCallback(t.done,n,new Uint8Array),g&&r.pendingRequests.length>0&&(g=!1,v.executeCurrentRequest()),e.firstByteTime||(e.firstByteTime=e.requestStartTime),e.requestEndTime=u,f=e.firstByteTime-e.requestStartTime,h=e.requestEndTime-e.firstByteTime,m.log_d("F"+l.status+": "+T[T.length-1]+", i="+e.index+" ,t="+Math.floor(e.startTime)+", "+f+"ms, "+h+"ms, "),r.NXDebug.debug("["+e.streamType+"] loaded : "+e.type+":"+e.startTime+" ("+l.status+", "+f+"ms, "+h+"ms)"),r.NXDebug.info("["+e.streamType+"] loaded : "+e.type+":"+e.startTime+" ("+l.status+", "+f+"ms, "+h+"ms)"),e.size=e.loaded,d.tresponse=e.firstByteTime,d.tfinish=e.requestEndTime,d.responsecode=l.status,e.code=200,d.size=e.loaded,r.onSuccess({status:l.status,req:e,xhr:l}),r.metrics.appendHttpTrace(d,u,u-p,[e.loaded]),p=u,void a({status:"ok",data:new Uint8Array(0)});if(u=(new Date).getTime(),c?(c=!1,e.firstByteTime=u,e.total=i,e.loaded=t.value.length,n=r.firstChunkLoadingCallback(e)):e.loaded+=t.value.length,r.chunkLoadingCallback(t.done,n,t.value),g&&r.pendingRequests.length>0){var y=Number.MAX_VALUE;null!=i&&i>0?e.loaded>0&&(y=(u-e.requestStartTime)/e.loaded*(e.total-e.loaded)):n&&n.chunks.length>0&&(y=n.dur-(n.chunks[n.chunks.length-1].start+n.chunks[n.chunks.length-1].dur-n.time)),y<e.firstByteTime-e.requestStartTime&&(g=!1,v.executeCurrentRequest())}return H(s.read(),o).then((function(e){return E(e,i,s)})).catch((function(e){o.unlisten(),S()}))}S(new Error("AbortError"))};H(fetch(e.url,u),o).then((function(t){if(o.unlisten(),l.status=t.status,l.ok=t.ok,1==t.ok){var i=t.headers.get("content-length"),n=i?parseInt(i,10):null,a=t.body.getReader();if(!n&&e.range){var s=e.range.split("-");s.length>1&&(n=parseInt(s[1])-parseInt(s[0])+1)}return H(a.read(),o).then((function(e){return E(e,n,a)})).catch((function(e){S()}))}return r.NXDebug.debug("404 Not Found"),Promise.reject(new Error("res.false"))})).catch((function(e){S()})),r.NXDebug.info("str: ["+e.streamType+"] "+T[T.length-1]+", i="+e.index+" ,t="+Math.floor(e.startTime)+", rst:"+e.requestStartTime),r.startLoadingCallback.call(r.context,e)},this.fragmentLoad=function(e,t){var i=t;e||i({status:"ok",data:null}),e.loading=!0,r.useFetch?r.doLoadF(e,r.RETRY_ATTEMPTS,i):r.doLoadX(e,r.RETRY_ATTEMPTS,i)},this.abort=function(){for(var e,t=r.xhrs.length,i=0;i<t;i+=1)(e=r.xhrs[i]).abort&&e.abort();r.xhrs=[]},this.getRecent2ExecutedDownloadRequestIndex=function(){for(var e=[],t=r.executedRequests.length-1;t>=0&&!("download"===r.executedRequests[t].action&&(e.push(t),e.length>=2));t--);return e},this.reviseRequestStatus=function(e){var t=r.getRecent2ExecutedDownloadRequestIndex.call(r),i={},n=0,a=0;if(t.length>0){var s=r.executedRequests[t.shift()],o=s.requestEndTime-s.requestStartTime,l=s.requestEndTime>e.requestStartTime?s.requestEndTime-e.requestStartTime:0,u=o>l?l/o:1;n=s.size*u}if(r.loadingRequests.length>0){var d=r.loadingRequests[0];a=isNaN(d.loaded)?0:d.loaded}if(i.stream=e.streamType,i.trequest=e.requestStartTime,i.tresponse=e.firstByteTime,i.tfinish=e.requestEndTime,i.mediaduration=e.duration,i.size=Math.round(e.size+n+a),i.bandwidth=e.bandwidth,i.url=e.url,i.baseURL=e.baseURL[0].url,i.responsecode=e.code,i.index=e.index,r.metrics.addRevisedHttpRequest(i),r.STORE_MEASURED_DATA){var f=r.metrics.addReportHttpRequest(i,r.context.getVideoModel().getCurrentTime());r.eventBus.dispatchEvent({type:"httpRequestReceived",data:f})}408!=i.responsecode&&i.tfinish-i.trequest<1e3*i.mediaduration&&(r.restrictMultiLoad=!1)},this.loadCurrentFragment=function(e){var t=r;r.fragmentLoad.call(t,e,(function(i){"ok"===i.status?function(e,i){var n=r.loadingRequests.indexOf(e);n>-1&&r.loadingRequests.splice(n,1),r.reviseRequestStatus.call(t,e),r.executedRequests.push(e),r.executedRequests.length>20&&r.executedRequests.shift(),r.successLoadingCallback.call(r.context,e,i),e.loading=!1}(e,i.data):function(e,i){var n=r.loadingRequests.indexOf(i);n>-1&&r.loadingRequests.splice(n,1),400!=i.code&&(r.reviseRequestStatus.call(t,i),r.executedRequests.push(i)),r.errorLoadingCallback.call(r.context,e,i),i.loading=!1}(i.type,e)}))},this.sortRequestsByProperty=function(e){e.sort((function(e,t){return e.pStart<t.pStart?-1:e.pStart==t.pStart?e.index<t.index?-1:e.index>t.index?1:0:e.pStart>t.pStart?1:0}))},this.checkLoaded=function(e,t,i){var n=e.MSETimeOffset,r=t.action?t.MSETimeOffset:t.offset,a=e.quality,s=t.quality,o=e.startTime,l=t.action?t.startTime:t.rstime;if(n!=r)return!1;if(a==s){if(o==l)return!0}else if(Math.abs(o-l)<=i)return!0;return!1},this.removeExecutedRequest=function(e){var t=r.executedRequests.indexOf(e);-1!==t&&r.executedRequests.splice(t,1)},this.setContext=function(e){r.context=e},this.getContext=function(){return r.context},this.addRequest=function(e){e&&(r.pendingRequests.push(e),r.sortRequestsByProperty.call(r,r.pendingRequests))},this.setCallbacks=function(e,t,i,n,a,s,o){r.startLoadingCallback=e,r.streamEndCallback=n,r.errorLoadingCallback=i,r.successLoadingCallback=t,r.firstChunkLoadingCallback=a,r.chunkLoadingCallback=s,r.errorChunkLoadingCallback=o},this.isFragmentLoadedOrPending=function(e,t,i){var n=t||[],a=i||0;return!!(r.isFragmentQueued(e,n,a)||r.isFragmentLoaded(e,a)||r.isFragmentPending(e,a)||r.isFragmentLoading(e,a))},this.isFragmentLoadingOrPending=function(e,t,i){var n=t||[],a=i||0;return!!(r.isFragmentQueued(e,n,a)||r.isFragmentPending(e,a)||r.isFragmentLoading(e,a))},this.isFragmentLoaded=function(e,t){var i,n=!1,a=t||0,s=r.executedRequests.length;if(!n)for(var o=0;o<s;o++)if(200==(i=r.executedRequests[o]).code&&(r.checkLoaded(e,i,a)||"complete"===i.action&&e.action===i.action)){n=!0;break}return n},this.isFragmentPending=function(e,t){for(var i,n=!1,a=t||0,s=r.pendingRequests.length,o=0;o<s;o++)i=r.pendingRequests[o],r.checkLoaded(e,i,a)&&(n=!0);return n},this.isFragmentLoading=function(e,t){for(var i,n=!1,a=t||0,s=r.loadingRequests.length,o=0;o<s;o++)i=r.loadingRequests[o],r.checkLoaded(e,i,a)&&(n=!0);return n},this.isReady=function(){return r.context.isReady()},this.getExecutedRequests=function(){return r.executedRequests},this.getPendingRequests=function(){return r.pendingRequests},this.getLoadingRequests=function(){return r.loadingRequests},this.needToPrepareNewRequest=function(){return r.loadingRequests.length<r.LOADING_REQUEST_THRESHOLD},this.getExecutedRequestForTime=function(e){for(var t=NaN,i=NaN,n=null,a=r.executedRequests.length-1;a>=0;a-=1)if(i=(t=(n=r.executedRequests[a]).startTime)+n.duration,!isNaN(t)&&!isNaN(i)&&e>t&&e<i)return n;return null},this.removeAllExecutedRequests=function(){r.executedRequests=[]},this.removeExecutedRequestsBeforeTime=function(e){for(var t=NaN,i=null,n=r.executedRequests.length-1;n>=0;n-=1)t=(i=r.executedRequests[n]).startTime,!isNaN(t)&&t<e&&r.removeExecutedRequest.call(r,i)},this.cancelPendingRequests=function(){if(r.pendingRequests.length)for(var e=r.pendingRequests.length-1;e>=0;e--)r.pendingRequests[e].keep||r.pendingRequests.splice(e,1)},this.clearAllRequests=function(){r.pendingRequests=[],r.abort.call(r),r.loadingRequests=[],r.executedRequests=[]},this.abortRequests=function(e){if(void 0===e&&(e=!1),e)for(var t=0;t<r.loadingRequests.length;t++)r.loadingRequests[t].canceled=!0;r.abort.call(r),r.loadingRequests=[]},this.abortRequestForTime=function(e){for(var t=0;t<r.xhrs.length;t++)if(r.xhrs[t].startTime==e){var i=r.xhrs.splice(t,1)[0];i.abort&&i.abort(),i=void 0;break}},this.setRestrictMultiLoad=function(e){r.restrictMultiLoad=e},this.executeCurrentRequest=function(){var e,t=r;if(0!==r.pendingRequests.length&&!(r.loadingRequests.length>=r.LOADING_REQUEST_THRESHOLD||r.loadingRequests.length>0&&r.restrictMultiLoad))switch((e=r.pendingRequests.shift()).action){case"complete":r.executedRequests.push(e),r.streamEndCallback.call(r.context,e);break;case"download":var i=r.metrics.getCurrentBufferLevel();i&&(e.bufferLevelAtStartDate=i.totalLevel),r.loadingRequests.push(e),r.loadCurrentFragment.call(t,e);break;default:r.NXDebug.log("Unknown request action."),e.loading?e.loading=!1:r.errorLoadingCallback.call(r.context,"",e)}},this.checkForExistence=function(e,t){var i=t;if(e){e.url=K.call(r,e.relativeURL,e.baseURL[e.baseURLIdx].url);var n=new XMLHttpRequest,a=!1;n.open("HEAD",e.url,!0),n.onload=function(){n.status<200||n.status>299||(a=!0,i({status:"ok",data:e}))},n.onloadend=n.onerror=function(){a||i({status:"error",msg:"checkForExistence error"})},n.send()}else i({status:"ok",data:null})},this.context=void 0,this.executedRequests=[],this.pendingRequests=[],this.loadingRequests=[],this.startLoadingCallback=function(){},this.successLoadingCallback=function(){},this.chunkLoadingCallback=function(){},this.errorChunkLoadingCallback=function(){},this.errorLoadingCallback=function(){},this.streamEndCallback=function(){},this.NXDebug=new s,this.LOADING_REQUEST_THRESHOLD=e.LOADING_REQUEST_THRESHOLD||2,this.STORE_MEASURED_DATA=e.STORE_MEASURED_DATA||!1,this.useFetch=!(!e.USE_FETCH||!("fetch"in window)),this.RETRY_ATTEMPTS=0,this.RETRY_INTERVAL=500,this.xhrs=[],this.restrictMultiLoad=!1,this.commonQrys=o(n,"query")?n.query:[],this.commonHdrs=o(n,"header")?n.header:[],this.onPrepare=o(n,"onPrepare")?n.onPrepare:function(){},this.onSuccess=o(n,"onSuccess")?n.onSuccess:function(){},this.onError=o(n,"onError")?n.onError:function(){},this.params=e,this.eventBus=t,this.metrics=i,this.xhrCustom=n}return e.prototype.isFragmentQueued=function(e,t,i){for(var n=!1,r=t||[],a=i||0,s=r.length,o=0;o<s;o++)if(this.checkLoaded(e,r[o],a)){n=!0;break}return n},e}(),V=function(e,t,i,n){var r=this;this.findModel=function(e){for(var t=r.fragmentModels.length,i=0;i<t;i++)if(r.fragmentModels[i].getContext()==e)return r.fragmentModels[i];return null},this.attachBufferController=function(e){if(!e)return null;var t=r.findModel(e);return t||((t=new X(r.params,r.eventBus,r.metricsModel.getMetricsFor(e.getType()),r.xhrCustom)).setContext(e),r.fragmentModels.push(t)),t},this.detachBufferController=function(e){var t=r.fragmentModels.indexOf(e);t>-1&&r.fragmentModels.splice(t,1)},this.isFragmentLoadedOrPending=function(e,t){var i=r.findModel(e);return!!i&&i.isFragmentLoadedOrPending(t,e.getBuffer().queue,e.getTolerance())},this.isFragmentLoadingOrPending=function(e,t){var i=r.findModel(e);return!!i&&i.isFragmentLoadingOrPending(t,e.getBuffer().queue,e.getTolerance())},this.getExecutedRequests=function(e){var t=r.findModel(e);return t?t.getExecutedRequests():null},this.getPendingRequests=function(e){var t=r.findModel(e);return t?t.getPendingRequests():null},this.getLoadingRequests=function(e){var t=r.findModel(e);return t?t.getLoadingRequests():null},this.needToPrepareNewRequest=function(e){var t=r.findModel(e);return t?t.needToPrepareNewRequest():null},this.isInitializationRequest=function(e){return!(!e||!e.type||"initialization segment"!==e.type.toLowerCase())},this.getExecutedRequestForTime=function(e,t){return e?e.getExecutedRequestForTime(t):null},this.removeExecutedRequest=function(e,t){e&&e.removeExecutedRequest(t)},this.removeExecutedRequestsBeforeTime=function(e,t){e&&e.removeExecutedRequestsBeforeTime(t)},this.clearAllRequestsForModel=function(e){e&&e.clearAllRequests()},this.abortRequestsForModel=function(e){e&&e.abortRequests()},this.isFragmentExists=function(e,t,i){var n=i||function(){},a=r.findModel(e);a?a.checkForExistence.call(r,t,(function(e){"ok"===e.status&&null!=e.data?n(!0):n(!1)})):n(!1)},this.prepareFragmentForLoading=function(e,t,i,n,a,s,o,l){var u=r.findModel(e);return u?(u.setCallbacks(t,i,n,a,s,o,l),!0):null},this.reset=function(){for(var e=0;e<r.fragmentModels.length;e++)r.clearAllRequestsForModel(r.fragmentModels[e]);r.fragmentModels=[]},this.fragmentModels=[],this.params=e,this.eventBus=t,this.metricsModel=i,this.xhrCustom=n},Q=m,z=new s,G=function(){function e(e,t){var i=this;this.findBuffer=function(e){for(var t=0;t<i.buffers.length;t++)if(i.buffers[t]===e)return i.buffers[t];return null},this._appendBuffer=function(e,t,n,r,a){"appendBuffer"in e?e.appendBuffer(t):"append"in e&&e.append(t),e.lastAppendtime=(new Date).getTime(),i.videoModel&&!i.videoModel.getNeedsMoreData()&&(e.preDur=1e3*n),e.updatingRange={start:r,end:a},t=void 0},this.appendX=function(e,t,i,n,r,a,s,o,l,u,d,f,c){try{i&&(s in e.initQ||(e.initQ[s]=[]),d in e.initQ[s]||(e.initQ[s][d]=[]),e.initQ[s][d][u]=i);for(var m=0,g=e.queue;m<g.length;m++){var p=g[m];if(s==p.pStart&&r==p.time&&a==p.dur&&u==p.quality&&d==p.asetIdx)return e.queue.length}e.queue.push({type:"data",data:t,rstime:n,time:r,dur:a,quality:u,pStart:s,offset:o,asetIdx:d,divNum:f,ridx:c}),e.queue.sort((function(e,t){if(e.pStart<t.pStart)return-1;if(e.pStart==t.pStart){if(e.rstime<t.rstime)return-1;if(e.rstime>t.rstime)return 1;if(e.rstime==t.rstime){if(e.divNum<t.divNum)return-1;if(e.divNum>t.divNum)return 1}}return e.pStart>t.pStart?1:0})),void 0===e.updating||e.updating}catch(e){Q.log(e),z.info(e)}return e.queue.length},this.appendF=function(e,t,i,n,r,a,s,o,l,u,d,f,c){var m;try{i&&(s in e.initQ||(e.initQ[s]=[]),d in e.initQ[s]||(e.initQ[s][d]=[]),e.initQ[s][d][u]=i);for(var g=0,p=e.queue;g<p.length;g++){var h=p[g];if(s==h.pStart&&r==h.time&&a==h.dur&&u==h.quality&&d==h.asetIdx)return m}return m={type:"data",data:t,rstime:n,time:r,dur:a,quality:u,pStart:s,offset:o,asetIdx:d,divNum:f,ridx:c,chunks:[],progress:[],chunkEnd:0,chunkStartTime:-1,chunkDur:0,done:!1,appending:!1,params:i.params},e.queue.push(m),e.queue.sort((function(e,t){if(e.pStart<t.pStart)return-1;if(e.pStart==t.pStart){if(e.rstime<t.rstime)return-1;if(e.rstime>t.rstime)return 1}return e.pStart>t.pStart?1:0})),m}catch(e){throw Q.log(e),z.info(e),e}},this.appendFromQX=function(e,t,n){var r,a,s,o,l,u=null,d=null,f=null,c=0,m=0,g=0,p=(new Date).getTime(),h=n||5;try{if(0==e.appendStart)return;if(0===e.queue.length)return;if(e.waiting)return;if(r=e.queue,void 0!==e.updating&&0==e.updating&&p-e.lastAppendtime>e.preDur/3||void 0===e.updating&&p-e.lastAppendtime>e.preDur/3)if(!1===t){for(e.startTimeAfterSeek=Number.MAX_VALUE,a=i.playbackStarted?i.videoModel.getCurrentTime():i.videoModel.getStartTime(),o=(s=i.getBufferRange(e,a))?s.end:a;r.length>0;)if(m=(u=r[0]).time,(g=u.time+u.dur)<a-u.dur)z.log("["+e.type+"]discard curTime:"+a+", q:end"+g),Q.log("["+e.type+"]discard curTime:"+a+", q:end"+g),r.shift();else{if(!(o+.1<m))break;if(g-a>20)return;if(u.rstime<=o+.1&&u.rstime<m&&u.rstime!=u.pStart)return Q.log("["+e.type+"] Gap!!end:"+o+", rstime:"+u.rstime+", dataStart:"+m),z.info("["+e.type+"] Gap!!end:"+o+", rstime:"+u.rstime+", dataStart:"+m),void i.eventBus.dispatchEvent({type:"checkBufferGap",data:{type:e.type,time:u.rstime-u.dur/2}});if(!(o<e.updatingRange.end-.1&&e.updatingRange.start-.1<o&&p-e.lastAppendtime>2*e.preDur/3))break;Q.log("updating?? end:"+o+", exp:"+e.updatingRange.end+", q:"+m),z.log("["+e.type+"] updating?? end:"+o+", exp start:"+e.updatingRange.start+",end:"+e.updatingRange.end+", q:"+m+",st:"+e.startTimeAfterSeek),e.laData&&r.unshift(e.laData)}if(0==r.length)return;u=r.shift(),e.pStart!==u.pStart&&(z.debug("***** period change **** from:"+e.pStart+", to:"+u.pStart),z.debug("***** startTime :::"+u.time+" ******"),e.pStart=u.pStart,e.quality=-1),e.asetIdx!=u.asetIdx&&(z.debug("***** AdaptationSet change **** from:"+e.asetIdx+", to:"+u.asetIdx),z.debug("***** startTime :::"+u.time+" ******"),e.asetIdx=u.asetIdx,e.quality=-1),e.quality!==u.quality?(f=null,"video"===e.type?Q.log_V2Q("bf["+u.quality+"] init,ps="+u.pStart):Q.log_A2Q("bf["+u.quality+"] init,ps="+u.pStart),u.offset!==e.timestampOffset&&(e.timestampOffset=u.offset),(f=new Uint8Array(u.data.length+e.initQ[u.pStart][u.asetIdx][u.quality].data.length)).set(e.initQ[u.pStart][u.asetIdx][u.quality].data,0),"video"===e.type?Q.log_V2Q("bf["+u.quality+"] t="+parseInt(String(100*u.time))/100):Q.log_A2Q("bf["+u.quality+"] t="+parseInt(String(100*u.time))/100),f.set(u.data,e.initQ[u.pStart][u.asetIdx][u.quality].data.length),i._appendBuffer(e,f,u.dur,m,g),e.quality=u.quality):("video"===e.type?Q.log_V2Q("bf["+u.quality+"] t="+parseInt(String(100*u.time))/100):Q.log_A2Q("bf["+u.quality+"] t="+parseInt(String(100*u.time))/100),u.offset!==e.timestampOffset&&(e.timestampOffset=u.offset),i._appendBuffer(e,u.data,u.dur,m,g)),z.debug("["+e.type+"] appended t="+u.time+", q:"+r.length),e.laData=u,u=void 0}else{if(!e.playbackStarted){if(!e.ready){for(var y=0;y<r.length;y++){if((d=r[y]).rstime==e.startTimeAfterSeek){m=d.time,c=d.rstime,e.tmpData={diff:m-c,start:m,offset:d.offset},e.ready=!0;break}if(d.rstime>e.startTimeAfterSeek)break}if(!e.ready)return}var v=!0;for(y=0;y<i.buffers.length;y++)i.buffers[y].ready||(v=!1);if(!v)return void(e.waiting=!0);var S=Number.MAX_VALUE,T=!1;for(y=0;y<i.buffers.length;y++)(l=i.buffers[y]).tmpData&&l.tmpData.diff<S&&(S=l.tmpData.diff);if(S>1)T=!0;else if(S<0)for(y=0;y<i.buffers.length;y++)if(i.buffers[y].tmpData&&i.buffers[y].tmpData.start+i.buffers[y].tmpData.offset<0){Q.log("["+i.buffers[y].type+", s:"+i.buffers[y].tmpData.start+", o:"+i.buffers[y].tmpData.offset),T=!0;break}if(1==T)for(y=0;y<i.buffers.length;y++)for(var E=0;E<i.buffers[y].queue.length;E++)i.buffers[y].queue[E].offset-=S,i.buffers[y].queue[E].time-=S;for(y=0;y<i.buffers.length;y++)(l=i.buffers[y]).waiting=!1,l.ready=!1,l.playbackStarted=!0,T&&i.eventBus.dispatchEvent({type:"needToModifyOffset",data:{type:l.type,minDiff:S}})}var b=[],D=0,R=0,M=0,I="",k=void 0,x=void 0,L=void 0,_=0;for(a=i.playbackStarted?i.videoModel.getCurrentTime():i.videoModel.getStartTime();r.length>0;){if(m=(u=r[0]).time,g=u.time+u.dur,k=u.time,x=u.dur,L=u.rstime,_=0,m+x+x<a&&L<e.startTimeAfterSeek){if(Q.log("["+e.type+"] packet received before seek -> discard c:"+a+", q:"+k+", rstime:"+L),z.info("["+e.type+"] packet received before seek -> discard c:"+a+", q:"+k+", rstime:"+L),r.shift(),r.length>0)continue;return}if(L>e.startTimeAfterSeek)return;if(L!=e.startTimeAfterSeek&&a+.1<m){if(null!=(s=i.getBufferRange(e,a))&&m<=s.end+.1){h-=m-a;break}o=null!=s?s.end:a,Q.log("["+e.type+"] Gap!!! c:"+a+", l:"+o+"q:"+k+", qc:"+k+", s"+i.videoModel.getStartTime()+",st:"+e.startTimeAfterSeek),z.info("["+e.type+"] Gap!!! c:"+a+", l:"+o+"q:"+k+", qc:"+k+", s"+i.videoModel.getStartTime()+",st:"+e.startTimeAfterSeek);var A;return A=L<=o+.1&&L<m?L-x/2:o,void i.eventBus.dispatchEvent({type:"checkBufferGap",data:{type:e.type,time:A}})}h+=_=m<a?a-m:0;break}var C=m,N=0,P=0;for(y=0;y<r.length&&!(0!==y&&C+.1<r[y].time)&&(M+=r[y].dur,C+=r[y].dur,C+=N=i.getBufferLength(e,C),P++,!(h<=(M+=N)));y++);if(M<h-.1&&M<i.prefetchThreshold[e.type]-.5)return z.info("append["+e.type+"]: dataDur:"+M+", bufferThreshold:"+h+", "+i.prefetchThreshold[e.type]+", qlen:"+r.length),void(e.underThreshold=!0);for(M=0,e.underThreshold=!1,c=(u=e.queue[0]).rstime;r.length>0;){if(u=e.queue.shift(),e.pStart!==u.pStart){if(0!==D){e.queue.unshift(u);break}z.debug("***** period change **** from:"+e.pStart+", to:"+u.pStart),z.debug("***** startTime :::"+u.time+" ******"),e.pStart=u.pStart,e.quality=-1}if(e.asetIdx!==u.asetIdx){if(0!==D){r.unshift(u);break}z.debug("***** AdaptationSet change **** from:"+e.asetIdx+", to:"+u.asetIdx),z.debug("***** startTime :::"+u.time+" ******"),e.asetIdx=u.asetIdx,e.quality=-1}if(e.quality!==u.quality&&("video"===e.type?Q.log_V2Q("bf["+u.quality+"] init"):Q.log_A2Q("bf["+u.quality+"] init"),D+=e.initQ[u.pStart][u.asetIdx][u.quality].data.length,b.push(e.initQ[u.pStart][u.asetIdx][u.quality].data),e.quality=u.quality),R=u.offset,D+=u.data.length,b.push(u.data),M+=u.dur,I+="*","video"===e.type?(Q.log_V2Q("bf["+u.quality+"] t="+parseInt(String(100*u.time))/100+I),z.debug("bfv["+u.quality+"] t="+parseInt(String(100*u.time))/100)):(Q.log_A2Q("bf["+u.quality+"] t="+parseInt(String(100*u.time))/100+I),z.debug("bfa["+u.quality+"] t="+parseInt(String(100*u.time))/100)),0==--P||_+i.appendEnableThreshold[e.type]<M||u.time+u.dur>i.mse.duration)break;u=null}if(0==D)return;g=m+M,M-=_,f=new Uint8Array(D);for(var B=0,q=void 0;b.length>0;)q=b.shift(),f.set(q,B),B+=q.length;R!==e.timestampOffset&&(e.timestampOffset=R),e.startTimeAfterSeek=Number.MAX_VALUE,i._appendBuffer(e,f,M,m,g),i.eventBus.dispatchEvent({type:"appendedEnoughDataToStart",data:{type:e.type}}),f=void 0}else p<e.lastAppendtime&&(Q.log("now:"+p+", last:"+e.lastAppendtime),e.lastAppendtime=p)}catch(t){z.log("append error!! Q"),Q.log("append error!! Q"),Q.log(t.message),e.queue.unshift(u),z.log("#############################################"),z.log(t)}},this.appendFromQF=function(e,t,n){var r,a,s,o=null,l=null,u=null,d=null,f=0,c=0,m=null,g=0,p="",h=!1,y=void 0,v=null,S=0,T=0,E=n||5;try{if(0==e.appendStart)return;if(0===e.queue.length)return;if(e.waiting)return;if(1==(o=(y=e.queue)[0]).appending){if(o.chunks&&o.chunks.length>0&&(S=(m=o.chunks)[0].start,T=m[m.length-1].start+m[m.length-1].dur,m.forEach((function(e){f+=e.data.length})),u=new Uint8Array(f),m.forEach((function(e){u.set(e.data,c),c+=e.data.length})),e.appendBuffer(u),e.updatingRange={start:S,end:T},h=!0,u=null,f=0,c=0,o.chunks=[]),o.done&&("video"===e.type?(Q.log_V2Q("bf["+o.quality+"] t="+parseInt(String(100*o.time))/100+p),z.debug("bfv["+o.quality+"] t="+parseInt(String(100*o.time))/100+",appended:"+h)):(Q.log_A2Q("bf["+o.quality+"] t="+parseInt(String(100*o.time))/100+p),z.debug("bfa["+o.quality+"] t="+parseInt(String(100*o.time))/100+",appended:"+h)),y.shift(),o=void 0,0==y.length))return;if(h)return}if(!1===t){for(e.startTimeAfterSeek=Number.MAX_VALUE,r=i.playbackStarted?i.videoModel.getCurrentTime():i.videoModel.getStartTime(),a=(v=i.getBufferRange(e,r))?v.end:r;y.length>0;){if(S=0,T=0,(o=y[0]).chunks&&o.done){if(0==o.chunks.length){y.shift();continue}S=o.chunks[0].start,T=o.chunks[o.chunks.length-1].start+o.chunks[o.chunks.length-1].dur}else{if(!(o.chunks&&o.chunks.length>0))return;S=o.chunks[0].start,T=o.chunks[o.chunks.length-1].start+o.chunks[o.chunks.length-1].dur}if(!(T<r-o.dur)){if(a+.1<S){if(T-r>20)return;if(o.rstime<=a+.1&&o.rstime<S&&o.rstime!=o.pStart)return Q.log("["+e.type+"] Gap!! end:"+a+", rstime:"+o.rstime+", chunkStart:"+S+",ps:"+o.pStart),z.info("["+e.type+"] Gap!! end:"+a+", rstime:"+o.rstime+", chunkStart:"+S),void i.eventBus.dispatchEvent({type:"checkBufferGap",data:{type:e.type,time:o.rstime-o.dur/2}});break}break}z.log("["+e.type+"]discard curTime:"+r+", q:end"+T),Q.log("["+e.type+"]discard curTime:"+r+", q:end"+T),y.shift()}if(0==y.length)return;o=y[0],e.pStart!==o.pStart&&(z.debug("***** period change **** from:"+e.pStart+", to:"+o.pStart),z.debug("***** startTime :::"+o.time+" ******"),e.pStart=o.pStart,e.quality=-1),e.asetIdx!=o.asetIdx&&(z.debug("***** AdaptationSet change **** from:"+e.asetIdx+", to:"+o.asetIdx),z.debug("***** startTime :::"+o.time+" ******"),e.asetIdx=o.asetIdx,e.quality=-1),e.quality!=o.quality&&("video"===e.type?Q.log_V2Q("bf["+o.quality+"] init"):Q.log_A2Q("bf["+o.quality+"] init"),f+=e.initQ[o.pStart][o.asetIdx][o.quality].data.length,d=e.initQ[o.pStart][o.asetIdx][o.quality].data,e.quality=o.quality),(g=o.offset)!=e.timestampOffset&&(e.timestampOffset=g),(m=o.chunks).forEach((function(e){f+=e.data.length})),u=new Uint8Array(f),d&&(u.set(d,c),c+=d.length),m.forEach((function(e){u.set(e.data,c),c+=e.data.length})),e.appendBuffer(u),e.updatingRange={start:S,end:T},u=void 0,o.chunks=[],o.appending=!0,o.done&&("video"===e.type?(Q.log_V2Q("bf["+o.quality+"] t="+parseInt(String(100*o.time))/100+p),z.debug("bfv["+o.quality+"] t="+parseInt(String(100*o.time))/100+", "+parseInt(String(100*o.rstime))/100)):(Q.log_A2Q("bf["+o.quality+"] t="+parseInt(String(100*o.time))/100+p),z.debug("bfa["+o.quality+"] t="+parseInt(String(100*o.time))/100+", "+parseInt(String(100*o.rstime))/100)),y.shift(),o=void 0)}else{if(!e.playbackStarted){if(!e.ready){for(var b=0;b<y.length;b++){if((l=y[b]).rstime==e.startTimeAfterSeek){if(0==l.chunks.length)return;S=l.time;var D=l.rstime;e.tmpData={diff:S-D,start:S,offset:l.offset},e.ready=!0;break}if(l.rstime>e.startTimeAfterSeek)break}if(!e.ready)return}var R=!0;for(b=0;b<i.buffers.length;b++)i.buffers[b].ready||(R=!1);if(!R)return void(e.waiting=!0);var M=Number.MAX_VALUE,I=!1;for(b=0;b<i.buffers.length;b++)(s=i.buffers[b]).tmpData.diff<M&&(M=s.tmpData.diff);if(M>1)I=!0;else if(M<0)for(b=0;b<i.buffers.length;b++)if(i.buffers[b].tmpData.start+i.buffers[b].tmpData.offset<0){Q.log("["+i.buffers[b].type+", s:"+i.buffers[b].tmpData.start+", o:"+i.buffers[b].tmpData.offset),I=!0;break}if(1==I)for(b=0;b<i.buffers.length;b++)for(var k=0;k<i.buffers[b].queue.length;k++){i.buffers[b].queue[k].offset-=M,i.buffers[b].queue[k].chunks.length>0&&(i.buffers[b].queue[k].time-=M),i.buffers[b].queue[k].chunkStartTime>-1&&(i.buffers[b].queue[k].chunkStartTime-=M);for(var x=0;x<i.buffers[b].queue[k].chunks.length;x++)i.buffers[b].queue[k].chunks[x].start-=M}for(b=0;b<i.buffers.length;b++)(s=i.buffers[b]).waiting=!1,s.ready=!1,s.playbackStarted=!0,I&&i.eventBus.dispatchEvent({type:"needToModifyOffset",data:{type:s.type,minDiff:M}})}var L=[],_=0,A=0,C=0,N=void 0,P=void 0,B=0,q=0,F=void 0;for(u=null,p="",r=i.playbackStarted?i.videoModel.getCurrentTime():i.videoModel.getStartTime(),S=0,T=0;y.length>0;){if((F=(o=y[0]).chunks).length>0?(S=o.chunks[0].start,T=o.chunks[o.chunks.length-1].start+o.chunks[o.chunks.length-1].dur):(S=o.time,T=o.time+o.dur),N=o.time,P=o.dur,B=o.rstime,q=0,S+P+P<r&&B<e.startTimeAfterSeek){if(Q.log("["+e.type+"] packet received before seek -> discard c:"+r+", q:"+N+", rstime:"+B),z.info("["+e.type+"] packet received before seek -> discard c:"+r+", q:"+N+", rstime:"+B),y.shift(),y.length>0)continue;return}if(B>e.startTimeAfterSeek)return;if(0==F.length)return;if(B!=e.startTimeAfterSeek&&r+.1<S){if(null!=(v=i.getBufferRange(e,r))&&S<=v.end+.1){E-=S-r;break}a=null!=v?v.end:r,Q.log("["+e.type+"] Gap!!! c:"+r+", l:"+a+"q:"+N+", qc:"+F[0].start+", s"+i.videoModel.getStartTime()),z.info("["+e.type+"] Gap!!! c:"+r+", l:"+a+"q:"+N+", qc:"+F[0].start+", s"+i.videoModel.getStartTime());var w;return w=B<=a+.1&&B<S?B-P/2:a,void i.eventBus.dispatchEvent({type:"checkBufferGap",data:{type:e.type,time:w}})}E+=q=S<r?r-S:0;break}var O=S,U=0,H=0,K=void 0;for(b=0;b<y.length&&(l=y[b],K=0,0!=l.chunks.length)&&!(0!==b&&O+.1<l.chunks[0].start)&&(K=l.chunks[l.chunks.length-1].dur+(l.chunks[l.chunks.length-1].start-l.chunks[0].start),C+=K,O+=K,O+=U=i.getBufferLength(e,O),H++,!(E<=(C+=U)));b++);if(C<E-.1&&C<i.prefetchThreshold[e.type]-.5)return z.info("append["+e.type+"]: dataDur:"+C+", bufferThreshold:"+E+", "+i.prefetchThreshold[e.type]+", qlen:"+y.length+",chunkStart:"+S+", curTime:"+r+", rstime:"+B),void(e.underThreshold=!0);if(C=0,e.underThreshold=!1,F&&0==F.length)return;for(;y.length>0;){if(o=y[0],e.pStart!==o.pStart){if(0!==_)break;z.debug("***** period change **** from:"+e.pStart+", to:"+o.pStart),z.debug("***** startTime :::"+o.time+" ******"),e.pStart=o.pStart,e.quality=-1}if(e.asetIdx!==o.asetIdx){if(0!==_)break;z.debug("***** AdaptationSet change **** from:"+e.asetIdx+", to:"+o.asetIdx),z.debug("***** startTime :::"+o.time+" ******"),e.asetIdx=o.asetIdx,e.quality=-1}if(e.quality!==o.quality&&("video"===e.type?Q.log_V2Q("bf["+o.quality+"] init"):Q.log_A2Q("bf["+o.quality+"] init"),_+=e.initQ[o.pStart][o.asetIdx][o.quality].data.length,L.push(e.initQ[o.pStart][o.asetIdx][o.quality].data),e.quality=o.quality),A=o.offset,o.chunks.forEach((function(e){_+=e.data.length,C+=e.dur,L.push(e.data)})),p+="*","video"===e.type?(Q.log_V2Q("bf["+o.quality+"] t="+parseInt(String(100*o.time))/100+p),z.debug("bfv["+o.quality+"] t="+parseInt(String(100*o.time))/100+", "+parseInt(String(100*o.rstime))/100)):(Q.log_A2Q("bf["+o.quality+"] t="+parseInt(String(100*o.time))/100+p),z.debug("bfa["+o.quality+"] t="+parseInt(String(100*o.time))/100+", "+parseInt(String(100*o.rstime))/100)),o.chunks=[],o.appending=!0,!o.done)break;if(y.shift(),0==--H||q+i.appendEnableThreshold[e.type]<C||o.time+o.dur>i.mse.duration)break;o=null}if(0==_)return;T=S+C,q&&(C-=q),u=new Uint8Array(_);for(var X=0,V=void 0;L.length>0;)V=L.shift(),u.set(V,X),X+=V.length;A!==e.timestampOffset&&(e.timestampOffset=A),e.startTimeAfterSeek=Number.MAX_VALUE,e.appendBuffer(u),e.updatingRange={start:S,end:T},i.eventBus.dispatchEvent({type:"appendedEnoughDataToStart",data:{type:e.type}}),u=void 0}}catch(e){z.log("append error!! Q"),Q.log("append error!! Q"),Q.log(e.message),y&&y.unshift(o),z.log("#############################################"),z.log(e)}},this.playbackStart=function(){i.playbackStarted=!0},this.setVideoModel=function(e){i.videoModel=e},this.setAppendStatus=function(e,t,n){for(var r=0;r<t.length;r++)t[r].quality=n,t[r].appendStart=e,i.appendFromQ(t[r],!0)},this.directAppend=function(e,t){"appendBuffer"in e?e.appendBuffer(t):"append"in e&&e.append(t)},this.attachBuffer=function(e){if(!e)return null;var t=i.findBuffer(e);return t||i.buffers.push(e),t},this.detachBuffer=function(e){var t=i.buffers.indexOf(e);t>-1&&i.buffers.splice(t,1)},this.detachAllBuffers=function(){i.buffers=[]},this.createSourceBuffer=function(e,t){try{return{status:"ok",data:e.addSourceBuffer(t)}}catch(e){return{status:"error",msg:e.dscription}}},this.removeSourceBuffer=function(e,t){try{e.removeSourceBuffer(t)}catch(e){Q.log(e.description)}},this.getBufferRange=function(e,t,i){var n=null,r=0,a=0,s=null,o=null,l=0,u=i||.15,d=i||.15;try{n=e.buffered}catch(e){return null}if(null!=n){for(var f=0,c=n.length;f<c;f+=1)if(r=n.start(f),a=n.end(f),null===s){if(l=Math.abs(r-t),t>=r&&t<a){s=r,o=a;continue}if(l<=u){s=r,o=a;continue}}else{if(!((l=r-o)<=d))break;o=a}if(null!==s)return{start:s,end:o}}return null},this.getAllRanges=function(e){try{return e.buffered}catch(e){return null}},this.waitForUpdateEnd=function(e,t){if(!1!==e.updating){var i,n=function(){e.updating||(clearInterval(i),t(!0))},r=function(){e.updating||(e.removeEventListener("updateend",r,!1),t(!0))};if("function"==typeof e.addEventListener)try{e.addEventListener("updateend",r,!1)}catch(e){i=setInterval(n,50)}else i=setInterval(n,50)}else t(!0)},this.dataQduration=function(e,t){var n,r=i.playbackStarted?i.videoModel.getCurrentTime():i.videoModel.getStartTime(),a=i.getBufferRange(e,r),s=null!=a?a.end:r,o=0;if(e.queue)for(var l=0;l<e.queue.length;l++)"data"===(n=e.queue[l]).type&&n.time<s+i.prefetchThreshold[e.type]&&s<n.time+n.dur&&(o+=n.dur);return o},this.setMediaSource=function(e){i.mse=e},this.remove=function(e,t,n,r,a,s){try{t>=0&&n>t&&"ended"!==a.readyState&&e.remove(t,n),i.waitForUpdateEnd(e,(function(e){s(!0)}))}catch(e){s(!1)}},this.abort=function(e,t){i.playbackStarted=!1;try{"open"===e.readyState&&t.abort()}catch(e){Q.log(e.description)}},this.playbackStarted=!1,this.prefetchThreshold={video:void 0!==e.BUFFER_PREFETCH_THRESHOLD_V?e.BUFFER_PREFETCH_THRESHOLD_V:e.BUFFER_PREFETCH_THRESHOLD||15,audio:void 0!==e.BUFFER_PREFETCH_THRESHOLD_A?e.BUFFER_PREFETCH_THRESHOLD_A:e.BUFFER_PREFETCH_THRESHOLD||15},this.appendEnableThreshold={video:void 0!==e.MSE_APPEND_ENABLE_THRESHOLD_V?e.MSE_APPEND_ENABLE_THRESHOLD_V:e.MSE_APPEND_ENABLE_THRESHOLD||5,audio:void 0!==e.MSE_APPEND_ENABLE_THRESHOLD_A?e.MSE_APPEND_ENABLE_THRESHOLD_A:e.MSE_APPEND_ENABLE_THRESHOLD||5},this.eventBus=t,this.useFetch=!(!e.USE_FETCH||!("fetch"in window)),this.buffers=[],this.append=this.useFetch?this.appendF:this.appendX,this.appendFromQ=this.useFetch?this.appendFromQF:this.appendFromQX}return e.prototype.getBufferLength=function(e,t,i){var n=this.getBufferRange(e,t,this.videoModel.getCurrentTime()>0?i:.5);return null===n?0:n.end-t},e}(),Y=function(e){for(var t=new Uint8Array(e.length),i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t},W=function(e){return String.fromCharCode.apply(String,e)},j=function(e){for(var t=e.buffer,i=new DataView(t),n=0;n<t.byteLength;){var r=i.getUint32(n,!1),a=i.getUint32(n+4,!1);if(1886614376!=a)throw"Box type "+a.toString(16)+' not equal to "pssh"';if(2584014969==i.getUint32(n+12,!1)&&2554348166==i.getUint32(n+16,!1)&&2878531163==i.getUint32(n+20,!1)&&3767033749==i.getUint32(n+24,!1))return e;if(0==i.getUint32(n+12,!1)&&0==i.getUint32(n+16,!1)&&0==i.getUint32(n+20,!1)&&1==i.getUint32(n+24,!1)){var s=i.getUint32(n+28,!1);return new Uint8Array(t.slice(n+32+3,n+32+s))}if(3991899049==i.getUint32(n+12,!1)&&2044086990==i.getUint32(n+16,!1)&&2747803612==i.getUint32(n+20,!1)&&3575456237==i.getUint32(n+24,!1))return new Uint8Array(t.slice(n+36,n+52));n+=r}return e},$=function(){function e(e,t){var i=this;this.logHandler=m,this.init=function(e,t){i.element=e,i.EME01b_prefix=t},this.supportsCodec=function(e,t){var i="WebKitMediaKeys"in window,n="MSMediaKeys"in window;return"MediaKeys"in window?MediaKeys.isTypeSupported(e,t):i?WebKitMediaKeys.isTypeSupported(e,t):!!n&&MSMediaKeys.isTypeSupported(e,t)},this.createMediaKeys=function(e){var t="WebKitMediaKeys"in window,n="MSMediaKeys"in window;return"MediaKeys"in window?(i.logHandler.log_DRM("new MediaKeys( "+e+" )",99),new MediaKeys(e)):t?(i.logHandler.log_DRM("new WebKitMediaKeys( "+e+" )",99),new WebKitMediaKeys(e)):n?(i.logHandler.log_DRM("new MSMediaKeys( "+e+" )",99),new MSMediaKeys(e)):null},this.setMediaKey=function(e,t){var n="WebKitSetMediaKeys"in e,r="msSetMediaKeys"in e;return"setMediaKeys"in e?e.setMediaKeys(t):n?e.WebKitSetMediaKeys(t):r?e.msSetMediaKeys(t):void i.NXDebug.log("no setmediakeys function in element")},this.createSession=function(e,t,n){var r;try{m.log_DRM("createSession()<br>&nbsp;&nbsp;codec ==> "+t,1),r=e.createSession(t,n)}catch(e){i.logHandler.log_DRM("Error: createSession "+String(e))}return r},this.getKeySystems=function(){var e=function(e,t,n,r){var a=null,s=[],l=new DOMParser,u=String.fromCharCode.apply(null,e),d=l.parseFromString(u,"application/xml"),f=o(n,"query")?n.query.concat():[],c=o(n,"header")?n.header.concat():[],g=o(n,"onPrepare")?n.onPrepare:function(){},p=o(n,"onSuccess")?n.onSuccess:function(){},h=o(n,"onError")?n.onError:function(){};if(d.getElementsByTagName("PlayReadyKeyMessage")[0]){if(!d.getElementsByTagName("Challenge")[0])return void r({status:"error",msg:"DRM: playready update, can not find Challenge in keyMessage"});var y=d.getElementsByTagName("Challenge")[0].childNodes[0].nodeValue;y&&(a=T(y))}else a=u;var v=d.getElementsByTagName("name"),S=d.getElementsByTagName("value");if(v.length==S.length){for(var E=0;E<v.length;E++)s[E]={name:v[E].childNodes[0].nodeValue,value:S[E].childNodes[0].nodeValue};if(i.useFetch){var b={},D={aborted:!1},R={method:"POST",headers:{},credentials:"same-origin"};b.url=t,g({req:b,qrys:f,hdrs:c,xhr:b}),f.length>0&&f.forEach((function(e){b.url+=b.url.indexOf("?")>0?"&":"?",b.url+=e.name+"="+e.value})),t=b.url,c.length>0&&c.forEach((function(e){s.push({name:e.name,value:e.value})})),s.push({name:"Content-Type",value:"text/xml; charset=utf-8"}),s&&s.forEach((function(e){R.headers[e.name]=e.value})),R.body=a,fetch(b.url,R).then((function(e){return m.log_DRM("License( res.status == "+e.status+" )",3),b.status=e.status,1==e.ok?e.arrayBuffer():Promise.reject(new Error("res.false"))})).then((function(e){p({status:b.status,req:b,xhr:b}),r({status:"ok",data:new Uint8Array(e)})})).catch((function(e){D.abort&&(b.status=-1),h({status:b.status,req:b,xhr:b}),b.status>0?r({status:"error",msg:"DRM: playready update, XHR status code is"+b.status}):-1==b.status?r({status:"error",msg:"DRM: License Request is aborted."}):r({status:"error",msg:"DRM: playready update, XHR error."})}))}else{var M=new XMLHttpRequest;M.keysTypeString="com.microsoft.playready",M.url=t,g({req:M,qrys:f,hdrs:c,xhr:M}),f.length>0&&f.forEach((function(e){M.url+=M.url.indexOf("?")>0?"&":"?",M.url+=e.name+"="+e.value})),t=M.url,c.length>0&&c.forEach((function(e){s.push({name:e.name,value:e.value})})),M.onload=function(){m.log_DRM("License( xhr.status == "+M.status+" )",3),200==M.status?(p({status:M.status,req:M,xhr:M}),r({status:"ok",data:new Uint8Array(M.response)})):(h({status:M.status,req:M,xhr:M}),r({status:"error",msg:'DRM: playready update, XHR status is "'+M.statusText+'" ('+M.status+"), expected to be 200. readyState is "+M.readyState}))},M.onabort=function(){h({status:M.status,req:M,xhr:M}),r({status:"error",msg:'DRM: playready update, XHR aborted. status is "'+M.statusText+'" ('+M.status+"), readyState is "+M.readyState})},M.onerror=function(){h({status:M.status,req:M,xhr:M}),r({status:"error",msg:'DRM: playready update, XHR error. status is "'+M.statusText+'" ('+M.status+"), readyState is "+M.readyState})},M.open("POST",M.url),M.responseType="arraybuffer",s.push({name:"Content-Type",value:"text/xml; charset=utf-8"}),s&&s.forEach((function(e){M.setRequestHeader(e.name,e.value)})),M.send(a)}m.log_DRM("Get License()<br>&nbsp;&nbsp;laURL ==> "+t,2)}else r({status:"error",msg:"DRM: playready update, invalid header name/value pair in keyMessage"})},t=function(e,t,n,r){var a=[],s=o(n,"query")?n.query.concat():[],l=o(n,"header")?n.header.concat():[],u=o(n,"onPrepare")?n.onPrepare:function(){},d=o(n,"onSuccess")?n.onSuccess:function(){},f=o(n,"onError")?n.onError:function(){};if(i.useFetch){var c={},g={aborted:!1},p={method:"POST",headers:{},credentials:"same-origin"};c.url=t,u({req:c,qrys:s,hdrs:l,xhr:c}),s.length>0&&s.forEach((function(e){c.url+=c.url.indexOf("?")>0?"&":"?",c.url+=e.name+"="+e.value})),t=c.url,a.push({name:"Content-Type",value:"text/xml; charset=utf-8"}),l.length>0&&l.forEach((function(e){a.push({name:e.name,value:e.value})})),a&&a.forEach((function(e){p.headers[e.name]=e.value})),p.body=e,fetch(c.url,p).then((function(e){return m.log_DRM("License( res.status == "+e.status+" )",3),c.status=e.status,1==e.ok?e.arrayBuffer():Promise.reject(new Error("res.false"))})).then((function(e){d({status:c.status,req:c,xhr:c}),r({status:"ok",data:new Uint8Array(e)})})).then((function(e){g.abort&&(c.status=-1),f({status:c.status,req:c,xhr:c}),c.status>0?r({status:"error",msg:"DRM: playready update, XHR status code is"+c.status}):-1==c.status?r({status:"error",msg:"DRM: License Request is aborted."}):r({status:"error",msg:"DRM: playready update, XHR error."})}))}else{var h=new XMLHttpRequest;h.keysTypeString="com.microsoft.playready",h.onload=function(){m.log_DRM("Key( xhr.status == "+h.status+" )",3),200==h.status?(d({status:h.status,req:h,xhr:h}),r({status:"ok",data:new Uint8Array(h.response)})):(f({status:h.status,req:h,xhr:h}),r({status:"error",msg:'DRM: playready update, XHR status is "'+h.statusText+'" ('+h.status+"), expected to be 200. readyState is "+h.readyState}))},h.onabort=function(){m.log_DRM("playreadyGetKeyEME01b: xhr.onabort"+h.status,-1),f({status:h.status,req:h,xhr:h}),r({status:"error",msg:'DRM: playready update, XHR aborted. status is "'+h.statusText+'" ('+h.status+"), readyState is "+h.readyState})},h.onerror=function(){m.log_DRM("playreadyGetKeyEME01b: xhr.onerror == "+h.status,-1),f({status:h.status,req:h,xhr:h}),r({status:"error",msg:'DRM: playready update, XHR error. status is "'+h.statusText+'" ('+h.status+"), readyState is "+h.readyState})},h.url=t,u({req:h,qrys:s,hdrs:l,xhr:h}),s.length>0&&s.forEach((function(e){h.url+=h.url.indexOf("?")>0?"&":"?",h.url+=e.name+"="+e.value})),t=h.url,a.push({name:"Content-Type",value:"text/xml; charset=utf-8"}),l.length>0&&l.forEach((function(e){a.push({name:e.name,value:e.value})})),h.open("POST",h.url),h.responseType="arraybuffer",a&&a.forEach((function(e){h.setRequestHeader(e.name,e.value)})),h.send(e)}m.log_DRM("GetKey<br>&nbsp;&nbsp;laURL ==> "+t,2)},n=function(e,t){return!0},r=function(e){var t,i,n,r=0,a=new Uint8Array([112,115,115,104,0,0,0,0]),s=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]),o=null,l=null,u=null;if("pro"in e)o=S(e.pro.__text);else{if(!("prheader"in e))return null;o=S(e.prheader.__text)}return t=o.length,i=4+a.length+s.length+4+t,n=new ArrayBuffer(i),l=new Uint8Array(n),(u=new DataView(n)).setUint32(r,i),r+=4,l.set(a,r),r+=a.length,l.set(s,r),r+=s.length,u.setUint32(r,t),r+=4,l.set(o,r),r+=t,l};return[{schemeIdUri:"urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95",keysTypeString:"com.microsoft.playready",isSupported:function(e){return this.schemeIdUri===e.schemeIdUri.toLowerCase()},needToAddKeySession:n,getInitData:r,getUpdate:e,getKeyEME01b:t},{schemeIdUri:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",keysTypeString:"com.widevine.alpha",isSupported:function(e){return this.schemeIdUri===e.schemeIdUri.toLowerCase()},needToAddKeySession:n,getInitData:r,getUpdate:function(e,t,n,r){var a=r||function(){},s=i,l=[],u=o(n,"query")?n.query.concat():[],d=o(n,"header")?n.header.concat():[],f=o(n,"onPrepare")?n.onPrepare:function(){},c=o(n,"onSuccess")?n.onSuccess:function(){},m=o(n,"onError")?n.onError:function(){},g=new XMLHttpRequest;g.keysTypeString="com.widevine.alpha",g.url=t,f({req:g,qrys:u,hdrs:d,xhr:g}),u.length>0&&u.forEach((function(e){g.url+=g.url.indexOf("?")>0?"&":"?",g.url+=e.name+"="+e.value})),t=g.url,d.length>0&&d.forEach((function(e){l.push({name:e.name,value:e.value})})),g.onload=function(){s.logHandler.log_DRM("License( xhr.status == "+g.status+" )",3),200==g.status?(c({status:g.status,req:g,xhr:g}),a({status:"ok",data:new Uint8Array(g.response)})):(m({status:g.status,req:g,xhr:g}),a({status:"error",msg:'DRM: widevine update, XHR status is "'+g.statusText+'" ('+g.status+"), expected to be 200. readyState is "+g.readyState}))},g.onabort=function(){m({status:g.status,req:g,xhr:g}),a({status:"error",msg:'DRM: widevine update, XHR aborted. status is "'+g.statusText+'" ('+g.status+"), readyState is "+g.readyState})},g.onerror=function(){m({status:g.status,req:g,xhr:g}),a({status:"error",msg:'DRM: widevine update, XHR error. status is "'+g.statusText+'" ('+g.status+"), readyState is "+g.readyState})},g.open("POST",g.url),g.responseType="arraybuffer",l&&l.forEach((function(e){g.setRequestHeader(e.name,e.value)})),g.send(e),i.logHandler.log_DRM("Get License()<br>&nbsp;&nbsp;laURL ==> "+t,2)},getKeyEME01b:function(e,t,n,r){var a=i,s=[],l=o(n,"query")?n.query.concat():[],u=o(n,"header")?n.header.concat():[],d=o(n,"onPrepare")?n.onPrepare:function(){},f=o(n,"onSuccess")?n.onSuccess:function(){},c=o(n,"onError")?n.onError:function(){},m=new XMLHttpRequest;m.keysTypeString="com.widevine.alpha",m.onload=function(){a.logHandler.log_DRM("Key( xhr.status == "+m.status+" )",3),200==m.status?(f({status:m.status,req:m,xhr:m}),r({status:"ok",data:new Uint8Array(m.response)})):(c({status:m.status,req:m,xhr:m}),r({status:"error",msg:'DRM: widevine update, XHR status is "'+m.statusText+'" ('+m.status+"), expected to be 200. readyState is "+m.readyState}))},m.onabort=function(){a.logHandler.log_DRM("widevineGetKeyEME01b: xhr.onabort"+m.status,-1),c({status:m.status,req:m,xhr:m}),r({status:"error",msg:'DRM: widevine update, XHR aborted. status is "'+m.statusText+'" ('+m.status+"), readyState is "+m.readyState})},m.onerror=function(){a.logHandler.log_DRM("widevineGetKeyEME01b: xhr.onerror == "+m.status,-1),c({status:m.status,req:m,xhr:m}),r({status:"error",msg:'DRM: widevine update, XHR error. status is "'+m.statusText+'" ('+m.status+"), readyState is "+m.readyState})},m.url=t,d({req:m,qrys:l,hdrs:u,xhr:m}),l.length>0&&l.forEach((function(e){m.url+=m.url.indexOf("?")>0?"&":"?",m.url+=e.name+"="+e.value})),t=m.url,u.length>0&&u.forEach((function(e){s.push({name:e.name,value:e.value})})),m.open("POST",m.url),m.responseType="arraybuffer",s&&s.forEach((function(e){m.setRequestHeader(e.name,e.value)})),m.send(e),i.logHandler.log_DRM("GetKey<br>&nbsp;&nbsp;laURL ==> "+t,2)}},{schemeIdUri:"urn:mpeg:dash:mp4protection:2011",keysTypeString:"com.microsoft.playready",isSupported:function(e){return this.schemeIdUri===e.schemeIdUri.toLowerCase()&&"cenc"===e.value.toLowerCase()},needToAddKeySession:n,getInitData:function(){return null},getUpdate:e,getKeyEME01b:t},{schemeIdUri:"urn:uuid:1077efec-c0b2-4d02-ace3-3c1e52e2fb4b",keysTypeString:"webkit-org.w3.clearkey",isSupported:function(e){return this.schemeIdUri===e.schemeIdUri.toLowerCase()},needToAddKeySession:function(){return!0},getInitData:function(){return null},getUpdate:function(e){return e},getKeyEME01b:function(){return null}}]},this.generateKeyRequest=function(e,t,n){var r;null!=n&&m.log("generateKeyRequest ("+n.keySystem.keysTypeString+")",1),r=null==n?"webkit-org.w3.clearkey":n.keySystem.keysTypeString;var a=i,s=t;t&&e||m.log("generateKeyRequest Called 1 data false","#c0c0ff");try{"function"==typeof e.webkitGenerateKeyRequest&&null!=r&&null!=t?(m.log_DRM("webkitGenerateKeyRequest()",1),e.webkitGenerateKeyRequest(r,s),a.initDataQueue.push(s)):"function"==typeof e.generateKeyRequest?("webkit-org.w3.clearkey"!==r?e.generateKeyRequest(r,s):e.generateKeyRequest("org.w3.clearkey",s),a.initDataQueue.push(s),m.log_DRM("generateKeyRequest()",1)):"function"==typeof e.msGenerateKeyRequest&&("webkit-org.w3.clearkey"!==r?e.msGenerateKeyRequest(r,s):e.msGenerateKeyRequest("org.w3.clearkey",s),a.initDataQueue.push(t),m.log_DRM("msGenerateKeyRequest()",1)),m.log_DRM("KeyInfo ==> "+r,99)}catch(e){m.log_DRM("generateKeyRequest Error "+e,-1)}},this.addKey=function(e,t,n,r){"function"==typeof i.element.webkitAddKey?(i.element.webkitAddKey(r,e,t,n),m.log_DRM("webkitAddKey sessionID:"+n,1)):"function"==typeof i.element.msaddKey?(i.element.msaddKey(r,e,t,n),m.log_DRM("msaddKey sessionID:"+n,1)):"function"==typeof i.element.addKey&&(i.element.addKey("com.youtube.playready",e,t,n),m.log_DRM("addKey sessionID:"+n+" keystr: "+r,1))},this.extractClearKeyKIDFromPSSHBox=function(e){for(var t=j(e),i=JSON.parse(T(W(t))).keys[0].kid,n=4-i.length%4,r=0;r<n;r++)i+="=";var a=S(i);return("0"+a[0].toString(16)).slice(-2)+("0"+a[1].toString(16)).slice(-2)+("0"+a[2].toString(16)).slice(-2)+("0"+a[3].toString(16)).slice(-2)+"-"+("0"+a[4].toString(16)).slice(-2)+("0"+a[5].toString(16)).slice(-2)+"-"+("0"+a[6].toString(16)).slice(-2)+("0"+a[7].toString(16)).slice(-2)+"-"+("0"+a[8].toString(16)).slice(-2)+("0"+a[9].toString(16)).slice(-2)+"-"+("0"+a[10].toString(16)).slice(-2)+("0"+a[11].toString(16)).slice(-2)+("0"+a[12].toString(16)).slice(-2)+("0"+a[13].toString(16)).slice(-2)+("0"+a[14].toString(16)).slice(-2)+("0"+a[15].toString(16)).slice(-2)},this.eventBus=t,this.NXDebug=new s,this.useFetch=!(!e.USE_FETCH||!("fetch"in window)),this.useFetch=!1,this.initDataQueue=[],this.element=null,this.EME01b_prefix=null}return e.prototype.extractClearKeyFromMessageForRMKSA=function(e){try{var t=j(e);return JSON.parse(T(W(t)))}catch(e){return void this.NXDebug.debug(e)}},e.prototype.addKeyForClearKey=function(e,t,i){var n,r,a,s=this;try{n=j(i);var o=JSON.parse(T(W(n)));r=o.keys[0].kid,a=o.keys[0].k;for(var l=4-r.length%4,u=0;u<l;u++)r+="=";var d=S(r);for(l=4-a.length%4,u=0;u<l;u++)a+="=";var f=S(a)}catch(e){return void s.NXDebug.debug(e)}this.logHandler.log(T(W(n))),this.logHandler.log("kid:"+r+", key:"+a),"function"==typeof s.element.webkitAddKey?(m.log(">> CK webkitAddKey sessionID:"+t,"#40ff40"),s.element.webkitAddKey("webkit-org.w3.clearkey",f,d,t)):"function"==typeof s.element.msaddKey?(m.log(">> CK msaddKey sessionID:"+t,"#40ff40"),s.element.msaddKey("org.w3.clearkey",f,d,t)):"function"==typeof s.element.addKey&&(s.element.addKey("org.w3.clearkey",f,d,t),m.log(">> CK addKey sessionID:"+t,"#40ff40"))},e.prototype.extractPROFromPSSHBox=function(e){for(var t=e.buffer,i=new DataView(t),n=0;n<t.byteLength;){var r=i.getUint32(n,!1),a=i.getUint32(n+4,!1);if(1886614376!=a)throw"Box type "+a.toString(16)+' not equal to "pssh"';if(2584014969==i.getUint32(n+12,!1)&&2554348166==i.getUint32(n+16,!1)&&2878531163==i.getUint32(n+20,!1)&&3767033749==i.getUint32(n+24,!1)){var s=i.getUint32(n+28,!1),o=new Uint16Array(t.slice(n+32+10,n+32+s)),l=W(o);return(new DOMParser).parseFromString(l,"application/xml")}n+=r}return null},e.prototype.extractKIDFromPSSHBox=function(e){for(var t=e.buffer,i=new DataView(t),n=0;n<t.byteLength;){var r=i.getUint32(n,!1),a=i.getUint32(n+4,!1);if(1886614376!=a)throw"Box type "+a.toString(16)+' not equal to "pssh"';if(2584014969==i.getUint32(n+12,!1)&&2554348166==i.getUint32(n+16,!1)&&2878531163==i.getUint32(n+20,!1)&&3767033749==i.getUint32(n+24,!1)){var s,o=i.getUint32(n+28,!1),l=new Uint16Array(t.slice(n+32+10,n+32+o)),u=void 0,d=void 0;s=W(l);var f=(new DOMParser).parseFromString(s,"application/xml");return f.getElementsByTagName("LA_URL")[0],f.getElementsByTagName("KID")[0]&&(u=f.getElementsByTagName("KID")[0].childNodes[0].nodeValue),("0"+(d=S(u))[3].toString(16)).slice(-2)+("0"+d[2].toString(16)).slice(-2)+("0"+d[1].toString(16)).slice(-2)+("0"+d[0].toString(16)).slice(-2)+"-"+("0"+d[5].toString(16)).slice(-2)+("0"+d[4].toString(16)).slice(-2)+"-"+("0"+d[7].toString(16)).slice(-2)+("0"+d[6].toString(16)).slice(-2)+"-"+("0"+d[8].toString(16)).slice(-2)+("0"+d[9].toString(16)).slice(-2)+"-"+("0"+d[10].toString(16)).slice(-2)+("0"+d[11].toString(16)).slice(-2)+("0"+d[12].toString(16)).slice(-2)+("0"+d[13].toString(16)).slice(-2)+("0"+d[14].toString(16)).slice(-2)+("0"+d[15].toString(16)).slice(-2)}n+=r}return"CCC"},e.prototype.extractWideVineKIDFromPSSHBox=function(e){for(var t=e.buffer,i=new DataView(t),n=0;n<t.byteLength;){var r=i.getUint32(n,!1),a=i.getUint32(n+4,!1);if(1886614376!=a)throw"Box type "+a.toString(16)+' not equal to "pssh"';if(3991899049==i.getUint32(n+12,!1)&&2044086990==i.getUint32(n+16,!1)&&2747803612==i.getUint32(n+20,!1)&&3575456237==i.getUint32(n+24,!1)){var s=new Uint8Array(t.slice(n+32+4,n+32+4+16));return("0"+s[0].toString(16)).slice(-2)+("0"+s[1].toString(16)).slice(-2)+("0"+s[2].toString(16)).slice(-2)+("0"+s[3].toString(16)).slice(-2)+"-"+("0"+s[4].toString(16)).slice(-2)+("0"+s[5].toString(16)).slice(-2)+"-"+("0"+s[6].toString(16)).slice(-2)+("0"+s[7].toString(16)).slice(-2)+"-"+("0"+s[8].toString(16)).slice(-2)+("0"+s[9].toString(16)).slice(-2)+"-"+("0"+s[10].toString(16)).slice(-2)+("0"+s[11].toString(16)).slice(-2)+("0"+s[12].toString(16)).slice(-2)+("0"+s[13].toString(16)).slice(-2)+("0"+s[14].toString(16)).slice(-2)+("0"+s[15].toString(16)).slice(-2)}n+=r}return"CCC"},e.prototype.listenToNeedKey=function(e,t){e.listen("webkitneedkey",t),e.listen("msneedkey",t),e.listen("needKey",t)},e.prototype.listenToNeedKeyEME01b=function(e,t){m.log("listenToNeedKeyEME01b:"+this.EME01b_prefix,"#8080ff"),e.addEventListener({standard:"needkey",webkit:"webkitneedkey",ms:"msneedkey"}[this.EME01b_prefix],t,!1)},e.prototype.listenToKeyError=function(e,t){e.addEventListener("webkitkeyerror",t,!1),e.addEventListener("mskeyerror",t,!1),e.addEventListener("keyerror",t,!1)},e.prototype.listenToKeyMessage=function(e,t){try{e.addEventListener("webkitkeymessage",t,!1),e.addEventListener("mskeymessage",t,!1),e.addEventListener("keymessage",t,!1)}catch(e){m.log("listenToKeyMessage Error: "+e.message,"#8080ff")}},e.prototype.listenToKeyAdded=function(e,t){e.addEventListener("webkitkeyadded",t,!1),e.addEventListener("mskeyadded",t,!1),e.addEventListener("keyadded",t,!1)},e.prototype.unlistenToNeedKeyEME01b=function(e,t){m.log("unlistenToNeedKeyEME01b:"+this.EME01b_prefix,"#8080ff"),e.removeEventListener({standard:"needkey",webkit:"webkitneedkey",ms:"msneedkey"}[this.EME01b_prefix],t,!1)},e.prototype.unlistenToNeedKey=function(e,t){e.unlisten("webkitneedkey",t),e.unlisten("msneedkey",t),e.unlisten("needKey",t)},e.prototype.unlistenToKeyError=function(e,t){e.removeEventListener("webkitkeyerror",t),e.removeEventListener("mskeyerror",t),e.removeEventListener("keyerror",t)},e.prototype.unlistenToKeyMessage=function(e,t){e.removeEventListener("webkitkeymessage",t),e.removeEventListener("mskeymessage",t),e.removeEventListener("keymessage",t)},e.prototype.unlistenToKeyAdded=function(e,t){e.removeEventListener("webkitkeyadded",t),e.removeEventListener("mskeyadded",t),e.removeEventListener("keyadded",t)},e}(),J=function(){function e(e,t){var i=this;this.logHandler=m,this.teardownKeySystem=function(e){var t=i;i.removeKeySystem.call(t,e)},this.selectKeySystem=function(e,t,n){for(var r=i,a=0;a<i.keySystemDescs.length;++a)for(var s=0;s<t.length;++s)if(i.keySystemDescs[a].isSupported(t[s])&&i.protectionExt.supportsCodec(i.keySystemDescs[a].keysTypeString,e)){var o=void 0;return o||(o="com.microsoft.playready"===i.keySystemDescs[a].keysTypeString?i.protectionExt.extractKIDFromPSSHBox(n):"com.widevine.alpha"===i.keySystemDescs[a].keysTypeString?i.protectionExt.extractWideVineKIDFromPSSHBox(n):"unknown"),i.logHandler.log_item("codec_video","V-Codec: "+e),i.logHandler.log_item("keysystem","KeySystem: "+i.keySystemDescs[a].keysTypeString),i.logHandler.log_item("keysystem_kid_v","KID: "+o),-1==i.kids.indexOf(o)&&(i.NXDebug.debug(String(i.kids)),i.addKeySystem.call(r,o,t[s],i.keySystemDescs[a]),i.kids.push(o)),i.logHandler.log_DRM("  KID ==> "+o,99),i.logHandler.log_DRM("  KeyInfo ==> "+i.keySystemDescs[a].keysTypeString,99),i.logHandler.log_DRM("  Codec ==> "+e,99),i.NXDebug.log("DRM: Selected Key System: "+i.keySystemDescs[a].keysTypeString+" For KID: "+o),{kid:o,keysTypeString:i.keySystemDescs[a].keysTypeString}}throw new Error("DRM: The protection system for this content is not supported.")},this.ensureKeySession=function(e,t,n){var r=i,a=null,s=null;return i.needToAddKeySession.call(r,e)?(s||null==n||(s=n,i.logHandler.log("DRM: Using initdata from needskey event."),i.NXDebug.log("DRM: Using initdata from needskey event.")),null!=s?(a=i.addKeySession.call(r,e,t,s),i.logHandler.log("DRM: Added Key Session ["+(a.sessionIdIsAvailable?a.sessionId:a.tmpSessionId)+"] for KID: "+e+" type: "+t),i.NXDebug.log("DRM: Added Key Session ["+a.sessionId+"] for KID: "+e+" type: "+t)):i.NXDebug.log("DRM: initdata is null."),a):null},this.updateFromMessage=function(e,t,n,r,a){var s=i;i._updateFromMessage.call(s,e,n,r,i.xhrCustom,(function(e){"ok"===e.status?(t.update(e.data),i.logHandler.log_DRM("update()",1),a(e)):a(e)}))},this.updateFromMessageForClearKey=function(e,t,n){i.protectionExt.addKeyForClearKey(e,t,n)},this.addKeySession=function(e,t,n){var r=null;try{r=i.protectionExt.createSession(i.keySystems[e].keys,t,n)}catch(e){i.logHandler.log("createSession "+e)}r.sessionId?r.sessionIdIsAvailable=!0:r.tmpSessionId=(new Date).getTime();try{i.protectionExt.listenToKeyAdded(r,i.keyAddedListener),i.protectionExt.listenToKeyError(r,i.keyErrorListener),i.protectionExt.listenToKeyMessage(r,i.keyMessageListener),i.keySystems[e].initData=n,i.keySystems[e].keySessions.push(r)}catch(e){i.logHandler.log("after listener "+e)}return r},this.addKeySystem=function(e,t,n){var r=null;null==i.element.mediaKeysObject?(r=i.protectionExt.createMediaKeys(n.keysTypeString),i.protectionExt.setMediaKey(i.element,r)):r=i.element.mediaKeysObject,i.keySystems[e]={kID:e,contentProtection:t,keySystem:n,keys:r,initData:null,keySessions:[]}},this.removeKeySystem=function(e){if(null!==e&&void 0!==i.keySystems[e]&&0!==i.keySystems[e].keySessions.length){for(var t=i.keySystems[e].keySessions,n=0;n<t.length;++n)i.protectionExt.unlistenToKeyError(t[n],i.keyErrorListener),i.protectionExt.unlistenToKeyAdded(t[n],i.keyAddedListener),i.protectionExt.unlistenToKeyMessage(t[n],i.keyMessageListener),t[n].close();i.keySystems[e]=void 0}},this.needToAddKeySession=function(e){var t=i.keySystems[e];return t.keySystem.needToAddKeySession(t.initData,t.keySessions)},this._updateFromMessage=function(e,t,n,r,a){return i.keySystems[e].keySystem.getUpdate(t,n,r,a)},this.element=null,this.keyAddedListener=null,this.keyErrorListener=null,this.keyMessageListener=null,this.keySystems=[],this.kids=[],this.keySystemDescs=null,this.videoModel=null,this.xhrCustom=null,this.protectionExt=new $(e,t),this.NXDebug=new s}return e.prototype.init=function(e,t,i){this.videoModel=e,this.xhrCustom=t,this.element=this.videoModel.getElement(),this.keySystemDescs=this.protectionExt.getKeySystems(),this.protectionExt.init(this.element,"")},e.prototype.listenToNeedKey=function(e){this.protectionExt.listenToNeedKey(this.videoModel,e)},e.prototype.listenToKeyError=function(e){this.keyErrorListener=e;for(var t=0;t<this.keySystems.length;++t)for(var i=this.keySystems[t].keySessions,n=0;n<i.length;++n)this.protectionExt.listenToKeyError(i[n],e)},e.prototype.listenToKeyMessage=function(e){this.keyMessageListener=e;for(var t=0;t<this.keySystems.length;++t)for(var i=this.keySystems[t].keySessions,n=0;n<i.length;++n)this.logHandler.log("Model.listenToKeyMessage "+n),this.protectionExt.listenToKeyMessage(i[n],e)},e.prototype.listenToKeyAdded=function(e){this.keyAddedListener=e;for(var t=0;t<this.keySystems.length;++t)for(var i=this.keySystems[t].keySessions,n=0;n<i.length;++n)this.protectionExt.listenToKeyAdded(i[n],e)},e.prototype.unlistenToNeedKey=function(e){this.protectionExt.unlistenToNeedKey(this.videoModel,e)},e.prototype.unlistenToKeyError=function(e){for(var t=0;t<this.keySystems.length;++t)for(var i=this.keySystems[t].keySessions,n=0;n<i.length;++n)this.protectionExt.unlistenToKeyError(i[n],e)},e.prototype.unlistenToKeyMessage=function(e){for(var t=0;t<this.keySystems.length;++t)for(var i=this.keySystems[t].keySessions,n=0;n<i.length;++n)this.protectionExt.unlistenToKeyMessage(i[n],e)},e.prototype.unlistenToKeyAdded=function(e){for(var t=0;t<this.keySystems.length;++t)for(var i=this.keySystems[t].keySessions,n=0;n<i.length;++n)this.protectionExt.unlistenToKeyAdded(i[n],e)},e}(),Z=function(){function e(e,t){var i=this;this.logHandler=m,this.selectKeySystemEME01b=function(e,t){for(var n=null,r=0;r<i.keySystems.length;++r)for(var a=0;a<e.length;++a)if(i.keySystems[r].isSupported(e[a]))return n="com.microsoft.playready"===i.keySystems[r].keysTypeString?i.protectionExt.extractKIDFromPSSHBox(t):"com.widevine.alpha"===i.keySystems[r].keysTypeString?i.protectionExt.extractWideVineKIDFromPSSHBox(t):"unknown",i.logHandler.log_item("keysystem","KeySystem: "+i.keySystems[r].keysTypeString),i.logHandler.log_item("keysystem_kid_v","KID: "+n),i.addKeySystem01b(n,e[a],i.keySystems[r]),{kid:n,initData:t,keysTypeString:i.keySystems[r].keysTypeString};return n},this._licenseFromMessage=function(e,t,n,r,a){return i.NXDebug.debug("_licenseFromMessage "+e+" "+n),i.logHandler.log("_licenseFromMessage "+e+" "+n),i.keySystems[e].keySystem.getKeyEME01b(t,n,r,a)},this.addKeyFromMessage=function(e,t,n,r,a,s){void 0===s&&(s=function(){});var o=i,l=i.keySystems[e].keySystem.keysTypeString;i._licenseFromMessage.call(o,e,r,a,i.xhrCustom,(function(e){"ok"===e.status?(i.protectionExt.addKey(e.data,n,t,l),s(e)):s(e)}))},this.addKeyFromMessageForClearKey=function(e,t,n,r,a){i.protectionExt.addKeyForClearKey(e,t,n)},this.element=null,this.keySystems=[],this.xhrCustom=null,this.protectionExt=null,this.NXDebug=new s,this.params=e,this.eventBus=t}return e.prototype.init=function(e,t,i){this.videoModel=e,this.element=e.getElement(),this.xhrCustom=t;try{this.protectionExt=new $(this.params,this.eventBus)}catch(e){this.logHandler.log(e)}this.protectionExt.init(this.element,i),this.keySystems=this.protectionExt.getKeySystems()},e.prototype.addKeySystem01b=function(e,t,i){this.keySystems[e]={kID:e,contentProtection:t,keySystem:i,keys:null,initData:null,keySessions:[]}},e.prototype.getInitData=function(e){var t=this.keySystems[e];return t.keySystem.getInitData(t.contentProtection)},e.prototype.getKeysTypeString=function(e){return this.keySystems[e].keySystem.keysTypeString},e.prototype.addKey=function(e,t,i,n){this.logHandler.log_DRM("ProtectionModel::addKey "+e+" "+t,1),this.protectionExt.addKey(this.element,e,t,i)},e.prototype.generateKeyRequest=function(e,t){"clearkey"!=t?this.protectionExt.generateKeyRequest(this.element,e,this.keySystems[t]):this.protectionExt.generateKeyRequest(this.element,e,null)},e.prototype.listenToNeedKey=function(e){this.protectionExt.listenToNeedKeyEME01b(this.element,e)},e.prototype.listenToKeyMessage=function(e){this.protectionExt.listenToKeyMessage(this.element,e)},e.prototype.listenToKeyAdded=function(e){this.protectionExt.listenToKeyAdded(this.element,e)},e.prototype.listenToKeyError=function(e){this.protectionExt.listenToKeyError(this.element,e)},e.prototype.unlistenToNeedKey=function(e){this.protectionExt.unlistenToNeedKeyEME01b(this.element,e)},e.prototype.unlistenToKeyMessage=function(e){this.protectionExt.unlistenToKeyMessage(this.element,e)},e.prototype.unlistenToKeyAdded=function(e){this.protectionExt.unlistenToKeyAdded(this.element,e)},e.prototype.unlistenToKeyError=function(e){this.protectionExt.unlistenToKeyError(this.element,e)},e}(),ee=function(){function e(e,t){var i=this;this.logHandler=m,this.createSupportedKeySystem=function(e,t){var i=[],n={initDataTypes:["cenc"]};return e.video&&(n.videoCapabilities=[{contentType:e.video,robustness:""}]),e.audio&&(n.audioCapabilities=[{contentType:e.audio,robustness:""}]),i.push(n),navigator.requestMediaKeySystemAccess(t,i).then((function(e){return e.createMediaKeys()}))},this.getSystems=function(){return[{schemeIdUri:"urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95",keysTypeString:"com.microsoft.playready",isSupported:function(e){return this.schemeIdUri===e.schemeIdUri.toLowerCase()}},{schemeIdUri:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",keysTypeString:"com.widevine.alpha",isSupported:function(e){return this.schemeIdUri===e.schemeIdUri.toLowerCase()}},{schemeIdUri:"urn:mpeg:dash:mp4protection:2011",keysTypeString:"com.microsoft.playready",isSupported:function(e){return this.schemeIdUri===e.schemeIdUri.toLowerCase()&&"cenc"===e.value.toLowerCase()}},{schemeIdUri:"urn:uuid:1077efec-c0b2-4d02-ace3-3c1e52e2fb4b",keysTypeString:"org.w3.clearkey",isSupported:function(e){return this.schemeIdUri===e.schemeIdUri.toLowerCase()}}]},this.selectKeySystemRMKSA=function(e,t,n,r,a,s){var o,l=a,u=r,d=n;if(i.keySystemDescs[l].isSupported(t[u]))i.createSupportedKeySystem(e,i.keySystemDescs[l].keysTypeString).then((function(n){if(0==s&&(d=t[u].pssh),o="com.microsoft.playready"===i.keySystemDescs[l].keysTypeString?i.protectionExt.extractKIDFromPSSHBox(new Uint8Array(d)):"com.widevine.alpha"===i.keySystemDescs[l].keysTypeString?i.protectionExt.extractWideVineKIDFromPSSHBox(new Uint8Array(d)):"org.w3.clearkey"===i.keySystemDescs[l].keysTypeString?i.protectionExt.extractClearKeyKIDFromPSSHBox(new Uint8Array(d)):"unknown",i.logHandler.log_item("codec_video","V-Codec: "+e.video),i.logHandler.log_item("keysystem","KeySystem: "+i.keySystemDescs[l].keysTypeString),i.logHandler.log_item("keysystem_kid_v","KID: "+o),i.logHandler.log_DRM("  KID ==> "+o,99),i.logHandler.log_DRM("  KeyInfo ==> "+i.keySystemDescs[l].keysTypeString,99),i.logHandler.log_DRM("  Codec ==> "+e.video,99),i.NXDebug.log("DRM: Selected Key System: "+i.keySystemDescs[l].keysTypeString+" For KID: "+o),n.keysTypeString=i.keySystemDescs[l].keysTypeString,n.schemeIdUri=i.keySystemDescs[l].schemeIdUri,i.element.mediaKeysObject=n,s){for(var r=0;r<i.element.pendingSessionData.length;r++){var a=i.element.pendingSessionData[r];i.makeNewRequest(i.element.mediaKeysObject,a.initDataType,a.initData)}i.element.pendingSessionData=[]}else{for(r=0;r<i.element.pendingContentProtectionData.length;r++){var f=i.element.pendingContentProtectionData[r];i.keySystemDescs[l].isSupported(f)&&i.makeNewRequest(i.element.mediaKeysObject,"cenc",f.pssh)}i.element.pendingContentProtectionData=[]}return i.element.setMediaKeys(n)})).catch((function(n){if(i.NXDebug.log(i.keySystemDescs[l].keysTypeString+" error:"+n),u<t.length-1)u++;else{if(!(l<i.keySystemDescs.length-1))throw new Error("DRM: The protection system for this content is not supported.");l++,u=0}i.selectKeySystemRMKSA(e,t,d,u,l,s)}));else{if(u<t.length-1)u++;else{if(!(l<i.keySystemDescs.length-1))throw new Error("DRM: The protection system for this content is not supported.");l++,u=0}i.selectKeySystemRMKSA(e,t,d,u,l,s)}},this.addKeySession=function(e,t,n){e.mediaKeysObject?i.makeNewRequest(e.mediaKeysObject,t,n):e.pendingSessionData.push({initDataType:t,initData:n})},this.addContentProtectionData=function(e,t){if(e.mediaKeysObject)for(var n=0;n<t.length;n++)e.mediaKeysObject.schemeIdUri==t[n].schemeIdUri.toLowerCase()&&i.makeNewRequest(e.mediaKeysObject,"cenc",t[n].pssh);else e.pendingContentProtectionData=e.pendingContentProtectionData.concat(t)},this.makeNewRequest=function(e,t,n){var r,a,s=i,o=null,l=e.keysTypeString;if("com.microsoft.playready"===l){if(a=new Uint8Array(n),r=i.protectionExt.extractKIDFromPSSHBox(a),i.kids.indexOf(r)>-1)return;i.kids.push(r);var u,d=i.protectionExt.extractPROFromPSSHBox(a);u=d.getElementsByTagName("LA_URL")[0]?d.getElementsByTagName("LA_URL")[0].childNodes[0].nodeValue:"unknown",(o=e.createSession("temporary")).laURL=u,o.keysTypeString=l,o.addEventListener("message",i.licenseRequestReady.bind(i),!1),o.generateRequest(t,n).then((function(){})).catch((function(e){i.logHandler.log("gerateRequest error")}))}else if("com.widevine.alpha"===l){if(a=new Uint8Array(n),r=i.protectionExt.extractWideVineKIDFromPSSHBox(a),i.kids.indexOf(r)>-1)return;i.kids.push(r),(o=e.createSession("temporary")).keysTypeString=l,o.addEventListener("message",i.licenseRequestReady_wv.bind(i),!1),o.generateRequest(t,n).then((function(){})).catch((function(){s.logHandler.log("gerateRequest error")}))}else if("org.w3.clearkey"==l){var f=i.protectionExt.extractClearKeyFromMessageForRMKSA(new Uint8Array(n)),c={};if(r=f.keys[0].kid,c.kids=[r],i.kids.indexOf(r)>-1)return;i.kids.push(r),(o=e.createSession()).addEventListener("message",i.handleClearKeyMessage.bind(i,f),!1),o.generateRequest("keyids",Y(JSON.stringify(c)))}},this.handleClearKeyMessage=function(e,t){var n=t.target;e.type="temporary",n.update(Y(JSON.stringify(e))).then((function(){i.stream.onKeyAdded()})).catch((function(e){i.logHandler.log(e)}))},this.licenseRequestReady=function(e){var t,n,r=new Uint8Array(e.message),a=String.fromCharCode.apply(null,Array.from(r)),s=null,l=new DOMParser,u=l.parseFromString(a,"application/xml"),d=[],f=o(i.xhrCustom,"query")?i.xhrCustom.query.concat():[],c=o(i.xhrCustom,"header")?i.xhrCustom.header.concat():[],g=o(i.xhrCustom,"onPrepare")?i.xhrCustom.onPrepare:function(){},p=o(i.xhrCustom,"onSuccess")?i.xhrCustom.onSuccess:function(){},h=o(i.xhrCustom,"onError")?i.xhrCustom.onError:function(){};if(u.getElementsByTagName("parsererror")[0]&&(r=new Uint16Array(e.message),a=String.fromCharCode.apply(null,Array.from(r)),u=l.parseFromString(a,"application/xml")),t=u.getElementsByTagName("LA_URL")[0]?u.getElementsByTagName("LA_URL")[0].childNodes[0].nodeValue:e.target.laURL,u.getElementsByTagName("PlayReadyKeyMessage")[0]){if(!u.getElementsByTagName("Challenge")[0])return void i.logHandler.log("error: DRM: playready update, can not find Challenge in keyMessage");var y=u.getElementsByTagName("Challenge")[0].childNodes[0].nodeValue;y&&(s=T(y))}else s=a;var v=u.getElementsByTagName("name"),S=u.getElementsByTagName("value");if(v.length==S.length){for(var E=0;E<v.length;E++)d[E]={name:v[E].childNodes[0].nodeValue,value:S[E].childNodes[0].nodeValue};if(i.useFetch){var b={},D={aborted:!1},R={method:"POST",headers:{},credentials:"same-origin"};b.keySession=e.target,b.url=t,g({req:b,qrys:f,hdrs:c,xhr:b}),f.length>0&&f.forEach((function(e){b.url+=b.url.indexOf("?")>0?"&":"?",b.url+=e.name+"="+e.value})),t=b.url,c.length>0&&c.forEach((function(e){d.push({name:e.name,value:e.value})})),d&&(n=!1,d.forEach((function(e){R.headers[e.name]=e.value,"content-type"===e.name.toLowerCase()&&(n=!0)})),n||(R.headers["Content-Type"]="text/xml; charset=utf-8")),R.body=s,fetch(b.url,R).then((function(e){return m.log_DRM("License( res.status == "+e.status+" )",3),b.status=e.status,1==e.ok?e.arrayBuffer():Promise.reject(new Error("res.false"))})).then((function(e){p({status:b.status,req:b,xhr:b}),b.keySession.update(e).then((function(){i.stream.onKeyAdded()})).catch((function(e){i.NXDebug.info("session.update error")}))})).then((function(e){D.aborted&&(m.log_DRM("License Request aborted.",3),b.status=-1),h({status:b.status,req:b,xhr:b})}))}else{var M=new XMLHttpRequest;M.keySession=e.target,M.keysTypeString=e.target.keysTypeString,M.url=t,g({req:M,qrys:f,hdrs:c,xhr:M}),f.length>0&&f.forEach((function(e){M.url+=M.url.indexOf("?")>0?"&":"?",M.url+=e.name+"="+e.value})),t=M.url,c.length>0&&c.forEach((function(e){d.push({name:e.name,value:e.value})})),M.onload=function(){m.log_DRM("License( xhr.status == "+M.status+" )",3),200==M.status?(p({status:M.status,req:M,xhr:M}),M.keySession.update(M.response).then((function(){i.stream.onKeyAdded()})).catch((function(e){i.NXDebug.info("session.update error")}))):h({status:M.status,req:M,xhr:M})},M.onabort=function(){h({status:M.status,req:M,xhr:M})},M.onerror=function(){h({status:M.status,req:M,xhr:M})},M.open("POST",M.url),M.responseType="arraybuffer",d&&(n=!1,d.forEach((function(e){M.setRequestHeader(e.name,e.value),"content-type"===e.name.toLowerCase()&&(n=!0)})),n||M.setRequestHeader("Content-Type","text/xml; charset=utf-8")),M.send(s)}m.log_DRM("Get License()<br>&nbsp;&nbsp;laURL ==> "+t,2)}else i.logHandler.log("error: DRM: playready update, invalid header name/value pair in keyMessage")},this.licenseRequestReady_wv=function(e){var t=i,n=new Uint8Array(e.message),r=[],a=o(i.xhrCustom,"query")?i.xhrCustom.query.concat():[],s=o(i.xhrCustom,"header")?i.xhrCustom.header.concat():[],l=o(i.xhrCustom,"onPrepare")?i.xhrCustom.onPrepare:function(){},u=o(i.xhrCustom,"onSuccess")?i.xhrCustom.onSuccess:function(){},d=o(i.xhrCustom,"onError")?i.xhrCustom.onError:function(){},f=new XMLHttpRequest;f.keySession=e.target,f.keysTypeString=e.target.keysTypeString,f.url="unknown",l({req:f,qrys:a,hdrs:s,xhr:f}),a.length>0&&a.forEach((function(e){f.url+=f.url.indexOf("?")>0?"&":"?",f.url+=e.name+"="+e.value})),s.length>0&&s.forEach((function(e){r.push({name:e.name,value:e.value})})),f.onload=function(){t.logHandler.log_DRM("License( xhr.status == "+f.status+" )",3),200==f.status?(u({status:f.status,req:f,xhr:f}),f.keySession.update(f.response).then((function(){t.stream.onKeyAdded()})).catch((function(){t.NXDebug.info("session.update error")}))):d({status:f.status,req:f,xhr:f})},f.onabort=function(){d({status:f.status,req:f,xhr:f})},f.onerror=function(){d({status:f.status,req:f,xhr:f})},f.open("POST",f.url),f.responseType="arraybuffer",f.send(n)},this.element=null,this.kids=[],this.keySystemDescs=null,this.xhrCustom=null,this.protectionExt=null,this.stream=null,this.useFetch=!(!e.USE_FETCH||!("fetch"in window)),this.useFetch=!1,this.NXDebug=new s,this.eventBus=t,this.checkList=[{schemeIdUri:"urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95",keysTypeString:"com.microsoft.playready"},{schemeIdUri:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",keysTypeString:"com.widevine.alpha"},{schemeIdUri:"urn:uuid:1077efec-c0b2-4d02-ace3-3c1e52e2fb4b",keysTypeString:"org.w3.clearkey"}]}return e.prototype.init=function(e,t,i,n){this.videoModel=e,this.element=e.getElement(),this.xhrCustom=i,this.keySystemDescs=this.getSystems.call(this),this.stream=t;try{this.protectionExt=new $({},this.eventBus)}catch(e){this.logHandler.log(e)}this.protectionExt.init(this.element,n)},e.prototype.listenToEncrypted=function(e){this.videoModel.listen("encrypted",e)},e.prototype.listenToKeyAdded=function(e){this.protectionExt.listenToKeyAdded(this.element,e)},e.prototype.listenToKeyError=function(e){this.protectionExt.listenToKeyError(this.element,e)},e.prototype.unlistenToEncrypted=function(e){this.videoModel.unlisten("encrypted",e)},e.prototype.unlistenToKeyAdded=function(e){this.protectionExt.unlistenToKeyAdded(this.element,e)},e.prototype.unlistenToKeyError=function(e){this.protectionExt.unlistenToKeyError(this.element,e)},e.prototype.reset=function(){this.kids=[]},e}(),te=function(){function e(e,t,i){var n=this;this.sessionIds={},this.errHandler=f,this.logHandler=m,this.sessionToKID={},this.onMediaSourceNeedsKey=function(e){var t,i;n.logHandler.log_item("needkey_type",e.type),n.eventTypeList.push(e.type),null==n.stream||n.periodInfo||(n.periodInfo=n.stream.getPeriodInfo());var r=n.periodInfo.getPrimaryMediaData("video");null!==r&&(t=r.getCodec(),i=r.getContentProtectionData(),n.logHandler.log("Code: "+t,"#ff8080"),n.logHandler.log("CP: "+i[0].schemeIdUri,"#ff8080")),n.needsKeyQue.push({type:e.type,initData:e.initData,codec:t,contentProtection:i}),n.needsKeyProcessing?(n.needsKeyProcessListener=n.needsKeyHandlerMED.bind(self),n.eventBus.addEventListener("ON_ADDED_KEY_PROCESSED",n.needsKeyProcessListener)):n.needsKeyHandlerMED.call(self,null)},this.needsKeyHandlerMED=function(e){var t,i,r=n,a=null!=e?e.data.keysTypeString:"none";if(0==n.needsKeyQue.length)return n.eventBus.removeEventListener("ON_ADDED_KEY_PROCESSED",n.needsKeyProcessListener),void(n.needsKeyProcessListener=null);for(n.stream.clearInitTimer();n.needsKeyQue.length>0;){if(t=n.needsKeyQue.shift(),n.logHandler.log("EventType: "+t.type,"#ff8080"),n.NXDebug.log("DRM: Key required for - "+t.codec),n.logHandler.log("DRM: Key required for - "+t.codec),null!=t.contentProtection&&null!=t.codec)try{if(i=n.protectionModel.selectKeySystem(t.codec,t.contentProtection,t.initData),n.kid=i.kid,"none"!=a&&a!=i.keysTypeString)continue}catch(e){n.NXDebug.log(e),n.errHandler.mediaKeySystemSelectionError(n.eventBus,e);continue}var s;if(n.initData.push({type:t.codec,initData:t.initData}),n.logHandler.log("kid: "+n.kid,"#ff8080"),null!=n.kid&&(s=n.protectionModel.ensureKeySession(n.kid,t.codec,t.initData))){s.sessionIdIsAvailable?n.sessionToKID[s.sessionId]=n.kid:n.sessionToKID[s.tmpSessionId]=n.kid,n.needsKeyProcessing=!0,n.needsKeyProcessingTimerId=setTimeout((function(){r.needsKeyProcessing&&(r.needsKeyProcessing=!1,r.eventBus.dispatchEvent({type:"ON_ADDED_KEY_PROCESSED",data:{kid:r.kid,keysTypeString:"none"}})),r.stream.onKeyAdded(),r.needsKeyProcessingTimerId=null}),1e3),n.needsKeyQue.length>0&&!n.needsKeyProcessListener&&(n.needsKeyProcessListener=n.needsKeyHandlerEME01b.bind(r),n.eventBus.addEventListener("ON_ADDED_KEY_PROCESSED",n.needsKeyProcessListener));break}}},this.onMediaSourceKeyMessage=function(e){var t,i=null,r=null,a=e.target.keySystem,s=null;n.NXDebug.log("DRM: Got a key message..."),n.needsKeyProcessingTimerId&&(clearTimeout(n.needsKeyProcessingTimerId),n.needsKeyProcessingTimerId=null),t=e.target,"webkit-org.w3.clearkey"!==a&&"org.w3.clearkey"!==a?(i="mskeymessage"==e.type?new Uint16Array(e.message.buffer):new Uint16Array(e.message),r=e.destinationURL||"unknown",n.logHandler.log_DRM("message<br>&nbsp;&nbsp;laURL ==> "+r,0),s=t.sessionIdIsAvailable?n.sessionToKID[t.sessionId]:n.sessionToKID[t.tmpSessionId],n.protectionModel.updateFromMessage(s,t,i,r,(function(e){"error"===e.status&&(n.NXDebug.log(e.msg),n.errHandler.mediaKeyMessageError(n.eventBus,e.msg)),n.updatedKIDs.push(s),n.eventBus.dispatchEvent({type:"addKeyProcessed",data:{kid:s,keysTypeString:a}})}))):(s=t.sessionIdIsAvailable?n.sessionToKID[t.sessionId]:n.sessionToKID[t.tmpSessionId],n.protectionModel.updateFromMessageForClearKey(s,t.sessionId,e.message))},this.onMediaSourceEncrypted=function(e){var t=e.target,i={},r=null;if(void 0===t.mediaKeysObject){t.mediaKeysObject=null,t.pendingSessionData=[],null==n.stream||n.periodInfo||(n.periodInfo=n.stream.getPeriodInfo());var a=n.periodInfo.getPrimaryMediaData("video");null!==a&&(i.video=a.getCodec(),r=a.getContentProtectionData()),null!==(a=n.periodInfo.getPrimaryMediaData("audio"))&&(i.audio=a.getCodec(),r||(r=a.getContentProtectionData())),n.protectionModel.selectKeySystemRMKSA(i,r,e.initData,0,0,!0)}n.protectionModel.addKeySession(t,e.initDataType,e.initData)},this.createMediaKeysFromMPD_MED=function(e,t){},this.createMediaKeysFromMPD_EME01b=function(e,t){var i,r=n;if(null!==e&&(i=e.getContentProtectionData()))for(var a=0;a<i.length;a++)i[a].pssh&&n.needsKeyQue.push({type:"fromMPD",initData:i[a].pssh,contentProtection:[i[a]]});if(null!==t&&(i=t.getContentProtectionData()))for(a=0;a<i.length;a++)i[a].pssh&&n.needsKeyQue.push({type:"fromMPD",initData:i[a].pssh,contentProtection:[i[a]]});n.needsKeyProcessing?n.needsKeyProcessListener||(n.needsKeyProcessListener=n.needsKeyHandlerEME01b.bind(r),n.eventBus.addEventListener("ON_ADDED_KEY_PROCESSED",n.needsKeyProcessListener)):n.needsKeyHandlerEME01b.call(r,null)},this.createMediaKeysFromMPD_RMKS=function(e,t){var i,r={},a=[];if(null!==e&&(r.video=e.getCodec(),i=e.getContentProtectionData()))for(var s=0;s<i.length;s++)i[s].pssh&&a.push(i[s]);if(null!==t&&(r.audio=t.getCodec(),i=t.getContentProtectionData()))for(s=0;s<i.length;s++)i[s].pssh&&a.push(i[s]);a.length>0&&(void 0===n.element.mediaKeysObject&&(n.element.mediaKeysObject=null,n.element.pendingContentProtectionData=[],n.element.pendingSessionData=[],console.info(a),n.protectionModel.selectKeySystemRMKSA(r,a,null,0,0,!1)),n.protectionModel.addContentProtectionData(n.element,a))},this.onMediaSourceKeyAdded=function(){n.logHandler.log_DRM("Key Added",0),n.NXDebug.log("DRM: Key added."),n.stream.onKeyAdded()},this.onMediaSourceKeyError=function(e){var t=e.target,i="DRM: MediaKeyError - sessionId: "+t.sessionId+" errorCode: "+t.error.code+" systemErrorCode: "+t.error.systemCode+" [";switch(t.error.code){case 1:i+="MEDIA_KEYERR_UNKNOWN - An unspecified error occurred. This value is used for errors that don't match any of the other codes.";break;case 2:i+="MEDIA_KEYERR_CLIENT - The Key System could not be installed or updated.";break;case 3:i+="MEDIA_KEYERR_SERVICE - The message passed into update indicated an error from the license service.";break;case 4:i+="MEDIA_KEYERR_OUTPUT - There is no available output device with the required characteristics for the content protection system.";break;case 5:i+="MEDIA_KEYERR_HARDWARECHANGE - A hardware configuration change caused a content protection error.";break;case 6:i+="MEDIA_KEYERR_DOMAIN - An error occurred in a multi-device domain licensing configuration. The most common error is a failure to join the domain."}i+="]",n.NXDebug.log(i),n.errHandler.mediaKeySessionError(n.eventBus,i)},this.onAddKeyProcessed=function(e){n.needsKeyProcessingTimerId&&(clearTimeout(n.needsKeyProcessingTimerId),n.needsKeyProcessingTimerId=null),n.needsKeyProcessing&&(n.needsKeyProcessing=!1,n.eventBus.dispatchEvent({type:"ON_ADDED_KEY_PROCESSED",data:{kid:e.data.kid,keysTypeString:e.data.keysTypeString}})),n.stream.onKeyAdded()},this.needsKeyHandlerEME01b=function(e){var t,i,r=n,a=null!=e?e.data.keysTypeString:"none";if(0==n.needsKeyQue.length)return n.eventBus.removeEventListener("ON_ADDED_KEY_PROCESSED",n.needsKeyProcessListener),void(n.needsKeyProcessListener=null);for(n.stream.clearInitTimer(),n.logHandler.log("needsKeyQue.len:"+n.needsKeyQue.length);n.needsKeyQue.length>0;){if(t=n.needsKeyQue.shift(),n.logHandler.log_DRM("needkey( "+t.type+" )",0),t.contentProtection){if(i=n.protectionModel.selectKeySystemEME01b(t.contentProtection,t.initData),n.kid=i.kid,"none"!=a&&a!=i.keysTypeString)continue}else n.protectionModel.generateKeyRequest(t.initData,"clearkey");if(n.updatedKIDs.indexOf(n.kid)<0){n.logHandler.log("kid= "+n.kid,"#fff0f0"),n.needsKeyProcessingTimerId=setTimeout((function(){r.needsKeyProcessing&&(r.needsKeyProcessing=!1,r.eventBus.dispatchEvent({type:"ON_ADDED_KEY_PROCESSED",data:{kid:r.kid,keysTypeString:"none"}})),r.needsKeyProcessingTimerId=null}),1e3),n.needsKeyQue.length>0&&!n.needsKeyProcessListener&&(n.needsKeyProcessListener=n.needsKeyHandlerEME01b.bind(r),n.eventBus.addEventListener("ON_ADDED_KEY_PROCESSED",n.needsKeyProcessListener)),n.initData.push(t.initData),n.needsKeyProcessing=!0,n.protectionModel.generateKeyRequest(t.initData,n.kid);break}}},this.onMediaSourceNeedsKeyEME01b=function(e){var t=n,i=null,r=null;null==n.stream||n.periodInfo||(n.periodInfo=n.stream.getPeriodInfo());var a=n.periodInfo.getPrimaryMediaData("video");null!==a&&(i=a.getCodec(),r=a.getContentProtectionData(),n.logHandler.log(i,"#fff0f0")),n.needsKeyQue.push({type:e.type,initData:e.initData,contentProtection:r}),n.needsKeyProcessing?(n.needsKeyProcessListener=n.needsKeyHandlerEME01b.bind(n),n.eventBus.addEventListener("ON_ADDED_KEY_PROCESSED",n.needsKeyProcessListener)):n.needsKeyHandlerEME01b.call(t,null)},this.onMediaSourceKeyMessageEME01b=function(e){var t,i=n,r=e.defaultURL,a=e.keySystem||n.protectionModel.getKeysTypeString(n.kid),s=null;if(n.logHandler.log_DRM("KeyRequest<br>&nbsp;&nbsp;defaultURL ==> "+(null!=e.defaultURL?r:"NONE"),0),"com.microsoft.playready"==a){if(s=String.fromCharCode.apply(String,e.message),!e.defaultURL){var o=(new DOMParser).parseFromString(s,"application/xml");o.getElementsByTagName("LA_URL")[0]&&(r=o.getElementsByTagName("LA_URL")[0].childNodes[0].nodeValue)}}else"com.widevine.alpha"==a&&(s=e.message,e.defaultURL||(r="unknown"));if((t=e.sessionId)in n.sessionIds)return n.logHandler.log("<< onMediaSourceKeyMessageEME01b 99 : sessionId="+t,"#80ff80"),n.needsKeyProcessingTimerId&&(clearTimeout(n.needsKeyProcessingTimerId),n.needsKeyProcessingTimerId=null),void(n.needsKeyProcessing&&(n.needsKeyProcessing=!1,n.eventBus.dispatchEvent({type:"ON_ADDED_KEY_PROCESSED",data:{kid:n.kid,keysTypeString:"none"}})));n.sessionIds[t]=t,r||""!=a||(a="org.w3.clearkey");var l=n.initData.shift();"webkit-org.w3.clearkey"!==a&&"org.w3.clearkey"!==a?n.protectionModel.addKeyFromMessage(n.kid,t,l,s,r,(function(e){"ok"==e.status&&(i.updatedKIDs.push(i.kid),i.eventBus.dispatchEvent({type:"addKeyProcessed",data:{kid:i.kid,keysTypeString:a}}))})):(n.protectionModel.addKeyFromMessageForClearKey(n.kid,t,l,s,r),n.updatedKIDs.push(n.kid),n.eventBus.dispatchEvent({type:"addKeyProcessed",data:{kid:n.kid,keysTypeString:a}})),n.logHandler.log("onMediaSourceKeyMessageEME01b 2",0)},this.onMediaSourceKeyAddedEME01b=function(e){n.logHandler.log_DRM("Key added sessionID:"+e.sessionId,0)},this.onMediaSourceKeyErrorEME01b=function(e){n.needsKeyProcessingTimerId&&(clearTimeout(n.needsKeyProcessingTimerId),n.needsKeyProcessingTimerId=null),n.needsKeyProcessing&&(n.needsKeyProcessing=!1,n.eventBus.dispatchEvent({type:"ON_ADDED_KEY_PROCESSED",data:{kid:"none",keysTypeString:"none"}}))},this.MediaKeys_prefix=function(){var e="WebKitMediaKeys"in window,t="MSMediaKeys"in window,i="MediaKeys"in window,r="----";return e?r="webkit":t?r="ms":i&&(r="standard"),n.eme_prefix=r,r},this.EME01b_prefix=function(e){var t="function"==typeof e.webkitGenerateKeyRequest,i="function"==typeof e.msGenerateKeyRequest,r="----";return"function"==typeof e.generateKeyRequest?r="standard":t?r="webkit":i&&(r="ms"),n.eme_prefix=r,r},this.supportsRequestMediaKeySystemAccess=function(){var e="requestMediaKeySystemAccess"in navigator;return e&&n.logHandler.log_item("EME_ver",'EME: <span style="color:#808080">01b</span> <span style="color:#e7527d">requestMediaKeySystemAccess('+n.MediaKeys_prefix()+")</span>"),e},this.supportsMediaKeys=function(){var e="WebKitMediaKeys"in window,t="MSMediaKeys"in window,i="MediaKeys"in window;return(e||t||i)&&n.logHandler.log_item("EME_ver",'EME: <span style="color:#808080">01b</span> <span style="color:#e7527d">MediaKeys('+n.MediaKeys_prefix()+")</span>"),e||t||i},this.supportsEME01b=function(){var e="function"==typeof n.element.webkitGenerateKeyRequest,t="function"==typeof n.element.msGenerateKeyRequest,i="function"==typeof n.element.generateKeyRequest;return(e||t||i)&&n.logHandler.log_item("EME_ver",'EME: <span style="color:#e7527d">01b( '+n.EME01b_prefix(n.element)+' )</span> <span style="color:#808080">MediaKeys</span>'),e||t||i},this.createMediaKeysFromMPD=function(e,t){n.supportsRequestMediaKeySystemAccess()?n.createMediaKeysFromMPD_RMKS(e,t):n.supportsMediaKeys()?n.createMediaKeysFromMPD_MED(e,t):n.supportsEME01b()&&n.createMediaKeysFromMPD_EME01b(e,t)},this.stream=null,this.videoModel=null,this.element=null,this.eme_prefix=null,this.periodInfo=null,this.protectionModel=null,this.initData=[],this.updatedKIDs=[],this.kid=null,this.sessionIds={},this.needsKeyQue=[],this.eventTypeList=[],this.needsKeyProcessListener=null,this.needsKeyProcessing=!1,this.needsKeyProcessingTimerId=null,this.NXDebug=new s,this.sessionToKID={},this.encryptedListener,this.needKeyListener,this.keyMessageListener,this.keyAddedListener,this.keyErrorListener,this.eventBus=t,this.params=e,this.xhrCustom=i}return e.prototype.init=function(e){this.stream=e,this.videoModel=e.getVideoModel(),this.element=this.videoModel.getElement(),this.eventBus.addEventListener("addKeyProcessed",this.onAddKeyProcessed.bind(this)),this.logHandler.log("EME"+this.videoModel,"#ff8080"),this.supportsRequestMediaKeySystemAccess()?(this.protectionModel=new ee(this.params,this.eventBus),this.protectionModel.init(this.videoModel,this.stream,this.xhrCustom,""),this.encryptedListener=this.onMediaSourceEncrypted.bind(this),this.protectionModel.listenToEncrypted(this.encryptedListener)):(this.supportsMediaKeys()||this.supportsEME01b())&&(this.supportsMediaKeys()?(this.logHandler.log("MediaKeys 1","#ff8080"),this.protectionModel=new J(this.params,this.eventBus),this.protectionModel.init(this.videoModel,this.xhrCustom),this.needKeyListener=this.onMediaSourceNeedsKey.bind(this),this.keyMessageListener=this.onMediaSourceKeyMessage.bind(this),this.keyAddedListener=this.onMediaSourceKeyAdded.bind(this),this.keyErrorListener=this.onMediaSourceKeyError.bind(this)):this.supportsEME01b()&&(this.logHandler.log("01b 1","#ff8080"),this.protectionModel=new Z(this.params,this.eventBus),this.protectionModel.init(this.videoModel,this.xhrCustom,this.eme_prefix),this.needKeyListener=this.onMediaSourceNeedsKeyEME01b.bind(this),this.keyMessageListener=this.onMediaSourceKeyMessageEME01b.bind(this),this.keyAddedListener=this.onMediaSourceKeyAddedEME01b.bind(this),this.keyErrorListener=this.onMediaSourceKeyErrorEME01b.bind(this),this.logHandler.log("01b 4","#ff8080")),this.protectionModel.listenToNeedKey(this.needKeyListener),this.protectionModel.listenToKeyMessage(this.keyMessageListener),this.protectionModel.listenToKeyAdded(this.keyAddedListener),this.protectionModel.listenToKeyError(this.keyErrorListener))},e.prototype.supportsProtection=function(){return this.supportsMediaKeys.call(this)||this.supportsEME01b.call(this)||this.supportsRequestMediaKeySystemAccess.call(this)},e.prototype.reset=function(){this.needsKeyProcessing=!1,this.element&&(this.element.mediaKeysObject=void 0),this.needsKeyProcessingTimerId&&(clearTimeout(this.needsKeyProcessingTimerId),this.needsKeyProcessingTimerId=null),this.supportsRequestMediaKeySystemAccess()?(this.protectionModel.unlistenToEncrypted(this.encryptedListener),this.protectionModel.reset()):(this.supportsMediaKeys()||this.supportsEME01b())&&(this.protectionModel.unlistenToNeedKey(this.needKeyListener),this.protectionModel.unlistenToKeyMessage(this.keyMessageListener),this.protectionModel.unlistenToKeyAdded(this.keyAddedListener),this.protectionModel.unlistenToKeyError(this.keyErrorListener))},e}(),ie=function(){function e(e,t,i,n,r,a){var l=this;this.updateDataReason=ne,this.errHandler=f,this.logHandler=m,this.play=function(e){l.initialized&&l.videoModel.play(e)},this.pause=function(e){l.scheduleWhilePaused=!1,l.suspend.call(l),l.videoModel.pause(e),l.videoModel.setSelfPaused(e)},this.seek=function(e){l.initialized&&(l.NXDebug.debug("Do seek: "+e),l.videoModel.isDummy()?l.videoModel.setStartTime(e):(l.eventBus.dispatchEvent({type:"setCurrentTime",data:{}}),l.videoModel.setCurrentTime(e)),l.startBuffering(e,e,"1"))},this.supportsCodec=function(e,t){if(!(e instanceof HTMLVideoElement))throw"element must be of type HTMLVideoElement.";l.logHandler.log("codec:::"+t);var i=e.canPlayType(t);return l.logHandler.log("canPlay:::"+i),"probably"===i||"maybe"===i},this.tearDownMediaSource=function(){null!=l.videoController&&l.videoController.reset(l.errored),null!=l.audioController&&l.audioController.reset(l.errored),null!=l.textController&&l.textController.reset(l.errored),null!=l.mediaSource&&(l.sourceBufferExt.setAppendStatus(!1,[],0),l.sourceBufferExt.detachAllBuffers()),l.initialized=!1,l.audioInitData=[],l.videoInitData=[],l.eventTimerList=[],l.audioInitReceived=!1,l.videoInitReceived=!1,l.lastCheckGapTime=-1,l.checkGapTimerId&&(clearInterval(l.checkGapTimerId),l.checkGapTimerId=null),l.nextPeriodTopIsAlreadyBuffered=!1,l.contentProtections=null,l.videoController=null,l.audioController=null,l.textController=null,l.sourceBufferExt=null,l.videoCodec=null,l.audioCodec=null,l.mediaSource=null,l.manifest=null},this.initializeVideoSource=function(e,t){var i=l,n=l.periodInfo.getDataForRole("video",l.DEFAULT_ROLE_FOR_VIDEO),r=!1,a=null;if(null!==n)if(l.videoCodec=n.getCodec(),l.NXDebug.log("Video codec: "+l.videoCodec),(l.videoCodec.indexOf("hvc")>-1||l.videoCodec.indexOf("hev")>-1)&&(l.params.BDAT_INSERT_MODE=!1),l.contentProtections=n.getContentProtectionData(),l.supportsCodec.call(i,l.videoModel.getElement(),l.videoCodec))if(null==l.contentProtections||l.protectionController.supportsProtection()){l.logHandler.log_item("codec_video","V-Codec: "+l.videoCodec);var s=l.sourceBufferExt.createSourceBuffer(l.mediaSource,l.videoCodec);"ok"===s.status?(a=s.data,l.logHandler.log("video buffer was successfully created."+l.videoCodec),null===a?(l.NXDebug.log("No buffer was created, skipping video stream."),t({status:"ok",data:null})):(l.videoController=new C,a.type="video",1==r&&(a.convertCodecType=!0),l.videoController.initialize(l.params,"video",l.periodInfo,n,a,l.videoModel,l.fragmentController,l.mediaSource,l.eventBus,l.manifestModel,l.metricsModel,l.abrController,l.sourceBufferExt,l.indexHandler,e,(function(e){"ok"==e.status?(l.NXDebug.log("Video is ready!"),t({status:"ok",data:e.data})):t({status:"fail",msg:e.msg})})))):(l.logHandler.log("Failed to create video buffer"+l.videoCodec),l.videoCodec.indexOf("hev1")>-1?(l.videoCodec=l.videoCodec.replace("hev1","hvc1"),l.logHandler.log("Trying to convert hev1 -> hvc1"),r=!0,"ok"===(s=l.sourceBufferExt.createSourceBuffer(l.mediaSource,l.videoCodec)).status?(a=s.data,l.logHandler.log("video buffer was successfully created."+l.videoCodec),null===a?(l.NXDebug.log("No buffer was created, skipping video stream."),t({status:"ok",data:null})):(l.videoController=new C,a.type="video",1==r&&(a.convertCodecType=!0),l.videoController.initialize(l.params,"video",l.periodInfo,n,a,l.videoModel,l.fragmentController,l.mediaSource,l.eventBus,l.manifestModel,l.metricsModel,l.abrController,l.sourceBufferExt,l.indexHandler,e,(function(e){"ok"==e.status?(l.NXDebug.log("Video is ready!"),t({status:"ok",data:e.data})):t({status:"fail",msg:e.msg})})))):(l.errHandler.mediaSourceError(l.eventBus,"Error creating video source buffer."),t({status:"ok",data:null}))):(l.errHandler.mediaSourceError(l.eventBus,"Error creating video source buffer."),t({status:"ok",data:null})))}else l.logHandler.log("initializeVideoSource noProtection"),l.errHandler.capabilityError(l.eventBus,"mediakeys"),l.contentProtections=null,t({status:"fail",msg:"initializeVideoSource noProtection "});else{var o="Video Codec ("+l.videoCodec+") is not supported.";l.videoCodec.indexOf("hev1")>-1&&l.supportsCodec.call(i,l.videoModel.getElement(),l.videoCodec.replace("hev1","hvc1"))?(l.videoCodec=l.videoCodec.replace("hev1","hvc1"),l.logHandler.log("Trying to convert hev1 -> hvc1"),r=!0):(l.errHandler.manifestError(l.eventBus,o,"codec",l.manifest),l.NXDebug.log(o),t({status:"fail",msg:o}))}else l.NXDebug.log("No video data."),l.eventBus.dispatchEvent({type:"initDataReceived",data:{type:"video",initData:null}}),t({status:"ok",data:null})},this.initializeAudioSource=function(e,t){var i=l,n=l.periodInfo.getDataForRole("audio",l.DEFAULT_ROLE_FOR_AUDIO);if(null!==n)if(l.audioCodec=n.getCodec(),l.NXDebug.log("Audio codec: "+l.audioCodec),l.contentProtections=n.getContentProtectionData(),l.supportsCodec.call(i,l.videoModel.getElement(),l.audioCodec))if(null==l.contentProtections||l.protectionController.supportsProtection()){l.logHandler.log_item("codec_audio","A-Codec: "+l.audioCodec);var r=l.sourceBufferExt.createSourceBuffer(l.mediaSource,l.audioCodec);if("ok"===r.status){var a=r.data;l.NXDebug.debug(String(a)),null===a?(l.NXDebug.log("No buffer was created, skipping audio stream."),t({status:"ok",data:null})):(l.audioController=new C,a.type="audio",l.audioController.initialize(l.params,"audio",l.periodInfo,n,a,l.videoModel,l.fragmentController,l.mediaSource,l.eventBus,l.manifestModel,l.metricsModel,l.abrController,l.sourceBufferExt,l.indexHandler,e,(function(e){"ok"==e.status?t({status:"ok",data:e.data}):t({status:"fail",msg:e.msg})})))}else l.errHandler.mediaSourceError(l.eventBus,"Error creating audio source buffer."),t({status:"ok",data:null})}else l.errHandler.capabilityError(l.eventBus,"mediakeys"),l.contentProtections=null,t({status:"fail",msg:"Audio contents protection error"});else{var s="Audio Codec ("+l.audioCodec+") is not supported.";l.errHandler.manifestError(l.eventBus,s,"codec",l.manifest),l.NXDebug.log(s),t({status:"fail",msg:s})}else l.NXDebug.log("No audio streams."),l.eventBus.dispatchEvent({type:"initDataReceived",data:{type:"audio",initData:null}}),t({status:"ok",data:null})},this.tempInitializeVideoSource=function(e,t){var i=l.periodInfo.getDataForRole("video",l.DEFAULT_ROLE_FOR_VIDEO);null!==i?(l.videoCodec=i.getCodec(),l.NXDebug.log("Video codec: "+l.videoCodec),(l.videoCodec.indexOf("hvc")>-1||l.videoCodec.indexOf("hev")>-1)&&(l.params.BDAT_INSERT_MODE=!1),l.contentProtections=i.getContentProtectionData(),l.logHandler.log_item("codec_video","V-Codec: "+l.videoCodec),l.videoController=new C,l.videoController.initialize(l.params,"video",l.periodInfo,i,{type:"video",buffered:{length:0,start:function(e){return 0},end:function(e){return 0}}},l.videoModel,l.fragmentController,l.mediaSource,l.eventBus,l.manifestModel,l.metricsModel,l.abrController,l.sourceBufferExt,l.indexHandler,e,(function(e){"ok"==e.status?(l.NXDebug.log("Video is ready!"),t({status:"ok",data:e.data})):t({status:"fail",msg:e.msg})}))):(l.NXDebug.log("No video data."),l.eventBus.dispatchEvent({type:"initDataReceived",data:{type:"video",initData:null}}),t({status:"ok",data:null}))},this.tempInitializeAudioSource=function(e,t){var i=l.periodInfo.getDataForRole("audio",l.DEFAULT_ROLE_FOR_AUDIO);null!==i?(l.audioCodec=i.getCodec(),l.NXDebug.log("Audio codec: "+l.audioCodec),l.contentProtections=i.getContentProtectionData(),l.logHandler.log_item("codec_audio","A-Codec: "+l.audioCodec),l.audioController=new C,l.audioController.initialize(l.params,"audio",l.periodInfo,i,{type:"audio",buffered:{length:0,start:function(e){return 0},end:function(e){return 0}}},l.videoModel,l.fragmentController,l.mediaSource,l.eventBus,l.manifestModel,l.metricsModel,l.abrController,l.sourceBufferExt,l.indexHandler,e,(function(e){"ok"==e.status?t({status:"ok",data:e.data}):t({status:"fail",msg:e.msg})}))):(l.NXDebug.log("No audio streams."),l.eventBus.dispatchEvent({type:"initDataReceived",data:{type:"audio",initData:null}}),t({status:"ok",data:null}))},this.updateSourceBuffer=function(){var e,t;if(null!=l.videoController){var i=l.periodInfo.getDataForRole("video",l.DEFAULT_ROLE_FOR_VIDEO);null!==i&&(l.videoCodec=i.getCodec(),l.NXDebug.log("Video codec: "+l.videoCodec),(l.videoCodec.indexOf("hvc")>-1||l.videoCodec.indexOf("hev")>-1)&&(l.params.BDAT_INSERT_MODE=!1),"ok"===(t=l.sourceBufferExt.createSourceBuffer(l.mediaSource,l.videoCodec)).status?(e=t.data,l.logHandler.log("video buffer was successfully created."+l.videoCodec),null===e?l.NXDebug.log("No buffer was created, skipping video stream."):l.videoController.update(e,l.videoModel,l.mediaSource)):(l.logHandler.log("Failed to create video buffer"+l.videoCodec),l.videoCodec.indexOf("hev1")>-1&&(l.videoCodec=l.videoCodec.replace("hev1","hvc1"),l.logHandler.log("Trying to convert hev1 -> hvc1"),"ok"===(t=l.sourceBufferExt.createSourceBuffer(l.mediaSource,l.videoCodec)).status&&(e=t.data,l.logHandler.log("video buffer was successfully created."+l.videoCodec),null===e?l.NXDebug.log("No buffer was created, skipping video stream."):l.videoController.update(e,l.videoModel,l.mediaSource,!0)))))}if(null!=l.audioController){var n=l.periodInfo.getDataForRole("audio",l.DEFAULT_ROLE_FOR_AUDIO);null!==n&&(l.audioCodec=n.getCodec(),l.NXDebug.log("Audio codec: "+l.audioCodec),"ok"===(t=l.sourceBufferExt.createSourceBuffer(l.mediaSource,l.audioCodec)).status&&(e=t.data,l.NXDebug.debug(String(e)),null===e?l.NXDebug.log("No buffer was created, skipping audio stream."):l.audioController.update(e,l.videoModel,l.mediaSource)))}},this.initializeMediaSource=function(e){var t=l;l.manifestModel.getIsDynamic(l.manifest)||l.videoModel.setStartTime(l.initialPresentationStartTime),l.protectionController&&l.protectionController.createMediaKeysFromMPD(l.periodInfo.getDataForRole("video",l.DEFAULT_ROLE_FOR_VIDEO),l.periodInfo.getDataForRole("audio",l.DEFAULT_ROLE_FOR_AUDIO)),l.initializeVideoSource(l.initialPresentationStartTime,(function(i){if("ok"==i.status){var n=null!=i.data?i.data:l.initialPresentationStartTime;l.initializeAudioSource(n,(function(i){"ok"==i.status?l.videoController||l.audioController?(l.startBuffering.call(t,n,i.data,"INITIAL"),e(!0)):e(!1):(l.startBuffering.call(t,n,n,"INITIAL"),e(!0))}))}else e(!1)}))},this.tempInitializeMediaSource=function(e){var t=l;l.manifestModel.getIsDynamic(l.manifest)||l.videoModel.setStartTime(l.initialPresentationStartTime),l.tempInitializeVideoSource(l.initialPresentationStartTime,(function(i){if("ok"==i.status){var n=i.data||l.initialPresentationStartTime;l.tempInitializeAudioSource(n,(function(i){"ok"==i.status?l.videoController||l.audioController?(l.startBuffering.call(t,n,i.data,"INITIAL"),e(!0)):e(!1):(l.startBuffering.call(t,n,n,"INITIAL"),e(!0))}))}else e(!1)}))},this.setDuration=function(e){if("static"===l.manifest.mpd.type){try{null!=l.manifest.mpd.mediaPresentationDuration&&l.manifest.mpd.mediaPresentationDuration!==1/0?l.mediaSource.duration=l.manifest.mpd.mediaPresentationDuration:l.mediaSource.duration=l.periodInfoArray[l.periodInfoArray.length-1].end}catch(e){l.logHandler.log("duration cannot be changed while buffer updating")}l.NXDebug.log("Duration successfully set to: "+l.mediaSource.duration)}else e&&(l.mediaSource.duration=l.periodInfo.mpd.liveEdge)},this.checkGap=function(e,t){var i=l.videoModel.getCurrentTime(),n=t,r=!1;if(i!==l.lastCheckGapTime?(l.lastCheckGapTime=i,i>n-l.CHECK_GAP_INTERVAL?(l.eventBus.dispatchEvent({type:"periodEnded",data:e-1}),Math.abs(l.videoModel.getCurrentTime()-i)<.5&&(l.bufferGapBetweenPeriods(i,n)?(l.logHandler.log("### detected the buffer gap. force seeking to start time of period["+e+"] ***"+l.videoModel.getCurrentTime()+", "+i),l.NXDebug.debug("### detected the buffer gap. force seeking to start time of period["+e+"] ***"+l.videoModel.getCurrentTime()+", "+i),l.seekToNearestStartTime(n)):l.SKIP_PERIOD_BOUNDARY&&(l.logHandler.log("### SKIP_PERIOD_BOUNDARY switch is on. force seeking to start time of period["+e+"] ***"),l.NXDebug.debug("### SKIP_PERIOD_BOUNDARY switch is on. force seeking to start time of period["+e+"] ***"),l.seekToNearestStartTime(n))),r=!0):i>n+l.EPSILON-.5&&l.bufferGapOnlyInVideoBuffer(i,n)&&(r=!0,l.logHandler.log("### stalled due to the buffer gap. force seeking to start time of period["+e+"] ***"),l.NXDebug.debug("### stalled due to the buffer gap. force seeking to start time of period["+e+"] ***"),l.eventBus.dispatchEvent({type:"periodEnded",data:e-1}),Math.abs(l.videoModel.getCurrentTime()-i)<.5&&l.seekToNearestStartTime(n))):i<n&&i>n+l.EPSILON-.5&&(r=!0,l.eventBus.dispatchEvent({type:"periodEnded",data:e-1}),Math.abs(l.videoModel.getCurrentTime()-i)<.5&&l.bufferGapBetweenPeriods(i,n)&&(l.logHandler.log("*** stalled due to the buffer gap. force seeking to start time of period["+e+"] ***"+i),l.NXDebug.debug("*** stalled due to the buffer gap. force seeking to start time of period["+e+"] ***"),l.seekToNearestStartTime(n))),!l.nextPeriodTopIsAlreadyBuffered&&n-4<i&&i<n-l.CHECK_GAP_INTERVAL){var a=l.checkNextPeriodTop(n);l.eventBus.dispatchEvent({type:"PeriodChangeCheck",data:{periodIdx:e-1,timeToEnd:n-i,prepared:a}})}i>=n&&(r=!0),r&&(clearInterval(l.checkGapTimerId),l.checkGapTimerId=null,l.lastCheckGapTime=-1,l.nextPeriodTopIsAlreadyBuffered=!1)},this.dispatchCheckGap=function(e){var t=null,i=0;for(i=l.checkGapQue.length-1;0<=i;i--)if(l.checkGapQue[i].nextStart<e)l.checkGapQue.splice(i,1);else if(l.checkGapQue[i].curStart<e&&e<l.checkGapQue[i].nextStart&&l.checkGapQue[i].nextStart-2<e){t=l.checkGapQue.shift();break}null!=t&&(l.checkGapTimerId&&clearInterval(l.checkGapTimerId),l.checkGapTimerId=setInterval(l.checkGap.bind(l,t.nextIdx,t.nextStart),1e3*l.CHECK_GAP_INTERVAL))},this.onCanPlayThrough=function(){l.videoModel.unlisten("canplaythrough",l.canplaythroughListener)},this.onLoad=function(){l.NXDebug.log("Got loadmetadata event."),null===l.contentProtections&&(l.setAppendStatus(!0,0),l.setInitialSeekTime.call(l,(function(e){}))),l.eventBus.dispatchEvent({type:"GOT_LOADED_METADATA",data:{}})},this.onPlay=function(){l.updateCurrentTime.call(l)},this.onPause=function(){l.suspend.call(l),l.scheduleWhilePaused=!0,l.ltimeupdate=NaN},this.onStalled=function(){},this.onError=function(e){var t=e.srcElement.error,i=t.code,n="";if(-1!==i){switch(i){case 1:n="MEDIA_ERR_ABORTED";break;case 2:n="MEDIA_ERR_NETWORK";break;case 3:n="MEDIA_ERR_DECODE";break;case 4:n="MEDIA_ERR_SRC_NOT_SUPPORTED";break;case 5:n="MEDIA_ERR_ENCRYPTED"}l.errored=!0,l.NXDebug.log("Video Element Error: "+n),l.NXDebug.log(t),l.errHandler.mediaSourceError(l.eventBus,n),l.logHandler.log("##### STREAM Video Element Error: "+n),l.reset()}},this.setAppendStatus=function(e,t){var i=[l.videoController,l.audioController],n=t||-1;i.forEach((function(t){null!=t&&t.getBuffer().appendStart!==e&&(t.getBuffer().appendStart=e,t.getBuffer().quality=n,t.appendFromQ())}))},this.setInitData=function(e,t){var i;null!=l.videoController&&null!=e&&(void 0===(i=l.videoController.getBuffer()).updating?i.append(e):i.appendBuffer(e)),null!=l.audioController&&null!=t&&(void 0===(i=l.audioController.getBuffer()).updating?i.append(t):i.appendBuffer(t))},this.setDummy=function(){null!=l.videoController&&l.videoController.setDummy(),null!=l.audioController&&l.audioController.setDummy()},this._seeking=function(){var e=l,t=!1,i=l.videoModel.getCurrentTime();if(l.ltimeupdate=NaN,l.NXDebug.debug(" ### onSeeking : "+i),l.logHandler.log(" ### onSeeking : "+i),1!=l.seeking){if(l.seeking=!0,l.lastSeekTime,l.checkGapTimerId&&(clearInterval(l.checkGapTimerId),l.checkGapTimerId=null),l.eventTimerList.length>0&&(l.eventTimerList.forEach((function(e){clearTimeout(e),e=null})),l.eventTimerList=[]),l.videoModel.onAdjusting())return l.eventBus.dispatchEvent({type:"ADJUST_CURRENTTIME_END",data:{ctime:i}}),void(l.seeking=!1);null!=l.videoController&&(l.videoController.cancelPendingRequests("video"),l.videoController.abortOnGoingRequests()),null!=l.audioController&&(l.audioController.cancelPendingRequests("audio"),l.audioController.abortOnGoingRequests());for(var n=l.periodInfoArray.length-1;n>=0;n--)if(l.periodInfoArray[n].start<=i){l.periodInfo.start!==l.periodInfoArray[n].start&&(l.currentPeriodIdx=n,l.updateDataInfo(l.updateDataReason.PERIOD_CHANGE,l.periodInfoArray[n],i,(function(t){null!=l.videoController?l.videoController.getSegmentStartTime(i,(function(t){null!=l.audioController?l.audioController.getSegmentStartTime(t,(function(i){l.startBuffering.call(e,t,i,"3")})):l.startBuffering(t,t,"4")})):l.startBuffering.call(e,i,i,"5")})),t=!0);break}t||(null!=l.videoController?l.videoController.getSegmentStartTime(i,(function(e){null!=l.audioController?l.audioController.getSegmentStartTime(e,(function(t){l.NXDebug.debug("=====StartBuffering======"),l.startBuffering(e,e,"6")})):l.startBuffering(e,e,"7")})):l.startBuffering(i,i,"8")),l.lastSeekTime=NaN}},this.onSeeking=function(){l.seeking?l.seekWaiting=!0:l._seeking.call(l)},this.onSeekInhibition=function(){l.videoModel.unlisten("seeking",l.seekingListener)},this.onReleaseSeekInhibition=function(){l.videoModel.listen("seeking",l.seekingListener)},this.onPlaybackStarted=function(){l.sourceBufferExt.playbackStart()},this.onSeeked=function(){l.videoModel.listen("seeking",l.seekingListener),l.videoModel.unlisten("seeked",l.seekedListener)},this.onUpdateDataEnd=function(e){for(var t=null;l.updateQue.length>0&&(t=l.updateQue.shift()).reason==l.updateDataReason.PERIOD_CHANGE&&t.reason==e.data.reason&&t.time==e.data.time;)t=null;null!=t&&l.updateDataInfo.call(l,t.reason,t.period,t.time,t.callback)},this.dispatchDashEvent=function(){var e=l,t=l.videoModel.getCurrentTime(),i=function(i){var n=0,r=i.length,a=[];for(n=0;n<r;n++){var s=i[n];if(!isNaN(l.ltimeupdate)&&t<=s.presentationTime&&s.presentationTime<t+(t-l.ltimeupdate)){var o={index:n,de:s,timerId:null,delta:1e3*(s.presentationTime-t)};a.push(o)}}a.forEach((function(t){t.timerId=setTimeout((function(){e.eventBus.dispatchEvent({type:t.de.schemeIdUri,data:{eventList:i,index:t.index,event:t.de}}),e.deletePastDashEvent&&i.splice(i.indexOf(t.de),1),e.eventTimerList.splice(e.eventTimerList.indexOf(t.timerId),1)}),t.delta),e.eventTimerList.push(t.timerId)}))};for(var n in l.periodInfo.inEventList)i(l.periodInfo.inEventList[n]);for(var n in l.periodInfo.outEventList)i(l.periodInfo.outEventList[n]);l.ltimeupdate=t},this.onTimeupdate=function(){var e,t=l,i=l.videoModel.getCurrentTime();if(l.updateBuffer.call(l),l.dispatchDashEvent.call(l),l.dispatchCheckGap.call(l,i),!isNaN(l.presentationEndTime)&&i>l.presentationEndTime)l.videoModel.pause();else{if(i>l.videoModel.getDuration()-4&&l.mediaSource&&"open"===l.mediaSource.readyState&&!l.manifestModel.getIsDynamic(l.manifest)){var n=l.videoModel.getBuffered();if(n.start(n.length-1)<=i&&n.end(n.length-1)>l.videoModel.getDuration()-.5){if(null!=l.videoController&&(e=l.sourceBufferExt.getAllRanges(l.videoController.getBuffer()))&&e.length>0)for(var r=0,a=e.length;r<a;r+=1)l.NXDebug.debug("[video] Buffered Range["+r+"]: "+e.start(r)+" - "+e.end(r));if(null!=l.audioController&&(e=l.sourceBufferExt.getAllRanges(l.audioController.getBuffer()))&&e.length>0)for(r=0,a=e.length;r<a;r+=1)l.NXDebug.debug("[audio] Buffered Range["+r+"]: "+e.start(r)+" - "+e.end(r));l.logHandler.log("********** onTimeupdate: signalEndOfStream ************"),l.signalEndOfStream.call(l,l.mediaSource),null!=l.videoController&&l.videoController.clearTimer(),null!=l.audioController&&l.audioController.clearTimer()}}var s=l.currentPeriodIdx;if(l.periodChgCheck&&!l.dataIsUpdating&&l.currentPeriodIdx<l.periodInfoArray.length-1&&i+7>=l.periodInfoArray[l.currentPeriodIdx].end){l.periodChgCheck=!1;var o=[];o.push(l.videoController.getIsStreamCompleted()||l.alreadyBufferedAllSegments(l.videoController,i,l.periodInfoArray[l.currentPeriodIdx].end-.4)),o.push(l.audioController.getIsStreamCompleted()||l.alreadyBufferedAllSegments(l.audioController,i,l.periodInfoArray[l.currentPeriodIdx].end-.4)),o[0]&&o[1]&&s===l.currentPeriodIdx?l.currentPeriodIdx<l.periodInfoArray.length-1&&(l.currentPeriodIdx++,l.logHandler.log("*** appended all segments in this period. start fetching period["+l.currentPeriodIdx+"] *** : "+s),l.updateDataInfo(l.updateDataReason.PERIOD_CHANGE,l.periodInfoArray[l.currentPeriodIdx],l.periodInfoArray[l.currentPeriodIdx].start,(function(e){l.startBuffering.call(t,e.data,e.data,"9")}))):s!==l.currentPeriodIdx&&l.logHandler.log("### currentPeriodIdx: "+l.currentPeriodIdx+", checkPeriodIdx: "+s),l.periodChgCheck=!0}}},this.bufferGapBetweenPeriods=function(e,t){var i=l.checkBufferGap(l.videoController,e,t),n=l.checkBufferGap(l.audioController,e,t);return 1==i||1==n},this.checkBufferGap=function(e,t,i){var n;if(null!=e){var r=e.getTolerance();return!(null!=(n=l.sourceBufferExt.getBufferRange(e.getBuffer(),i-r,r))&&n.start<=t&&i+.1<=n.end)}return!1},this.alreadyBufferedAllSegments=function(e,t,i){var n;return null==e||null!=(n=l.sourceBufferExt.getBufferRange(e.getBuffer(),t,e.getTolerance()))&&n.end>=i},this.bufferGapOnlyInVideoBuffer=function(e,t){var i=null,n=null;return null!=l.videoController&&null!=(i=l.sourceBufferExt.getBufferRange(l.videoController.getBuffer(),e,l.videoController.getTolerance()))&&i.end<t&&(null==l.audioController||null!=(n=l.sourceBufferExt.getBufferRange(l.audioController.getBuffer(),e,l.audioController.getTolerance()))&&n.end>=t)},this.checkNextPeriodTop=function(e){var t=l.sourceBufferExt.getBufferRange(l.videoController.getBuffer(),e+1.5,l.videoController.getTolerance());return null!=t&&(null==l.audioController||null!=l.sourceBufferExt.getBufferRange(l.audioController.getBuffer(),e+1.5,l.audioController.getTolerance()))},this.seekToNearestStartTime=function(e){var t=0,i=l.sourceBufferExt.getBufferRange(l.videoController.getBuffer(),e+.5,l.videoController.getTolerance());null!=i?(t=i.start<e?e:i.start,null!=l.audioController&&t<(i=l.sourceBufferExt.getBufferRange(l.audioController.getBuffer(),e+.5,l.audioController.getTolerance())).start&&(t=i.start),l.logHandler.log("ST:"+t),l.videoModel.silentSeek(t)):(l.logHandler.log("?????"),t=e,l.videoModel.setCurrentTime(t+.2))},this.onRatechange=function(){},this.updateBuffer=function(){l.videoController&&l.videoController.updateBufferState(),l.audioController&&l.audioController.updateBufferState()},this.startBuffering=function(e,t,i){l.videoController&&(void 0===e?l.videoController.start("33333"):l.seekWaiting||l.videoController.seek(e,"{"+i+"} [video] seek")),l.audioController&&(void 0===t?l.audioController.start("44444"):l.seekWaiting||l.audioController.seek(t,"{"+i+"}[audio] seek")),l.seeking=!1,l.seekWaiting&&(l.seekWaiting=!1,l._seeking.call(l))},this.stopBuffering=function(){l.videoController&&l.videoController.stop(),l.audioController&&l.audioController.stop()},this.suspend=function(){l.scheduleWhilePaused&&!l.manifestModel.getIsDynamic(l.manifest)||l.stopBuffering.call(l)},this.updateCurrentTime=function(){l.videoModel.isPaused()||l.dataIsUpdating||l.startBuffering()},this.doLoad=function(e){var t=l,i=function(){l.eventBus.removeEventListener("MEDIASOURCE_IS_SET",i),l.setDuration.call(t),l.initializeMediaSource.call(t,(function(e){e&&(l.NXDebug.log("Playback initialized!"),l.initialized=!0,l.NXDebug.log("element loaded!"),l.eventBus.dispatchEvent({type:"PLAYBACK_INITIALIZED",data:{}}))}))};l.manifest=e,l.videoModel.setAutoPlay(l.autoPlay),null!=l.mediaSource?i():l.eventBus.addEventListener("MEDIASOURCE_IS_SET",i)},this.tempLoad=function(e){var t=l;l.manifest=e,l.videoModel.setAutoPlay(l.autoPlay),l.tempInitializeMediaSource.call(t,(function(e){e&&(l.NXDebug.log("Playback initialized!"),l.initialized=!0,l.NXDebug.log("element loaded!"),l.eventBus.dispatchEvent({type:"PLAYBACK_INITIALIZED",data:{}}))}))},this.currentTimeChanged=function(){l.NXDebug.log("Current time has changed, block programmatic seek."),l.videoModel.unlisten("seeking",l.seekingListener),l.videoModel.listen("seeked",l.seekedListener)},this.bufferingCompleted=function(e){l.videoController&&!l.videoController.isBufferingCompleted||l.audioController&&!l.audioController.isBufferingCompleted||l.mediaSource&&l.logHandler.log(" *** bufferingCompleted ***")},this.segmentLoadingFailed=function(){l.stopBuffering.call(l)},this.processProtection=function(e,t,i){var n,r=l,a=null,s=function(){l.eventBus.removeEventListener("ON_KEY_ADDED",n),1===i?"video"===e&&0!==l.audioInitData.length?l.processProtection.call(r,"audio",l.audioInitData,0):(l.NXDebug.debug("process protection end!!!"),l.setAppendStatus(!0,0),l.setInitialSeekTime.call(l,(function(e){}))):(void 0===(a="video"===e?l.videoController.getBuffer():l.audioController.getBuffer()).updating?a.append(t[i].data):a.appendBuffer(t[i].data),l.drmKeyProcessing=!0,l.drmKeyProcessingTimerId=setTimeout((function(){l.drmKeyProcessing&&(l.drmKeyProcessing=!1,l.eventBus.dispatchEvent({type:"ON_KEY_ADDED",data:{}})),l.drmKeyProcessingTimerId=null}),1e3),l.processProtection.call(r,e,t,i+1))};l.drmKeyProcessing?(n=s.bind(r),l.eventBus.addEventListener("ON_KEY_ADDED",n)):s()},this.setInitialSeekTime=function(e){if(0===l.videoModel.getCurrentTime()){var t=l.videoModel.getStartTime(),i=t;l.NXDebug.log("Starting playback at offset: "+t+", adjusted:"+i),l.logHandler.log("Starting playback at offset: "+t+", adjusted:"+i),i>.5?l.videoModel.silentSeek(i,(function(){e(!0)})):e(!0)}},this.streamIsCompleted=function(e){var t=l;l.NXDebug.debug("["+e.data.type+"] Stream is completed.----");var i=!1,n=l.videoModel.getCurrentTime();if("video"===e.data.type?l.audioController?(l.audioController.getIsStreamCompleted()||l.alreadyBufferedAllSegments(l.audioController,n,e.data.pEnd-.2))&&(i=!0):i=!0:l.videoController?(l.videoController.getIsStreamCompleted()||l.alreadyBufferedAllSegments(l.videoController,n,e.data.pEnd-.2))&&(i=!0):i=!0,i){for(var r=0;r<l.periodInfoArray.length;r++)if(l.periodInfoArray[r].start==e.data.pStart){r<l.periodInfoArray.length?l.currentPeriodIdx=r+1:l.currentPeriodIdx=r;break}if(e.data.pStart<l.periodInfoArray[0].start&&(l.currentPeriodIdx=0),l.periodInfoArray.length>l.currentPeriodIdx){if(l.periodInfoArray[l.currentPeriodIdx].start==l.periodInfo.start)return;for(var a=0;a<l.updateQue.length;a++)if(l.updateQue[a].reason==l.updateDataReason.PERIOD_CHANGE&&l.updateQue[a].time==l.periodInfoArray[l.currentPeriodIdx].start)return;l.logHandler.log("*** -appended all segments in this period. start fetching period["+l.currentPeriodIdx+"]  p:"+e.data.pStart+", n:"+l.periodInfoArray[l.currentPeriodIdx].start+" ***"),l.NXDebug.info("*** -appended all segments in this period. start fetching period["+l.currentPeriodIdx+"] p:"+e.data.pStart+", n:"+l.periodInfoArray[l.currentPeriodIdx].start+" ***");var s=l.periodInfoArray[l.currentPeriodIdx].start;l.updateDataInfo(l.updateDataReason.PERIOD_CHANGE,l.periodInfoArray[l.currentPeriodIdx],l.periodInfoArray[l.currentPeriodIdx].start,(function(i){l.startBuffering.call(t,i.data,i.data,"10"),l.checkGapQue.push({curStart:e.data.pStart,nextIdx:l.currentPeriodIdx,nextStart:s})}))}else l.mediaSource&&l.mediaSource.readyState}},this.initDataReceived=function(e){if(0===l.videoModel.getCurrentTime()&&("video"===e.data.type?(l.videoInitReceived=!0,l.videoInitData=e.data.initData):"audio"===e.data.type&&(l.audioInitReceived=!0,l.audioInitData=e.data.initData),l.videoInitReceived&&l.audioInitReceived)){var t=function(){l.eventBus.removeEventListener("MEDIASOURCE_UPDATED",t),l.setDummy();var e=null!=l.videoInitData?l.videoInitData[0].data:null,i=null!=l.audioInitData?l.audioInitData[0].data:null;if(null===l.contentProtections)l.setInitData(e,i);else if(l.protectionController.supportsMediaKeys()||l.protectionController.supportsEME01b()){var n=function(){l.eventBus.removeEventListener("ON_KEY_ADDED",n),l.setAppendStatus(!0,0),l.setInitialSeekTime.call(l,(function(e){}))};l.setInitData(e,i),l.drmInitialized?(l.setAppendStatus(!0,0),l.setInitialSeekTime.call(l,(function(){}))):l.eventBus.addEventListener("ON_KEY_ADDED",n)}else l.setInitData(e,i)};l.videoModel.isDummy()?l.eventBus.addEventListener("MEDIASOURCE_UPDATED",t):t()}},this.bufferStateChange=function(e){var t;"video"==e.data.type?null!=l.audioController&&(t=Math.min(e.data.state,l.audioController.getBufferState())):null!=l.videoController&&(t=Math.min(e.data.state,l.videoController.getBufferState())),l.bufferState!=t&&(l.bufferState=t,l.eventBus.dispatchEvent({type:"BUFFER_STATE_CHANGE",data:l.bufferState}))},this.clearInitTimer=function(){l.drmKeyProcessingTimerId&&(clearTimeout(l.drmKeyProcessingTimerId),l.drmKeyProcessingTimerId=null)},this.onKeyAdded=function(){l.drmKeyProcessing=!1,l.eventBus.dispatchEvent({type:"ON_KEY_ADDED",data:{}}),l.NXDebug.debug("onKeyAdded!!!!!"),l.drmInitialized=!0},this.clearPreparedRequests=function(){null!=l.videoController&&(l.videoController.cancelPendingRequests("video"),l.videoController.clearAllSegments()),null!=l.audioController&&(l.audioController.cancelPendingRequests("audio"),l.audioController.clearAllSegments())},this.getCurrentAdaptationIdxFor=function(e){return"video"===e&&l.videoController?l.videoController.getData().index:"audio"===e&&l.audioController?l.audioController.getData().index:-1},this.setAdaptationIdxFor=function(e,t){"video"===e&&l.videoController?l.videoController.updateData(l.updateDataReason.ADAPTATION_CHANGE,l.periodInfo.getDataForIndex(t),l.periodInfo,0):"audio"===e&&l.audioController&&l.audioController.updateData(l.updateDataReason.ADAPTATION_CHANGE,l.periodInfo.getDataForIndex(t),l.periodInfo,0)},this.setAdaptationRoleFor=function(e,t){for(var i=l.periodInfo.getRolesFor(e),n=-1,r=0;r<i.length;r++)if(i[r].role==t){n=i[r].index;break}"video"===e&&l.videoController&&-1!=n?l.videoController.updateData(l.updateDataReason.ADAPTATION_CHANGE,l.periodInfo.getDataForIndex(n),l.periodInfo,0):"audio"===e&&l.audioController&&-1!=n&&l.audioController.updateData(l.updateDataReason.ADAPTATION_CHANGE,l.periodInfo.getDataForIndex(n),l.periodInfo,0)},this.updateDataInfo=function(e,t,i,n){var r,a,s,u=!1,d=0,f=0,c=[],m=0,g=function(e,t){l.dataIsUpdating=!1,l.eventBus.dispatchEvent({type:"UPDATE_DATA_END",data:{reason:e,time:t}})};l.dataIsUpdating=!0,l.manifest=l.manifestModel.getValue(),0==l.manifestModel.getIsDynamic(l.manifest)&&(l.periodInfo=null),l.periodInfo?(u=l.periodInfo.isClientServerTimeSyncCompletedForTC,d=l.periodInfo.clientServerTimeShift,f=l.periodInfo.timestampOffsetFor32bitVE,c=l.periodInfo.inEventList,m=l.periodInfo.liveEdgeFromRequest,e==l.updateDataReason.MPD_UPDATE&&(t.mpd.liveEdge=l.periodInfo.mpd.liveEdge,t.mpd.liveEdgeS=l.periodInfo.mpd.liveEdgeS,t.mpd.liveEdgeE=l.periodInfo.mpd.liveEdgeE,t.mpd.liveEdgeC=l.periodInfo.mpd.liveEdgeC),l.periodInfo=t,l.periodInfo.isClientServerTimeSyncCompletedForTC=u,l.periodInfo.clientServerTimeShift=d,l.periodInfo.timestampOffsetFor32bitVE=f,l.periodInfo.inEventList=c,l.periodInfo.liveEdgeFromRequest=m):l.periodInfo=t,l.currentPeriodIdx=l.periodInfo.index,l.NXDebug.log("Manifest updated... set new data on buffers."+i);var p=function(t,n,r,a){a=a||function(e){},l.manifestModel.getIsDynamic(l.manifest)?(r=t.getData(),s=null!=r&&r.period.start==l.periodInfo.start?null!=r&&o(r,"id")?l.periodInfo.getDataForId(r.id):l.periodInfo.getDataForIndex(r.index):l.periodInfo.getPrimaryMediaData(n)):s=l.periodInfo.getPrimaryMediaData(n),s?("video"==n?l.protectionController.createMediaKeysFromMPD(s,null):l.protectionController.createMediaKeysFromMPD(null,s),t.updateData(e,s,l.periodInfo,i,(function(e){a(e)}))):a({status:"fail",msg:"no "+n+" AdaptationSets??"})};null!=l.videoController&&null!=l.audioController?p(l.videoController,"video",r,(function(t){p(l.audioController,"audio",a,(function(t){n(t),g(e,i)}))})):null!=l.videoController?p(l.videoController,"video",r,(function(t){n(t),g(e,i)})):null!=l.audioController?p(l.audioController,"audio",a,(function(t){n(t),g(e,i)})):(n({status:"ok",data:i}),g(e,i))},this.signalEndOfStream=function(e){e.endOfStream()},this.setup=function(){l.eventBus.addEventListener("setCurrentTime",l.currentTimeChanged.bind(l)),l.eventBus.addEventListener("bufferingCompleted",l.bufferingCompleted.bind(l)),l.eventBus.addEventListener("segmentLoadingFailed",l.segmentLoadingFailed.bind(l)),l.eventBus.addEventListener("initDataReceived",l.initDataReceived.bind(l)),l.eventBus.addEventListener("streamIsCompleted",l.streamIsCompleted.bind(l)),l.eventBus.addEventListener("bufferStateChangeInt",l.bufferStateChange.bind(l)),l.eventBus.addEventListener("seekInhibition",l.onSeekInhibition.bind(l)),l.eventBus.addEventListener("releaseSeekInhibition",l.onReleaseSeekInhibition.bind(l)),l.eventBus.addEventListener("playbackStarted",l.onPlaybackStarted.bind(l)),l.eventBus.addEventListener("UPDATE_DATA_END",l.onUpdateDataEnd.bind(l)),l.fragmentController=new V(l.params,l.eventBus,l.metricsModel,o(l.xhrCustom,"seg")?l.xhrCustom.seg:{}),l.playListener=l.onPlay.bind(l),l.pauseListener=l.onPause.bind(l),l.stalledListener=l.onStalled.bind(l),l.errorListener=l.onError.bind(l),l.seekingListener=l.onSeeking.bind(l),l.seekedListener=l.onSeeked.bind(l),l.ratechangeListener=l.onRatechange.bind(l),l.timeupdateListener=l.onTimeupdate.bind(l),l.loadedListener=l.onLoad.bind(l),l.canplaythroughListener=l.onCanPlayThrough.bind(l)},this.load=function(e,t,i){l.periodInfo=t,l.periodInfoArray=i,l.currentPeriodIdx=l.periodInfo.index,l.videoModel.isDummy()?l.tempLoad.call(l,e):l.doLoad.call(l,e)},this.updatePlaybackCondition=function(e,t,i){if(l.periodInfoArray=i,l.manifest=e,"static"===l.manifest.mpd.type){try{null!=l.manifest.mpd.mediaPresentationDuration&&l.manifest.mpd.mediaPresentationDuration!==1/0?l.mediaSource.duration<l.manifest.mpd.mediaPresentationDuration&&(l.mediaSource.duration=l.manifest.mpd.mediaPresentationDuration):l.mediaSource.duration=l.periodInfoArray[l.periodInfoArray.length-1].end}catch(e){l.logHandler.log("duration cannot be changed while buffer updating")}l.NXDebug.log("Duration successfully set to: "+l.mediaSource.duration)}},this.setVideoModel=function(e){l.videoModel=e,l.videoModel.listen("play",l.playListener),l.videoModel.listen("pause",l.pauseListener),l.videoModel.listen("stalled",l.stalledListener),l.videoModel.listen("error",l.errorListener),l.videoModel.listen("seeking",l.seekingListener),l.videoModel.listen("timeupdate",l.timeupdateListener),l.videoModel.listen("ratechange",l.ratechangeListener),l.videoModel.listen("loadedmetadata",l.loadedListener),l.videoModel.listen("canplaythrough",l.canplaythroughListener),l.sourceBufferExt.setVideoModel(e)},this.initProtection=function(){l.videoModel.isDummy()||(l.protectionController=new te(l.params,l.eventBus,o(l.xhrCustom,"drm")?l.xhrCustom.drm:{}),l.protectionController.init(l))},this.getVideoModel=function(){return l.videoModel},this.getManifestModel=function(){return l.manifestModel},this.setAutoPlay=function(e){l.autoPlay=e},this.getAutoPlay=function(){return l.autoPlay},this.reset=function(){l.pause.call(l,!0),l.videoModel.unlisten("play",l.playListener),l.videoModel.unlisten("pause",l.pauseListener),l.videoModel.unlisten("stalled",l.stalledListener),l.videoModel.unlisten("error",l.errorListener),l.videoModel.unlisten("seeking",l.seekingListener),l.videoModel.unlisten("timeupdate",l.timeupdateListener),l.videoModel.unlisten("loadedmetadata",l.loadedListener),l.videoModel.unlisten("canplaythrough",l.canplaythroughListener),l.videoModel.reset(),l.fragmentController.reset(),l.fragmentController=null,l.tearDownMediaSource.call(l),l.protectionController.reset(),l.drmKeyProcessing=!1,l.xhrCustom={},l.dataIsUpdating=!1,l.updateQue=[],l.checkGapQue=[],l.bufferState=0},this.setPresentationStartTime=function(e){l.initialPresentationStartTime=e},this.setPresentationEndTime=function(e){l.presentationEndTime=e},this.setMediaSource=function(e){null!=e&&(l.mediaSource=e,l.sourceBufferExt.setMediaSource(e),l.eventBus.dispatchEvent({type:"MEDIASOURCE_IS_SET",data:e}))},this.updateMediaSource=function(){var e=function(){l.eventBus.removeEventListener("MEDIASOURCE_IS_SET",e),l.setDuration(!0),l.updateSourceBuffer(),l.eventBus.dispatchEvent({type:"MEDIASOURCE_UPDATED",data:{}})};l.eventBus.addEventListener("MEDIASOURCE_IS_SET",e)},this.getBufferState=function(){return l.bufferState},this.getBufferFor=function(e){return"video"==e&&null!=l.videoController?l.videoController.getBuffer():"audio"==e&&null!=l.audioController?l.audioController.getBuffer():null},this.end=function(){l.pause.call(l,!0),l.mediaSource&&"open"===l.mediaSource.readyState&&(l.logHandler.log("********** stop: signalEndOfStream ************"),l.signalEndOfStream.call(l,l.mediaSource))},this.updateData=function(e,t,i,n){var r=l;if(l.dataIsUpdating){if(l.updateQue.length>0)for(var a=l.updateQue.length-1;a>=0;a--)l.updateQue[a].reason==l.updateDataReason.PERIOD_CHANGE&&l.updateQue.pop();l.updateQue.push({reason:e,period:t,time:i,callback:n})}else l.updateDataInfo.call(r,e,t,i,n)},this.manifest=null,this.mediaSource=null,this.videoCodec=null,this.audioCodec=null,this.contentProtections=null,this.videoController=null,this.audioController=null,this.textController=null,this.autoPlay=!0,this.periodChgCheck=!0,this.initialized=!1,this.errored=!1,this.xhrCustom=a||{},this.audioInitData=[],this.videoInitData=[],this.eventTimerList=[],this.audioInitReceived=!1,this.videoInitReceived=!1,this.drmInitialized=!1,this.drmKeyProcessing=!1,this.drmKeyProcessingTimerId=null,this.lastCheckGapTime=-1,this.checkGapTimerId=null,this.nextPeriodTopIsAlreadyBuffered=!1,this.CHECK_GAP_INTERVAL=.2,this.updateDataReason=ne,this.dataIsUpdating=!1,this.updateQue=[],this.checkGapQue=[],this.periodInfo=null,this.periodInfoArray=null,this.currentPeriodIdx=0,this.initialPresentationStartTime=0,this.presentationEndTime=NaN,this.ltimeupdate=0,this.lastSeekTime=NaN,this.seeking=!1,this.seekWaiting=!1,this.scheduleWhilePaused=!0,this.NXDebug=new s,this.sourceBufferExt=new G(e,t),this.indexHandler=new U(e,t,o(a,"seg")?a.seg:{}),this.videoModel=null,this.fragmentController=null,this.bufferState=0,this.protectionController=null,this.EPSILON=-.1,this.SKIP_PERIOD_BOUNDARY=e.SKIP_PERIOD_BOUNDARY||!1,this.DEFAULT_ROLE_FOR_VIDEO=e.DEFAULT_ROLE_FOR_VIDEO||"main",this.DEFAULT_ROLE_FOR_AUDIO=e.DEFAULT_ROLE_FOR_AUDIO||"main",this.deletePastDashEvent=e.DELETE_PAST_DASHEVENT||!1,this.eventBus=t,this.manifestModel=i,this.params=e,this.metricsModel=n,this.abrController=r}return e.prototype.getPeriodInfo=function(){return this.periodInfo},e}(),ne={INITIAL_UPDATE:"initialize",PERIOD_CHANGE:"period_change",ADAPTATION_CHANGE:"adaptation_change",MPD_UPDATE:"mpd_update"},re=function(e,t,i,n,r){var a=this;this.logHandler=m,this.errHandler=f,this.updateDataReason=ne,this.play=function(e){a.activeStream.play(e)},this.pause=function(e){a.activeStream.pause(e)},this.seek=function(e){a.activeStream.seek(e)},this.attachVideoEvents=function(e){e.listen("pause",a.pauseListener),e.listen("play",a.playListener)},this.detachVideoEvents=function(e){e.unlisten("pause",a.pauseListener),e.unlisten("play",a.playListener)},this.onPause=function(){a.videoModel.getSelfPaused()||a.manifestModel.manifestUpdateStop()},this.onPlay=function(){a.manifestModel.manifestUpdateStart()},this.composeStreams=function(e){var t,i,n=a,r=a.manifestModel.getValue(),s=e||function(){};if(r){var o=r.mpd.periods;if(0!==o.length){var l=a.videoModel.getCurrentTime();if(null!=a.activeStream){var u=a.activeStream.getPeriodInfo(),d=a.videoModel.getCurrentTime();l=i=d>u.start?d:u.start;for(var f=o.length-1;f>=0;f--)if(o[f].start<=i){t=o[f];break}a.activeStream.updatePlaybackCondition(r,t,o)}if(a.activeStream)a.activeStream.updateData(a.updateDataReason.MPD_UPDATE,t,l,(function(e){s(e)}));else{if(isNaN(a.initialPresentationStartTime))if("dynamic"==r.mpd.type)if(1==a.params.START_FROM_MPDTOP_FORLIVE)t=o[0];else{var c=o[o.length-1];if(c.end==1/0)t=c;else if((i=c.end-r.mpd.suggestedPresentationDelay)<o[0].start)t=o[0];else for(f=o.length-1;f>=0;f--)if(o[f].start<=i){t=o[f];break}}else a.initialPresentationStartTime=0,t=o[0];else if(a.initialPresentationStartTime<o[0].start)a.logHandler.log("Playback stat time is out of range."),a.initialPresentationStartTime=o[0].start,t=o[0];else for(f=o.length-1;f>=0;f--)if(o[f].start<=a.initialPresentationStartTime){t=o[f];break}if(!t)return void s({status:"error",msg:"Playback stat time is out of range."});a.activeStream=new ie(a.params,a.eventBus,a.manifestModel,a.metricsModel,a.abrController,a.xhrCustom),a.activeStream.setup(),a.activeStream.setVideoModel(a.videoModel),a.activeStream.initProtection(),a.activeStream.setPresentationStartTime(a.initialPresentationStartTime),a.activeStream.setPresentationEndTime(a.initialPresentationEndTime),a.activeStream.setAutoPlay(a.autoPlay),a.activeStream.setMediaSource(a.mediaSource),a.activeStream.load(r,t,o),a.attachVideoEvents.call(n,a.activeStream.getVideoModel()),s({status:"ok",data:!0})}}else s({status:"error",msg:"There are no regular periods"})}else s({status:"ok",data:!1})},this.createMediaSource=function(){var e="WebKitMediaSource"in window;return"MediaSource"in window?new MediaSource:e?new WebKitMediaSource:null},this.attachMediaSource=function(e,t){t.setSource(window.URL.createObjectURL(e))},this.detachMediaSource=function(e){e.setSource(null),e.getElement().setMediaKeys&&e.getElement().setMediaKeys(null)},this._setUpMediaSource=function(e,t){var i=t||function(){},n=a,r=function(t){a.NXDebug.debug("MediaSource is open!"),a.NXDebug.debug(String(t)),e.removeEventListener("sourceopen",r),e.removeEventListener("webkitsourceopen",r),a.logHandler.log("readyState :"+e.readyState),i(e)};e.addEventListener("sourceopen",r,!1),e.addEventListener("webkitsourceopen",r,!1),a.attachMediaSource.call(n,e,a.videoModel)},this.manifestHasUpdated=function(){var e=a;a.composeStreams.call(e,(function(t){"ok"===t.status?(a.NXDebug.debug("composeStreams ok"),a.manifestModel.onManifestRefreshEnd.call(e)):(a.NXDebug.debug("composeStreams fail"),a.getIsDynamic()?(a.manifestModel.onManifestRefreshEnd.call(e),a.manifestModel.manifestUpdateStartPoll.call(e)):(a.logHandler.log("ERROR:"+t.msg),a.errHandler.manifestError(a.eventBus,t.msg,"nostreamscomposed",a.manifestModel.getValue()),e.reset()))}))},this.getManifestModel=function(){return a.activeStream.getManifestModel()},this.setAutoPlay=function(e){a.autoPlay=e},this.getIsDynamic=function(){var e=a.manifestModel.getValue();return!!e&&"dynamic"===e.mpd.type},this.getPeriodInfo=function(){var e=a.manifestModel.getValue(),t=[];return e&&(t=e.mpd.periods),t},this.getPeriodIdxForTime=function(e){for(var t=a.manifestModel.getValue().mpd.periods,i=0;i<t.length;i++)if(e<t[i].end)return i;return t.length-1},this.getPeriodInfoForIdx=function(e){var t=a.manifestModel.getValue().mpd.periods;return e>=0&&e<t.length?t[e]:null},this.getBaseURLIdxFor=function(e){var t=a.manifestModel.getValue().mpd.periods;return e>=0&&e<t.length?t[e].selectedBaseURLIdx:null},this.getMaxBaseURLIdxFor=function(e){var t=a.manifestModel.getValue().mpd.periods;return e>=0&&e<t.length?t[e].BaseURL.length-1:null},this.setBaseURLIdxFor=function(e,t){var i=a.manifestModel.getValue().mpd.periods;e>=0&&e<i.length&&t>=0&&t<i[e].BaseURL.length&&(i[e].selectedBaseURLIdx=t,null!=a.activeStream&&a.activeStream.getPeriodInfo().index==e&&a.activeStream.clearPreparedRequests())},this.getCurrentAdaptationIdxFor=function(e){return a.activeStream.getCurrentAdaptationIdxFor(e)},this.setAdaptationIdxFor=function(e,t){a.activeStream.setAdaptationIdxFor(e,t)},this.setAdaptationRoleFor=function(e,t){a.activeStream.setAdaptationRoleFor(e,t)},this.setCueingPeriodIdx=function(e){if(a.activeStream){var t=a.manifestModel.getValue().mpd.periods;e<t.length&&a.videoModel.setCurrentTime(t[e].start+.2)}},this.getVideoModel=function(){return a.videoModel},this.getCurrentManifestData=function(){return a.manifestModel.getValue()},this.getBufferState=function(){return null!=a.activeStream?a.activeStream.getBufferState():0},this.getBufferFor=function(e){return null!=a.activeStream?a.activeStream.getBufferFor(e):null},this.getMediaSourceReadyState=function(){return null!=a.mediaSource?a.mediaSource.readyState:"null"},this.setVideoModel=function(e){a.videoModel=e,1==a.params.SKIP_GAP_AT_HOB&&a.videoModel.setSkipGapAtHOB(!0)},this.setUpMediaSource=function(e){if(null!=e){var t=a,i=a.createMediaSource.call(t);a._setUpMediaSource.call(t,i,(function(e){a.mediaSource=e,null!=a.activeStream&&a.activeStream.setMediaSource(a.mediaSource)}))}},this.load=function(e){var t=a;if("url"===e.type){var i=function(e){e.data.success?(a.manifestModel.setValue(e.data.result),a.NXDebug.log("Manifest has loaded.")):t.reset(),a.eventBus.removeEventListener("LOAD_MANIFEST_END",i)};a.eventBus.addEventListener("LOAD_MANIFEST_END",i),a.manifestModel.loadManifest(e.source)}else"xml"===e.type?a.manifestModel.setManifestFromExt(e.baseUrl,e.source):"data"===e.type&&a.manifestModel.setValue(e.source)},this.updateVideoModel=function(e){a.setVideoModel(e),a.setUpMediaSource(e.getElement()),a.attachVideoEvents(e),null!=a.activeStream&&(a.activeStream.setVideoModel(e),a.activeStream.initProtection(),a.activeStream.updateMediaSource())},this.setManifestFromExt=function(e,t){a.manifestModel.setManifestFromExt(e,t)},this.setBandwidthLimit=function(e,t){a.manifestModel.setBandwidthLimit(e,t)},this.reset=function(){null!=a.activeStream&&(a.detachVideoEvents.call(a,a.activeStream.getVideoModel()),a.activeStream.reset()),null!=a.mediaSource&&a.detachMediaSource.call(self,a.videoModel),a.manifestModel.manifestUpdateStop(),a.manifestModel.setValue(null),a.eventBus.clearAllEventListener(),a.activeStream=null,a.xhrCustom={}},this.end=function(){a.activeStream&&a.activeStream.end(),a.mediaSource&&a.detachMediaSource.call(a,a.videoModel)},this.setPresentationStartTime=function(e){a.initialPresentationStartTime=e},this.setPresentationEndTime=function(e){a.initialPresentationEndTime=e},this.activeStream=null,this.autoPlay=!0,this.pauseListener=this.onPause.bind(this),this.playListener=this.onPlay.bind(this),this.NXDebug=new s,this.params=e,this.eventBus=t,this.metricsModel=i,this.abrController=n,this.xhrCustom=r,this.mediaSource=null,this.initialPresentationStartTime=NaN,this.initialPresentationEndTime=NaN,this.manifestModel=new A(this.params,this.eventBus,this.xhrCustom),this.eventBus.addEventListener("manifestUpdated",this.manifestHasUpdated.bind(this))},ae=function(){var e=this;this.NS={XHTML:"http://www.w3.org/1999/xhtml",TTML:"http://www.w3.org/ns/ttml",SMPTE:"http://www.smpte-ra.org/schemas/2052-1/2013/smpte-tt",ARIB:"http://www.arib.or.jp/ns/arib-tt",getTagName:function(e){var t=e.localName;switch(e.namespaceURI){case this.XHTML:return t;case this.TTML:return"tt:"+t;case this.SMPTE:return"smpte:"+t;case this.ARIB:return"arib-tt:"+t;default:return""}}},this.getObjFromTagName=function(e,t){return e[0].getElementsByTagName(t)},this.parse=function(t,i,n){if(e.baseURL=i,"string"==typeof t&&(t=e.parseXML(t)),e._root=t.getElementsByTagName("tt"),e.arr_captions=[],e._root.length>0){e._head=e.getObjFromTagName(e._root,"head"),e._styling=0==e._head.length?[]:e.getObjFromTagName(e._head,"styling"),e._styles=0==e._styling.length?[]:e.getObjFromTagName(e._styling,"style"),e._layout=0==e._head.length?[]:e.getObjFromTagName(e._head,"layout"),e._regions=0==e._layout.length?[]:e.getObjFromTagName(e._layout,"region"),e._arib_keyframes=0==e._head.length?[]:e.getObjFromTagName(e._head,"keyframes"),e._arib_fontfaces=0==e._head.length?[]:e.getObjFromTagName(e._head,"font-face"),e._body=e.getObjFromTagName(e._root,"body");try{e.parseStyle(),e.isUndefined(n)&&(n={begin_time:0,end_time:36e6}),e.listupCaptions(e._body[0],{begin_time:0,end_time:36e6},n)}catch(t){var r="**ERR** "+t.message;e.NXDebug.debug(r)}}return{captions:e.arr_captions,fontfaces:e.arr_fontfaces,keyframes:e.arr_keyframes}},this.parseStyle=function(){var t,i,n,r,a,s,l;for(e.arr_regions=[],e.arr_styles=[],r=0;r<e._styles.length;r++)3!=(t=e._styles[r]).nodeType&&(i=e.transAttrFromElement(t),o(i.htmlAttrs,"id")?(n=i.htmlAttrs.id,o(i.htmlAttrs,"style_ref")&&(i.htmlCss.style_ref=i.htmlAttrs.style_ref),e.arr_styles[n]=i.htmlCss):e.NXDebug.log("ERROR : style.id(xml:id) attribute is not found !!! "));for(var u=0;u<e._regions.length;u++)if(3!=(t=e._regions[u]).nodeType)if(i=e.transAttrFromElement(t),o(i.htmlAttrs,"id")){n=i.htmlAttrs.id;var d=null,f=null;o(i.htmlAttrs,"style_ref")&&(i.htmlCss.style_ref=i.htmlAttrs.style_ref),o(i.htmlAttrs,"begin")&&(d=i.htmlAttrs.begin),o(i.htmlAttrs,"end")&&(f=i.htmlAttrs.end),e.arr_regions.push({id:i.htmlAttrs.id,begin:d,end:f,styles:i.htmlCss})}else e.NXDebug.error("ERROR : region.id(xml:id) attribute is not found !!!");e.arr_keyframes=[];for(var c=0;c<e._arib_keyframes.length;c++)if(3!=(t=e._arib_keyframes[c]).nodeType){i=e.transAttrFromElement(t);var m="";if(o(i.htmlAttrs,"animationName")){m=i.htmlAttrs.animationName;var g=[];for(s=t.childNodes,r=0;r<s.length;r++)if(3!=(l=s[r]).nodeType)if(i=e.transAttrFromElement(l),o(i.htmlAttrs,"keyframeposition")){var p=i.htmlAttrs.keyframeposition,h="";for(a in i.htmlCss)""!=h&&(h+=";"),h+=a+":"+i.htmlCss[a];""!=h&&(h+=";"),g.push({position:p,styles:"{"+h+"}"})}else e.NXDebug.error("ERROR : arib-tt:keyframe.position is not found ");e.arr_keyframes.push({name:m,positions:g})}}e.arr_fontfaces=[];for(var y=0;y<e._arib_fontfaces.length;y++)if(3!=(t=e._arib_fontfaces[y]).nodeType&&(i=e.transAttrFromElement(t),o(i.htmlAttrs,"id"))){var v={};for(a in n=i.htmlAttrs.id,i.htmlAttrs)o(i.htmlAttrs,a)&&(v[a]="font-family"==a?"'"+i.htmlAttrs[a]+"'":i.htmlAttrs[a]);for(s=t.childNodes,r=0;r<s.length;r++)if(3!=(l=s[r]).nodeType)for(a in(i=e.transAttrFromElement(l)).htmlAttrs)o(i.htmlAttrs,a)&&(v[a]=i.htmlAttrs[a]);e.arr_fontfaces.push(v)}for(e.arr_styleSheets=[],r=0;r<e.arr_regions.length;r++){var S=e.arr_regions[r];e.arr_styleSheets.push({id:S.id,begin:S.begin,end:S.end,styles:e.applyStyleToRegion(S.styles)})}for(var T in e.arr_styles){var E=e.arr_styles[T];e.arr_styleSheets.push({id:T,begin:null,end:null,styles:e.applyStyleToRegion(E)})}},this.listupCaptions=function(t,i,n){var r=i.begin_time,a=i.end_time,s=t.getAttribute("begin"),o=t.getAttribute("end"),l=t.getAttribute("xml:id");if(null==s&&null==o);else{var u=e.parseTime(s)+r,d=e.parseTime(o);if(n&&!(n.begin_time<=u&&u<n.end_time))return;if("true"==t.getAttribute("parsed"))return;var f=e.transElement(t);t.setAttribute("parsed","true"),e.arr_captions.push({begin_time:u,end_time:d,id:l,caption:f}),r=u,a=d}for(var c=t.childNodes,m=0;m<c.length;m++)"#text"!=c[m].nodeName&&e.listupCaptions(c[m],{begin_time:r,end_time:a},n)},this.applyStyleToRegion=function(t){if(o(t,"style_ref")){var i=t.style_ref;if(delete t.style_ref,o(e.arr_styles,i)){var n=e.arr_styles[i];for(var r in n)o(t,r)||(t[r]=n[r]);t=e.applyStyleToRegion(t)}else e.NXDebug.error("ERROR : style id is not found in region/style!!! id="+i)}return t},this.applyDefaultStyleToElement=function(e){return e.style.position="absolute",e.style.margin="0px",e.style.padding="0px",e.style.whiteSpace="nowrap",e.style.offset="0px",e.style.border="0px",e.style.overflow="hidden",e},this.applyRegionStyleToElement=function(t){var i=t.getAttribute("region");e.isUndefined(i)||e.applyStyleSheet(t,i);var n=t.getAttribute("style");e.isUndefined(n)||e.applyStyleSheet(t,n)},this.applyStyleSheet=function(t,i){for(var n,r,a={begin:t.getAttribute("begin"),end:t.getAttribute("end")},s=0;s<e.arr_styleSheets.length;s++)if(i==e.arr_styleSheets[s].id&&(n={begin:(r=e.arr_styleSheets[s]).begin,end:r.end},e.checkRange(a,n)))for(var o in r.styles)t.style[o]=r.styles[o]},this.checkRange=function(t,i){return!(!(e.isUndefined(t.begin)&&e.isUndefined(t.end)||e.isUndefined(i.begin)&&e.isUndefined(i.end))&&(!e.isUndefined(t.begin)&&!e.isUndefined(i.begin)&&t.begin>i.begin||!e.isUndefined(t.end)&&!e.isUndefined(i.end)&&t.end<i.end))},this.transElement=function(t){var i,n,r=t.localName,a=document.createElement(r);(a=e.applyDefaultStyleToElement(a)).style.position="absolute",a.style.margin="0px",a.style.padding="0px",a.style.whiteSpace="nowrap",a.style.offset="0px",a.style.border="0px",a.style.overflow="hidden";var s=t.getAttribute("region"),l=t.getAttribute("style");null!=s&&void 0!==s&&a.setAttribute("region",s),null!=l&&void 0!==l&&a.setAttribute("style",l),e.applyRegionStyleToElement(a);var u={},d=[];for(i=0;i<t.attributes.length;i++)switch((n=t.attributes[i]).name){case"tts:fontSize":var f=n.value,c=f.split(/\s/);if(2==c.length){a.style[n.name]=c[1];var m=+c[0].replace("px","")/+c[1].replace("px","");if(1!=m){a.style.transform="scaleX("+m+")",a.style["transform-origin"]="left top",a.style["-webkit-transform"]="scaleX("+m+")",a.style["-webkit-transform-origin"]="left top",a.style["-moz-transform"]="scaleX("+m+")",a.style["-moz-transform-origin"]="left top",a.style["-o-transform"]="scaleX("+m+")",a.style["-o-transform-origin"]="left top",a.style["-ms-transform"]="scaleX("+m+")",a.style["-ms-transform-origin"]="left top";var g=t.getAttribute("arib-tt:letter-spacing");if(void 0!==g){var p=+g.replace("px","")/m;a.style["letter-spacing"]=p+"px",d.push("letter-spacing")}}}else a.style["font-size"]=f;break;case"smpte:backgroundImage":var h=document.createElement("img");h.setAttribute("src",e.baseURL+n.value),a.appendChild(h);break;default:u[n.localName]=n.value}for(i=0;i<d.length;i++)delete u[d[i]];for(var y in"arib-tt:audio"===e.NS.getTagName(t)&&"false"==t.getAttribute("loop")&&delete u.loop,u)if(o(u,y)){var v=e.transAttr(y,u[y]);for(var S in v.htmlAttrs)o(v.htmlAttrs,S)&&a.setAttribute(S,v.htmlAttrs[S]);for(var T in v.htmlCss)o(v.htmlCss,T)&&(a.style[T]=v.htmlCss[T])}var E=t.childNodes;for(i=0;i<E.length;i++)if(3==E[i].nodeType);else{var b=e.transElement(E[i]);a.appendChild(b)}var D=t.childNodes;for(i=0;i<D.length;i++)3==D[i].nodeType&&""!=D[i].data.replace(/[\s\n\t]+/gm,"")&&a.appendChild(document.createTextNode(D[i].data));return a},this.parseXML=function(e){return(new DOMParser).parseFromString(e,"application/xml")},this.parseTime=function(e){var t=e.split("."),i=0;if(t.length>=2&&(i=parseInt(t[1],10)),t.length>=1){var n=t[0].split(":");if(n.length>=3)return 1e3*(60*parseInt(n[0],10)*60+60*parseInt(n[1],10)+parseInt(n[2],10))+i}return 0},this.transAttrFromElement=function(t){var i,n={},r=t.attributes;for(i=0;i<r.length;i++)n[r[i].localName]=r[i].value;var a={},s={};if("arib-tt:src"===t.tagName){if(void 0!==n.url){var l="url('"+e.baseURL+n.url+"') ";void 0!==n.format&&(l+="format('"+n.format+"')"),a.src=l}n={}}for(var u in n)if(o(n,u)){var d=e.transAttr(u,n[u]);for(var f in d.htmlAttrs)a[f]=d.htmlAttrs[f];for(var c in d.htmlCss)s[c]=d.htmlCss[c]}return{htmlAttrs:a,htmlCss:s}},this.transAttr=function(t,i){var n,r,a={},s={};switch(t){case"animation":a.WebkitAnimation=i,a["white-space"]="nowrap";break;case"animationName":s.animationName=i;break;case"position":s.keyframeposition=i;break;case"style":s.style_ref=i;break;case"region":s.class=i,s.region=i;break;case"id":default:s[t]=i;break;case"extent":var o=i.split(/\s/);a.width=o[0],a.height=o[1];break;case"origin":var l=i.split(/\s/);a.position="absolute",a.left=l[0],a.top=l[1];break;case"color":case"backgroundColor":if(0==i.indexOf("#")){for("backgroundColor"==t&&(t="background-color"),n=[],r=0;2*r+1<=i.length-1;)n[r]=i.substr(2*r+1,2),r+=1;4==n.length?a[t]="rgba("+parseInt(n[0],16)+","+parseInt(n[1],16)+","+parseInt(n[2],16)+","+(parseInt(n[3],16)+1)/256+")":a[t]="rgb("+parseInt(n[0],16)+","+parseInt(n[1],16)+","+parseInt(n[2],16)+")"}else e.NXDebug.debug("ERROR: color,backgroundColor format is only #nnnnnn[nn] ... value="+i);break;case"src":s.src=e.baseURL+i;break;case"border":var u=i.split(" "),d=void 0;if(u&&3==u.length){n=[],r=0;for(var f=u[2];2*r+1<=f.length-1;)n[r]=f.substr(2*r+1,2),r+=1;d=4==n.length?"rgba("+parseInt(n[0],16)+","+parseInt(n[1],16)+","+parseInt(n[2],16)+","+(parseInt(n[3],16)+1)/256+")":"rgb("+parseInt(n[0],16)+","+parseInt(n[1],16)+","+parseInt(n[2],16)+")",a[t]=u[0]+" "+u[1]+" "+d}else a[t]=i;break;case"border-left":case"border-right":case"border-top":case"border-bottom":case"fontStyle":case"fontWeight":case"lineHeight":case"textDecoration":case"letter-spacing":a[t]=i;break;case"textOutline":var c=i.split(" ");if(c&&3==c.length){var m=parseInt(c[2])+parseInt(c[1]);n=[],r=0;for(var g=c[0];2*r+1<=g.length-1;)n[r]=g.substr(2*r+1,2),r+=1;4==n.length?a["-webkit-text-stroke-color"]="rgba("+parseInt(n[0],16)+","+parseInt(n[1],16)+","+parseInt(n[2],16)+","+(parseInt(n[3],16)+1)/256+")":a["-webkit-text-stroke-color"]="rgb("+parseInt(n[0],16)+","+parseInt(n[1],16)+","+parseInt(n[2],16)+")",a["-webkit-text-stroke-width"]=c[1],a["-webkit-text-shadow"]=-1*m+"px "+-1*m+"px "+c[0]+","+m+"px "+-1*m+"px "+c[0]+","+-1*m+"px "+m+"px "+c[0]+","+m+"px "+m+"px "+c[0]}else e.NXDebug.debug("ERROR: textOutline format is unavailable ... value = "+i);break;case"opacity":a.opacity=i;break;case"fontSize":var p=i.split(/\s/);p.length>1?a["font-size"]=p[1]:a["font-size"]=i;break;case"fontFamily":a["font-family"]='"'+i+'"'}return{htmlAttrs:s,htmlCss:a}},this.isUndefined=function(e){return void 0===e||null==e},this.NXDebug=new s,this._root=[],this._body=[],this._head=[],this._styling=[],this._layout=[],this._styles=[],this._regions=[],this._arib_keyframes=[],this._arib_fontfaces=[],this.arr_styles=[],this.arr_regions=[],this.arr_styleSheets=[],this.arr_keyframes=[],this.arr_fontfaces=[],this.arr_captions=[],this.baseURL=""};function se(e){return void 0===e||null==e}var oe=function(e){this.ttml=e,this.parsed_end_time=0},le=function(e){this.id=e.id,this.begin_time=e.begin_time,this.end_time=e.end_time,this.caption=e.caption},ue=function e(){var t=this;this.add=function(e){t.arr_caption.push(e)},this.getLength=function(){return t.arr_caption.length},this.get=function(e){return t.arr_caption[e]},this.search=function(e){for(var i=0;i<t.arr_caption.length;i++)if(t.arr_caption[i]==e)return i;return-1},this.remove=function(e){for(var i=0;i<t.arr_caption.length;i++)if(t.arr_caption[i]==e)return t.arr_caption.splice(i,1),i;return-1},this.getActiveTTMLCaptionList=function(i){for(var n=new e,r=0,a=t.arr_caption;r<a.length;r++){var s=a[r];se(s.begin_time)&&se(s.end_time)||s.begin_time<=i&&i<s.end_time&&n.add(s)}return n},this.arr_caption=[]},de=function(e,t,i,n){var r=this;this.getID=function(){return r.id},this.addTTMLCue=function(e){r.arr_ttml_cue.shift(),r.arr_ttml_cue.push(new oe(e))},this.parseCue=function(e){for(var t,i=0,n=e+2e4,a={begin_time:e,end_time:n},s=0;s<r.arr_ttml_cue.length;s++){t=r.arr_ttml_cue[s],a.begin_time=e,a.end_time=n;for(var o=r.parentClass.ttmlParser.parse(t.ttml,r.getBaseUrl(),a),l=new ue,u=0,d=o.captions;u<d.length;u++){var f=d[u],c=new le(f);l.add(c)}if(i=o.captions.length,r.addTTMLCaptionList(l),!r.kfCreateFlg&&o.captions.length>0){var m=o.captions[0].id;r.kfCreateFlg=!0,r.parentClass.createKeyFrame(o.keyframes,r.getID(),m),r.parentClass.createFontFace(o.fontfaces,r.getID(),m)}}i>0&&(t.parsed_end_time=n)},this.getSrc=function(){return r.src},this.getBaseUrl=function(){var e=r.src.split("/");if(e&&e.length>1){for(var t="",i=0;i<e.length-1;i++)t+=e[i]+"/";return t}return"/"},this.getSrclang=function(){return r.srclang},this.addTTMLCaptionList=function(e){for(var t=0;t<e.getLength();t++){for(var i=e.get(t),n=!0,a=0;a<r.ttml_caption_list.getLength();a++)if(r.ttml_caption_list.get(a).id==i.id){n=!1;break}n&&r.ttml_caption_list.add(i)}},this.presentationTTML=function(e){var t,i,n=r.ttml_caption_list.getActiveTTMLCaptionList(e),a=new ue,s=new ue;for(i=0;i<n.getLength();i++)t=-1,r.currentActiveList&&(t=r.currentActiveList.search(n.get(i))),-1==t&&a.add(n.get(i));if(r.currentActiveList)for(i=0;i<r.currentActiveList.getLength();i++)-1==n.search(r.currentActiveList.get(i))&&s.add(r.currentActiveList.get(i));for(i=0;i<s.getLength();i++){var l=s.get(i).id,u=document.getElementById(l);u&&r._overlay.removeChild(u)}if(a.getLength()>0){var d=void 0,f=void 0;for(i=0;i<a.getLength();i++)if(f=(d=a.get(i)).caption.cloneNode(!0),null==document.getElementById(d.id)){if("div"==f.localName&&f.hasAttribute("style")){var c=f;o(c.style,"width")&&(c.style.width=r._overlay.style.width),o(c.style,"height")&&(c.style.height=r._overlay.style.height)}r._overlay.appendChild(f)}}var m=r._overlay.getElementsByTagName("audio");for(i=0;i<m.length;i++)"autoplay"!=m[i].getAttribute("autoplay")&&m[i].setAttribute("autoplay","autoplay");return r.currentActiveList=n,a.getLength()},this.parentClass=e,this.id=i,this.src=se(n.src)?null:n.src,this.srclang=se(n.srclang)?null:n.srclang,this.arr_ttml_cue=[],this.ttml_caption_list=new ue,this.currentActiveList=null,this.kfCreateFlg=!1,this._overlay=document.createElement("div"),this._overlay.id=i,this._overlay.setAttribute("class","subtitle_element"),this._overlay.style.position="absolute",this._overlay.style.left="0px",this._overlay.style.top="0px",this._overlay.style.width=t.width+"px",this._overlay.style.height=t.height+"px",this._overlay.style.padding="0px",this._overlay.style.overflow="hidden",t.parentNode.insertBefore(this._overlay,t.nextSibling)},fe=new function(){var e=this;this.setSubtitleVisible=function(t){for(var i=0;i<e.getSubtitleElementCount();i++)if(i==e.select_subtitle_index){var n=e.getSubtitleElement(i);document.getElementById(n.getID()).style.display=t?"block":"none"}},this.getSubtitleVisible=function(){for(var t=0;t<e.getSubtitleElementCount();t++){var i=e.getSubtitleElement(t);if("none"!=document.getElementById(i.getID()).style.display)return!0}return!1},this.selectSubtitle=function(t){e.setSubtitleVisible(!1);for(var i=0;i<e.getSubtitleElementCount();i++)if(t==i){e.select_subtitle_index=t;var n=e.getSubtitleElement(i);document.getElementById(n.getID()).style.display="block";break}},this.addParsedEvent=function(t){e.parsedEvent.push(t)},this.getSubtitleElementById=function(t){for(var i=0;i<e.arr_subtitle_element.length;i++)if(e.arr_subtitle_element[i].getID()==t)return e.arr_subtitle_element[i];return null},this.retrieveStaticSubtitle=function(t,i){var n=new XMLHttpRequest;n.onload=function(){200!=n.status&&206!=n.status||(e.addTTMLText(t,n.response),e.NXDebug.log("ttml-retrieve-success: "+i))},n.onerror=function(){e.NXDebug.log("ttml-retrieve-failure: "+n.status+" "+n.statusText+" url:"+i)},n.onabort=function(){},n.open("GET",i,!1),n.send()},this.parseTTMLFromMPD=function(t,i){var n;for(void 0===t&&m.log("error periods is undefined!!"),e.videoElement=i,n=0;n<t.length;n++)for(var r=0,a=t[n].adaptationSets;r<a.length;r++){var s=a[r];if(s.mimeType&&"application/ttml+xml"==s.mimeType){if("undefined"==s.Role){m.log("--\x3eerror adaptationSets.Role is undefined!! ");break}if("subtitle"!=s.Role){e.NXDebug.log("adaptationSets.Role != subtitle >> "+s.Role);break}for(var o=0;o<s.representations.length;o++){var l=s.representations[o].BaseURL[0].url,u="ttml_"+(s.representations[o].id||s.representations[o].index);e.getSubtitleElementById(u)||e.addSubtitleElement(i,u,{src:l,srclang:s.attrs.lang}),e.retrieveStaticSubtitle(u,l)}}}var d=e.getSubtitleElementCount();if(d>0)for(e.select_subtitle_index=0,n=0;n<d;n++){var f=e.getSubtitleElement(n);document.getElementById(f.getID()).style.display="none"}else e.select_subtitle_index=-1;e.callParsedEvent()},this.callParsedEvent=function(){for(var t=0;t<e.parsedEvent.length;t++)e.parsedEvent[t]()},this.getSubtitleElementCount=function(){return e.arr_subtitle_element.length},this.getSubtitleElement=function(t){return e.arr_subtitle_element[t]},this.videoSeeked=function(){e.parseTTMLElements()},this.addSubtitleElement=function(t,i,n){null==e.seekedListener&&(e.seekedListener=e.videoSeeked.bind(e),e.videoElement.addEventListener("seeked",e.seekedListener));var r=new de(e,t,i,n);e.arr_subtitle_element.push(r),se(e.presentationTimer)&&(e.presentationTimer=setInterval(e.presentationTTMLElements,e.setting.presentation_interval)),se(e.parseTimer)&&(e.parseTimer=setInterval(e.parseTTMLElements,17e3))},this.addTTMLText=function(t,i){var n=e.getSubtitleElementById(t);se(n)||(n.addTTMLCue(i),e.parseTTMLElements())},this.createKeyFrame=function(t,i,n){if(null==e._head&&(e._head=document.getElementsByTagName("head")[0]),t.length>0){var r=e._head.getElementsByTagName("style");if(r.length>0&&o(r,"getElementById")){var a=r.getElementById("temp_keyframes_"+i+"_"+n);a&&e._head.removeChild(a)}for(var s="",l=0,u=t;l<u.length;l++){var d=u[l];s+="@-webkit-keyframes "+d.name+"{";for(var f=0;f<d.positions.length;f++)s+=d.positions[f].position+d.positions[f].styles,s+="\n";s+="}\n"}var c=document.createElement("style");c.type="text/css",c.id="temp_keyframes_"+i+"_"+n,c.innerHTML=s,e._head.appendChild(c)}},this.createFontFace=function(t,i,n){var r="";if(null==e._head&&(e._head=document.getElementsByTagName("head")[0]),t.length>0)for(var a=0;a<t.length;a++){for(var s in r="@font-face {",t[a])"id"!=s&&(r+=s+":"+t[a][s]+";");r+="}";var o=document.createElement("style");o.type="text/css",o.id="temp_fontfaces_"+i+"_"+n+"_"+t[a].id,o.innerHTML=r,e._head.appendChild(o)}},this.getCurrentTime=function(){return 0==e.setting.presentation_timing?(new Date).getTime():e.videoElement?1e3*e.videoElement.currentTime:(e.NXDebug.error("videoElement is null..."),0)},this.presentationTTMLElements=function(){if(e.arr_subtitle_element.length>0){var t=e.getCurrentTime();for(var i in e.arr_subtitle_element)e.arr_subtitle_element[i].presentationTTML(t)}},this.parseTTMLElements=function(){if(e.arr_subtitle_element.length>0)for(var t=e.getCurrentTime(),i=0;i<e.arr_subtitle_element.length;i++)e.arr_subtitle_element[i].parseCue(t)},this.setDashTVPlayer=function(t){t.addEventListener("manifestUpdated",(function(){var i=t.getPeriodInfo();e.parseTTMLFromMPD(i,t.getVideoModel().getElement())}),!1)},this.setSetting=function(t){e.setting=t},this.NXDebug=new s,this._head=null,this.setting={presentation_timing:1,presentation_interval:500},this.presentationTimer=null,this.parseTimer=null,this.arr_subtitle_element=[],this.parsedEvent=[],this.ttmlParser=new ae,this.videoElement=null,this.seekedListener=null,this.select_subtitle_index=-1},ce=function(){function e(t){var i=this;this.errHandler=f,this.xhrCustom=null,this.isReady=function(){return null!=i.element&&null!=i.source},this.supportsMediaSource=function(){var e="WebKitMediaSource"in window,t="MediaSource"in window;return e||t},this.play=function(){i.supportsMediaSource.call(i)?(i.source&&o(i.source,"params")&&(i.params=i.source.params),i.playing=!0,i.xhrCustom=i.source&&o(i.source,"xhrCustom")?i.source.xhrCustom:{},i.streamController=new re(i.params,i.eventBus,i.metricsModel,i.abrController,i.xhrCustom),i.streamController.setVideoModel(i.videoModel),i.streamController.setUpMediaSource(i.element),i.streamController.setPresentationStartTime(i.initialPresentationStartTime),i.streamController.setPresentationEndTime(i.initialPresentationEndTime),i.streamController.setBandwidthLimit(i.minBandwidth,i.maxBandwidth),i.streamController.setAutoPlay(i.autoPlay),i.streamController.load(i.source)):i.errHandler.capabilityError(i.eventBus,"mediasource")},this.VERSION="1.9.10",this.DEPLOY_DATE="ver.2022/3/31 11:11:40",this.params={},this.element=t,this.playing=!1,this.autoPlay=!0,this.eventBus=new c,this.NXDebug=e.Debug,this.metricsModel=new p,this.abrController=new d,this.errHandler=f,this.videoModel=null!=this.element?new y(this.element,this.eventBus):new h(this.element,this.eventBus),this.xhrCustom=null,this.initialPresentationStartTime=NaN,this.initialPresentationEndTime=NaN,this.minBandwidth={video:NaN,audio:NaN},this.maxBandwidth={video:NaN,audio:NaN},e.LogHandler.log(this.DEPLOY_DATE),e.LogHandler.log_item("player_version",this.DEPLOY_DATE+" / "+this.VERSION)}return e.prototype.addEventListener=function(e,t,i){this.eventBus.addEventListener(e,t,i)},e.prototype.removeEventListener=function(e,t,i){this.eventBus.removeEventListener(e,t,i)},e.prototype.getVersion=function(){return this.VERSION},e.prototype.getDebug=function(){return this.NXDebug},e.prototype.getVideoModel=function(){return this.videoModel},e.prototype.setAutoPlay=function(e){this.autoPlay=e},e.prototype.getAutoPlay=function(){return this.autoPlay},e.prototype.getIsDynamic=function(){return this.streamController.getIsDynamic()},e.prototype.getPeriodInfo=function(){return this.streamController.getPeriodInfo()},e.prototype.getPeriodInfoForIdx=function(e){return this.streamController.getPeriodInfoForIdx(e)},e.prototype.getPeriodIdxForTime=function(e){return this.streamController.getPeriodIdxForTime(e)},e.prototype.getCurrentPlayingPeriodIdx=function(){var e=this.videoModel.getCurrentTime();return this.streamController.getPeriodIdxForTime(e)},e.prototype.getBaseURLIdxFor=function(e){return this.streamController.getBaseURLIdxFor(e)},e.prototype.getMaxBaseURLIdxFor=function(e){return this.streamController.getMaxBaseURLIdxFor(e)},e.prototype.setBaseURLIdxFor=function(e,t){this.streamController.setBaseURLIdxFor(e,t)},e.prototype.getCurrentAdaptationIdxFor=function(e){return this.streamController.getCurrentAdaptationIdxFor(e)},e.prototype.setAdaptationIdxFor=function(e,t){this.streamController.setAdaptationIdxFor(e,t)},e.prototype.setAdaptationRoleFor=function(e,t){this.streamController.setAdaptationRoleFor(e,t)},e.prototype.setCueingPeriodIdx=function(e){this.streamController.setCueingPeriodIdx(e)},e.prototype.getMetricsExt=function(){return this.metricsModel},e.prototype.getMetricsFor=function(e){return this.metricsModel.getMetricsFor(e)},e.prototype.getMaxQualityIndexFor=function(e){return this.abrController.getMaxQualityIndexFor(e)},e.prototype.getQualityFor=function(e){return this.abrController.getQualityFor(e)},e.prototype.setQualityFor=function(e,t){this.abrController.setPlaybackQuality(e,t)},e.prototype.getDefaultQualityFor=function(e){return this.abrController.getDefaultQualityFor(e)},e.prototype.setDefaultQualityFor=function(e,t){this.abrController.setDefaultPlaybackQuality(e,t),this.abrController.setPlaybackQuality(e,t)},e.prototype.setMinBandwidthFor=function(e,t){this.minBandwidth[e]=t},e.prototype.setMaxBandwidthFor=function(e,t){this.maxBandwidth[e]=t},e.prototype.getAutoSwitchQuality=function(){return this.abrController.getAutoSwitchBitrate()},e.prototype.getBufferFor=function(e){return this.streamController.getBufferFor(e)},e.prototype.getMediaSourceReadyState=function(){return this.streamController.getMediaSourceReadyState()},e.prototype.setAutoSwitchQuality=function(e){this.abrController.setAutoSwitchBitrate(e)},e.prototype.attachView=function(e){if(this.element=e,this.element){var t=null;null!=this.videoModel&&this.videoModel.isDummy()&&(t=this.videoModel.getCurrentStatus()),this.videoModel=new y(this.element,this.eventBus),null!=t&&this.videoModel.setCurrentStatus(t),this.streamController.updateVideoModel(this.videoModel)}else this.videoModel=null},e.prototype.attachSource=function(t,i,n){this.initialPresentationStartTime=i>=0?i:NaN,this.initialPresentationEndTime=n||NaN,this.source=t,this.playing&&this.streamController&&(e.LogHandler.clearLogs(),this.streamController.reset(),this.streamController=null,this.playing=!1),null!=this.source&&(this.videoModel.isDummy()?this.play.call(this):(this.videoModel.checkCanplaythrough(),this.isReady()&&this.play.call(this)))},e.prototype.setManifestFromExt=function(e,t){this.streamController.setManifestFromExt(e,t)},e.prototype.reset=function(){this.attachSource(null),this.attachView(null),this.minBandwidth={video:NaN,audio:NaN},this.maxBandwidth={video:NaN,audio:NaN}},e.prototype.setCurrentTime=function(t){var i=this.videoModel.getCurrentTime(),n=this.videoModel.getDuration(),r=t;r<0?r=0:r>n&&(r=n),e.LogHandler.log("*** SEEK: "+t+" ["+i+"] -> ["+r+"]"),this.NXDebug.log("*** SEEK: "+t+" ["+i+"] -> ["+r+"]"),this.videoModel.isDummy()?this.streamController.seek(r):(this.videoModel.isPaused()||this.setPause(),this.videoModel.setCurrentTime(r))},e.prototype.getBufferState=function(){return this.streamController.getBufferState()},e.prototype.setCurrentTimeDelta=function(t,i){var n=this.videoModel.getCurrentTime(),r=this.videoModel.getDuration(),a=i||!1,s=n+t;s<0?s=0:s>r&&(s=r),e.LogHandler.log("*** SEEK: "+t+" ["+n+"] -> ["+s+"]"),this.NXDebug.log("*** SEEK: "+t+" ["+n+"] -> ["+s+"]"),this.videoModel.isDummy()?this.streamController.seek(s):a?this.videoModel.silentSeek(s):(this.videoModel.isPaused()||this.setPause(),this.videoModel.setCurrentTime(s))},e.prototype.setSeekTime=function(t){var i=this.videoModel.getCurrentTime(),n=this.videoModel.getDuration(),r=i+t;r<0?r=0:r>n&&(r=n),e.LogHandler.log("*** SEEK: "+t+" ["+i+"] -> ["+r+"]"),this.NXDebug.log("*** SEEK: "+t+" ["+i+"] -> ["+r+"]"),this.videoModel.isDummy()?this.streamController.seek(r):(this.videoModel.isPaused()||this.setPause(),this.videoModel.setCurrentTime(r))},e.prototype.getCurrentManifestData=function(){return this.streamController.getCurrentManifestData()},e.prototype.setPause=function(e){var t=e||!0;this.streamController.pause(t)},e.prototype.setPlay=function(e){var t=e||!0;this.streamController.play(t)},e.prototype.end=function(){this.streamController&&this.streamController.end()},e.prototype.setPresentationStartTime=function(e){this.initialPresentationStartTime=e},e.prototype.setDebugMode=function(e){this.NXDebug.setMode(e)},e.prototype.getDebugMode=function(){return this.NXDebug.getMode()},e.Debug=new s,e.LogHandler=m,e.ttml_renderer=fe,e}();console.dir(ce),window.DashTVPlayer=ce}();